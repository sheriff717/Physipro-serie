<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PhysiPro Moulage – v316 – Bouton Fiche + Menu Déplacer + Priorité vue horizontale</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
/* =============================================================================
   PHYSIPRO MOULAGE - FEUILLE DE STYLES v11.0
   Structure: Reset, Layout, Cartes, Menus, Fiches, Vue Robot, Commandes, Modals
============================================================================= */

/* -----------------------------------------------------------------------------
   RESET & BASE
----------------------------------------------------------------------------- */
html, body { margin: 0; padding: 0; }

.physiproRoot {
  min-height: 100vh;
  font-family: Arial, Helvetica, sans-serif;
  background: linear-gradient(to bottom, #0b1d36, #3f6eb8);
  background-attachment: fixed;
  color: #fff;
}

.app-shell {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* ===== TOP BAR ===== */
.topbar {
  flex: 0 0 auto;
  width: 100%;
  box-sizing: border-box;
  padding: 6px 20px 12px 20px;
  min-height: 90px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.45);
  position: relative;
}

.tb-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ========== ANIMATION FLIP 3D LOGO ========== */
.logo-flip-container {
  width: 240px;
  height: 78px;
  perspective: 1000px;
  cursor: pointer;
  position: relative;
  z-index: 100;
}

.logo-flip-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1);
  transform-style: preserve-3d;
  pointer-events: none;
}

.logo-flip-container:hover .logo-flip-inner {
  transform: rotateY(15deg);
}

/* Animation fluide sans pause - switch magique au milieu */
@keyframes flipToBack {
  0% { transform: rotateY(0deg); }
  100% { transform: rotateY(180deg); }
}

@keyframes flipToFront {
  0% { transform: rotateY(180deg); }
  100% { transform: rotateY(360deg); }
}

.logo-flip-container.flipping-to-back .logo-flip-inner {
  animation: flipToBack 0.7s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
}

.logo-flip-container.flipping-to-front .logo-flip-inner {
  animation: flipToFront 0.7s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
}

.logo-flip-front,
.logo-flip-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  border: none;
  background: transparent;
  overflow: hidden;
}

.logo-flip-front {
  z-index: 2;
}

.logo-flip-back {
  transform: rotateY(180deg);
}

.logo-flip-front img,
.logo-flip-back img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  filter: brightness(1.1) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

/* Les deux logos ont maintenant la même taille */

/* Pas d'effet spécial pendant le flip */
.logo-flip-container.flipping-to-back .logo-flip-front,
.logo-flip-container.flipping-to-back .logo-flip-back,
.logo-flip-container.flipping-to-front .logo-flip-front,
.logo-flip-container.flipping-to-front .logo-flip-back {
  box-shadow: none;
}

/* État actif sans glow visible */
.logo-flip-container.active-moulages .logo-flip-front,
.logo-flip-container.active-commandes .logo-flip-back {
  border: none;
  box-shadow: none;
}

.hidden {
  display: none !important;
}

.tb-center {
  position: absolute;
  left: 50%;
  top: 35%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.top-title {
  font-size: 22px;
  white-space: nowrap;
  font-weight: 700;
  font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #fdfdfd;
  text-shadow: 0 2px 3px rgba(0,0,0,0.85);
  pointer-events: none;
}

/* Bouton Settings (engrenage) */
.settings-btn {
  font-size: 22px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px;
  border-radius: 50%;
  transition: all 0.2s;
  pointer-events: auto;
}

.settings-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: rotate(45deg);
}

/* Menu Settings Popup */
.settings-menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 50000;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 80px;
}

.settings-menu-overlay.hidden {
  display: none;
}

.settings-menu-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  min-width: 200px;
  overflow: hidden;
}

.settings-menu-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: white;
  font-weight: 600;
  font-size: 14px;
}

.settings-close-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 12px;
}

.settings-close-btn:hover {
  background: #ef4444;
}

.settings-menu-content {
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.settings-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 15px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  color: white;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.settings-menu-item:hover {
  background: rgba(255,255,255,0.15);
}

.settings-menu-item.logout {
  border-color: rgba(239,68,68,0.3);
}

.settings-menu-item.logout:hover {
  background: rgba(239,68,68,0.2);
}

.settings-icon {
  font-size: 18px;
}

/* Menu Import/Export */
.import-export-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.import-export-overlay.hidden {
  display: none;
}

.import-export-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0a1628);
  border: 2px solid #4a8ef5;
  border-radius: 12px;
  width: 500px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.import-export-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #2a4a7f, #1e3a5f);
  border-bottom: 1px solid #4a8ef5;
  border-radius: 10px 10px 0 0;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
}

.import-export-close-btn {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.import-export-close-btn:hover {
  filter: brightness(1.2);
}

.import-export-content {
  padding: 20px;
}

.import-export-section {
  margin-bottom: 15px;
}

.import-export-section h3 {
  margin: 0 0 10px 0;
  font-size: 15px;
  color: #4ade80;
}

.import-export-section p {
  margin: 0 0 15px 0;
  font-size: 12px;
  color: #94a3b8;
  line-height: 1.4;
}

.import-export-btn {
  width: 100%;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: filter 0.2s;
}

.import-export-btn:hover {
  filter: brightness(1.1);
}

.export-btn {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.import-btn {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
}

.export-options {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.import-export-btn-small {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #4a8ef5;
  border-radius: 6px;
  background: rgba(74,142,245,0.1);
  color: #4a8ef5;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}

.import-export-btn-small:hover {
  background: rgba(74,142,245,0.3);
}

.import-export-divider {
  height: 1px;
  background: linear-gradient(to right, transparent, #4a8ef5, transparent);
  margin: 20px 0;
}

.import-warning {
  margin-top: 15px;
  padding: 10px;
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.3);
  border-radius: 6px;
  font-size: 11px;
  color: #fca5a5;
  text-align: center;
}

.tb-right {
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  z-index: 150;
}

.tb-right-main {
  display: flex;
  align-items: center;
  gap: 10px;
}

.tb-right-top {
  display: flex;
  gap: 8px;
  align-items: center;
}

.tb-right-bottom {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: flex-end;
}

/* Boutons header */
.header-btn {
  padding: 6px 18px;
  font-size: 10px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.45);
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: #ffffff;
  cursor: pointer;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.18), 0 2px 4px rgba(0,0,0,0.7);
  position: relative;
  z-index: 200;
}

.header-btn-small {
  padding: 4px 10px;
  font-size: 9px;
}

.header-btn:hover {
  background: linear-gradient(to bottom, #4a7fc9, #264170);
}

/* Zone auth - aligné à droite sous Ajouter moulage */
.tb-right-bottom {
  display: flex;
  align-items: center;
  gap: 4px;
  justify-content: flex-end;
}

.user-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  margin-right: 4px;
}

.user-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
}

.user-status .status-dot.offline {
  background: #ef4444;
}

.auth-btn {
  padding: 4px 8px;
  font-size: 9px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.3);
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
  color: #fff;
  cursor: pointer;
  position: relative;
  z-index: 200;
}

.auth-btn.login {
  background: linear-gradient(to bottom, #22c55e, #15803d);
}

/* ===== POPUP ARCHIVES ===== */
.archives-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  z-index: 50000;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.archives-popup {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 700px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  overflow: hidden;
}

.archives-header {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  color: white;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.archives-header h2 {
  margin: 0;
  font-size: 16px;
  flex: 1;
}

.archives-count {
  background: rgba(255,255,255,0.2);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
}

.archives-close {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
}

.archives-close:hover {
  background: #ef4444;
}

/* ===== MENU LOG ===== */
.log-menu-popup {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  overflow: hidden;
}

.log-menu-header {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  color: white;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.log-menu-header h2 {
  margin: 0;
  font-size: 16px;
}

.log-menu-content {
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.log-menu-btn {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 15px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  background: #f8fafc;
  cursor: pointer;
  transition: all 0.2s;
}

.log-menu-btn:hover {
  background: #dbeafe;
  border-color: #3b82f6;
}

.log-menu-icon {
  font-size: 24px;
  margin-bottom: 5px;
}

.log-menu-text {
  font-weight: 700;
  font-size: 14px;
  color: #1e3a5f;
}

.log-menu-desc {
  font-size: 11px;
  color: #6b7280;
  margin-top: 3px;
}

.log-menu-footer {
  padding: 10px 20px;
  background: #f1f5f9;
  font-size: 11px;
  color: #6b7280;
  text-align: center;
}

/* Bouton backup dans le menu */
.log-menu-btn.backup-btn {
  border-color: #fbbf24;
  background: #fffbeb;
}

.log-menu-btn.backup-btn:hover {
  background: #fef3c7;
  border-color: #f59e0b;
}

/* ===== NOTIFICATION BACKUP ===== */
.backup-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 60000;
  animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.backup-notif-content {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px 20px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.backup-notif-icon {
  font-size: 24px;
}

.backup-notif-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.backup-notif-text strong {
  font-size: 13px;
}

.backup-notif-text span {
  font-size: 11px;
  opacity: 0.9;
}

.backup-notif-content button {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 12px;
}

.backup-notif-content button:hover {
  background: rgba(255,255,255,0.3);
}

/* ===== LISTE DES BACKUPS ===== */
.backup-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 10px;
}

.backup-item:hover {
  background: #f1f5f9;
}

.backup-info {
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 150px;
}

.backup-date {
  font-weight: 700;
  font-size: 13px;
  color: #1e3a5f;
}

.backup-by {
  font-size: 10px;
  color: #6b7280;
}

.backup-stats {
  flex: 1;
  display: flex;
  gap: 15px;
  font-size: 11px;
  color: #4b5563;
}

.backup-restore-btn {
  padding: 8px 15px;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}

.backup-restore-btn:hover {
  background: linear-gradient(to bottom, #2563eb, #1d4ed8);
}

.backup-manual-section {
  padding: 15px;
  border-top: 1px solid #e2e8f0;
  text-align: center;
}

.backup-manual-btn {
  padding: 12px 25px;
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
}

.backup-manual-btn:hover {
  background: linear-gradient(to bottom, #d97706, #b45309);
}

/* ===== SLIDER ARCHIVES ===== */
.archive-slider-popup {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 600px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  overflow: hidden;
}

.archive-slider-header {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  color: white;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.slider-nav-btn {
  padding: 8px 15px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}

.slider-nav-btn:hover:not(:disabled) {
  background: rgba(255,255,255,0.2);
}

.slider-nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.slider-counter {
  flex: 1;
  text-align: center;
  font-weight: 700;
  font-size: 14px;
}

.archive-slider-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.archive-slider-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
}

.archive-type-big {
  font-size: 32px;
}

.archive-slider-title h2 {
  margin: 0;
  font-size: 20px;
  color: #1e3a5f;
}

.archive-slider-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.archive-slider-field {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.archive-slider-field .label {
  font-size: 10px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
}

.archive-slider-field .value {
  font-size: 13px;
  color: #1f2937;
  font-weight: 500;
  padding: 6px 10px;
  background: #f1f5f9;
  border-radius: 6px;
}

.archive-slider-section {
  margin-bottom: 15px;
}

.archive-slider-section h3 {
  font-size: 12px;
  color: #1e3a5f;
  margin: 0 0 10px 0;
}

.archive-dept-times {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.dept-time-pill {
  padding: 5px 10px;
  background: #dbeafe;
  color: #1e40af;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.archive-notes-box {
  padding: 12px;
  background: #fffde7;
  border-radius: 8px;
  font-size: 12px;
  color: #333;
  font-style: italic;
  min-height: 40px;
}

.archive-slider-footer {
  font-size: 10px;
  color: #9ca3af;
  text-align: center;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
}

.archive-slider-range {
  padding: 15px 20px;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  gap: 15px;
}

.archive-slider-range input[type="range"] {
  flex: 1;
  height: 8px;
  -webkit-appearance: none;
  background: #cbd5e1;
  border-radius: 4px;
  outline: none;
}

.archive-slider-range input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  background: #3b82f6;
  border-radius: 50%;
  cursor: pointer;
}

.archive-slider-range span {
  font-size: 12px;
  font-weight: 600;
  color: #1e3a5f;
  min-width: 60px;
  text-align: center;
}

.no-data {
  color: #9ca3af;
  font-style: italic;
}

.archives-list {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.archives-empty {
  text-align: center;
  padding: 40px;
  color: #9ca3af;
  font-size: 14px;
}

.archive-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 10px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.archive-card:hover {
  background: #f1f5f9;
  border-color: #3b82f6;
}

.archive-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.archive-type {
  font-size: 16px;
}

.archive-name {
  font-weight: 700;
  color: #1e3a5f;
  flex: 1;
}

.archive-date {
  font-size: 10px;
  color: #6b7280;
}

.archive-summary {
  display: flex;
  gap: 15px;
  font-size: 11px;
  color: #4b5563;
}

.archive-details {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e2e8f0;
}

.archive-detail-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 11px;
  border-bottom: 1px dotted #e2e8f0;
}

.archive-detail-row:last-child {
  border-bottom: none;
}

.archive-detail-row span:first-child {
  font-weight: 600;
  color: #6b7280;
}

.archive-detail-row span:last-child {
  color: #1f2937;
}

/* Zone recherche */
.top-search-row {
  position: absolute;
  left: 50%;
  bottom: 4px;
  transform: translateX(-50%);
  width: auto;
  display: flex;
  justify-content: center;
  pointer-events: none;
}

.search-box {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid #325f9b;
  background: rgba(2,11,24,0.55);
  box-shadow: 0 2px 4px rgba(0,0,0,0.55);
  width: 460px;
  min-width: 460px;
  margin-bottom: 6px;
  pointer-events: auto;
}

.search-box input {
  flex: 1;
  padding: 3px 5px;
  font-size: 10px;
  border: none;
  background: transparent;
  color: #fff;
  outline: none;
}

.search-box input::placeholder {
  color: rgba(210,220,240,0.7);
}

.search-clear {
  padding: 0 8px;
  font-size: 11px;
  border: none;
  background: transparent;
  color: rgba(210,220,240,0.9);
  cursor: pointer;
}

/* ===== BOARD ===== */
.board-wrapper {
  flex: 1 1 auto;
  padding: 4px 0 16px;
  display: flex;
  justify-content: flex-start;
}

.boards-container {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
  box-sizing: border-box;
}

.board {
  width: 100%;
  display: grid;
  grid-template-columns: repeat(8, minmax(0, 1fr));
  column-gap: 4px;
}

/* Board commandes - 5 colonnes égales pleine largeur */
.board.commandes-board {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  column-gap: 4px;
  padding: 0 4px;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  overflow: hidden;
}

.board.commandes-board .col-cmd {
  min-width: 0;
  overflow: hidden;
}

/* ===== COLONNES ===== */
.col {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.colheader {
  position: relative;
  border-radius: 18px;
  padding: 6px 28px 6px 12px;
  text-align: center;
  font-weight: 700;
  font-size: 10px;
  color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  box-shadow: 0 2px 3px rgba(0,0,0,0.8);
  border: 1px solid rgba(0,0,0,0.8);
  background: linear-gradient(to bottom, #2b5b99, #103561);
}

.colheader .col-count {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 22px;
  padding: 0 6px;
  border-radius: 0 17px 17px 0;
  background: linear-gradient(to bottom, #1a3a5c, #0d1f33);
  border-left: 1px solid rgba(100, 180, 255, 0.4);
  font-size: 11px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Compteur colonnes commandes */
.colheader .col-count-cmd {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 22px;
  padding: 0 6px;
  border-radius: 0 17px 17px 0;
  background: linear-gradient(to bottom, #1a3a5c, #0d1f33);
  border-left: 1px solid rgba(100, 180, 255, 0.4);
  font-size: 11px;
  font-weight: 700;
}

.colheader.en-attente {
  background: linear-gradient(to bottom, #b81f1f, #6e0505);
}

.colheader.en-attente .col-count {
  background: linear-gradient(to bottom, #5c1a1a, #330d0d);
  border-left: 1px solid rgba(255, 100, 100, 0.4);
}

/* Headers colonnes clients pour Commandes - Glassmorphism comme les cartes */

/* VERMEIREN - Vert glassmorphism 58% - Texte blanc */
.colheader.client-vermeiren-header {
  background: linear-gradient(135deg, 
    rgba(34, 197, 94, 0.58) 0%, 
    rgba(22, 101, 52, 0.58) 50%, 
    rgba(34, 197, 94, 0.58) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  border: 1px solid rgba(255,255,255,0.25);
}

.colheader.client-vermeiren-header .col-count-cmd {
  background: rgba(255,255,255,0.2);
  color: white;
  font-size: 13px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* HME - Gold Ontario métallique */
.colheader.client-hme-header {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.colheader.client-hme-header .col-count-cmd {
  background: rgba(0,0,0,0.15);
  color: #ffffff;
  font-size: 13px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* C1SOUTH - Violet glassmorphism 58% */
.colheader.client-c1south-header {
  background: linear-gradient(135deg, 
    rgba(139, 92, 246, 0.58) 0%, 
    rgba(76, 29, 149, 0.58) 50%, 
    rgba(139, 92, 246, 0.58) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  border: 1px solid rgba(255,255,255,0.25);
}

.colheader.client-c1south-header .col-count-cmd {
  background: rgba(255,255,255,0.2);
  color: white;
  font-size: 13px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* CUBRO - Fond Cyan (couleur du texte Cubro sur les cartes) */
.colheader.client-cubro-header {
  background: linear-gradient(to bottom, #0e7490 0%, #67e8f9 100%);
  color: white;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.colheader.client-cubro-header .col-count-cmd {
  background: rgba(255,255,255,0.2);
  color: white;
  font-size: 13px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* FRANCE - Jaune glassmorphism 80% */
.colheader.client-france-header {
  background: linear-gradient(135deg, 
    rgba(250, 204, 21, 0.80) 0%, 
    rgba(202, 138, 4, 0.80) 50%, 
    rgba(250, 204, 21, 0.80) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  border: 1px solid rgba(255,255,255,0.25);
}

.colheader.client-france-header .col-count-cmd {
  background: rgba(0,0,0,0.15);
  color: #ffffff;
  font-size: 13px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* ===== CARTES COMPACTES ===== */
.mcard {
  position: relative;
  margin: 2px 3px;
  padding: 6px 8px 3px 8px;
  border-radius: 10px;
  background: linear-gradient(to bottom, #051020 0%, #0a1e38 35%, #5a8ac9 100%);
  border: 2px solid #000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  color: #fff;
  font-size: 8px;
  overflow: visible;
}

/* Couleurs par région - dégradé métallique glossy */
/* Bordure noire sur TOUS les textes des cartes */
.mcard.region-qc {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.region-qc .mcard-title,
.mcard.region-qc .mcard-order,
.mcard.region-qc .mcard-region-pill,
.mcard.region-qc .mcard-delay-pill,
.mcard.region-qc .mcard-btn-move,
.mcard.region-qc .mcard-btn-delete,
.mcard.region-qc .mcard-btn-priority,
.mcard.region-qc .mcard-btn-fiche,
.mcard.region-qc .mcard-toggle-btn {
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.region-on .mcard-title,
.mcard.region-on .mcard-order,
.mcard.region-on .mcard-region-pill,
.mcard.region-on .mcard-delay-pill,
.mcard.region-on .mcard-btn-move,
.mcard.region-on .mcard-btn-delete,
.mcard.region-on .mcard-btn-priority,
.mcard.region-on .mcard-btn-fiche,
.mcard.region-on .mcard-toggle-btn {
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma {
  background: linear-gradient(to bottom, #451238 0%, #8D2E6A 40%, #C7458C 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.region-ma .mcard-title,
.mcard.region-ma .mcard-order,
.mcard.region-ma .mcard-region-pill,
.mcard.region-ma .mcard-delay-pill,
.mcard.region-ma .mcard-btn-move,
.mcard.region-ma .mcard-btn-delete,
.mcard.region-ma .mcard-btn-priority,
.mcard.region-ma .mcard-btn-fiche,
.mcard.region-ma .mcard-toggle-btn {
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Couleurs par client - TOUTES en bleu Québec métallique */
/* Texte blanc avec bordure noire sur tous les éléments */

/* VERMEIREN - Bleu Québec, texte vert */
.mcard.client-vermeiren {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.client-vermeiren .mcard-btn-move,
.mcard.client-vermeiren .mcard-btn-fiche,
.mcard.client-vermeiren .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
  color: #ffffff !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}
.mcard.client-vermeiren .mcard-order {
  color: #4ade80 !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* HME - Bleu Québec, texte or */
.mcard.client-hme {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.client-hme .mcard-btn-move,
.mcard.client-hme .mcard-btn-fiche,
.mcard.client-hme .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
  color: #ffffff !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}
.mcard.client-hme .mcard-order {
  color: #E8B97A !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* FRANCE - Bleu Québec, texte jaune */
.mcard.client-france {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.client-france .mcard-btn-move,
.mcard.client-france .mcard-btn-fiche,
.mcard.client-france .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
  color: #ffffff !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}
.mcard.client-france .mcard-order {
  color: #facc15 !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* CUBRO - Bleu Québec, texte cyan */
.mcard.client-cubro {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.client-cubro .mcard-btn-move,
.mcard.client-cubro .mcard-btn-fiche,
.mcard.client-cubro .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
  color: #ffffff !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}
.mcard.client-cubro .mcard-order {
  color: #67e8f9 !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* C1SOUTH - Bleu Québec, texte mauve */
.mcard.client-c1south {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.client-c1south .mcard-btn-move,
.mcard.client-c1south .mcard-btn-fiche,
.mcard.client-c1south .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
  color: #ffffff !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}
.mcard.client-c1south .mcard-order {
  color: #a78bfa !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* Couleurs de réserve pour futures régions */
.mcard.region-extra1 {
  background: linear-gradient(to bottom, #1a0a1a 0%, #351535 30%, #b06ab0 100%);
}
.mcard.region-extra2 {
  background: linear-gradient(to bottom, #1a0a0a 0%, #351515 30%, #bf6a6a 100%);
}

/* Header carte: info gauche, bouton fiche droite */
.mcard-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 1px;
}

.mcard-info {
  width: 100%;
  text-align: center;
}

.mcard-title-line {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mcard-title {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 2px;
  cursor: text;
  border: none;
  background: transparent;
  padding: 0;
  width: 100%;
  outline: none;
  font-family: inherit;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

/* Titre Ontario texte noir */
.mcard-title:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

.mcard-order-line {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #fff;
  position: relative;
  width: 100%;
  height: 22px;
}

/* Pastille région (Québec, Ontario, Maritime) - ancien style */
.mcard-region-pill {
  position: absolute;
  left: 2px;
  background: rgba(255,255,255,0.25);
  color: #fff;
  font-size: 6px;
  font-weight: 700;
  padding: 2px 4px;
  border-radius: 3px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  text-align: center;
  line-height: 1.1;
}

/* Nouvelle pastille région en haut à droite du titre */
.mcard-region-pill-top {
  background: rgba(255,255,255,0.25);
  color: #fff;
  font-size: 6px;
  font-weight: 700;
  padding: 1px 4px;
  border-radius: 3px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  text-align: center;
  line-height: 1.1;
  flex-shrink: 0;
  margin-left: auto;
}

/* Petit bouton priorité à gauche du numéro de commande */
.mcard-btn-priority-small {
  position: absolute;
  left: 3px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: 1px solid transparent;
  border-radius: 999px;
  padding: 3px 6px;
  font-size: 8px;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
  width: 28px;
  height: 16px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  pointer-events: auto;
}

.mcard-btn-priority-small:hover {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  transform: translateY(-50%) scale(1.05);
  border: 1px solid rgba(0,0,0,0.5);
}

/* Quand une priorité est active, le bouton devient visible et coloré */
.mcard.priority .mcard-btn-priority-small {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  border: 1px solid rgba(0,0,0,0.5);
}

/* Pastille région Ontario - texte blanc avec bordure noire */
.mcard.region-on .mcard-region-pill {
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-order {
  cursor: text;
  border: none;
  background: transparent;
  color: #fff;
  font-size: 15px;
  font-family: inherit;
  font-weight: 600;
  padding: 0;
  width: 65px;
  outline: none;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  text-align: center;
}

.mcard-order:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

/* Bouton toggle (ouvre fiche) - IDENTIQUE au bouton étoile */
.mcard-toggle-btn {
  position: absolute;
  right: 3px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: 1px solid transparent;
  border-radius: 999px;
  padding: 3px 6px;
  font-size: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
  width: 28px;
  height: 16px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  pointer-events: auto;
  color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  background: linear-gradient(to bottom, #6b7fa8, #4a5a7a);
  border: 1px solid rgba(0,0,0,0.5);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

.mcard-toggle-btn:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.2);
}

/* Bouton fiche des COMMANDES (pas de bouton étoile, donc peut être plus large) */
#commandesBoard .mcard-toggle-btn {
  width: auto;
  min-width: 28px;
  padding: 3px 8px;
}

/* Bouton fiche par région - couleurs métalliques */
.mcard.region-qc .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-toggle-btn {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-toggle-btn {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Pastille délai - pleine largeur avec coins arrondis */
.mcard-delay-pill {
  width: 100%;
  padding: 1px 4px;
  font-size: 8px;
  font-weight: 700;
  border-radius: 999px;
  background: linear-gradient(to bottom, #4a6fa5, #2d4a6f);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #000;
  margin-top: 0px;
  margin-bottom: 2px;
  box-sizing: border-box;
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Pastille délai par région - couleurs métalliques */
.mcard.region-qc .mcard-delay-pill {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-delay-pill {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-delay-pill {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Séparateur entre haut et bas de la carte */
.mcard-separator {
  height: 1px;
  background: rgba(255,255,255,0.25);
  margin: 1px -8px 1px -8px;
}

.mcard-delay-pill.delay-warning {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
}

.mcard-delay-pill.delay-danger {
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
}

.mcard-delay-pill.retard {
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
  animation: pulse-retard 1s infinite;
}

/* Pastille délai colorée - VERT (plus de 10 jours) */
.mcard-delay-pill.delai-vert {
  background: linear-gradient(to bottom, #22c55e, #15803d) !important;
  color: white !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* Pastille délai colorée - JAUNE (4-10 jours) */
.mcard-delay-pill.delai-jaune {
  background: linear-gradient(to bottom, #facc15, #d97706) !important;
  color: #000 !important;
  text-shadow: none !important;
}

/* Pastille délai colorée - ROUGE (1-3 jours) */
.mcard-delay-pill.delai-rouge {
  background: linear-gradient(to bottom, #ef4444, #dc2626) !important;
  color: white !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}

/* Pastille délai colorée - RETARD (clignotant) */
.mcard-delay-pill.delai-retard {
  background: linear-gradient(to bottom, #dc2626, #7f1d1d) !important;
  color: white !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
  animation: pulse-retard-delai 0.8s infinite !important;
}

@keyframes pulse-retard-delai {
  0%, 100% { 
    background: linear-gradient(to bottom, #dc2626, #7f1d1d);
    box-shadow: 0 0 4px #dc2626;
  }
  50% { 
    background: linear-gradient(to bottom, #ef4444, #dc2626);
    box-shadow: 0 0 8px #ef4444;
  }
}

@keyframes pulse-retard {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* En colonne En attente: pastille devient rouge avec "?" cliquable */
.mcard.in-attente-column .mcard-delay-pill {
  background: linear-gradient(to bottom, #dc2626, #b91c1c);
  cursor: pointer;
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard.in-attente-column .mcard-delay-pill:hover {
  filter: brightness(1.1);
}

/* Clignotement rouge quand une raison est sélectionnée */
.mcard.in-attente-column .mcard-delay-pill.attente-active {
  animation: blinkRed 0.8s infinite;
  background: #dc2626;
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

@keyframes blinkRed {
  0%, 49% { 
    background: #dc2626;
    box-shadow: none;
  }
  50%, 100% { 
    background: #ff0000;
    box-shadow: 0 0 4px #ff0000, 0 0 8px #ff0000;
  }
}

/* En colonne Expédition: pastille garde couleur région mais cliquable */
.mcard.in-expedition-column .mcard-delay-pill {
  cursor: pointer;
}

.mcard.in-expedition-column .mcard-delay-pill:hover {
  filter: brightness(1.1);
}

/* Une fois expédié: même couleur que délai mais avec texte "Expédié" */
.mcard .mcard-delay-pill.expedie {
  cursor: default !important;
  animation: none !important;
}

/* Expédié garde exactement la couleur de la région */
.mcard.region-qc .mcard-delay-pill.expedie {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
}
.mcard.region-on .mcard-delay-pill.expedie {
  background: linear-gradient(to bottom, #E8B97A, #704414) !important;
  color: #ffffff !important;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000 !important;
}
.mcard.region-ma .mcard-delay-pill.expedie {
  background: linear-gradient(to bottom, #C7458C, #451238) !important;
}

/* Boutons carte - pleine largeur avec coins arrondis */
.mcard-footer-buttons {
  display: flex;
  gap: 4px;
  margin-top: 1px;
}

.mcard-btn {
  flex: 1;
  padding: 1px 4px;
  font-size: 8px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid #000;
  cursor: pointer;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
  line-height: 1;
  white-space: nowrap;
}

.mcard-btn:hover {
  filter: brightness(1.1);
}

.mcard-btn-move {
  background: linear-gradient(to bottom, #1e3a5f, #0f2744);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Bouton déplacer par région - couleurs métalliques */
.mcard.region-qc .mcard-btn-move {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-btn-move {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-btn-move {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-btn-delete {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-btn-priority {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  font-size: 10px;
}

/* ===== MENU DE DÉPLACEMENT ===== */
.move-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.move-overlay.hidden {
  display: none;
}

/* Menu de confirmation (suppression, etc.) */
.move-menu {
  background: linear-gradient(to bottom, #1a1a2e, #16213e);
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.3);
  box-shadow: 0 8px 32px rgba(0,0,0,0.85);
  padding: 20px;
  min-width: 280px;
  max-width: 350px;
  text-align: center;
}

.move-menu-title {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 10px;
}

.move-menu-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.move-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 10px;
  max-width: 95%;
  width: 750px;
  box-sizing: border-box;
}

.move-title {
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.move-columns {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.move-column {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.move-column-header {
  background: linear-gradient(to bottom, #2b5b99, #103561);
  border-radius: 6px;
  padding: 4px 2px;
  text-align: center;
  font-weight: 700;
  font-size: 7px;
  color: #ffffff;
  border: 1px solid rgba(0,0,0,0.5);
}

.move-column-header.current {
  background: linear-gradient(to bottom, #059669, #047857);
}

.move-positions {
  display: flex;
  flex-direction: column;
  gap: 2px;
  max-height: 200px;
  overflow-y: auto;
}

.move-position-btn {
  background: linear-gradient(to bottom, #233d63, #12243f);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 4px;
  padding: 3px 2px;
  text-align: center;
  font-weight: 600;
  font-size: 8px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.15s;
}

.move-position-btn:hover {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  border-color: #3b82f6;
}

.move-footer {
  display: flex;
  justify-content: center;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.move-btn-close {
  padding: 5px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  cursor: pointer;
  font-weight: 600;
  font-size: 10px;
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Menu déplacement commandes - 6 colonnes */
.move-columns-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 6px;
  margin-bottom: 10px;
}

.move-col {
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 6px;
}

.move-col.current-col {
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid #10b981;
}

.move-col-header {
  text-align: center;
  font-size: 9px;
  font-weight: 700;
  color: #fff;
  padding: 4px;
  background: linear-gradient(to bottom, #2b5b99, #103561);
  border-radius: 6px;
}

.move-col.current-col .move-col-header {
  background: linear-gradient(to bottom, #059669, #047857);
}

.move-col-count {
  text-align: center;
  font-size: 8px;
  color: rgba(255,255,255,0.7);
}

.move-col-positions {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  justify-content: center;
}

.move-pos-btn {
  width: 22px;
  height: 22px;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(to bottom, #233d63, #12243f);
  color: #fff;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
}

.move-pos-btn:hover {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
}

.move-pos-btn.current {
  background: linear-gradient(to bottom, #10b981, #059669);
  cursor: default;
}

/* Menu déplacement simple - rangs seulement */
.move-panel-simple {
  background: linear-gradient(to bottom, #1a3a5c, #0f2544);
  border-radius: 12px;
  padding: 15px 20px;
  min-width: 250px;
  max-width: 350px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  border: 2px solid #3b82f6;
}

.move-panel-simple .move-title {
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  text-align: center;
  margin-bottom: 5px;
}

.move-panel-simple .move-subtitle {
  font-size: 10px;
  color: rgba(255,255,255,0.7);
  text-align: center;
  margin-bottom: 15px;
}

.move-rangs-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 15px;
}

.move-rang-btn {
  width: 100%;
  padding: 10px 15px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(to bottom, #233d63, #12243f);
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.move-rang-btn:hover:not(:disabled) {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  border-color: #60a5fa;
  transform: translateX(5px);
}

.move-rang-btn.current {
  background: linear-gradient(to bottom, #10b981, #059669);
  border-color: #34d399;
  cursor: default;
}

.move-rang-btn:disabled {
  opacity: 0.7;
}

.move-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
}
  display: flex;
  justify-content: center;
  gap: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.move-delete-btn {
  padding: 6px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: #fff;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
}

.move-cancel-btn {
  padding: 6px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: #fff;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
}

.move-btn-close:hover {
  filter: brightness(1.1);
}

/* ===== CONFIRMATION SUPPRESSION ===== */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.confirm-overlay.hidden {
  display: none;
}

.confirm-panel {
  background: linear-gradient(to bottom, #1a1a2e, #16213e);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 20px;
  text-align: center;
  max-width: 300px;
}

.confirm-title {
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.confirm-message {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
  margin-bottom: 16px;
}

.confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.confirm-btn {
  padding: 8px 20px;
  border-radius: 999px;
  border: none;
  font-weight: 600;
  font-size: 11px;
  cursor: pointer;
  color: #fff;
}

.confirm-btn-yes {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.confirm-btn-no {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
}

.confirm-btn:hover {
  filter: brightness(1.1);
}

/* ===== VUE HORIZONTALE ROBOT ===== */
.robot-horizontal-container {
  flex: 1;
  width: 100%;
  padding: 15px;
  box-sizing: border-box;
  background: linear-gradient(to bottom, #1a3a5c, #4a7ab8);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.robot-horizontal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #04152c, #325f9b);
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
}

.robot-horizontal-header h2 {
  color: #fff;
  margin: 0;
  font-size: 18px;
}

.robot-horizontal-scroll {
  flex: 1;
  overflow: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
}

.robot-horizontal-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.robot-horizontal-table thead {
  position: sticky;
  top: 0;
  z-index: 100;
}

.robot-horizontal-table th {
  position: relative;
  background: linear-gradient(to bottom, #325f9b, #04152c);
  color: white;
  padding: 8px 6px;
  text-align: center;
  font-weight: 700;
  font-size: 10px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  white-space: nowrap;
  min-width: 80px;
  user-select: none;
}

.resize-handle {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 4px;
  cursor: col-resize;
  background: rgba(255, 255, 255, 0.1);
}

.resize-handle:hover {
  background: rgba(255, 255, 255, 0.3);
}

.robot-horizontal-table td {
  padding: 6px;
  border: 1px solid #e5e7eb;
  font-size: 10px;
  color: #1f2937;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
}

.robot-horizontal-table td.editable {
  cursor: text;
  background: white;
}

.robot-horizontal-table td.editable:hover {
  background: #f3f4f6;
}

.robot-horizontal-table td.editable:focus {
  outline: 2px solid #3b82f6;
  background: #dbeafe;
}

.robot-horizontal-table tbody tr:nth-child(even) {
  background: #f9fafb;
}

.robot-horizontal-table tbody tr:hover {
  background: #dbeafe;
}

.robot-cell-column {
  background: #93c5fd !important;
  text-align: center;
  font-weight: 700;
  color: #1e3a8a;
}

/* Bouton Rang Robot dans la table */
.rang-robot-cell {
  text-align: center;
}

.rang-robot-btn {
  padding: 4px 8px;
  font-size: 9px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}

.rang-robot-btn:hover {
  background: linear-gradient(to bottom, #60a5fa, #3b82f6);
}

/* Menus déroulants dans la table */
.table-select {
  width: 100%;
  padding: 2px 4px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: white;
  cursor: pointer;
  text-align: center;
  text-align-last: center;
}

.table-select:focus {
  outline: 2px solid #3b82f6;
  border-color: #3b82f6;
}

.table-select-cell {
  padding: 2px !important;
  text-align: center;
}

/* Cellule priorité dans la vue horizontale */
.priority-cell .priority-select {
  font-weight: 600;
  min-width: 100px;
}

/* Cellule notes */
.notes-cell {
  text-align: center;
  padding: 2px !important;
}

.notes-btn {
  padding: 4px 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: #f3f4f6;
  cursor: pointer;
}

.notes-btn:hover {
  background: #e5e7eb;
}

.notes-btn.has-notes {
  background: linear-gradient(to bottom, #fbbf24, #f59e0b);
  color: white;
  border-color: #d97706;
  animation: blink-notes 1s infinite;
}

@keyframes blink-notes {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Popup de notes */
.notes-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

/* Overlay Notes Moulage */
.moulage-notes-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 25000;
}

.moulage-notes-popup {
  background: white;
  border-radius: 10px;
  width: 450px;
  max-width: 95vw;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.moulage-notes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  color: white;
  border-radius: 10px 10px 0 0;
}

.moulage-notes-header h3 {
  margin: 0;
  font-size: 14px;
}

.moulage-notes-header button {
  padding: 4px 12px;
  font-size: 11px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 4px;
  cursor: pointer;
}

.moulage-notes-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
}

.existing-notes {
  background: #fffbeb;
  border: 1px solid #fcd34d;
  border-radius: 6px;
  padding: 8px;
  min-height: 80px;
  max-height: 200px;
  overflow-y: auto;
  font-size: 11px;
  margin-bottom: 12px;
}

.existing-notes .note-entry {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #e5e7eb;
}

.existing-notes .note-entry:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.existing-notes .note-signature {
  font-weight: 700;
  color: #1e40af;
  font-size: 10px;
}

.existing-notes .note-text {
  margin-top: 4px;
  color: #374151;
}

.new-note-section {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 6px;
  padding: 8px;
}

.note-signature-line {
  font-size: 10px;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 6px;
}

.new-note-section textarea {
  width: 100%;
  height: 60px;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
}

.moulage-notes-footer {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 12px;
  background: #f1f5f9;
  border-radius: 0 0 10px 10px;
}

.btn-save-note {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.btn-close-note {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.notes-popup {
  background: white;
  border-radius: 12px;
  padding: 16px;
  width: 400px;
  max-width: 90vw;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.notes-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.notes-popup-header h4 {
  margin: 0;
  font-size: 14px;
  color: #1f2937;
}

.notes-popup-close {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #6b7280;
}

.notes-popup-close:hover {
  color: #ef4444;
}

.notes-popup-text {
  width: 100%;
  height: 200px;
  padding: 10px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  resize: vertical;
  font-family: inherit;
}

.notes-popup-text:focus {
  outline: 2px solid #3b82f6;
  border-color: #3b82f6;
}

.notes-popup-buttons {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: flex-end;
}

.notes-popup-save {
  padding: 8px 16px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.notes-popup-save:hover {
  background: #059669;
}

.notes-popup-cancel {
  padding: 8px 16px;
  background: #6b7280;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.notes-popup-cancel:hover {
  background: #4b5563;
}

/* Calendrier popup pour la table */
.table-calendar-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.table-calendar-popup {
  background: white;
  border-radius: 12px;
  padding: 16px;
  width: 280px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.table-calendar-header {
  text-align: center;
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 12px;
  color: #1f2937;
}

.table-cal-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.table-cal-nav button {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 10px;
  cursor: pointer;
}

.table-cal-nav button:hover {
  background: #2563eb;
}

.table-cal-month {
  font-weight: 600;
  font-size: 13px;
}

.table-cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 4px;
}

.table-cal-weekday {
  text-align: center;
  font-size: 10px;
  font-weight: 600;
  color: #6b7280;
  padding: 4px;
}

.table-cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.table-cal-day {
  text-align: center;
  padding: 6px;
  font-size: 11px;
  border-radius: 4px;
  cursor: pointer;
  background: #f3f4f6;
}

.table-cal-day:hover {
  background: #dbeafe;
}

.table-cal-day.today {
  background: #3b82f6;
  color: white;
  font-weight: 600;
}

.table-cal-day.selected {
  background: #10b981;
  color: white;
}

.table-cal-day.empty {
  background: transparent;
  cursor: default;
}

.table-cal-buttons {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: center;
}

.table-cal-buttons button {
  padding: 6px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
}

.table-cal-today {
  background: #3b82f6;
  color: white;
}

.table-cal-clear {
  background: #ef4444;
  color: white;
}

.table-cal-close {
  background: #6b7280;
  color: white;
}

/* Cellules de date cliquables dans la table */
.date-cell {
  cursor: pointer;
  text-align: center;
  background: #ffffff !important;
}

.date-cell:hover {
  background: #f3f4f6 !important;
}

/* ===== FICHE MOULAGE (popup centré) ===== */
.card-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

.card-overlay.active {
  display: block;
}

.mcard.mcard-expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  width: 1050px;
  height: 90vh;
  max-height: 90vh;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  overflow: hidden;
  display: flex;
  text-shadow: none !important;
}

/* Reset text-shadow pour tout le contenu de la fiche */
.mcard.mcard-expanded *,
.mcard.mcard-expanded input,
.mcard.mcard-expanded select,
.mcard.mcard-expanded label,
.mcard.mcard-expanded span,
.mcard.mcard-expanded div {
  text-shadow: none !important;
}

/* Responsive pour mobile */
@media (max-width: 1100px) {
  .mcard.mcard-expanded {
    width: 95vw;
    flex-direction: column;
    max-height: 85vh;
    overflow-y: auto;
  }
  
  .mcard.mcard-expanded .mcard-fiche {
    width: 100% !important;
    border-right: none !important;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .mcard.mcard-expanded .mcard-notes-page {
    width: 100% !important;
    min-height: 250px;
  }
}

.mcard.mcard-expanded .mcard-header,
.mcard.mcard-expanded .mcard-top-right,
.mcard.mcard-expanded .mcard-delay-pill,
.mcard.mcard-expanded .mcard-footer-buttons {
  display: none !important;
}

.mcard.mcard-expanded .mcard-toggle-btn {
  display: flex !important;
  background: linear-gradient(to bottom, #ff4444, #cc0000);
  position: absolute;
  top: 8px;
  right: 8px;
  bottom: auto;
  width: 20px;
  height: 20px;
  z-index: 10;
}

/* ===== SIDEBAR TRACKING À GAUCHE ===== */
.mcard-tracking-sidebar {
  display: none;
  width: 140px;
  flex-shrink: 0;
  background: #ffffff;
  border-right: 2px solid #e2e8f0;
  padding: 10px 8px;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-tracking-sidebar {
  display: flex;
}

.tracking-sidebar-title {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
}

.tracking-dept-list {
  display: flex;
  flex-direction: column;
  gap: 5px;
  flex: 1;
  justify-content: space-between;
}

.tracking-dept-list-expanded {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
  overflow-y: auto;
}

/* Nouvelles pastilles compactes pour tracking */
.tracking-pills-container {
  display: flex;
  flex-direction: column;
  gap: 3px;
  flex: 1;
  overflow: hidden;
}

.tracking-dept-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 8px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  flex: 1;
}

.tracking-dept-pill:hover {
  background: #eff6ff;
  border-color: #3b82f6;
}

.tracking-dept-pill.active {
  background: linear-gradient(to right, #dbeafe, #eff6ff);
  border-color: #3b82f6;
  border-width: 2px;
}

.tracking-dept-pill.completed {
  background: linear-gradient(to right, #dcfce7, #f0fdf4);
  border-color: #22c55e;
}

.tracking-pill-icon {
  font-size: 14px;
}

.tracking-pill-name {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  flex: 1;
}

.tracking-pill-jours {
  font-size: 15px;
  font-weight: 800;
  color: #1e40af;
  min-width: 32px;
  text-align: center;
}

.tracking-dept-pill.completed .tracking-pill-jours {
  color: #16a34a;
}

.tracking-dept-pill.active .tracking-pill-jours {
  color: #2563eb;
}

/* Menu dates tracking */
.tracking-dates-menu {
  position: fixed;
  background: white;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  z-index: 20000;
  min-width: 200px;
  overflow: hidden;
}

.tracking-menu-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
}

.tracking-menu-row {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  border-bottom: 1px solid #e5e7eb;
}

.tracking-menu-label {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  width: 60px;
}

.tracking-menu-date {
  flex: 1;
  font-size: 12px;
  color: #2563eb;
  cursor: pointer;
  padding: 6px 10px;
  background: #eff6ff;
  border-radius: 4px;
  text-align: center;
}

.tracking-menu-date:hover {
  background: #dbeafe;
}

.tracking-menu-footer {
  padding: 10px;
  text-align: center;
}

.tracking-menu-footer button {
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.tracking-dept-item-expanded {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 4px 6px;
}

.tracking-dept-item-expanded.active {
  background: linear-gradient(to bottom, #dbeafe, #eff6ff);
  border-color: #3b82f6;
}

.tracking-dept-item-expanded.completed {
  background: linear-gradient(to bottom, #dcfce7, #f0fdf4);
  border-color: #22c55e;
}

.tracking-dept-header {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 3px;
}

.tracking-dept-icon {
  font-size: 10px;
}

.tracking-dept-label {
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  flex: 1;
}

.tracking-dept-jours {
  font-size: 12px;
  font-weight: 800;
  color: #1e40af;
}

.tracking-dept-item-expanded.completed .tracking-dept-jours {
  color: #16a34a;
}

.tracking-dept-item-expanded.active .tracking-dept-jours {
  color: #2563eb;
}

.tracking-dept-dates {
  display: flex;
  gap: 3px;
}

.tracking-dept-dates-text {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  margin-top: 2px;
}

.tracking-date-clickable {
  font-size: 10px;
  font-weight: 600;
  color: #2563eb;
  cursor: pointer;
  padding: 2px 6px;
  background: #eff6ff;
  border-radius: 3px;
  transition: all 0.2s;
}

.tracking-date-clickable:hover {
  background: #dbeafe;
  color: #1d4ed8;
}

.tracking-date-separator {
  font-size: 9px;
  color: #9ca3af;
}

/* Calendrier popup pour tracking */
.tracking-cal-popup {
  position: fixed;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 3000;
  width: 200px;
  padding: 8px;
}

.tracking-cal-header {
  text-align: center;
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
  margin-bottom: 6px;
}

.tracking-cal-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.tracking-cal-nav button {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 10px;
}

.tracking-cal-nav span {
  font-size: 10px;
  font-weight: 600;
}

.tracking-cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-size: 8px;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 4px;
}

.tracking-cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.tracking-cal-day {
  text-align: center;
  font-size: 10px;
  padding: 4px 2px;
  cursor: pointer;
  border-radius: 3px;
}

.tracking-cal-day:hover {
  background: #dbeafe;
}

.tracking-cal-day.empty {
  cursor: default;
}

.tracking-cal-day.today {
  background: #fef3c7;
  font-weight: 700;
}

.tracking-cal-day.selected {
  background: #3b82f6;
  color: white;
  font-weight: 700;
}

.tracking-cal-btns {
  display: flex;
  gap: 4px;
  margin-top: 8px;
}

.tracking-cal-btns button {
  flex: 1;
  padding: 4px;
  font-size: 8px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  background: #e5e7eb;
}

.tracking-cal-btns button:first-child {
  background: #22c55e;
  color: white;
}

.tracking-cal-btns button:nth-child(2) {
  background: #ef4444;
  color: white;
}

.tracking-date-input {
  flex: 1;
  padding: 2px 3px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  background: white;
  text-align: center;
  min-width: 0;
}

.tracking-date-input:focus {
  outline: none;
  border-color: #3b82f6;
}

.tracking-dept-item {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 8px 8px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
  min-height: 0;
}

.tracking-dept-item:hover {
  background: #eff6ff;
  border-color: #3b82f6;
}

.tracking-dept-item.active {
  background: linear-gradient(to right, #dbeafe, #eff6ff);
  border-color: #3b82f6;
  border-width: 2px;
}

.tracking-dept-item.completed {
  background: linear-gradient(to right, #dcfce7, #f0fdf4);
  border-color: #22c55e;
}

.tracking-dept-name {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tracking-dept-days {
  font-size: 16px;
  font-weight: 800;
  color: #1e40af;
  min-width: 30px;
  text-align: right;
}

.tracking-dept-item.completed .tracking-dept-days {
  color: #16a34a;
}

.tracking-dept-item.active .tracking-dept-days {
  color: #2563eb;
  animation: pulse-days 1.5s infinite;
}

@keyframes pulse-days {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.tracking-total-box {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 2px solid #e2e8f0;
}

.tracking-total-label {
  font-size: 9px;
  color: #64748b;
  text-align: center;
  text-transform: uppercase;
  font-weight: 600;
}

.tracking-total-value {
  font-size: 24px;
  font-weight: 800;
  color: #1e40af;
  text-align: center;
}

/* Popup édition tracking */
.tracking-edit-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  display: none;
}

.tracking-edit-overlay.active {
  display: block;
}

.tracking-edit-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  z-index: 2001;
  width: 320px;
  display: none;
}

.tracking-edit-popup.active {
  display: block;
}

.tracking-edit-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 12px 16px;
  border-radius: 12px 12px 0 0;
  font-weight: 700;
  text-align: center;
}

.tracking-edit-body {
  padding: 16px;
}

.tracking-edit-field {
  margin-bottom: 12px;
}

.tracking-edit-field label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 4px;
}

.tracking-edit-field input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 13px;
  box-sizing: border-box;
}

.tracking-edit-btns {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.tracking-edit-btns button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}

.tracking-edit-btns .btn-save {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.tracking-edit-btns .btn-clear {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
}

.tracking-edit-btns .btn-close {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Bouton X fermer dans notes */
.notes-close-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.notes-close-btn:hover {
  background: linear-gradient(to bottom, #f87171, #ef4444);
  transform: scale(1.1);
}

/* Photos en bas de la fiche */
.fiche-photos-section.fiche-photos-bottom {
  position: absolute;
  bottom: 8px;
  left: 10px;
  right: 10px;
  margin: 0;
}

/* Contenu fiche - Page gauche */
.mcard-fiche {
  display: none;
  padding: 12px 14px;
  padding-bottom: 55px;
  width: 420px;
  flex-shrink: 0;
  border-right: 1px solid #e2e8f0;
  overflow-y: hidden;
  overflow-x: hidden;
  position: relative;
  box-sizing: border-box;
}

.mcard.mcard-expanded .mcard-fiche {
  display: block;
}

/* Page Notes - Page droite */
.mcard-notes-page {
  display: none;
  flex: 1;
  min-width: 450px;
  padding: 12px;
  background: #f8fafc;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-notes-page {
  display: flex;
}

.mcard-notes-page .notes-page-header {
  font-size: 13px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
  flex-shrink: 0;
  text-align: center;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* 6 boutons photos sur une ligne */
.notes-photos-row {
  display: flex;
  gap: 4px;
  margin-bottom: 10px;
  flex-shrink: 0;
}

.notes-photo-btn {
  flex: 1;
  padding: 5px 2px;
  font-size: 8px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.notes-photo-btn:hover {
  background: #f3f4f6;
}

.notes-photo-btn.has-link {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border-color: #15803d;
}

.mcard-notes-page .notes-page-textarea {
  flex: 1;
  width: 100%;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.2;
  background: white;
}

/* Zone de liens photos */
.notes-photos-links {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  margin-bottom: 8px;
}

.photo-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.photo-link-row label {
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  width: 50px;
}

.photo-link-row input {
  flex: 1;
  padding: 4px 6px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.save-photos-btn {
  margin-top: 6px;
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}

.save-photos-btn:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

.fiche-header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 15px;
  margin-bottom: 6px;
  padding-bottom: 4px;
  border-bottom: 1px solid #e2e8f0;
}

.fiche-header .fiche-logo img {
  height: 35px;
}

.fiche-header .fiche-title {
  text-align: center;
  flex: 1;
}

.fiche-header .fiche-title h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 700;
  color: #0f172a;
}

/* Bouton Priorité dans le header de la fiche */
.fiche-priority-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  color: #fff;
  font-size: 11px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.2s;
  border: none;
}

.fiche-priority-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

.fiche-priority-emoji {
  font-size: 12px;
}

.fiche-priority-text {
  text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
}

/* Menu déroulant priorité dans la fiche */
.fiche-priority-menu {
  position: absolute;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  z-index: 10001;
  min-width: 180px;
  overflow: hidden;
}

.fiche-priority-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 12px;
  color: #333;
  transition: background 0.2s;
  border-bottom: 1px solid #f1f5f9;
}

.fiche-priority-menu-item:last-child {
  border-bottom: none;
}

.fiche-priority-menu-item:hover {
  background: #f1f5f9;
}

.fiche-priority-menu-item.selected {
  background: #e0f2fe;
  font-weight: 600;
}

.fiche-priority-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  color: #fff;
  font-weight: bold;
}

.fiche-header .fiche-subtitle {
  font-size: 10px;
  color: #64748b;
}

.fiche-section {
  margin-bottom: 6px;
}

.fiche-section h4 {
  margin: 0 0 4px;
  font-size: 9px;
  font-weight: 700;
  color: #0f172a;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 2px;
}

.fiche-grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
}

.fiche-grid-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 4px;
}

.fiche-field {
  display: flex;
  flex-direction: column;
}

.fiche-label {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 2px;
  text-align: center;
}

.add-remove-btns {
  display: inline-flex;
  gap: 2px;
  margin-left: 4px;
}

.add-remove-btns span {
  cursor: pointer;
  font-size: 9px;
  opacity: 0.6;
  transition: opacity 0.2s;
}

.add-remove-btns span:hover {
  opacity: 1;
}

.fiche-rang-robot-btn {
  width: 100%;
  padding: 6px 10px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.fiche-rang-robot-btn:hover {
  background: linear-gradient(to bottom, #60a5fa, #3b82f6);
}

.fiche-input, .fiche-select {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  font-weight: 500;
  color: #1f2937;
  background: #fff;
  box-sizing: border-box;
  text-align: center;
}

.fiche-input:focus, .fiche-select:focus {
  outline: none;
  border-color: #3b82f6;
}

/* Pastille date cliquable */
.fiche-date-pill {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1f2937;
  font-weight: 500;
  cursor: pointer;
  box-sizing: border-box;
}

.fiche-date-pill:hover {
  background: #f9fafb;
  border-color: #9ca3af;
}

/* Calendrier popup visuel */
.fiche-calendar-popup {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  padding: 12px;
  z-index: 2000;
  min-width: 260px;
}

.fiche-calendar-popup.active {
  display: block;
}

.fiche-calendar-popup .cal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid #e2e8f0;
}

.fiche-calendar-popup .cal-title {
  font-size: 11px;
  font-weight: 700;
  color: #1e3a5f;
}

.fiche-calendar-popup .cal-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}

.fiche-calendar-popup .cal-nav button {
  width: 24px;
  height: 24px;
  border: none;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
}

.fiche-calendar-popup .cal-month-year {
  font-size: 11px;
  font-weight: 600;
  color: #1e3a5f;
  min-width: 100px;
  text-align: center;
}

.fiche-calendar-popup .cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 4px;
}

.fiche-calendar-popup .cal-weekday {
  text-align: center;
  font-size: 8px;
  font-weight: 700;
  color: #64748b;
  padding: 4px 0;
}

.fiche-calendar-popup .cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.fiche-calendar-popup .cal-day {
  width: 32px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  border: none;
  background: #f8fafc;
  border-radius: 4px;
  cursor: pointer;
  color: #334155;
}

.fiche-calendar-popup .cal-day:hover {
  background: #dbeafe;
}

.fiche-calendar-popup .cal-day.other-month {
  color: #cbd5e1;
  background: transparent;
}

.fiche-calendar-popup .cal-day.today {
  background: #fef3c7;
  font-weight: 700;
  border: 1px solid #f59e0b;
}

.fiche-calendar-popup .cal-day.selected {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  font-weight: 700;
}

.fiche-calendar-popup .cal-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #e2e8f0;
}

.fiche-calendar-popup .cal-buttons button {
  padding: 6px 14px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.btn-today {
  background: linear-gradient(to bottom, #10b981, #059669);
  color: white;
}

.btn-close-cal {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Durées département */
.fiche-durations-photos {
  display: grid;
  grid-template-columns: 1fr 1px 1fr;
  gap: 6px;
  margin-top: 6px;
}

.fiche-center-bar {
  background: #e2e8f0;
}

.fiche-durations table {
  width: 100%;
  border-collapse: collapse;
  font-size: 8px;
}

.fiche-durations th, .fiche-durations td {
  padding: 3px 4px;
  border-bottom: 1px solid #f1f5f9;
}

.fiche-durations th {
  text-align: left;
  background: #f8fafc;
  font-weight: 600;
}

.dept-row {
  cursor: pointer;
}

.dept-row:hover {
  background: #f1f5f9;
}

/* Date cliquable sans pastille */
.dept-date-link {
  color: #1e40af;
  font-weight: 500;
  cursor: pointer;
  font-size: 8px;
}

.dept-date-link:hover {
  text-decoration: underline;
}

/* Jours passés */
.dept-days {
  font-weight: 600;
  color: #334155;
  font-size: 8px;
}

/* Popup dates département */
.dept-dates-popup {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  padding: 15px;
  z-index: 2000;
  min-width: 280px;
}

.dept-dates-popup.active {
  display: block;
}

.dept-dates-popup h4 {
  margin: 0 0 12px;
  font-size: 12px;
  font-weight: 700;
  text-align: center;
  color: #1e3a5f;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 8px;
}

.dept-date-field {
  margin-bottom: 10px;
}

.dept-date-field label {
  display: block;
  font-size: 10px;
  font-weight: 600;
  color: #1e3a5f;
  margin-bottom: 4px;
}

.dept-date-field input {
  width: 100%;
  padding: 6px;
  font-size: 10px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  box-sizing: border-box;
}

.dept-popup-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 10px;
}

.dept-popup-buttons button {
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-save {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
}

.btn-cancel {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Mini calendriers dans popup département */
.dept-cal-container {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  margin-top: 4px;
}

.mini-cal-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.mini-cal-btn {
  width: 22px;
  height: 22px;
  border: none;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
}

.mini-cal-title {
  font-size: 10px;
  font-weight: 600;
  color: #1e3a5f;
}

.mini-cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  margin-bottom: 4px;
}

.mini-cal-weekdays span {
  text-align: center;
  font-size: 7px;
  font-weight: 700;
  color: #64748b;
}

.mini-cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.mini-day {
  width: 24px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  background: #fff;
  border-radius: 3px;
  cursor: pointer;
  color: #334155;
}

.mini-day:hover {
  background: #dbeafe;
}

.mini-day.other {
  color: #cbd5e1;
  background: transparent;
  cursor: default;
}

.mini-day.today {
  background: #fef3c7;
  font-weight: 700;
  border: 1px solid #f59e0b;
}

.mini-day.selected {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  font-weight: 700;
}

/* Style ligne total */
.dept-total {
  border-top: 2px solid #94a3b8;
  font-weight: 700;
  background: #f1f5f9;
}

/* Section Durées - Une seule ligne pleine largeur */
.fiche-durations-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to right, #1e3a5f, #2d5a87);
  padding: 4px 6px;
  border-radius: 4px;
  gap: 2px;
}

.dur-item-line {
  font-size: 6px;
  color: white;
  white-space: nowrap;
}

.dur-item-line b {
  color: #fef08a;
  margin-right: 1px;
}

.dur-item-line .dept-date-link {
  color: #93c5fd;
  cursor: pointer;
  text-decoration: underline;
}

.dur-total-line {
  background: #f59e0b;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 700;
}

.dur-total-line b {
  color: white;
}

/* Section Photos - Ligne avec titre et 3 pastilles */
.fiche-photos-line {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 0;
}

.photos-title {
  font-size: 8px;
  font-weight: 700;
  color: #7c3aed;
  cursor: pointer;
  padding: 3px 6px;
  background: #f3e8ff;
  border-radius: 4px;
}

/* ===== SECTION DURÉES - Design horizontal propre ===== */
.fiche-durations-section {
  display: flex;
  align-items: stretch;
  gap: 0;
  margin: 8px 0 6px 0;
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  overflow: hidden;
}

.dur-item {
  flex: 1;
  text-align: center;
  padding: 8px 2px;
  background: white;
  border-right: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0;
}

.dur-item:last-child {
  border-right: none;
}

.dur-item.dur-date {
  flex: 1.4;
}

.dur-item-label {
  font-size: 6px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.2px;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dur-item-value {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  white-space: nowrap;
}

.dur-item-value.clickable {
  font-size: 9px;
  color: #3b82f6;
  cursor: pointer;
  text-decoration: underline;
}

.dur-item-value.clickable:hover {
  color: #1d4ed8;
}

.dur-item.total {
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  flex: 1;
}

.dur-item.total .dur-item-label {
  color: rgba(255,255,255,0.8);
}

.dur-item.total .dur-item-value {
  color: white;
  font-size: 13px;
}

/* ===== SECTION PHOTOS - Plus bas et espacée ===== */
.fiche-photos-section {
  margin: 8px 0 5px 0;
  padding: 8px 10px;
  background: #faf5ff;
  border: 1px solid #e9d5ff;
  border-radius: 8px;
}

.photos-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.photos-label {
  font-size: 11px;
  font-weight: 700;
  color: #7c3aed;
  cursor: pointer;
  white-space: nowrap;
}

.photo-btn {
  flex: 1;
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.photo-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.photo-btn.has-link {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border-color: #15803d;
}

.photo-btn.blink-green-photo {
  animation: blinkGreenPhoto 1s infinite;
}

@keyframes blinkGreenPhoto {
  0%, 100% { 
    background: linear-gradient(to bottom, #22c55e, #16a34a);
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
  }
  50% { 
    background: linear-gradient(to bottom, #4ade80, #22c55e);
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
  }
}

/* Popup Photos menu avec 3 liens */
.photos-menu-popup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border: 2px solid #7c3aed;
  border-radius: 8px;
  padding: 12px;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  width: 280px;
}

.photos-menu-header {
  font-size: 12px;
  font-weight: 700;
  color: #7c3aed;
  text-align: center;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid #e2e8f0;
}

.photos-menu-field {
  margin-bottom: 8px;
}

.photos-menu-field label {
  display: block;
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 2px;
}

.photos-menu-field input {
  width: 100%;
  padding: 6px 8px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  box-sizing: border-box;
}

.photos-menu-btns {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 10px;
}

.photos-menu-btns button {
  padding: 6px 14px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.photos-menu-btns button:first-child {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.photos-menu-btns button:last-child {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Section Notes - Zone expandable */
.fiche-notes-zone {
  position: relative;
}

.fiche-notes-simple {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 6px;
  transition: all 0.3s ease;
}

.fiche-notes-simple:hover {
  background: linear-gradient(to bottom, #4a7dc9, #2a4a70);
}

.notes-text-center {
  font-size: 11px;
  font-weight: 700;
  color: white;
}

.notes-text-center.has-notes {
  animation: blink-notes-text 1s infinite;
}

@keyframes blink-notes-text {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Zone Notes expandée - Couvre TOUTE la fiche */
.fiche-notes-expanded {
  position: absolute;
  top: 45px;
  left: 0;
  right: 0;
  bottom: 35px;
  background: white;
  border: 2px solid #3f6eb8;
  border-radius: 6px;
  z-index: 200;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.fiche-notes-expanded .notes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  flex-shrink: 0;
}

.fiche-notes-expanded .notes-header span {
  font-size: 10px;
  font-weight: 700;
}

.fiche-notes-expanded .notes-header button {
  padding: 4px 12px;
  font-size: 10px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 3px;
  cursor: pointer;
}

.fiche-notes-expanded .notes-body {
  flex: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.fiche-notes-expanded .notes-signature {
  font-size: 10px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 6px;
  flex-shrink: 0;
}

.fiche-notes-expanded textarea {
  flex: 1;
  width: 100%;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.4;
}

.fiche-notes-expanded .notes-history {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px dashed #e2e8f0;
  font-size: 9px;
  color: #374151;
  max-height: 80px;
  overflow-y: auto;
  flex-shrink: 0;
}

.fiche-notes-expanded .note-entry {
  margin-bottom: 6px;
  padding-bottom: 6px;
  border-bottom: 1px dotted #e5e7eb;
}

.fiche-notes-expanded .note-entry:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.fiche-notes-expanded .note-entry .note-signature {
  font-weight: 700;
  color: #1e40af;
  font-size: 8px;
}

.fiche-notes-expanded .note-entry .note-text {
  margin-top: 2px;
  color: #374151;
}

/* Section En attente */
/* ===== SECTION EN ATTENTE - Pastille pleine largeur ===== */
.fiche-attente-section {
  display: none;
  flex-direction: column;
  width: 100%;
  margin: 10px 0;
  box-sizing: border-box;
}

.fiche-attente-section.visible {
  display: flex !important;
}

.attente-badge-full {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  background: #dc2626;
  color: #ffffff;
  padding: 16px 12px;
  border-radius: 6px 6px 0 0;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
  box-sizing: border-box;
  animation: blink-attente 1.5s ease-in-out infinite;
  min-height: 50px;
}

.attente-days-full {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  background: #fee2e2;
  color: #b91c1c;
  padding: 12px 12px;
  border-radius: 0 0 6px 6px;
  font-size: 13px;
  font-weight: 600;
  text-align: center;
  border: 2px solid #dc2626;
  border-top: none;
  box-sizing: border-box;
  min-height: 40px;
}

@keyframes blink-attente {
  0%, 100% { background: #dc2626; }
  50% { background: #ef4444; }
}

.attente-badge-full {
  cursor: pointer;
}

/* Menu raison d'attente */
.raison-attente-menu {
  position: fixed;
  background: white;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  z-index: 25000;
  min-width: 220px;
  max-width: 280px;
  overflow: hidden;
}

.raison-menu-header {
  background: linear-gradient(to bottom, #dc2626, #b91c1c);
  color: white;
  padding: 12px 14px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
}

.raison-options {
  max-height: 200px;
  overflow-y: auto;
}

.raison-option {
  padding: 10px 14px;
  font-size: 11px;
  cursor: pointer;
  border-bottom: 1px solid #e5e7eb;
  transition: background 0.2s;
}

.raison-option:hover {
  background: #fee2e2;
}

.raison-option.selected {
  background: #fecaca;
  font-weight: 700;
  color: #991b1b;
}

.raison-menu-actions {
  border-top: 2px solid #e5e7eb;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.raison-action {
  padding: 8px 12px;
  font-size: 10px;
  cursor: pointer;
  border-radius: 4px;
  text-align: center;
  font-weight: 600;
}

.raison-action.add {
  background: #dcfce7;
  color: #166534;
}

.raison-action.remove {
  background: #fee2e2;
  color: #991b1b;
}

.raison-action.clear {
  background: #f3f4f6;
  color: #374151;
}

.raison-menu-footer {
  padding: 8px;
  border-top: 1px solid #e5e7eb;
  text-align: center;
}

.raison-menu-footer button {
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

/* Menu délais régionaux */
.delai-regions-menu {
  position: fixed;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  z-index: 25000;
  min-width: 240px;
  overflow: hidden;
}

.delai-menu-header {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  color: white;
  padding: 12px 16px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
}

.delai-regions-list {
  padding: 10px;
}

.delai-region-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 8px;
  border-bottom: 1px solid #e5e7eb;
}

.delai-region-row:last-child {
  border-bottom: none;
}

.delai-region-name {
  font-size: 13px;
  font-weight: 600;
  color: #1f2937;
}

.delai-region-controls {
  display: flex;
  align-items: center;
  gap: 6px;
}

.delai-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.delai-btn.minus {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
}

.delai-btn.plus {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.delai-btn:hover {
  transform: scale(1.1);
}

.delai-region-value {
  font-size: 18px;
  font-weight: 800;
  color: #1e40af;
  min-width: 40px;
  text-align: center;
}

.delai-unit {
  font-size: 10px;
  color: #6b7280;
}

.delai-menu-footer {
  padding: 10px;
  border-top: 2px solid #e5e7eb;
  text-align: center;
}

.delai-menu-footer button {
  padding: 10px 30px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* Menu popup délai pour les cartes moulage */
.delai-menu-popup {
  position: fixed;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  z-index: 25000;
  min-width: 240px;
  overflow: hidden;
}

.delai-menu-popup .delai-menu-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 12px 16px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
}

/* Nouveau style simplifié pour les régions */
.delai-regions-simple {
  padding: 8px;
}

.delai-region-row {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  margin: 4px 0;
  border-radius: 8px;
  background: #f8fafc;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.delai-region-row:hover {
  background: #e0f2fe;
}

.delai-region-row.active {
  background: #dbeafe;
  border-color: #3b82f6;
}

.delai-region-row .region-name {
  flex: 1;
  font-size: 13px;
  font-weight: 600;
  color: #1e3a5f;
}

.delai-region-row .region-delai-input {
  width: 50px;
  padding: 4px 6px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  background: white;
  color: #1e40af;
}

.delai-region-row .region-delai-input:focus {
  outline: none;
  border-color: #3b82f6;
}

.delai-region-row .region-unit {
  font-size: 11px;
  color: #6b7280;
  margin-left: 6px;
}

.delai-menu-footer {
  padding: 10px;
  background: #f1f5f9;
  border-top: 1px solid #e2e8f0;
}

.delai-save-btn {
  width: 100%;
  padding: 10px;
  font-size: 12px;
  font-weight: 700;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.delai-save-btn:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

.delai-menu-info {
  padding: 12px 14px;
  background: #f8fafc;
}

.delai-info-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  font-size: 12px;
  border-bottom: 1px solid #e2e8f0;
}

.delai-info-row:last-child {
  border-bottom: none;
}

.delai-info-row.highlight {
  background: #dbeafe;
  margin: 6px -14px -12px -14px;
  padding: 10px 14px;
  font-size: 14px;
}

.delai-info-row.highlight strong {
  color: #1e40af;
  font-size: 16px;
}

.delai-menu-change {
  padding: 12px 14px;
  border-top: 2px solid #e2e8f0;
}

.delai-menu-change label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 8px;
}

.delai-presets {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
}

.delai-presets button {
  flex: 1;
  padding: 8px 4px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  background: #f1f5f9;
  cursor: pointer;
  transition: all 0.2s;
}

.delai-presets button:hover {
  background: #dbeafe;
  border-color: #3b82f6;
}

.delai-presets button.active {
  background: #3b82f6;
  color: white;
  border-color: #2563eb;
}

.delai-custom {
  display: flex;
  gap: 6px;
}

.delai-custom input {
  flex: 1;
  padding: 8px;
  font-size: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  text-align: center;
}

.delai-custom button {
  padding: 8px 12px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.delai-menu-popup .delai-menu-footer {
  padding: 10px;
  border-top: 1px solid #e2e8f0;
  text-align: center;
}

.delai-menu-popup .delai-menu-footer button {
  padding: 8px 25px;
  font-size: 11px;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
}

.attente-raison {
  font-weight: 400;
}

.fiche-notes-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.fiche-notes textarea {
  width: 100%;
  min-height: 40px;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  padding: 4px;
  font-size: 8px;
  resize: vertical;
  box-sizing: border-box;
  cursor: pointer;
}

.fiche-notes.expanded {
  position: absolute;
  top: 45px;
  left: 0;
  right: 0;
  bottom: -30px;
  margin: 0;
  background: #fff;
  z-index: 200;
  display: flex;
  flex-direction: column;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 12px;
  box-sizing: border-box;
}

.fiche-notes.expanded .fiche-notes-header {
  margin-bottom: 8px;
}

.fiche-notes.expanded .fiche-notes-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.fiche-notes.expanded textarea {
  flex: 1;
  min-height: 0 !important;
  resize: none;
  cursor: text;
  font-size: 10px;
  margin-bottom: 10px;
  font-family: "Segoe UI", system-ui, sans-serif;
  line-height: 1.4;
}

.fiche-notes-close-bottom {
  display: none;
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  align-self: flex-end;
  flex-shrink: 0;
}

.fiche-notes.expanded .fiche-notes-close-bottom {
  display: block;
}

/* Boutons Notes et Fermer en bas de la fiche */
.fiche-footer-btns {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  background: linear-gradient(to top, #f1f5f9, #f8fafc);
  border-top: 1px solid #e2e8f0;
}

.fiche-notes-btn {
  flex: 1;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
}

.fiche-notes-btn:hover {
  background: linear-gradient(to bottom, #7c8591, #5c6574);
}

.fiche-notes-btn.has-notes {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  animation: blink-notes-btn 1s infinite;
}

@keyframes blink-notes-btn {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.fiche-close-btn-right {
  flex: 1;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}

.fiche-close-btn-right:hover {
  background: linear-gradient(to bottom, #4a7dc9, #2a4a70);
}

/* Ancien bouton fermer (compatibilité) */
.fiche-close-btn {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 5px 12px;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
}

/* Overlay Notes Moulage - Pleine zone */
.moulage-notes-overlay {
  position: absolute;
  top: 45px;
  left: 0;
  right: 0;
  bottom: 35px;
  background: white;
  border: 2px solid #3f6eb8;
  border-radius: 6px;
  z-index: 200;
  display: none;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
}

.moulage-notes-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.moulage-notes-signature {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 8px;
  text-align: center;
  flex-shrink: 0;
}

.moulage-notes-textarea {
  flex: 1;
  width: 100%;
  padding: 10px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.5;
}

/* ===== FICHE COMMANDE (2 pages split) ===== */
.cmd-fiche-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 10000;
  justify-content: center;
  align-items: center;
  padding: 19px 0;
}

.cmd-fiche-overlay.active {
  display: flex;
}

/* Container principal - 1.5 pouce (144px) d'espace de chaque côté */
/* 1 pouce = 96px, donc 1.5 pouce = 144px de chaque côté = 288px total */
.cmd-fiche-main-container {
  display: flex;
  flex-direction: column;
  width: calc(100vw - 288px);
  min-width: 600px;
  height: calc(100vh - 38px);
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  overflow: hidden;
}

/* Header avec onglets */
.cmd-fiche-main-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 15px;
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  border-bottom: 3px solid #3b82f6;
}

.cmd-fiche-main-header .logo-section {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cmd-fiche-main-header .logo-section img {
  height: 32px;
}

.cmd-fiche-main-header .title-section {
  color: white;
  text-align: center;
}

.cmd-fiche-main-header .title-section h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}

.cmd-fiche-main-header .title-section .subtitle {
  font-size: 10px;
  opacity: 0.8;
}

/* Onglets principaux */
.cmd-main-tabs {
  display: flex;
  gap: 4px;
}

.cmd-main-tab {
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 700;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.cmd-main-tab.tab-info-magasin {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
}

.cmd-main-tab.tab-info-magasin:hover {
  background: linear-gradient(to bottom, #60a5fa, #3b82f6);
}

.cmd-main-tab.tab-info-magasin.active {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.cmd-main-tab.tab-tableau {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  color: white;
}

.cmd-main-tab.tab-tableau:hover {
  background: linear-gradient(to bottom, #fbbf24, #f59e0b);
}

.cmd-main-tab.tab-tableau.active {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.cmd-close-x {
  width: 28px;
  height: 28px;
  background: linear-gradient(to bottom, #ff4444, #cc0000);
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
}

.cmd-close-x:hover {
  background: linear-gradient(to bottom, #ff6666, #ff4444);
}

/* Contenu principal */
.cmd-fiche-main-body {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Vue Info/Magasin - 2 colonnes avec marges de 3/4 pouce (~19px) de chaque côté */
.cmd-view-info-magasin {
  display: none;
  flex: 1;
  overflow: hidden;
  padding: 10px 0;
}

.cmd-view-info-magasin.active {
  display: flex;
}

.cmd-panel-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  border-right: 3px solid #1e3a5f;
  overflow: hidden;
  margin-left: 19px;
  margin-right: 10px;
}

.cmd-panel-magasin {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin-left: 10px;
  margin-right: 19px;
}

.cmd-panel-header {
  padding: 6px 10px;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border-bottom: 2px solid #cbd5e1;
  display: flex;
  align-items: center;
  gap: 8px;
}

.cmd-panel-header h4 {
  margin: 0;
  font-size: 11px;
  font-weight: 700;
  color: #1e3a5f;
}

.cmd-panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px 12px;
}

/* Pastilles uniformes pour Info - plus compactes - fond bleu pâle */
.cmd-pill-input {
  width: 100%;
  height: 26px;
  border: 1px solid #93c5fd;
  border-radius: 6px;
  padding: 3px 6px;
  font-size: 10px;
  font-weight: 500;
  color: #1e40af;
  background: #dbeafe;
  box-sizing: border-box;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.cmd-pill-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: #eff6ff;
}

select.cmd-pill-input {
  cursor: pointer;
}

input.cmd-pill-input {
  text-align: center;
}

/* Pastille délai - plus compacte */
.cmd-delai-pill {
  width: 100%;
  height: 26px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  cursor: default;
}

.delai-pill-inner {
  width: 100%;
  height: 100%;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Bleu pâle par défaut (plus de 8 jours) */
.delai-pill-vide {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
}

.delai-pill-vert {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
}

/* Jaune vrai (8 jours ou moins) */
.delai-pill-jaune {
  background: #facc15;
  color: #000000;
  border: 1px solid #eab308;
  font-weight: 700;
}

/* Rouge 58% opacité (3 jours ou moins) */
.delai-pill-rouge {
  background: rgba(239, 68, 68, 0.58);
  color: #7f1d1d;
  border: 1px solid #dc2626;
  font-weight: 700;
}

/* Rouge clignotant (0 ou retard) */
.delai-pill-retard {
  background: rgba(220, 38, 38, 0.58);
  color: white;
  border: 1px solid #991b1b;
  animation: blinkPillRetard 0.6s infinite;
  font-weight: 700;
}

@keyframes blinkPillRetard {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Total Matériaux section à gauche */
.cmd-materiaux-total-section-left {
  border-top: 1px solid #3b82f6;
  padding: 6px;
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  border-radius: 0 0 6px 6px;
  max-height: 150px;
  overflow-y: auto;
}

/* Total Matériaux en haut de Magasin */
.cmd-materiaux-total-section-top {
  padding: 8px 10px;
  background: linear-gradient(to bottom, #ffffff, #f8fafc);
  border-bottom: 2px solid #3b82f6;
  max-height: 120px;
  overflow-y: auto;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total {
  background: transparent;
  border: none;
  padding: 0;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-header {
  color: #1e3a5f;
  font-size: 10px;
  font-weight: 700;
  margin-bottom: 4px;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-item {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  padding: 2px 6px;
  margin-bottom: 2px;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-item .code,
.cmd-materiaux-total-section-top .cmd-materiaux-total-item .name {
  color: #374151;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-item .qty {
  color: #1e3a5f;
  font-weight: 700;
}

/* Vue Tableau - 100% de la fenêtre (sans entête) */
.cmd-view-tableau {
  display: none;
  flex: 1;
  overflow: hidden;
  flex-direction: column;
  padding: 0;
  margin: 0;
  margin-top: -1px;
}

.cmd-view-tableau.active {
  display: flex;
}

.cmd-tableau-header {
  padding: 6px 10px;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border-bottom: 1px solid #cbd5e1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

/* Barre header du tableau avec logo et bouton import */
.cmd-tableau-header-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: linear-gradient(to bottom, #1e3a5f, #0f2744);
  border-bottom: 2px solid #3b82f6;
}

.cmd-tableau-logo img {
  height: 30px;
}

.cmd-import-json-btn {
  padding: 6px 14px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.cmd-import-json-btn:hover {
  background: linear-gradient(to bottom, #a78bfa, #8b5cf6);
  transform: scale(1.02);
}

.cmd-header-actions {
  display: flex;
  align-items: center;
  margin-left: auto;
  margin-right: 15px;
}

.cmd-tableau-header h4 {
  margin: 0;
  font-size: 11px;
  font-weight: 700;
  color: #1e3a5f;
}

.cmd-tableau-body {
  flex: 1;
  overflow: auto;
  padding: 0;
  margin: 0;
  background: #fff;
}
  background: #f8fafc;
}

/* Footer commun */
.cmd-fiche-main-footer {
  padding: 8px 15px;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border-top: 2px solid #cbd5e1;
  display: flex;
  justify-content: center;
}

.cmd-fiche-main-footer button {
  padding: 10px 40px;
  font-size: 12px;
  font-weight: 700;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.cmd-fiche-main-footer button:hover {
  background: linear-gradient(to bottom, #60a5fa, #3b82f6);
}

/* Champs info dans l'onglet Information */
.cmd-info-body {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px;
}

.cmd-info-row {
  display: flex;
  gap: 8px;
}

.cmd-info-field {
  display: flex;
  flex-direction: column;
  gap: 3px;
  flex: 1;
}

.cmd-info-field.half {
  flex: 1;
}

.cmd-info-field label {
  font-size: 8px;
  font-weight: 600;
  color: #64748b;
}

.cmd-info-field input,
.cmd-info-field select {
  font-size: 10px;
  padding: 6px 8px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
}

.cmd-info-field .cmd-fiche-date-pill {
  font-size: 10px;
  padding: 3px 6px;
  background: #dbeafe;
  border: 1px solid #93c5fd;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  color: #1e40af;
  font-weight: 500;
}

/* Section Délai - Affichage professionnel */
.cmd-delai-section {
  margin-top: 8px;
  padding: 8px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

/* Délai agrandi pour onglet Information */
.cmd-delai-section-big {
  margin-top: 15px;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.cmd-delai-big {
  padding: 50px 30px !important;
  border-radius: 20px !important;
  text-align: center !important;
  background: #f8fafc !important;
  min-height: 280px !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
  flex: 1;
}

.cmd-delai-big-title {
  font-size: 28px !important;
  font-weight: 700 !important;
  margin-bottom: 25px !important;
}

.cmd-delai-big-message {
  font-size: 22px !important;
  color: #64748b !important;
}

.cmd-delai-big-badge {
  font-size: 32px !important;
  font-weight: 800 !important;
  letter-spacing: 2px !important;
  margin-bottom: 20px !important;
  text-transform: uppercase !important;
}

.cmd-delai-big-jours {
  font-size: 140px !important;
  font-weight: 900 !important;
  line-height: 1 !important;
  margin-bottom: 20px !important;
}

.cmd-delai-big-label {
  font-size: 32px !important;
  font-weight: 700 !important;
  margin-bottom: 20px !important;
}

.cmd-delai-big-date {
  font-size: 22px !important;
  opacity: 0.95 !important;
  font-weight: 600 !important;
}

/* Couleurs du délai - VERT > 10 jours */
.cmd-delai-big.delai-vert {
  background: linear-gradient(135deg, #22c55e, #15803d) !important;
  color: white !important;
}

/* Couleurs du délai - JAUNE 6-10 jours */
.cmd-delai-big.delai-jaune {
  background: linear-gradient(135deg, #fbbf24, #d97706) !important;
  color: #451a03 !important;
}

/* Couleurs du délai - ROUGE 1-5 jours */
.cmd-delai-big.delai-rouge {
  background: linear-gradient(135deg, #f87171, #dc2626) !important;
  color: white !important;
}

/* Couleurs du délai - RETARD clignotant */
.cmd-delai-big.delai-retard {
  background: linear-gradient(135deg, #dc2626, #7f1d1d) !important;
  color: white !important;
  animation: blinkRetardBig 0.8s infinite !important;
}

@keyframes blinkRetardBig {
  0%, 100% { 
    background: linear-gradient(135deg, #dc2626, #7f1d1d) !important;
    box-shadow: 0 0 30px rgba(220, 38, 38, 0.8) !important;
    transform: scale(1);
  }
  50% { 
    background: linear-gradient(135deg, #fca5a5, #ef4444) !important;
    box-shadow: 0 0 50px rgba(220, 38, 38, 1) !important;
    transform: scale(1.02);
  }
}

/* ========================================
   RECTANGLE DÉLAI - ZONE BIEN DÉLIMITÉE
   ======================================== */
.delai-rectangle {
  border: 2px solid #1e3a5f;
  border-radius: 8px;
  padding: 8px 10px;
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 65px;
  transition: all 0.3s ease;
}

.delai-rectangle.delai-vide {
  background: #f1f5f9;
  border-color: #94a3b8;
}

.delai-rectangle.delai-vert {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-color: #15803d;
  color: white;
}

.delai-rectangle.delai-jaune {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-color: #d97706;
  color: #451a03;
}

.delai-rectangle.delai-rouge {
  background: linear-gradient(135deg, #f87171, #ef4444);
  border-color: #dc2626;
  color: white;
}

.delai-rectangle.delai-retard {
  background: linear-gradient(135deg, #dc2626, #991b1b);
  border-color: #7f1d1d;
  color: white;
  animation: blinkDelaiRetard 0.6s infinite;
}

@keyframes blinkDelaiRetard {
  0%, 100% {
    background: linear-gradient(135deg, #dc2626, #991b1b);
    box-shadow: 0 0 10px rgba(220, 38, 38, 0.8);
    transform: scale(1);
  }
  50% {
    background: linear-gradient(135deg, #fca5a5, #f87171);
    box-shadow: 0 0 15px rgba(220, 38, 38, 1);
    transform: scale(1.01);
  }
}

.delai-rectangle .delai-titre {
  font-size: 8px;
  font-weight: 700;
  margin-bottom: 2px;
}

.delai-rectangle .delai-badge {
  font-size: 9px;
  font-weight: 800;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 2px;
}

.delai-rectangle .delai-chiffre {
  font-size: 28px;
  font-weight: 900;
  line-height: 1;
  margin-bottom: 2px;
}

.delai-rectangle .delai-label {
  font-size: 8px;
  font-weight: 700;
  margin-bottom: 2px;
}

.delai-rectangle .delai-date {
  font-size: 7px;
  font-weight: 600;
  opacity: 0.9;
}

/* ========================================
   DÉLAI COMPACT - Petit rectangle horizontal
   ======================================== */
.delai-compact {
  display: inline-flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 6px 10px;
  border-radius: 6px;
  border: 2px solid #1e3a5f;
  min-width: 90px;
}

.delai-compact-vide {
  background: #f1f5f9;
  border-color: #94a3b8;
}

.delai-compact-vert {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-color: #15803d;
  color: white;
}

.delai-compact-jaune {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-color: #d97706;
  color: #451a03;
}

.delai-compact-rouge {
  background: linear-gradient(135deg, #f87171, #ef4444);
  border-color: #dc2626;
  color: white;
}

.delai-compact-retard {
  background: linear-gradient(135deg, #dc2626, #991b1b);
  border-color: #7f1d1d;
  color: white;
  animation: blinkDelaiCompact 0.6s infinite;
}

@keyframes blinkDelaiCompact {
  0%, 100% {
    background: linear-gradient(135deg, #dc2626, #991b1b);
    box-shadow: 0 0 8px rgba(220, 38, 38, 0.8);
  }
  50% {
    background: linear-gradient(135deg, #fca5a5, #f87171);
    box-shadow: 0 0 12px rgba(220, 38, 38, 1);
  }
}

.delai-compact-status {
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 0.5px;
  margin-bottom: 2px;
}

.delai-compact-main {
  display: flex;
  align-items: baseline;
  gap: 4px;
}

.delai-compact-num {
  font-size: 24px;
  font-weight: 900;
  line-height: 1;
}

.delai-compact-text {
  font-size: 9px;
  font-weight: 600;
}

.delai-compact-date {
  font-size: 7px;
  font-weight: 500;
  opacity: 0.9;
  margin-top: 2px;
}

.cmd-delai-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.cmd-delai-title {
  font-size: 9px;
  font-weight: 700;
  color: #1e3a5f;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cmd-delai-badge {
  font-size: 8px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 12px;
  color: white;
}

.cmd-delai-badge.urgent {
  background: linear-gradient(135deg, #ff4444, #cc0000);
  animation: pulse 1s infinite;
}

.cmd-delai-badge.warning {
  background: linear-gradient(135deg, #ffaa00, #ff8800);
}

.cmd-delai-badge.ok {
  background: linear-gradient(135deg, #00dd00, #00aa00);
}

.cmd-delai-badge.passed {
  background: linear-gradient(135deg, #9333ea, #7c3aed);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.cmd-delai-progress {
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 6px;
}

.cmd-delai-progress-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.cmd-delai-progress-bar.urgent {
  background: linear-gradient(90deg, #ff4444, #cc0000);
}

.cmd-delai-progress-bar.warning {
  background: linear-gradient(90deg, #ffaa00, #ff8800);
}

/* ===== NOUVEAU SYSTÈME SUIVI DÉPARTEMENTS ===== */
.cmd-tracking-section {
  background: linear-gradient(135deg, #1e3a5f, #0f2744);
  border-radius: 8px;
  padding: 8px;
  margin-top: auto;
}

.cmd-tracking-title {
  font-size: 8px;
  font-weight: 700;
  color: #93c5fd;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
  text-align: center;
}

.cmd-tracking-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
}

.cmd-tracking-dept {
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  padding: 4px;
  text-align: center;
}

.cmd-tracking-dept.active {
  background: rgba(34, 197, 94, 0.3);
  border: 1px solid #22c55e;
}

.cmd-tracking-dept.completed {
  background: rgba(34, 197, 94, 0.2);
}

.cmd-tracking-dept-name {
  font-size: 7px;
  font-weight: 600;
  color: #93c5fd;
  margin-bottom: 2px;
}

.cmd-tracking-dept.active .cmd-tracking-dept-name {
  color: #22c55e;
}

.cmd-tracking-dept-time {
  font-size: 9px;
  font-weight: 700;
  color: white;
}

.cmd-tracking-dept-dates {
  font-size: 5px;
  color: #94a3b8;
  margin-top: 2px;
}

.cmd-tracking-total {
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid rgba(255,255,255,0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cmd-tracking-total-label {
  font-size: 7px;
  color: #93c5fd;
  font-weight: 600;
}

.cmd-tracking-total-value {
  font-size: 12px;
  font-weight: 700;
  color: #22c55e;
}

.cmd-tracking-livraison {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
  padding: 4px 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
}

.cmd-tracking-livraison-label {
  font-size: 7px;
  color: #94a3b8;
}

.cmd-tracking-livraison-days {
  font-size: 11px;
  font-weight: 700;
}

.cmd-tracking-livraison-days.urgent {
  color: #ef4444;
}

.cmd-tracking-livraison-days.warning {
  color: #f59e0b;
}

.cmd-tracking-livraison-days.ok {
  color: #22c55e;
}

/* Animation clignotement vert pour boutons avec lien */
@keyframes blink-green {
  0%, 100% { 
    background: linear-gradient(to bottom, #22c55e, #16a34a);
    box-shadow: 0 0 4px #22c55e;
  }
  50% { 
    background: linear-gradient(to bottom, #4ade80, #22c55e);
    box-shadow: 0 0 8px #22c55e;
  }
}

.photo-btn.has-link {
  animation: blink-green 1.5s infinite;
  color: white !important;
}

.cmd-delai-progress-bar.ok {
  background: linear-gradient(90deg, #00dd00, #00aa00);
}

.cmd-delai-progress-bar.passed {
  background: linear-gradient(90deg, #9333ea, #7c3aed);
}

.cmd-delai-info {
  display: flex;
  justify-content: space-between;
  font-size: 7px;
  color: #64748b;
}

.cmd-delai-days {
  font-size: 18px;
  font-weight: 800;
  text-align: center;
  margin: 4px 0;
}

.cmd-delai-days.urgent {
  color: #cc0000;
}

.cmd-delai-days.warning {
  color: #ff8800;
}

.cmd-delai-days.ok {
  color: #00aa00;
}

.cmd-delai-days.passed {
  color: #7c3aed;
}

.cmd-delai-label {
  font-size: 8px;
  color: #64748b;
  text-align: center;
}

/* Page droite (2/3) */
.cmd-fiche-page-twothirds {
  flex: 1;
  overflow: hidden;
  background: #fff;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  display: flex;
  flex-direction: column;
}

/* Responsive pour mobile - empilé */
@media (max-width: 700px) {
  .cmd-fiche-container-split {
    flex-direction: column;
    gap: 5px;
    overflow: hidden;
  }
  
  .cmd-fiche-page-third,
  .cmd-fiche-page-twothirds {
    width: 100%;
    min-width: unset;
    max-width: unset;
    height: auto;
    min-height: 300px;
    border-radius: 8px;
    border-right: none;
  }
}

/* Container ancien (pour compatibilité) */
.cmd-fiche-container {
  display: flex;
  gap: 0;
  width: calc(100vw - 2cm);
  height: calc(100vh - 2cm);
}

/* Chaque page ancienne */
.cmd-fiche-page {
  width: 420px;
  height: 100%;
  overflow: hidden;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  position: relative;
  display: flex;
  flex-direction: column;
}

.cmd-fiche-page .cmd-fiche-body,
.cmd-fiche-page-third .cmd-fiche-body,
.cmd-fiche-page-twothirds .cmd-fiche-body {
  flex: 1;
  overflow: hidden;
}

/* Boutons Notes/Fermer toujours en bas */
.cmd-fiche-footer-btns {
  display: flex;
  gap: 8px;
  padding: 6px 10px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  margin-top: auto;
}

.cmd-notes-btn {
  flex: 1;
  padding: 6px 10px;
  font-size: 9px;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.cmd-close-btn {
  padding: 6px 16px;
  font-size: 9px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}

.cmd-fiche-page:first-child {
  border-radius: 8px 0 0 8px;
}

.cmd-fiche-page:nth-child(2) {
  border-left: 1px solid #d1d5db;
  border-radius: 0;
}

.cmd-fiche-page:last-child {
  border-left: 1px solid #d1d5db;
  border-radius: 0 8px 8px 0;
}

/* Ancien style pour compatibilité - DÉSACTIVÉ quand contient 3 pages */
.cmd-fiche {
  background: transparent;
  border-radius: 0;
  width: auto;
  max-width: none;
  max-height: none;
  overflow: visible;
  box-shadow: none;
  position: relative;
  font-family: "Segoe UI", system-ui, sans-serif;
}

.cmd-fiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2px;
  padding: 6px 12px 4px 12px;
  border-bottom: 1px solid #e2e8f0;
}

.cmd-fiche-logo {
  flex-shrink: 0;
}

.cmd-fiche-logo img {
  height: 28px;
  width: auto;
}

.cmd-fiche-title {
  flex: 1;
  text-align: center;
}

.cmd-fiche-title h3 {
  margin: 0;
  font-size: 12px;
  font-weight: 700;
  color: #0f172a;
}

.cmd-fiche-title .subtitle {
  font-size: 8px;
  color: #64748b;
}

.cmd-fiche-body {
  padding: 4px 12px 35px 12px;
}

.cmd-fiche-section {
  margin-bottom: 6px;
}

.cmd-fiche-section h4 {
  margin: 0 0 4px 0;
  font-size: 11px;
  font-weight: 700;
  color: #0f172a;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 2px;
}

.cmd-fiche-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin-bottom: 8px;
}

.cmd-fiche-field {
  display: flex;
  flex-direction: column;
}

.cmd-fiche-field label {
  font-size: 10px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 2px;
}

.cmd-fiche-field input,
.cmd-fiche-field select {
  width: 100%;
  min-height: 26px;
  padding: 4px 6px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  box-sizing: border-box;
  background: #fff;
}

.cmd-fiche-date-pill {
  width: 100%;
  min-height: 26px;
  border: 1px solid #93c5fd;
  border-radius: 6px;
  padding: 4px 6px;
  font-size: 10px;
  background: #dbeafe;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1e40af;
  font-weight: 500;
  cursor: pointer;
  box-sizing: border-box;
}

.cmd-fiche-separator {
  height: 1px;
  background: #e5e7eb;
  margin: 6px 0;
}

/* Section département unique par page - ULTRA COMPACT */
.cmd-department-single {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  padding: 4px;
}

/* Section Atelier/Couture côte à côte (ancien) */
.cmd-departments-container {
  display: flex;
  gap: 4px;
}

.cmd-department {
  flex: 1;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  padding: 4px;
  min-width: 0;
}

.cmd-department-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2px;
  padding-bottom: 2px;
  border-bottom: 1px solid #e2e8f0;
}

.cmd-department-title {
  font-size: 8px;
  font-weight: 700;
  color: #1f2937;
  flex: 1;
  text-align: center;
}

.cmd-dept-add-item {
  padding: 2px 6px;
  font-size: 7px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

/* Bouton + Item dans le header par-dessus le titre */
.cmd-add-item-header {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 3px 8px;
  font-size: 8px;
  font-weight: 700;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
  z-index: 5;
}

.cmd-add-item-header:hover {
  background: linear-gradient(to bottom, #2563eb, #1d4ed8);
}

/* Items container - avec scroll si trop d'items */
.cmd-items-list {
  display: flex;
  flex-direction: column;
  gap: 3px;
  height: 100%;
  overflow-y: auto;
}

/* ========================================
   PAGES 2 & 3 - TABLEAU ITEMS
   Vrai tableau avec 3 sections: Atelier | Couture | Inspection
   PASTILLES COMPACTES 12px - ESPACEMENT UNIFORME
   ======================================== */

/* Container principal du tableau */
.cmd-table-container {
  width: 100%;
  overflow-x: auto;
  padding: 2px;
}

/* Le tableau principal - SANS ESPACEMENT pour éviter les lignes blanches */
.cmd-items-table {
  width: 100%;
  border-collapse: collapse;
  border-spacing: 0;
  font-size: 9px;
  table-layout: fixed;
}

/* En-têtes de sections (Atelier, Couture, Inspection) - COMPACT */
.cmd-items-table th.section-header {
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 4px;
  text-align: center;
  height: 16px;
}

.cmd-items-table th.section-header.atelier {
  border-right: 3px solid #1e3a5f;
}

.cmd-items-table th.section-header.couture {
  border-right: 3px solid #1e3a5f;
}

/* En-têtes de colonnes */
.cmd-items-table th.col-header {
  background: #e2e8f0;
  color: #1f2937;
  font-size: 9px;
  font-weight: 700;
  padding: 0;
  text-align: center;
  white-space: nowrap;
  height: 14px;
  line-height: 14px;
}

/* Largeurs des colonnes - OPTIMISÉES pour Employé */
.cmd-items-table .col-plus { width: 10px; }
.cmd-items-table .col-item { width: 42px; }
.cmd-items-table .col-qty { width: 18px; }
.cmd-items-table .col-total { width: 24px; }
.cmd-items-table .col-status { width: 38px; }
.cmd-items-table .col-emp { width: 62px; }
.cmd-items-table .col-notes { width: 28px; }
.cmd-items-table .col-exped { width: 90px; }
.cmd-items-table .col-x { width: 14px; text-align: center; }

.cmd-items-table th.col-header.border-right,
.cmd-items-table td.border-right {
  border-right: 3px solid #1e3a5f;
}

/* Bordures PLEINES entre sections */
.cmd-items-table th.col-header.border-right-solid,
.cmd-items-table td.border-right-solid {
  border-right: 3px solid #1e3a5f !important;
}

/* Cellules du tableau */
.cmd-items-table td {
  padding: 1px;
  text-align: center;
  vertical-align: middle;
  height: 14px;
}

/* Ligne d'item */
.cmd-items-table tr.item-row td {
  background: transparent;
  height: 16px;
}

/* Ligne de grandeur */
.cmd-items-table tr.grandeur-row td {
  background: white;
  height: 14px;
}

.cmd-items-table tr.grandeur-row:hover td {
  background: #f8fafc;
}

/* ========================================
   PASTILLES COMPACTES - TOUTES 12px HAUTEUR
   LARGEURS FIXES IDENTIQUES
   ======================================== */

/* Bouton + Item dans le header - VERT */
.cmd-table-add-item-green {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 2px;
  width: 100%;
  height: 12px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

.cmd-table-add-item-green:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

/* Bouton + Item dans le header (ancien bleu) */
.cmd-table-add-item {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 2px;
  width: 18px;
  height: 12px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

/* Bouton + Grandeur */
.cmd-table-add-grandeur {
  width: 12px;
  height: 12px;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 2px;
  font-size: 8px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

/* Bouton supprimer */
.cmd-table-delete {
  width: 12px;
  height: 12px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  line-height: 10px;
}

/* Pastille Item (bleue foncée) - LARGEUR FIXE 55px */
.cmd-table-item-pill {
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 8px;
  font-weight: 600;
  cursor: pointer;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

/* Pastille Grandeur - BLANC avec texte noir */
.cmd-table-grandeur-pill {
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 8px;
  font-weight: 600;
  cursor: pointer;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Quantité totale item - BLANC avec texte noir */
.cmd-table-item-qty {
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 9px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  line-height: 12px;
  box-sizing: border-box;
}

/* Nom item readonly */
.cmd-table-item-name {
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

/* Grandeur readonly - BLANC avec texte noir */
.cmd-table-grandeur-readonly {
  font-size: 8px;
  font-weight: 600;
  color: #1f2937;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Quantité readonly - BLANC */
.cmd-table-qty-readonly {
  font-size: 9px;
  font-weight: 600;
  color: #1f2937;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 12px;
  box-sizing: border-box;
}

/* Input quantité - SANS FLECHES */
.cmd-table-qty-input {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 9px;
  font-weight: 600;
  padding: 0;
  -moz-appearance: textfield;
  line-height: 10px;
  box-sizing: border-box;
}

.cmd-table-qty-input::-webkit-outer-spin-button,
.cmd-table-qty-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Input fait (x/y) - BOUTON CLIQUABLE */
.cmd-table-fait-btn {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 8px;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  cursor: pointer;
}

.cmd-table-fait-btn:hover {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
}

/* Container fraction éditable X/Y */
.cmd-table-fait-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 12px;
  width: 100%;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  box-sizing: border-box;
}

.cmd-table-fait-input-top {
  width: 14px;
  height: 10px;
  border: none;
  background: transparent;
  text-align: center;
  font-size: 8px;
  font-weight: 600;
  padding: 0;
  -moz-appearance: textfield;
  outline: none;
}

.cmd-table-fait-input-top::-webkit-outer-spin-button,
.cmd-table-fait-input-top::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.cmd-table-fait-input-top:focus {
  background: #e0f2fe;
}

.cmd-table-fait-separator {
  font-size: 8px;
  color: #6b7280;
  margin: 0 1px;
}

.cmd-table-fait-total {
  font-size: 8px;
  color: #6b7280;
}

/* Input fait (x/y) - ancien style */
.cmd-table-fait-input {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 7px;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
}

/* Pastille Status */
.cmd-table-status {
  height: 14px;
  width: 100%;
  border-radius: 3px;
  font-size: 8px;
  font-weight: 700;
  color: white;
  border: none;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 14px;
  box-sizing: border-box;
}

.cmd-table-status.todo {
  background: linear-gradient(to bottom, #ff4444, #cc0000);
}

.cmd-table-status.partial {
  background: linear-gradient(to bottom, #ffaa00, #ff8800);
}

.cmd-table-status.done {
  background: linear-gradient(to bottom, #00dd00, #00aa00);
}

/* Pastille Employe */
.cmd-table-emp {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Select Employé - Menu déroulant */
.cmd-table-emp-select {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  box-sizing: border-box;
  text-align: center;
  font-weight: 600;
}

.cmd-table-emp-select:focus {
  outline: none;
  border-color: #3b82f6;
}

/* Pastille Notes */
.cmd-table-notes {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  line-height: 14px;
  box-sizing: border-box;
}

.cmd-table-notes.has-note {
  background: linear-gradient(to bottom, #fef3c7, #fde68a);
  border-color: #f59e0b;
  color: #92400e;
}

/* Pastille Expédition - même style que les autres pastilles */
.cmd-table-exped {
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 7px;
  cursor: pointer;
  padding: 0 2px;
  line-height: 14px;
  box-sizing: border-box;
  border: 1px solid #cbd5e1;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Select Expédition - Menu déroulant */
.cmd-table-exped-select {
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  box-sizing: border-box;
  border: 1px solid #cbd5e1;
  font-weight: 600;
  text-align: center;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
}

.cmd-table-exped-select:focus {
  outline: none;
  border-color: #3b82f6;
}

.cmd-table-exped-select.blink-green {
  animation: blinkGreenSelect 1s infinite;
}

.cmd-table-exped-select.yellow-bg {
  background: linear-gradient(to bottom, #facc15, #eab308) !important;
  color: #713f12 !important;
  border-color: #ca8a04;
}

.cmd-table-exped-select.expedie {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border-color: #15803d;
}

@keyframes blinkGreenSelect {
  0%, 100% { 
    background: linear-gradient(to bottom, #22c55e, #16a34a);
    color: white;
    border-color: #15803d;
  }
  50% { 
    background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
    color: #166534;
    border-color: #22c55e;
  }
}

.cmd-table-exped.attente {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
}

.cmd-table-exped.pret {
  background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
  color: #166534;
  font-weight: 600;
}

.cmd-table-exped.blink-green {
  animation: blinkGreenExped 1s infinite;
}

.cmd-table-exped.yellow-bg {
  background: linear-gradient(to bottom, #facc15, #eab308) !important;
  color: #713f12 !important;
  font-weight: 700;
}

.cmd-table-exped.expedie {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

@keyframes blinkGreenExped {
  0%, 100% { 
    background: linear-gradient(to bottom, #22c55e, #16a34a);
    color: white;
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
  }
  50% { 
    background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
    color: #166534;
    box-shadow: none;
  }
}

/* Bouton supprimer */
.cmd-table-delete-text {
  font-size: 12px;
  font-weight: 700;
  color: #374151;
  cursor: pointer;
  line-height: 12px;
  display: block;
  text-align: center;
}

.cmd-table-delete-text:hover {
  color: #ef4444;
}

/* Colonne X à droite */
.cmd-items-table td.col-x {
  text-align: right;
  padding-right: 2px !important;
  min-width: 4px !important;
  max-width: 4px !important;
  padding: 0 !important;
  overflow: visible;
}

/* Items list container - plus de hauteur avant scroll */
.cmd-items-list {
  height: 100%;
  overflow-y: auto;
}

/* Bouton X supprimer item */
.cmd-item-delete-btn {
  width: 14px;
  height: 14px;
  padding: 0;
  font-size: 9px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Pastille Item - bleue - RAPETISSÉE */
.cmd-item-pill {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.cmd-item-pill:hover {
  background: linear-gradient(to bottom, #4a7fc9, #2a4670);
}

.cmd-item-pill-readonly {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

/* Quantité totale item - bleue - RAPETISSÉE */
.cmd-item-qty {
  width: 100%;
  height: 14px;
  padding: 0;
  font-size: 9px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

/* Statut item */
.cmd-item-status {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  border: none;
  border-radius: 3px;
  color: white;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.cmd-item-status.todo {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.cmd-item-status.partial {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
}

.cmd-item-status.complete {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
}

/* ========================================
   LIGNES GRANDEUR - Atelier | Couture | Inspection
   ======================================== */

.cmd-grandeurs-table {
  display: flex;
  flex-direction: column;
  gap: 0;
}

/* Ligne grandeur avec 3 sections */
.cmd-grandeur-row {
  display: grid;
  grid-template-columns: 14px 55px 24px 28px 45px 35px 3px 10px 55px 24px 28px 45px 50px 35px 3px 10px 55px 24px 28px 45px 35px 14px;
  gap: 2px;
  align-items: center;
  margin: 1px 0;
  padding: 0;
}

/* Ligne verticale dans les rows */
.cmd-row-line {
  width: 2px;
  height: 14px;
  background: #1e3a5f;
}

/* INSPECTION - grosse pastille État (combine Localisation + Employé) */
.cmd-grandeur-row.inspection-row {
  grid-template-columns: 14px 60px 28px 28px 55px 140px 45px 14px;
}

.cmd-dept-columns-header.inspection-header {
  grid-template-columns: 14px 60px 28px 28px 55px 140px 45px 14px;
}

.cmd-item-header.inspection-item-header {
  grid-template-columns: 12px 48px 22px 26px 50px 110px 35px 12px;
}

/* Grosse pastille État pour Inspection */
.cmd-g-etat-big {
  width: 100%;
  height: 14px;
  padding: 0 4px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-etat-big:hover {
  background: linear-gradient(to bottom, #4b5563, #374151);
}

.cmd-g-etat-big.inspecte {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
}

.cmd-g-etat-big.expedie {
  background: linear-gradient(to bottom, #10b981, #059669);
}

/* Pastille grandeur */
.cmd-g-name {
  width: 100%;
  height: 11px;
  padding: 0 1px;
  font-size: 7px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  background: #fff;
  box-sizing: border-box;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-name:hover {
  background: #f0f9ff;
  border-color: #3b82f6;
}

.cmd-g-name-readonly {
  width: 100%;
  height: 11px;
  padding: 0 1px;
  font-size: 7px;
  background: #f3f4f6;
  border-radius: 2px;
  color: #374151;
  box-sizing: border-box;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Quantité */
.cmd-g-qty {
  width: 100%;
  height: 11px;
  padding: 0;
  font-size: 7px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  background: #fff;
  box-sizing: border-box;
}

.cmd-g-qty-readonly {
  width: 100%;
  height: 11px;
  padding: 0;
  font-size: 7px;
  background: #f3f4f6;
  border-radius: 2px;
  text-align: center;
  color: #374151;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Quantité fait */
.cmd-g-qtyfait {
  width: 100%;
  height: 11px;
  padding: 0;
  font-size: 7px;
  font-weight: 600;
  background: #e5e7eb;
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  box-sizing: border-box;
}

/* Enlever flèches des inputs number */
.cmd-g-qty::-webkit-outer-spin-button,
.cmd-g-qty::-webkit-inner-spin-button,
.cmd-g-qtyfait::-webkit-outer-spin-button,
.cmd-g-qtyfait::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.cmd-g-qty, .cmd-g-qtyfait {
  -moz-appearance: textfield;
}

/* Statut grandeur */
.cmd-g-status {
  width: 100%;
  height: 11px;
  padding: 0 2px;
  font-size: 6px;
  font-weight: 600;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  color: white;
  text-align: center;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-status.todo {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.cmd-g-status.done {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
}

.cmd-g-status.partial {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
}

/* Location */
.cmd-g-loc {
  width: 100%;
  height: 11px;
  padding: 0 2px;
  font-size: 6px;
  font-weight: 600;
  background: white;
  color: #1f2937;
  border: 1px solid #d1d5db;
  border-radius: 2px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-loc:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

/* Employé */
.cmd-g-emp {
  width: 100%;
  height: 11px;
  padding: 0 2px;
  font-size: 6px;
  font-weight: 600;
  background: white;
  color: #1f2937;
  border: 1px solid #d1d5db;
  border-radius: 2px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-emp:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

/* Notes */
.cmd-g-note {
  width: 100%;
  height: 11px;
  padding: 0 1px;
  font-size: 6px;
  font-weight: 600;
  background: white;
  color: #1f2937;
  border: 1px solid #d1d5db;
  border-radius: 2px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-note:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.cmd-g-note.has-note {
  background: linear-gradient(to bottom, #fef08a, #fde047);
  color: #92400e;
  border-color: #f59e0b;
  animation: blink-note 1s infinite;
}

@keyframes blink-note {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Bouton X supprimer grandeur */
.cmd-g-del {
  width: 12px;
  height: 12px;
  padding: 0;
  font-size: 8px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-add-grandeur-btn {
  display: block;
  width: fit-content;
  padding: 2px 6px;
  font-size: 6px;
  font-weight: 600;
  background: #d1d5db;
  color: #374151;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  margin-top: 2px;
}

/* Mini popup */
.cmd-mini-note-popup {
  position: fixed;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 8px;
  width: 180px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 20000;
}

.cmd-mini-note-popup textarea,
.cmd-mini-note-popup input {
  width: 100%;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 6px;
  box-sizing: border-box;
}

.cmd-mini-note-popup textarea {
  height: 50px;
  resize: none;
}

.cmd-mini-note-popup .mini-note-btns {
  display: flex;
  gap: 4px;
  margin-top: 6px;
  justify-content: flex-end;
}

.cmd-mini-note-popup button {
  padding: 4px 10px;
  font-size: 9px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.cmd-mini-note-popup .save-btn {
  background: #10b981;
  color: white;
}

.cmd-mini-note-popup .close-btn {
  background: #6b7280;
  color: white;
}

/* Menu sélection Item/Grandeur */
.cmd-select-menu {
  position: fixed;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 6px;
  min-width: 120px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 20000;
}

.cmd-select-menu .cmd-select-title {
  font-size: 9px;
  font-weight: 700;
  color: #374151;
  padding: 4px 6px;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 4px;
}

.cmd-select-menu .cmd-select-option {
  display: block;
  width: 100%;
  padding: 5px 8px;
  font-size: 8px;
  text-align: left;
  background: #f8fafc;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin-bottom: 2px;
}

.cmd-select-menu .cmd-select-option:hover {
  background: #3b82f6;
  color: white;
}

/* Notes section */
.cmd-notes-section {
  margin-top: 15px;
}

.cmd-notes-section h4 {
  margin: 0 0 8px 0;
  font-size: 12px;
  font-weight: 700;
  color: #1f2937;
}

.cmd-notes-textarea {
  width: 100%;
  height: 100px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 10px;
  resize: vertical;
  box-sizing: border-box;
  background: #fff;
}

/* Notes directes dans fiche commande */
.cmd-notes-direct {
  flex: 1;
  display: flex;
  flex-direction: column;
  margin-top: 8px;
  min-height: 80px;
}

.cmd-notes-header {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 4px;
}

/* Zone notes compacte (une ligne) */
.cmd-notes-compact {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 8px;
}

.cmd-notes-compact:hover {
  background: #e0f2fe;
  border-color: #7dd3fc;
}

.cmd-notes-icon {
  font-size: 14px;
}

.cmd-notes-preview {
  font-size: 10px;
  color: #64748b;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

/* Zone notes étendue */
.cmd-notes-expanded {
  display: flex;
  flex-direction: column;
  margin-top: 8px;
  flex: 1;
  min-height: 120px;
}

.cmd-notes-header-expanded {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 4px;
}

.cmd-notes-collapse-btn {
  font-size: 9px;
  padding: 2px 8px;
  background: #e2e8f0;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: #475569;
}

.cmd-notes-collapse-btn:hover {
  background: #cbd5e1;
}

.cmd-notes-textarea-direct {
  flex: 1;
  width: 100%;
  min-height: 100px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 8px;
  resize: none;
  box-sizing: border-box;
  background: #fff;
  font-family: inherit;
  line-height: 1.3;
}

.cmd-fiche-close-btn {
  position: absolute;
  bottom: 8px;
  right: 10px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
}

/* Sélecteur client sur carte commande */
.mcard-client-select {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  cursor: pointer;
  text-align: center;
  padding: 2px 4px;
  border-radius: 4px;
}

/* Couleurs spécifiques pour les noms de clients */
.mcard.client-france .mcard-client-select {
  color: #facc15;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard.client-c1south .mcard-client-select {
  color: #a78bfa;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard.client-vermeiren .mcard-client-select {
  color: #4ade80;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Cubro - Cyan clair (proche du bleu) */
.mcard.client-cubro .mcard-client-select {
  color: #67e8f9;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* HME - Or */
.mcard.client-hme .mcard-client-select {
  color: #E8B97A;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-client-select:hover {
  background: rgba(255,255,255,0.2);
}

/* Menu client popup */
/* Popup menu pour commandes (Employé, Expédition) */
.cmd-popup-menu {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  z-index: 20000;
  min-width: 180px;
  max-width: 250px;
  overflow: hidden;
}

.cmd-popup-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 10px 14px;
  font-size: 12px;
  font-weight: 700;
  text-align: center;
}

.cmd-popup-options {
  max-height: 200px;
  overflow-y: auto;
}

.cmd-popup-option {
  padding: 10px 14px;
  font-size: 11px;
  cursor: pointer;
  border-bottom: 1px solid #e5e7eb;
  transition: background 0.2s;
}

.cmd-popup-option:hover {
  background: #eff6ff;
}

.cmd-popup-option.selected {
  background: #dbeafe;
  font-weight: 700;
  color: #1e40af;
}

.cmd-popup-actions {
  border-top: 2px solid #e5e7eb;
  padding: 6px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.cmd-popup-action {
  padding: 8px 12px;
  font-size: 10px;
  cursor: pointer;
  border-radius: 4px;
  text-align: center;
  font-weight: 600;
}

.cmd-popup-action.add {
  background: #dcfce7;
  color: #166534;
}

.cmd-popup-action.add:hover {
  background: #bbf7d0;
}

.cmd-popup-action.remove {
  background: #fee2e2;
  color: #991b1b;
}

.cmd-popup-action.remove:hover {
  background: #fecaca;
}

.cmd-popup-action.config {
  background: #fef3c7;
  color: #92400e;
}

.cmd-popup-action.config:hover {
  background: #fde68a;
}

.cmd-popup-footer {
  padding: 8px;
  border-top: 1px solid #e5e7eb;
  text-align: center;
}

.cmd-popup-footer button {
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.cmd-popup-footer button:hover {
  background: linear-gradient(to bottom, #9ca3af, #6b7280);
}

.client-menu-popup {
  position: fixed;
  background: linear-gradient(to bottom, #1a3a5c, #0d2340);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  padding: 6px;
  min-width: 140px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 15000;
}

.client-menu-item {
  padding: 6px 10px;
  font-size: 11px;
  color: white;
  cursor: pointer;
  border-radius: 4px;
  text-align: center;
}

.client-menu-item:hover {
  background: rgba(255,255,255,0.2);
}

/* ===== MODAL LOG ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 5000;
  justify-content: center;
  align-items: center;
}

.modal-overlay.active {
  display: flex;
}

.modal-content {
  background: linear-gradient(to bottom, #1a3a5c, #0d2340);
  border-radius: 12px;
  border: 2px solid #00aaff;
  padding: 20px;
  min-width: 400px;
  max-width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  color: #fff;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
}

.modal-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
}

/* ===== LOGIN OVERLAY ===== */
.login-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom, #0b1d36, #3f6eb8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50000;
}
.login-overlay.hidden {
  display: none;
}
.login-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 30px rgba(0,0,0,0.85);
  padding: 40px;
  max-width: 500px;
  width: 90%;
  color: #fff;
  text-align: center;
}
.login-logos {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-bottom: 25px;
}
.login-logo-item {
  height: 70px;
  object-fit: contain;
}
.login-logo {
  height: 80px;
  margin-bottom: 20px;
}

/* ===== LOGO ROTATIF LOGIN ===== */
.login-logo-flip-container {
  width: 385px;
  height: 140px;
  perspective: 1000px;
  margin: 15px auto 25px auto;
}

.login-logo-flip-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  animation: loginLogoSpin 5s linear infinite;
}

@keyframes loginLogoSpin {
  0% {
    transform: rotateY(0deg);
  }
  100% {
    transform: rotateY(360deg);
  }
}

.login-logo-flip-front,
.login-logo-flip-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-logo-flip-front img,
.login-logo-flip-back img {
  height: 122px;
  width: auto;
  object-fit: contain;
}

.login-logo-flip-back {
  transform: rotateY(180deg);
}
.login-title-container {
  text-align: center;
  margin-bottom: 10px;
}
.login-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 3px;
}
.login-author {
  font-family: 'Brush Script MT', 'Segoe Script', 'Bradley Hand', cursive;
  font-size: 22px;
  color: rgba(255,255,255,0.7);
  font-style: italic;
}
.login-subtitle {
  font-size: 13px;
  opacity: 0.8;
  margin-bottom: 25px;
}
.login-input {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 18px;
  text-align: center;
  margin-bottom: 20px;
  box-sizing: border-box;
  letter-spacing: 3px;
}
.login-input::placeholder {
  color: rgba(255,255,255,0.5);
  letter-spacing: normal;
  font-size: 14px;
}
.login-input:focus {
  outline: none;
  border-color: #00aaff;
  box-shadow: 0 0 10px rgba(0,170,255,0.3);
}
.login-btn {
  width: 100%;
  padding: 14px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #00aaff, #0077cc);
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.login-btn:hover {
  background: linear-gradient(to bottom, #00bbff, #0088dd);
  transform: translateY(-1px);
}
.login-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.login-error {
  color: #ff6666;
  font-size: 12px;
  margin-top: 10px;
  min-height: 20px;
}

.login-success {
  color: #22c55e;
  font-size: 12px;
  margin-top: 10px;
  min-height: 20px;
  background: rgba(34, 197, 94, 0.1);
  padding: 10px;
  border-radius: 8px;
  border: 1px solid rgba(34, 197, 94, 0.3);
}

.login-success.hidden {
  display: none;
}

.login-input-email {
  letter-spacing: normal !important;
  text-align: center !important;
  padding-left: 14px !important;
}

.login-remember {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 10px 0 15px 0;
  font-size: 13px;
  color: rgba(255,255,255,0.8);
}

.login-remember input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #00aaff;
}

.login-remember label {
  cursor: pointer;
}

.login-forgot-btn {
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.7);
  font-size: 12px;
  cursor: pointer;
  margin-top: 5px;
  text-decoration: underline;
}

.login-forgot-btn:hover {
  color: #00aaff;
}

.change-password-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.change-password-subtitle {
  font-size: 13px;
  opacity: 0.8;
  margin-bottom: 20px;
  line-height: 1.4;
}

.change-password-user {
  background: rgba(0,170,255,0.2);
  border: 1px solid rgba(0,170,255,0.4);
  border-radius: 8px;
  padding: 10px 15px;
  margin-bottom: 20px;
  font-size: 14px;
}

.password-requirements {
  text-align: left;
  margin-bottom: 20px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
}

.password-requirements .req {
  font-size: 12px;
  margin: 5px 0;
  opacity: 0.8;
}

.password-requirements .req.valid {
  color: #22c55e;
}

.password-requirements .req.invalid {
  color: #ff6666;
}

/* Badge de rôle utilisateur */
.user-role-badge {
  display: inline-block;
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 6px;
  font-weight: 600;
  text-transform: uppercase;
}

.user-role-badge.admin {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  color: #fff;
}

.user-role-badge.editor {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: #fff;
}

.user-role-badge.operator {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: #fff;
}

.user-role-badge.viewer {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: #fff;
}

/* ===== CARTES PRIORITAIRES ===== */
.mcard.priority {
  animation: priorityBorderPulse 1.5s ease-in-out infinite;
  box-shadow: 0 0 15px rgba(251, 191, 36, 0.5) !important;
}

@keyframes priorityBorderPulse {
  0%, 100% { 
    border: 2px solid #fbbf24;
    box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
  }
  50% { 
    border: 2px solid #f59e0b;
    box-shadow: 0 0 20px rgba(251, 191, 36, 0.7);
  }
}

.priority-badge {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 20px;
  height: 20px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border-radius: 8px 0 8px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.4);
  z-index: 10;
  border: none;
  pointer-events: none;
}

.priority-badge.p1 { background: linear-gradient(to bottom, #ef4444, #dc2626); }
.priority-badge.p2 { background: linear-gradient(to bottom, #f97316, #ea580c); }
.priority-badge.p3 { background: linear-gradient(to bottom, #eab308, #ca8a04); }
.priority-badge.p4 { background: linear-gradient(to bottom, #22c55e, #16a34a); }
.priority-badge.p5 { background: linear-gradient(to bottom, #3b82f6, #2563eb); }

/* Menu contextuel priorité */
.priority-menu {
  position: absolute;
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  padding: 8px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 10000;
  min-width: 180px;
}

.priority-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 13px;
  color: #fff;
  transition: background 0.2s;
}

.priority-menu-item:hover {
  background: rgba(255,255,255,0.1);
}

.priority-menu-item .priority-dot {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
}

.priority-dot.p1 { background: #ef4444; }
.priority-dot.p2 { background: #f97316; }
.priority-dot.p3 { background: #eab308; }
.priority-dot.p4 { background: #22c55e; }
.priority-dot.p5 { background: #3b82f6; }
.priority-dot.none { background: #6b7280; }

.login-signature {
  margin-top: 25px;
  font-family: 'Brush Script MT', 'Segoe Script', 'Bradley Hand', cursive;
  font-size: 20px;
  color: rgba(255,255,255,0.6);
  font-style: italic;
  text-align: right;
  padding-right: 10px;
}

.log-entries {
  max-height: 400px;
  overflow-y: auto;
}

.log-entry {
  padding: 8px;
  margin-bottom: 5px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  font-size: 11px;
}

.log-entry .log-time {
  color: #64748b;
  font-size: 9px;
}

/* ===== MODAL AJOUTER MOULAGE ===== */
.add-modal-field {
  margin-bottom: 12px;
}

.add-modal-field label {
  display: block;
  font-size: 11px;
  margin-bottom: 4px;
}

.add-modal-field input,
.add-modal-field select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 12px;
  box-sizing: border-box;
}

.add-modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 15px;
}

.add-modal-buttons button {
  padding: 8px 20px;
  border-radius: 6px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.btn-add {
  background: linear-gradient(to bottom, #22c55e, #15803d);
  color: #fff;
}

.btn-cancel-modal {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: #fff;
}

/* ===== DATE PICKER FIELD ===== */
.date-picker-field {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 12px;
  box-sizing: border-box;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.date-picker-field:hover {
  border-color: rgba(255,255,255,0.5);
  background: rgba(0,0,0,0.4);
}
.date-picker-value {
  color: #ccc;
}
.date-picker-field.has-value .date-picker-value {
  color: #fff;
}
.date-picker-icon {
  font-size: 14px;
}

/* ===== LIST MANAGE BUTTON ===== */
.list-manage-btn {
  background: transparent;
  border: none;
  color: #888;
  cursor: pointer;
  font-size: 10px;
  padding: 0 4px;
  margin-left: 4px;
}
.list-manage-btn:hover {
  color: #fff;
}

/* ===== ADD MODAL CALENDAR POPUP ===== */
.add-modal-calendar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 60000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.add-modal-calendar-overlay.hidden {
  display: none;
}
.add-modal-calendar-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  min-width: 280px;
}
.add-modal-calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  color: #fff;
  font-weight: 600;
}
.cal-nav-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: #fff;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
}
.cal-nav-btn:hover {
  background: rgba(255,255,255,0.2);
}
.add-modal-calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 5px;
}
.add-modal-calendar-weekdays span {
  text-align: center;
  font-size: 10px;
  color: #888;
  padding: 5px 0;
}
.add-modal-calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}
.add-modal-calendar-days .cal-day {
  text-align: center;
  padding: 8px 4px;
  font-size: 12px;
  color: #fff;
  cursor: pointer;
  border-radius: 4px;
  background: rgba(255,255,255,0.05);
}
.add-modal-calendar-days .cal-day:hover {
  background: rgba(74,142,245,0.4);
}
.add-modal-calendar-days .cal-day.today {
  border: 1px solid #4a8ef5;
}
.add-modal-calendar-days .cal-day.selected {
  background: #4a8ef5;
  font-weight: bold;
}
.add-modal-calendar-days .cal-day.other-month {
  color: #555;
}
.add-modal-calendar-footer {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  justify-content: center;
}
.btn-today-small, .btn-clear-small, .btn-close-small {
  padding: 5px 10px;
  border-radius: 4px;
  border: none;
  font-size: 11px;
  cursor: pointer;
}
.btn-today-small {
  background: linear-gradient(to bottom, #4a8ef5, #2563eb);
  color: #fff;
}
.btn-clear-small {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: #fff;
}
.btn-close-small {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: #fff;
}

/* ===== LIST MANAGER POPUP ===== */
.list-manager-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 60000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.list-manager-overlay.hidden {
  display: none;
}
.list-manager-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border-radius: 12px;
  padding: 0;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  min-width: 320px;
  max-width: 400px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}
.list-manager-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.list-manager-header h3 {
  margin: 0;
  color: #fff;
  font-size: 14px;
}
.list-manager-content {
  padding: 15px;
  flex: 1;
  overflow-y: auto;
}
.list-manager-items {
  max-height: 300px;
  overflow-y: auto;
}
.list-manager-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
  margin-bottom: 6px;
  color: #fff;
  font-size: 12px;
}
.list-manager-item:hover {
  background: rgba(255,255,255,0.1);
}
.list-manager-item .item-name {
  flex: 1;
}
.list-manager-item .btn-remove-item {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  color: #fff;
  width: 24px;
  height: 24px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.list-manager-item .btn-remove-item:hover {
  filter: brightness(1.2);
}
.list-manager-add {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.list-manager-add input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 12px;
}
.btn-add-small {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  border: none;
  color: #fff;
  width: 36px;
  height: 36px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
}
.btn-add-small:hover {
  filter: brightness(1.2);
}
.list-manager-footer {
  padding: 15px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  justify-content: flex-end;
}
.btn-save-list {
  padding: 8px 20px;
  border-radius: 6px;
  border: none;
  background: linear-gradient(to bottom, #4a8ef5, #2563eb);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}
.btn-save-list:hover {
  filter: brightness(1.1);
}

/* ===== AUTH MODAL ===== */
.auth-modal-field {
  margin-bottom: 12px;
}

.auth-modal-field label {
  display: block;
  font-size: 11px;
  margin-bottom: 4px;
}

.auth-modal-field input {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 13px;
  box-sizing: border-box;
}

.auth-error {
  color: #ef4444;
  font-size: 11px;
  margin-bottom: 10px;
  display: none;
}

.auth-error.show {
  display: block;
}

/* ========================================
   SYSTÈME DE RECETTES ET MATÉRIAUX
   ======================================== */

.cmd-materiaux-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 4px;
  background: transparent;
  padding: 0;
  margin: 0;
  align-items: stretch;
  max-width: 100%;
  overflow: hidden;
}

.cmd-materiaux-column {
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 3px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cmd-materiaux-header {
  font-size: 9px;
  font-weight: 700;
  color: white;
  text-align: center;
  padding: 2px 4px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  border-radius: 3px;
  margin-bottom: 2px;
}

.cmd-materiaux-list {
  font-size: 9px;
  color: #374151;
  line-height: 1.2;
  flex: 1;
}

/* Grille matériaux: Code | Matériau+Épaisseur | Qté - COMPACT */
.cmd-materiaux-item {
  display: grid;
  grid-template-columns: 40px 1fr 22px;
  gap: 2px;
  padding: 1px 0;
  border-bottom: 1px dotted #e5e7eb;
  align-items: center;
}

.cmd-materiaux-item:last-child {
  border-bottom: none;
}

.cmd-materiaux-code {
  font-size: 9px;
  font-weight: 700;
  color: #4b5563;
  text-align: left;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cmd-materiaux-name {
  font-size: 9px;
  font-weight: 500;
  color: #1f2937;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 2px;
}

.cmd-materiaux-qty {
  font-size: 12px;
  font-weight: 700;
  color: #059669;
  text-align: right;
}

/* Section Total Matériaux - COMPACTE - TAILLE AUGMENTÉE */
.cmd-materiaux-total {
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  border: 1px solid #3b82f6;
  border-radius: 3px;
  padding: 3px 4px;
  margin: 0;
  max-height: 120px;
  overflow-y: auto;
  overflow-x: hidden;
}

.cmd-materiaux-total-header {
  font-size: 10px;
  font-weight: 700;
  color: #1e40af;
  text-align: center;
  margin-bottom: 2px;
  padding-bottom: 2px;
  border-bottom: 1px solid #3b82f6;
  position: sticky;
  top: 0;
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
}

.cmd-materiaux-total-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 2px 4px;
}

.cmd-materiaux-total-item {
  display: grid;
  grid-template-columns: 35px 1fr 20px;
  gap: 2px;
  align-items: center;
  padding: 2px 3px;
  background: white;
  border-radius: 2px;
  font-size: 9px;
  line-height: 1.2;
}

.cmd-materiaux-total-item .code {
  font-weight: 700;
  color: #1e40af;
  font-size: 9px;
}

.cmd-materiaux-total-item .name {
  font-weight: 500;
  color: #374151;
  font-size: 9px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cmd-materiaux-total-item .qty {
  font-weight: 700;
  color: #059669;
  font-size: 10px;
  text-align: right;
}

/* Popup Notes Commande - Overlay */
.cmd-notes-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 25000;
}

.cmd-notes-popup-content {
  background: white;
  border-radius: 10px;
  width: 500px;
  max-width: 95vw;
  height: 50vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.cmd-notes-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 10px 10px 0 0;
}

.cmd-notes-popup-header h3 {
  margin: 0;
  font-size: 14px;
}

.cmd-notes-popup-header button {
  padding: 4px 12px;
  font-size: 11px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 4px;
  cursor: pointer;
}

.cmd-notes-popup-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.cmd-existing-notes {
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 8px;
  flex: 1;
  overflow-y: auto;
  font-size: 11px;
  margin-bottom: 12px;
}

.cmd-existing-notes .note-entry {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #e5e7eb;
}

.cmd-existing-notes .note-entry:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.cmd-existing-notes .note-signature {
  font-weight: 700;
  color: #1e40af;
  font-size: 10px;
}

.cmd-existing-notes .note-text {
  margin-top: 4px;
  color: #374151;
}

.cmd-new-note-section {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 6px;
  padding: 8px;
}

.cmd-note-signature {
  font-size: 10px;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 6px;
}

.cmd-new-note-section textarea {
  width: 100%;
  height: 60px;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
}

.cmd-notes-popup-footer {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 12px;
  background: #f1f5f9;
  border-radius: 0 0 10px 10px;
}

.cmd-notes-popup-footer .btn-save {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.cmd-notes-popup-footer .btn-close {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

/* Bouton gérer recettes */
.cmd-recettes-btn {
  font-size: 6px;
  padding: 2px 6px;
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  margin-left: 8px;
}

.cmd-recettes-btn:hover {
  background: linear-gradient(to bottom, #7c3aed, #6d28d9);
}

/* Popup recettes */
.recettes-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 650px;
  max-width: 95vw;
  max-height: 85vh;
  background: white;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  z-index: 10000;
  overflow: hidden;
  display: none;
}

.recettes-popup.show {
  display: block;
}

.recettes-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
}

.recettes-popup-header h3 {
  margin: 0;
  font-size: 14px;
}

.recettes-header-btns {
  display: flex;
  gap: 8px;
}

.recettes-btn-save {
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.recettes-btn-close {
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.recettes-btn-delete {
  padding: 6px 12px;
  font-size: 14px;
  font-weight: 600;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.recettes-popup-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 12px 15px;
  background: #f1f5f9;
  border-top: 1px solid #e2e8f0;
}

.recettes-popup-close {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.recettes-popup-body {
  padding: 15px;
  max-height: 55vh;
  overflow-y: auto;
}

.recette-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 10px;
}

.recette-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.recette-card-title {
  font-size: 14px;
  font-weight: 700;
  color: #1f2937;
}

.recette-card-actions {
  display: flex;
  gap: 4px;
}

.recette-card-actions button {
  padding: 4px 10px;
  font-size: 11px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.recette-edit-btn {
  background: #3b82f6;
  color: white;
}

.recette-delete-btn {
  background: #ef4444;
  color: white;
}

.recette-materiaux-list {
  font-size: 12px;
  color: #4b5563;
}

.recette-materiau-item {
  padding: 3px 0;
  display: flex;
  justify-content: space-between;
}

.add-recette-form {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 6px;
  padding: 12px;
  margin-top: 10px;
}

.add-recette-form h4 {
  margin: 0 0 10px 0;
  font-size: 14px;
  color: #166534;
}

.add-recette-form input,
.add-recette-form textarea {
  width: 100%;
  padding: 8px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  margin-bottom: 8px;
  box-sizing: border-box;
}

.add-recette-form button {
  padding: 6px 12px;
  font-size: 11px;
  background: #22c55e;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Menu popup amélioré avec Ajouter/Supprimer */
.menu-popup-actions {
  display: flex;
  gap: 4px;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e5e7eb;
}

.menu-popup-add-btn {
  flex: 1;
  padding: 4px 8px;
  font-size: 9px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.menu-popup-delete-btn {
  flex: 1;
  padding: 4px 8px;
  font-size: 9px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

/* =============================================================================
   STYLES RESPONSIVE POUR MOBILE
============================================================================= */
@media screen and (max-width: 768px) {
  /* Top bar */
  .top-bar {
    flex-wrap: wrap;
    padding: 8px;
    gap: 8px;
  }
  
  .top-bar h1 {
    font-size: 16px;
    width: 100%;
    text-align: center;
  }
  
  .top-bar-buttons {
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 4px;
  }
  
  .top-bar-buttons button {
    font-size: 11px;
    padding: 6px 10px;
  }
  
  /* Colonnes du board */
  .board {
    overflow-x: auto;
    padding: 8px;
  }
  
  .columns-container {
    min-width: 1200px;
  }
  
  .col {
    min-width: 140px;
  }
  
  .col-header h2 {
    font-size: 12px;
  }
  
  /* Cartes */
  .mcard {
    padding: 8px;
  }
  
  .mcard-title {
    font-size: 14px;
  }
  
  .mcard-order {
    font-size: 12px;
  }
  
  .mcard-delay-pill {
    font-size: 10px;
    padding: 4px 8px;
  }
  
  .mcard-btn {
    font-size: 10px;
    padding: 4px 6px;
  }
  
  /* Fiches */
  .mcard-expanded {
    width: 95vw !important;
    max-width: 95vw !important;
    left: 2.5vw !important;
    transform: none !important;
  }
  
  .fiche-content {
    padding: 10px;
  }
  
  .fiche-grid {
    grid-template-columns: 1fr !important;
    gap: 8px;
  }
  
  .fiche-notes {
    font-size: 12px;
  }
  
  /* Fiche commandes */
  #cmdFicheOverlay .cmd-fiche-container {
    width: 95vw !important;
    max-width: 95vw !important;
    height: 90vh !important;
    margin: 5vh auto;
  }
  
  .cmd-fiche-header {
    padding: 10px;
  }
  
  .cmd-fiche-header h2 {
    font-size: 16px;
  }
  
  /* Popups et menus */
  .move-menu, .delai-menu-popup, .raison-attente-menu {
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  /* Login */
  .login-box {
    width: 90vw;
    max-width: 300px;
  }
  
  /* Vue Robot table */
  .robot-table-wrapper {
    overflow-x: auto;
  }
  
  .robot-table {
    min-width: 800px;
  }
}

@media screen and (max-width: 480px) {
  .top-bar h1 {
    font-size: 14px;
  }
  
  .top-bar-buttons button {
    font-size: 10px;
    padding: 5px 8px;
  }
  
  .col {
    min-width: 120px;
  }
  
  .mcard-title {
    font-size: 12px;
  }
  
  .mcard-order {
    font-size: 10px;
  }
  
  .mcard-btn {
    font-size: 9px;
    padding: 3px 5px;
  }
}

  </style>
</head>
<body>
<div class="physiproRoot">
  <div class="app-shell">
    
    <!-- TOP BAR -->
    <header class="topbar">
      <div class="tb-left">
        <!-- Conteneur flip 3D pour les logos -->
        <div class="logo-flip-container" id="logoFlipContainer" onclick="flipLogoAndSwitch()">
          <div class="logo-flip-inner" id="logoFlipInner">
            <div class="logo-flip-front">
              <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro1.png" alt="PhysiPro Moulage"/>
            </div>
            <div class="logo-flip-back">
              <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro2.png" alt="PhysiPro Série Plus"/>
            </div>
          </div>
        </div>
      </div>
      
      <div class="tb-center">
        <span class="top-title" id="pageTitle">Outil de gestion des moulages</span>
        <button class="settings-btn" id="btnSettings" title="Paramètres">⚙️</button>
      </div>
      
      <div class="tb-right">
        <div class="tb-right-main">
          <div class="user-status" id="userStatus">
            <span class="status-dot offline"></span>
            <span class="user-name">Non connecté</span>
          </div>
          <button class="header-btn" id="btnAddMoulage">+ Ajouter moulage</button>
          <button class="header-btn hidden" id="btnAddCommande">+ Ajouter commande</button>
        </div>
      </div>
      
      <!-- Menu Settings Popup -->
      <div class="settings-menu-overlay hidden" id="settingsMenuOverlay">
        <div class="settings-menu-popup">
          <div class="settings-menu-header">
            <span>⚙️ Paramètres</span>
            <button class="settings-close-btn" id="settingsCloseBtn">✕</button>
          </div>
          <div class="settings-menu-content">
            <button class="settings-menu-item" id="settingsImportExportBtn">
              <span class="settings-icon">📦</span>
              <span>Importer / Exporter</span>
            </button>
            <button class="settings-menu-item" id="settingsLogBtn">
              <span class="settings-icon">📋</span>
              <span>Log / Archives</span>
            </button>
            <button class="settings-menu-item logout" id="settingsLogoutBtn">
              <span class="settings-icon">🚪</span>
              <span>Déconnexion</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- MENU IMPORT/EXPORT -->
      <div class="import-export-overlay hidden" id="importExportOverlay">
        <div class="import-export-popup">
          <div class="import-export-header">
            <span>📦 Importer / Exporter les données</span>
            <button class="import-export-close-btn" onclick="closeImportExportMenu()">✕</button>
          </div>
          <div class="import-export-content">
            <div class="import-export-section">
              <h3>📤 Exporter les données</h3>
              <p>Télécharger toutes vos données (moulages, commandes, paramètres) dans un fichier JSON.</p>
              <button class="import-export-btn export-btn" onclick="exportAllData()">
                <span>📥</span> Exporter toutes les données
              </button>
              <div class="export-options">
                <button class="import-export-btn-small" onclick="exportMoulagesOnly()">Moulages seulement</button>
                <button class="import-export-btn-small" onclick="exportCommandesOnly()">Commandes seulement</button>
              </div>
            </div>
            <div class="import-export-divider"></div>
            <div class="import-export-section">
              <h3>📥 Importer les données</h3>
              <p>Charger des données depuis un fichier JSON exporté précédemment.</p>
              <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
              <button class="import-export-btn import-btn" onclick="document.getElementById('importFileInput').click()">
                <span>📤</span> Importer un fichier
              </button>
              <div class="import-warning">
                ⚠️ L'importation remplacera les données existantes. Exportez d'abord vos données actuelles!
              </div>
            </div>
            <div class="import-export-divider"></div>
            <div class="import-export-section">
              <h3>🔧 Import Atelier (Items/Grandeurs/Quantités)</h3>
              <p>Importer un fichier JSON pour mettre à jour les items de l'Atelier sur plusieurs moulages.</p>
              <input type="file" id="importAtelierFile" accept=".json" style="display:none" onchange="handleImportAtelierFile(event)">
              <button class="import-export-btn import-btn" onclick="document.getElementById('importAtelierFile').click()" style="background: linear-gradient(to bottom, #8b5cf6, #7c3aed);">
                <span>🔧</span> Importer JSON Atelier
              </button>
              <div class="import-info" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 11px;">
                <strong>Format JSON attendu:</strong><br>
                <code style="display: block; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 10px; white-space: pre-wrap;">[
  { "commande": "123456", "item": "HP2", "grandeur": "M", "qty": 2 },
  { "commande": "234567", "item": "Coussin Brio", "grandeur": "L", "qty": 1 }
]</code>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="top-search-row">
        <div class="search-box">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" placeholder="Rechercher un moulage..."/>
          <button class="search-clear" id="searchClear">Effacer</button>
        </div>
      </div>
    </header>
    
    <!-- BOARD -->
    <div class="board-wrapper">
      <div class="boards-container" id="boardsContainer">
        <div class="board" id="mainBoard">
          <div class="col" data-col="0">
            <div class="colheader" style="cursor:pointer;" onclick="toggleRobotView()" title="Cliquer pour vue horizontale">⚙️ Robot <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="1">
            <div class="colheader">🪚 Dégauchage <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="2">
            <div class="colheader">♿ Essayage <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="3">
            <div class="colheader">📐 Atelier <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="4">
            <div class="colheader">🧵 Couture <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="5">
            <div class="colheader">🎨 Peinture <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="6">
            <div class="colheader">🚚 Expédition <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="7">
            <div class="colheader en-attente">⏳ En attente <span class="col-count">0</span></div>
          </div>
        </div>
      </div>
      
      <!-- VUE HORIZONTALE ROBOT -->
      <div id="robotHorizontalView" class="robot-horizontal-container" style="display:none;">
        <div class="robot-horizontal-header">
          <h2>📊 Robot - Vue Horizontale (Éditable)</h2>
          <div style="display:flex;gap:8px;">
            <button class="header-btn" onclick="addNewMoulageFromHorizontal()" style="background:linear-gradient(to bottom,#22c55e,#16a34a);">+ Ajouter moulage</button>
            <button class="header-btn" onclick="toggleRobotView()">← Retour au Kanban</button>
          </div>
        </div>
        <div class="robot-horizontal-scroll">
          <table class="robot-horizontal-table" id="robotTable">
            <thead>
              <tr>
                <th class="resizable-th">Nom moulage<div class="resize-handle"></div></th>
                <th class="resizable-th">Client<div class="resize-handle"></div></th>
                <th class="resizable-th">N° Commande<div class="resize-handle"></div></th>
                <th class="resizable-th">Priorité<div class="resize-handle"></div></th>
                <th class="resizable-th">Rang Robot<div class="resize-handle"></div></th>
                <th class="resizable-th">Région<div class="resize-handle"></div></th>
                <th class="resizable-th">Item<div class="resize-handle"></div></th>
                <th class="resizable-th">Date Reçue<div class="resize-handle"></div></th>
                <th class="resizable-th">Date Livraison<div class="resize-handle"></div></th>
                <th class="resizable-th">Date Essayage<div class="resize-handle"></div></th>
                <th class="resizable-th">Représentante<div class="resize-handle"></div></th>
                <th class="resizable-th">File<div class="resize-handle"></div></th>
                <th class="resizable-th">Angle<div class="resize-handle"></div></th>
                <th class="resizable-th">RUSH<div class="resize-handle"></div></th>
                <th class="resizable-th">Notes<div class="resize-handle"></div></th>
              </tr>
            </thead>
            <tbody id="robotTableBody">
              <!-- Les lignes seront générées dynamiquement -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- PAGE COMMANDES -->
      <div id="commandesPage" class="boards-container hidden">
        <div class="board commandes-board" id="commandesBoard">
          <div class="col col-cmd" data-col-cmd="0" data-client="Vermeiren">
            <div class="colheader client-vermeiren-header">🟢 Vermeiren <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="1" data-client="HME">
            <div class="colheader client-hme-header">🟤 HME <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="2" data-client="C1SOUTH">
            <div class="colheader client-c1south-header">⚫ C1SOUTH <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="3" data-client="Cubro">
            <div class="colheader client-cubro-header">🔵 Cubro <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="4" data-client="France">
            <div class="colheader client-france-header">🟡 France <span class="col-count-cmd">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- Overlay pour fiche moulage -->
<div class="card-overlay" id="cardOverlay"></div>

<!-- Overlay pour fiche commande -->
<div class="cmd-fiche-overlay" id="cmdFicheOverlay">
  <div class="cmd-fiche" id="cmdFicheContent">
    <!-- Contenu généré dynamiquement -->
  </div>
</div>

<!-- Menu de déplacement -->
<div class="move-overlay hidden" id="moveOverlay">
  <div class="move-panel">
    <div class="move-title">Déplacer vers quelle colonne?</div>
    <div class="move-columns" id="moveColumns">
      <!-- Généré dynamiquement -->
    </div>
    <div class="move-footer">
      <button class="move-btn-close" id="moveClose">Annuler</button>
    </div>
  </div>
</div>

<!-- Confirmation suppression -->
<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-panel">
    <div class="confirm-title">⚠️ Confirmer la suppression</div>
    <div class="confirm-message" id="confirmMessage">Voulez-vous vraiment supprimer ce moulage?</div>
    <div class="confirm-buttons">
      <button class="confirm-btn confirm-btn-yes" id="confirmYes">Oui, supprimer</button>
      <button class="confirm-btn confirm-btn-no" id="confirmNo">Non, annuler</button>
    </div>
  </div>
</div>

<!-- Modal Log -->
<div class="modal-overlay" id="logModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>📋 Journal des activités</h3>
      <button class="modal-close" id="closeLogModal">×</button>
    </div>
    <div class="log-entries" id="logEntries">
      <div class="log-entry">
        <div class="log-time">Aucune entrée</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ajouter Moulage -->
<div class="modal-overlay" id="addModal">
  <div class="modal-content" style="max-width: 520px;">
    <div class="modal-header">
      <h3>➕ Ajouter un moulage</h3>
      <button class="modal-close" id="closeAddModal">×</button>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <div class="add-modal-field">
        <label>Client <button class="list-manage-btn" onclick="openListManager('moulageClients', 'Client')">⚙</button></label>
        <select id="addClient"></select>
      </div>
      <div class="add-modal-field">
        <label>Nom du moulage</label>
        <input type="text" id="addName" placeholder="Ex: Dupont Jean">
      </div>
      <div class="add-modal-field">
        <label>Date reçue</label>
        <div class="date-picker-field" id="addDateRecueField" onclick="openAddModalCalendar('addDateRecue')">
          <span class="date-picker-value" id="addDateRecueDisplay">-- Sélectionner --</span>
          <span class="date-picker-icon">📅</span>
        </div>
        <input type="hidden" id="addDateRecue">
      </div>
      <div class="add-modal-field">
        <label>Date fabriquée au robot</label>
        <div class="date-picker-field" id="addDateRobotField" onclick="openAddModalCalendar('addDateRobot')">
          <span class="date-picker-value" id="addDateRobotDisplay">-- Sélectionner --</span>
          <span class="date-picker-icon">📅</span>
        </div>
        <input type="hidden" id="addDateRobot">
      </div>
      <div class="add-modal-field">
        <label>Numéro de commande</label>
        <input type="text" id="addOrder" placeholder="000000" maxlength="6">
      </div>
      <div class="add-modal-field">
        <label>Numéro PO</label>
        <input type="text" id="addNumeroPO" placeholder="000000" maxlength="6">
      </div>
      <div class="add-modal-field">
        <label>Région <button class="list-manage-btn" onclick="openListManager('regions', 'Région')">⚙</button></label>
        <select id="addRegion"></select>
      </div>
      <div class="add-modal-field">
        <label>Intervenant <button class="list-manage-btn" onclick="openListManager('intervenants', 'Intervenant')">⚙</button></label>
        <select id="addIntervenant"></select>
      </div>
      <div class="add-modal-field" style="grid-column: 1 / -1;">
        <label>Représentante <button class="list-manage-btn" onclick="openListManager('representantes', 'Représentante')">⚙</button></label>
        <select id="addRepresentant"></select>
      </div>
    </div>
    <div class="add-modal-buttons">
      <button class="btn-cancel-modal" id="cancelAdd">Annuler</button>
      <button class="btn-add" id="confirmAdd">Ajouter</button>
    </div>
  </div>
</div>

<!-- Calendrier popup pour modales d'ajout -->
<div class="add-modal-calendar-overlay hidden" id="addModalCalendarOverlay">
  <div class="add-modal-calendar-popup">
    <div class="add-modal-calendar-header">
      <button class="cal-nav-btn" onclick="addModalCalendarPrev()">◀</button>
      <span id="addModalCalendarTitle">Décembre 2025</span>
      <button class="cal-nav-btn" onclick="addModalCalendarNext()">▶</button>
    </div>
    <div class="add-modal-calendar-weekdays">
      <span>Dim</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Jeu</span><span>Ven</span><span>Sam</span>
    </div>
    <div class="add-modal-calendar-days" id="addModalCalendarDays"></div>
    <div class="add-modal-calendar-footer">
      <button class="btn-today-small" onclick="addModalCalendarToday()">Aujourd'hui</button>
      <button class="btn-clear-small" onclick="addModalCalendarClear()">Effacer</button>
      <button class="btn-close-small" onclick="closeAddModalCalendar()">Fermer</button>
    </div>
  </div>
</div>

<!-- Gestionnaire de listes -->
<div class="list-manager-overlay hidden" id="listManagerOverlay">
  <div class="list-manager-popup">
    <div class="list-manager-header">
      <h3 id="listManagerTitle">Gérer les valeurs</h3>
      <button class="modal-close" onclick="closeListManager()">×</button>
    </div>
    <div class="list-manager-content">
      <div class="list-manager-items" id="listManagerItems"></div>
      <div class="list-manager-add">
        <input type="text" id="listManagerNewItem" placeholder="Nouvelle valeur...">
        <button class="btn-add-small" onclick="addListItem()">+</button>
      </div>
    </div>
    <div class="list-manager-footer">
      <button class="btn-save-list" onclick="saveListManager()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Login Overlay (plein écran) -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-panel">
    <div class="login-logo-flip-container">
      <div class="login-logo-flip-inner">
        <div class="login-logo-flip-front">
          <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro1.png" alt="PhysiPro Moulage">
        </div>
        <div class="login-logo-flip-back">
          <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro2.png" alt="PhysiPro Série Plus">
        </div>
      </div>
    </div>
    <div class="login-title-container">
      <div class="login-title">Outil de gestion</div>
      <div class="login-author">par Daniel Charest</div>
    </div>
    <div class="login-subtitle">Connectez-vous avec votre email d'entreprise</div>
    <input type="email" id="loginEmail" class="login-input login-input-email" placeholder="Email d'entreprise" autocomplete="email">
    <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" maxlength="50" autocomplete="current-password">
    <div class="login-remember">
      <input type="checkbox" id="rememberMe">
      <label for="rememberMe">Se souvenir de moi sur cet ordinateur</label>
    </div>
    <button class="login-btn" id="loginBtn">Se connecter</button>
    <button class="login-forgot-btn" id="forgotPasswordBtn">Mot de passe oublié?</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- Modal Changement de Mot de Passe (premier login) -->
<div id="changePasswordOverlay" class="login-overlay hidden">
  <div class="login-panel">
    <div class="change-password-icon">🔐</div>
    <div class="login-title-container">
      <div class="login-title">Bienvenue!</div>
      <div class="change-password-subtitle">Pour votre sécurité, veuillez créer votre mot de passe personnel</div>
    </div>
    <div class="change-password-user" id="changePasswordUser"></div>
    <input type="password" id="newPassword1" class="login-input" placeholder="Nouveau mot de passe (min. 8 caractères)" maxlength="50">
    <input type="password" id="newPassword2" class="login-input" placeholder="Confirmer le mot de passe" maxlength="50">
    <div class="password-requirements">
      <div class="req" id="reqLength">❌ Au moins 8 caractères</div>
      <div class="req" id="reqMatch">❌ Les mots de passe correspondent</div>
    </div>
    <button class="login-btn" id="changePasswordBtn" disabled>Créer mon mot de passe</button>
    <div class="login-error" id="changePasswordError"></div>
  </div>
</div>

<!-- Modal Mot de Passe Oublié -->
<div id="forgotPasswordOverlay" class="login-overlay hidden">
  <div class="login-panel">
    <div class="change-password-icon">📧</div>
    <div class="login-title-container">
      <div class="login-title">Mot de passe oublié</div>
      <div class="change-password-subtitle">Entrez votre email pour recevoir un lien de réinitialisation</div>
    </div>
    <input type="email" id="forgotEmail" class="login-input login-input-email" placeholder="Votre email d'entreprise" autocomplete="email">
    <button class="login-btn" id="sendResetBtn">Envoyer le lien</button>
    <button class="login-forgot-btn" id="backToLoginBtn">← Retour à la connexion</button>
    <div class="login-error" id="forgotPasswordError"></div>
    <div class="login-success hidden" id="forgotPasswordSuccess"></div>
  </div>
</div>

<script>
// ===== CONFIGURATION FIREBASE =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCk7bqVnx08Kz1fVq1W24AuW854KY9jPno",
  authDomain: "liste-des-moulages-physipro.firebaseapp.com",
  databaseURL: "https://liste-des-moulages-physipro-default-rtdb.firebaseio.com",
  projectId: "liste-des-moulages-physipro",
  storageBucket: "liste-des-moulages-physipro.firebasestorage.app",
  messagingSenderId: "24566847562",
  appId: "1:24566847562:web:db492bdd33116373e0eeb3"
};

// ===== SYSTÈME D'AUTHENTIFICATION NIVEAU 2 - EMAIL RÉEL =====

// Table des utilisateurs avec vrais emails d'entreprise
const USERS = {
  // Admin
  "atelieratp@physipro.com": { name: "Daniel Charest", role: "admin", tempHash: "997a5fb50ce12b5619bdb2ecc2dc05f216af0ab61bb3f2609017c3fcb62da2ae" },
  
  // Editors
  "simdut@physipro.com": { name: "Cassie Valois", role: "editor", tempHash: "b36e5a61cadecc891b457429048e44133cf8dae501a9cfc4c423bcf00715da30" },
  "mplanguedoc@physipro.com": { name: "Marie-Pier Languedoc", role: "editor", tempHash: "ff5cfebfb49c5213aa2304f15e19c3147f48d55aa26ea299f7457c0209f804e0" },
  "marie-soleil.riverin@physipro.com": { name: "Marie-Soleil Riverin", role: "editor", tempHash: "722d36562183c87fa53ce5c44d424c63c6c3b2b27c72c7a233663d9f568fecc2" },
  "michelle.bouchard@physipro.com": { name: "Michelle Bouchard", role: "editor", tempHash: "a899253b54dd6c800f9513919186a55948f9ff0d6162b9fdb200bdaf60a500f3" },
  "ngagne@physipro.com": { name: "Nadia Gagne", role: "editor", tempHash: "cb2a7765e640d51841f9aa8dfc335e19bcbd894b0c8cc096d97a073c9a4b548d" },
  "cncatp@physipro.com": { name: "Sina Lotfollah", role: "editor", tempHash: "1d537709c14a89facf0704bd2c091d9da8b48fe69b0c65de5741db0b9ad7919d" },
  "magasinatp3@physipro.com": { name: "Stéphane Delorme", role: "editor", tempHash: "5042c15596f4aad0f612d50e0c013476f84a1d709527eca42821cf423f6092c0" },
  "sroy@physipro.com": { name: "Stephanie Roy", role: "editor", tempHash: "eeff8c3b9ae24e6a2d8b3c8766c0a7bf927bf479da0aa94e21061ded39c6ce6d" },
  "magasinatp2@physipro.com": { name: "Sylvain Carrier", role: "editor", tempHash: "ffdebc076a622154180f479624c9a9e1c4ff4c832f62aca8f15341d16cfda6ef" },
  "mario.jacques@physipro.com": { name: "Mario Jacques", role: "editor", tempHash: "15d700ad21280a8c2fa03075c55c70a766ea8c9db5b5d8f7a850835e67514357" },
  "valerie18@videotron.ca": { name: "Valérie Fréchette", role: "editor", tempHash: "3277ff046b6d07eb1ff818f1a54ef1a7d40d72cb151fd29058efc54bfbe84d1a" },
  
  // Viewers
  "fabrys.frechette@physipro.com": { name: "Fabrys Fréchette", role: "viewer", tempHash: "2815e7664309c9785471fe9dba0c2ed4f97dd52a89f5e2b17fa695187d07c34e" },
  "rh@physipro.com": { name: "Roxanne Valois", role: "viewer", tempHash: "47fb2d990d95be18c1e0206e1f3640bcaf5ed0345bbb220757556d0fd3424f07" },
  "sonia.boulanger@physipro.com": { name: "Sonia Boulanger", role: "viewer", tempHash: "847267f5801f9d09b17995593d69db5a4b6a425c3d8594d8cdf81227c80e1fec" },
  "magasinatp1@physipro.com": { name: "Stéphane Duchesneau", role: "viewer", tempHash: "bbca07c4246a26a6c438c325d29329b90693a5d26ccc166dd30ae755c9cfc540" },
  "marioouellette@physipro.com": { name: "Mario Ouellette", role: "viewer", tempHash: "71b5601cad7b61f8a9bbf42546303b4676990f07d8ecee70a89c464b36553c4a" },
  "service3@physipro.com": { name: "Jacynthe Gaumond", role: "viewer", tempHash: "fd9f31c199a09b28b4d0eafe0dd63713f219141c2723a62ec68106079c3b10b5" }
};

// Fonction pour hasher un mot de passe (SHA-256)
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

// Descriptions des rôles
const ROLE_DESCRIPTIONS = {
  admin: "Administrateur - Tout faire + gérer les utilisateurs + voir les logs + supprimer",
  editor: "Éditeur - Modifier, ajouter, déplacer les cartes",
  operator: "Opérateur - Modifier seulement certaines colonnes",
  viewer: "Lecteur - Lecture seule"
};

// Variables globales
let firebaseInitialized = false;
let currentUser = null;
let firebaseAuth = null;
let firebaseDb = null;
let _sessionValid = false;

// Initialiser Firebase
try {
  firebase.initializeApp(FIREBASE_CONFIG);
  firebaseDb = firebase.database();
  firebaseAuth = firebase.auth();
  firebaseInitialized = true;
  console.log("✅ Firebase initialisé");
} catch(e) {
  console.error("❌ Erreur Firebase:", e);
}

// ===== DONNÉES (modifiables) =====
let MENU_DATA = {
  regions: ["Québec", "Ontario", "Maritime"],
  delays: { "Québec": 90, "Ontario": 30, "Maritime": 45 },
  clients: [
    "SAT IRDPQ Hamel",
    "SAT CRDPCA",
    "SAT Jonquiere Saguenay Lac Saint Jean",
    "SAT Gaspésie Saint Anne des Monts",
    "SAT Baie Comeau",
    "SAT Sept Iles",
    "SAT Trois Rivieres",
    "SAT Joliette",
    "SAT Mont Joli",
    "SAT CRE Sherbrooke",
    "Stan Cassidy Nouveau Brunswick",
    "Metro Health Nouveau Brunswick",
    "IWK Nouvelle Écosse",
    "MED +",
    "TLC Medical"
  ],
  intervenants: [
    "Joelle Bourdages",
    "Judith Lagimonière",
    "Camille Morel",
    "Anne Sophie Montminy",
    "Josianne Labrecque",
    "Eric Gagnon",
    "Nadyne Gobeil",
    "Marie Michelle Hamel",
    "Lisa Houde",
    "Stéphanie D'Astou",
    "Annie Bourgeois",
    "Mireille Lefebvre",
    "Louis Matton",
    "Isabelle Neault",
    "Cindy Audet",
    "Josée Bédard",
    "Martine Comeau",
    "Ysabelle Fugere",
    "Julie Lefebvre",
    "Godefroy Neault",
    "Pam McKaskill",
    "Tabitha Knowles",
    "Marie Smith",
    "Anna Caulfield",
    "Maggie MCCann",
    "Jenny Jackson",
    "Mario Lebouthiller"
  ],
  representantes: ["Marie-Soleil", "Marie-Pier", "Multipass", "Fabrys"],
  items: ["HP2", "HP2 Ultra", "EasyFit", "Coussin Brio", "Coquille 2Sizer", "Siège", "Dossier", "Siège + Dossier"],
  employees: {
    robot: ["Mario Jaques", "Sina", "Zakaria"],
    degauchage: ["Pierre", "Serge", "Nestor", "Mathieu", "Daniel"],
    atelier: ["Pierre", "Serge", "Nestor", "Mathieu", "Daniel", "Valérie", "Tommy", "Saul", "Checkna"],
    couture: ["Stéphanie", "Cassie", "Thérèse", "Louisette", "Suave", "Martine"],
    peinture: ["Manuel", "Cheickna", "Saul", "Pablo"]
  },
  locations: ["Étagère Val", "Étagère Dan", "Donné à Michelle", "Tablette A1", "Tablette A2", "Rack C1", "Magasin"],
  // Recettes pour chaque item (avec code matériau)
  recettes: {
    "HP2": [
      { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" }
    ],
    "HP2 Ultra": [
      { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" },
      { code: "COQ-2S", materiau: "Coquille 2Sizer", qty: 1, epaisseur: "" },
      { code: "VIS-T36", materiau: "Feuille Viscose T36 (cuvette)", qty: 1, epaisseur: "" }
    ],
    "Ultra": [
      { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" },
      { code: "COQ-2S", materiau: "Coquille 2Sizer", qty: 1, epaisseur: "" }
    ],
    "EasyFit": [
      { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" }
    ],
    "Brio": [
      { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1.5, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" },
      { code: "BIS-BR", materiau: "Biseau pour Brio", qty: 1, epaisseur: "" }
    ],
    "Coussin Brio": [
      { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1.5, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" },
      { code: "BIS-BR", materiau: "Biseau pour Brio", qty: 1, epaisseur: "" },
      { code: "BUT-AB", materiau: "Butée ABD Néocor", qty: 1, epaisseur: "" },
      { code: "NEO-40", materiau: "Feuille Néocor VF40", qty: 0.5, epaisseur: "½″" }
    ]
  }
};

// Variables globales pour les listes (utilisées dans la vue horizontale)
window.CLIENTS_LIST = MENU_DATA.clients;
window.INTERVENANTS_LIST = MENU_DATA.intervenants;

// Stockage des cartes
let cardsData = {};
let logEntries = [];

// ===== SYSTÈME D'ARCHIVE DES CARTES SUPPRIMÉES =====
let archivedCards = [];

// Charger les archives depuis localStorage au démarrage
function loadArchivedCards() {
  try {
    const stored = localStorage.getItem('physipro_archives');
    if (stored) {
      archivedCards = JSON.parse(stored);
      console.log(`📂 ${archivedCards.length} cartes archivées chargées`);
    }
  } catch (e) {
    console.error('Erreur chargement archives:', e);
    archivedCards = [];
  }
}

// Sauvegarder les archives dans localStorage
function saveArchivedCards() {
  try {
    localStorage.setItem('physipro_archives', JSON.stringify(archivedCards));
  } catch (e) {
    console.error('Erreur sauvegarde archives localStorage:', e);
  }
}

// Sauvegarder une archive dans Firebase
function saveArchiveToFirebase(archive) {
  if (firebaseDb) {
    firebaseDb.ref('archives/' + archive.id).set(archive)
      .then(() => console.log(`☁️ Archive ${archive.id} sauvegardée dans Firebase`))
      .catch(e => console.error('Erreur Firebase archive:', e));
  }
}

// Charger les archives depuis Firebase
function loadArchivesFromFirebase() {
  if (firebaseDb) {
    firebaseDb.ref('archives').once('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        // Fusionner avec localStorage (éviter doublons)
        const firebaseArchives = Object.values(data);
        const existingIds = archivedCards.map(a => a.id);
        firebaseArchives.forEach(archive => {
          if (!existingIds.includes(archive.id)) {
            archivedCards.push(archive);
          }
        });
        saveArchivedCards();
        console.log(`☁️ ${firebaseArchives.length} archives chargées depuis Firebase`);
      }
    });
  }
}

// Calculer le temps passé dans chaque département
function calculateDepartmentTime(cardData) {
  const depts = ['Robot', 'Dégauchage', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expédition', 'En attente'];
  const times = {};
  
  // Si on a un historique de mouvements
  if (cardData.history && Array.isArray(cardData.history)) {
    let lastDept = null;
    let lastDate = null;
    
    cardData.history.forEach(entry => {
      if (lastDept && lastDate) {
        const currentDate = new Date(entry.date);
        const days = Math.round((currentDate - lastDate) / (1000 * 60 * 60 * 24));
        times[lastDept] = (times[lastDept] || 0) + days;
      }
      lastDept = entry.column || entry.dept;
      lastDate = new Date(entry.date);
    });
    
    // Ajouter le temps depuis le dernier mouvement
    if (lastDept && lastDate) {
      const days = Math.round((new Date() - lastDate) / (1000 * 60 * 60 * 24));
      times[lastDept] = (times[lastDept] || 0) + days;
    }
  }
  
  // Si pas d'historique, estimer avec la date de création
  if (Object.keys(times).length === 0 && cardData.createdAt) {
    const created = new Date(cardData.createdAt);
    const totalDays = Math.round((new Date() - created) / (1000 * 60 * 60 * 24));
    const currentDept = depts[cardData.columnIndex] || 'Inconnu';
    times[currentDept] = totalDays;
  }
  
  return times;
}

// Archiver une carte AVANT de la supprimer
function archiveCard(cardId, cardData, type = 'moulage') {
  const archive = {
    id: 'archive_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    type: type,
    originalId: cardId,
    deletedAt: new Date().toISOString(),
    deletedBy: currentUserName || 'Inconnu',
    
    // Infos principales
    name: cardData.name || '-',
    client: cardData.client || '-',
    order: cardData.order || '-',
    numeroPO: cardData.numeroPO || '-',
    
    // Dates
    dateRecue: cardData.dateRecue || cardData.createdAt || '-',
    dateLivraison: cardData.dateLivraison || '-',
    dateEssayage: cardData.dateEssayage || '-',
    createdAt: cardData.createdAt || '-',
    
    // Infos supplémentaires
    region: cardData.region || '-',
    intervenant: cardData.intervenant || '-',
    representant: cardData.representant || '-',
    item: cardData.item || '-',
    
    // Position au moment de la suppression
    lastColumn: cardData.columnIndex ?? '-',
    lastColumnName: ['Robot', 'Dégauchage', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expédition', 'En attente'][cardData.columnIndex] || '-',
    
    // Temps par département
    departmentTime: calculateDepartmentTime(cardData),
    
    // Notes
    notes: cardData.notes || '-',
    
    // Données complètes pour restauration éventuelle
    fullData: JSON.parse(JSON.stringify(cardData))
  };
  
  // Ajouter à la liste
  archivedCards.unshift(archive); // Plus récent en premier
  
  // Limiter à 500 archives max
  if (archivedCards.length > 500) {
    archivedCards = archivedCards.slice(0, 500);
  }
  
  // Sauvegarder localement ET dans Firebase
  saveArchivedCards();
  saveArchiveToFirebase(archive);
  
  console.log(`📁 Carte archivée: ${archive.name} (${archive.type})`);
  return archive;
}

// Afficher le popup des archives (Log)
// Variable pour le slider
let currentArchiveIndex = 0;

// Menu Log principal
function showLogMenu() {
  document.getElementById('logMenuPopup')?.remove();
  
  const popup = document.createElement('div');
  popup.id = 'logMenuPopup';
  popup.className = 'archives-popup-overlay';
  popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
  
  popup.innerHTML = `
    <div class="log-menu-popup">
      <div class="log-menu-header">
        <h2>📋 Menu Log</h2>
        <button class="archives-close" onclick="document.getElementById('logMenuPopup').remove()">✕</button>
      </div>
      <div class="log-menu-content">
        <button class="log-menu-btn" onclick="document.getElementById('logMenuPopup').remove(); showArchivesPopup();">
          <span class="log-menu-icon">📁</span>
          <span class="log-menu-text">Registre</span>
          <span class="log-menu-desc">Liste de toutes les cartes archivées</span>
        </button>
        <button class="log-menu-btn" onclick="document.getElementById('logMenuPopup').remove(); showArchiveSlider();">
          <span class="log-menu-icon">🔍</span>
          <span class="log-menu-text">Consulter une par une</span>
          <span class="log-menu-desc">Naviguer avec un slider</span>
        </button>
        <button class="log-menu-btn" onclick="document.getElementById('logMenuPopup').remove(); printAllArchives();">
          <span class="log-menu-icon">🖨️</span>
          <span class="log-menu-text">Imprimer tout</span>
          <span class="log-menu-desc">Imprimer le registre complet</span>
        </button>
        <button class="log-menu-btn backup-btn" onclick="document.getElementById('logMenuPopup').remove(); showBackupsPopup();">
          <span class="log-menu-icon">💾</span>
          <span class="log-menu-text">Backups</span>
          <span class="log-menu-desc">Voir et restaurer les sauvegardes</span>
        </button>
      </div>
      <div class="log-menu-footer">
        <span>${archivedCards.length} carte(s) archivée(s)</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
}

// Afficher le registre (ancien showArchivesPopup)
function showArchivesPopup() {
  // Fermer si existe déjà
  document.getElementById('archivesPopup')?.remove();
  
  const popup = document.createElement('div');
  popup.id = 'archivesPopup';
  popup.className = 'archives-popup-overlay';
  popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
  
  let archivesHtml = '';
  if (archivedCards.length === 0) {
    archivesHtml = '<div class="archives-empty">Aucune carte archivée</div>';
  } else {
    archivedCards.forEach((archive, index) => {
      const deletedDate = new Date(archive.deletedAt).toLocaleDateString('fr-CA');
      const deptTime = archive.departmentTime || {};
      const deptTimeStr = Object.entries(deptTime).map(([d, t]) => `${d}: ${t}j`).join(', ') || '-';
      
      archivesHtml += `
        <div class="archive-card" onclick="toggleArchiveDetails(${index})">
          <div class="archive-header">
            <span class="archive-type ${archive.type}">${archive.type === 'moulage' ? '🔧' : '📦'}</span>
            <span class="archive-name">${archive.name}</span>
            <span class="archive-date">Supprimé le ${deletedDate}</span>
          </div>
          <div class="archive-summary">
            <span>Client: ${archive.client}</span>
            <span>N° Cmd: ${archive.order}</span>
            <span>Par: ${archive.deletedBy}</span>
          </div>
          <div class="archive-details" id="archiveDetails_${index}" style="display:none;">
            <div class="archive-detail-row"><span>N° PO:</span><span>${archive.numeroPO}</span></div>
            <div class="archive-detail-row"><span>Région:</span><span>${archive.region}</span></div>
            <div class="archive-detail-row"><span>Intervenant:</span><span>${archive.intervenant}</span></div>
            <div class="archive-detail-row"><span>Représentante:</span><span>${archive.representant}</span></div>
            <div class="archive-detail-row"><span>Date reçue:</span><span>${archive.dateRecue}</span></div>
            <div class="archive-detail-row"><span>Date livraison:</span><span>${archive.dateLivraison}</span></div>
            <div class="archive-detail-row"><span>Date essayage:</span><span>${archive.dateEssayage}</span></div>
            <div class="archive-detail-row"><span>Dernière colonne:</span><span>${archive.lastColumnName}</span></div>
            <div class="archive-detail-row"><span>Temps départements:</span><span>${deptTimeStr}</span></div>
            <div class="archive-detail-row"><span>Notes:</span><span>${archive.notes}</span></div>
          </div>
        </div>
      `;
    });
  }
  
  popup.innerHTML = `
    <div class="archives-popup">
      <div class="archives-header">
        <h2>📁 Registre des archives</h2>
        <span class="archives-count">${archivedCards.length} carte(s)</span>
        <button class="archives-close" onclick="document.getElementById('archivesPopup').remove()">✕</button>
      </div>
      <div class="archives-list">
        ${archivesHtml}
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
}

// Slider pour voir les archives une par une
function showArchiveSlider() {
  if (archivedCards.length === 0) {
    alert('Aucune carte archivée');
    return;
  }
  
  currentArchiveIndex = 0;
  renderArchiveSlider();
}

function renderArchiveSlider() {
  document.getElementById('archiveSliderPopup')?.remove();
  
  const archive = archivedCards[currentArchiveIndex];
  const deletedDate = new Date(archive.deletedAt).toLocaleDateString('fr-CA');
  const deptTime = archive.departmentTime || {};
  
  const popup = document.createElement('div');
  popup.id = 'archiveSliderPopup';
  popup.className = 'archives-popup-overlay';
  popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
  
  popup.innerHTML = `
    <div class="archive-slider-popup">
      <div class="archive-slider-header">
        <button class="slider-nav-btn" onclick="event.stopPropagation(); navigateArchive(-1)" ${currentArchiveIndex === 0 ? 'disabled' : ''}>◀ Précédent</button>
        <span class="slider-counter">${currentArchiveIndex + 1} / ${archivedCards.length}</span>
        <button class="slider-nav-btn" onclick="event.stopPropagation(); navigateArchive(1)" ${currentArchiveIndex === archivedCards.length - 1 ? 'disabled' : ''}>Suivant ▶</button>
        <button class="archives-close" onclick="document.getElementById('archiveSliderPopup').remove()">✕</button>
      </div>
      
      <div class="archive-slider-content" onclick="event.stopPropagation()">
        <div class="archive-slider-title">
          <span class="archive-type-big">${archive.type === 'moulage' ? '🔧' : '📦'}</span>
          <h2>${archive.name}</h2>
        </div>
        
        <div class="archive-slider-grid">
          <div class="archive-slider-field"><span class="label">Client:</span><span class="value">${archive.client}</span></div>
          <div class="archive-slider-field"><span class="label">N° Commande:</span><span class="value">${archive.order}</span></div>
          <div class="archive-slider-field"><span class="label">N° PO:</span><span class="value">${archive.numeroPO}</span></div>
          <div class="archive-slider-field"><span class="label">Région:</span><span class="value">${archive.region}</span></div>
          <div class="archive-slider-field"><span class="label">Intervenant:</span><span class="value">${archive.intervenant}</span></div>
          <div class="archive-slider-field"><span class="label">Représentante:</span><span class="value">${archive.representant}</span></div>
          <div class="archive-slider-field"><span class="label">Date reçue:</span><span class="value">${archive.dateRecue}</span></div>
          <div class="archive-slider-field"><span class="label">Date livraison:</span><span class="value">${archive.dateLivraison}</span></div>
          <div class="archive-slider-field"><span class="label">Date essayage:</span><span class="value">${archive.dateEssayage}</span></div>
          <div class="archive-slider-field"><span class="label">Dernière colonne:</span><span class="value">${archive.lastColumnName}</span></div>
        </div>
        
        <div class="archive-slider-section">
          <h3>⏱ Temps par département</h3>
          <div class="archive-dept-times">
            ${Object.entries(deptTime).map(([dept, days]) => `<span class="dept-time-pill">${dept}: ${days}j</span>`).join('') || '<span class="no-data">Aucune donnée</span>'}
          </div>
        </div>
        
        <div class="archive-slider-section">
          <h3>📝 Notes</h3>
          <div class="archive-notes-box">${archive.notes || '-'}</div>
        </div>
        
        <div class="archive-slider-footer">
          <span>Supprimé le ${deletedDate} par ${archive.deletedBy}</span>
        </div>
      </div>
      
      <div class="archive-slider-range" onclick="event.stopPropagation()">
        <input type="range" min="0" max="${archivedCards.length - 1}" value="${currentArchiveIndex}" 
          onchange="currentArchiveIndex = parseInt(this.value); renderArchiveSlider();"
          oninput="document.getElementById('sliderPreview').textContent = (parseInt(this.value) + 1) + ' / ${archivedCards.length}'">
        <span id="sliderPreview">${currentArchiveIndex + 1} / ${archivedCards.length}</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
}

function navigateArchive(direction) {
  currentArchiveIndex += direction;
  if (currentArchiveIndex < 0) currentArchiveIndex = 0;
  if (currentArchiveIndex >= archivedCards.length) currentArchiveIndex = archivedCards.length - 1;
  renderArchiveSlider();
}

// Imprimer tout le registre
function printAllArchives() {
  if (archivedCards.length === 0) {
    alert('Aucune carte archivée à imprimer');
    return;
  }
  
  let printHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Registre des Archives - PhysiPro</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; font-size: 11px; }
        h1 { font-size: 18px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .archive-item { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 15px; page-break-inside: avoid; }
        .archive-item h2 { font-size: 14px; margin: 0 0 10px 0; color: #1e3a5f; }
        .archive-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .archive-field { display: flex; gap: 5px; }
        .archive-field .label { font-weight: bold; color: #666; }
        .archive-field .value { color: #000; }
        .dept-times { margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px; }
        .notes-box { margin-top: 10px; padding: 8px; background: #fffde7; border-radius: 4px; font-style: italic; }
        .footer { font-size: 9px; color: #999; margin-top: 8px; border-top: 1px dotted #ccc; padding-top: 5px; }
        @media print { .archive-item { break-inside: avoid; } }
      </style>
    </head>
    <body>
      <h1>📋 Registre des Archives - PhysiPro</h1>
      <p>Total: ${archivedCards.length} carte(s) archivée(s) | Imprimé le ${new Date().toLocaleDateString('fr-CA')}</p>
  `;
  
  archivedCards.forEach((archive, index) => {
    const deletedDate = new Date(archive.deletedAt).toLocaleDateString('fr-CA');
    const deptTime = archive.departmentTime || {};
    const deptTimeStr = Object.entries(deptTime).map(([d, t]) => `${d}: ${t}j`).join(' | ') || 'Aucune donnée';
    
    printHtml += `
      <div class="archive-item">
        <h2>${archive.type === 'moulage' ? '🔧' : '📦'} ${archive.name}</h2>
        <div class="archive-grid">
          <div class="archive-field"><span class="label">Client:</span><span class="value">${archive.client}</span></div>
          <div class="archive-field"><span class="label">N° Cmd:</span><span class="value">${archive.order}</span></div>
          <div class="archive-field"><span class="label">N° PO:</span><span class="value">${archive.numeroPO}</span></div>
          <div class="archive-field"><span class="label">Région:</span><span class="value">${archive.region}</span></div>
          <div class="archive-field"><span class="label">Intervenant:</span><span class="value">${archive.intervenant}</span></div>
          <div class="archive-field"><span class="label">Représentante:</span><span class="value">${archive.representant}</span></div>
          <div class="archive-field"><span class="label">Date reçue:</span><span class="value">${archive.dateRecue}</span></div>
          <div class="archive-field"><span class="label">Date livraison:</span><span class="value">${archive.dateLivraison}</span></div>
          <div class="archive-field"><span class="label">Date essayage:</span><span class="value">${archive.dateEssayage}</span></div>
        </div>
        <div class="dept-times"><strong>Temps par département:</strong> ${deptTimeStr}</div>
        ${archive.notes && archive.notes !== '-' ? `<div class="notes-box"><strong>Notes:</strong> ${archive.notes}</div>` : ''}
        <div class="footer">Supprimé le ${deletedDate} par ${archive.deletedBy} | Dernière colonne: ${archive.lastColumnName}</div>
      </div>
    `;
  });
  
  printHtml += `
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printHtml);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 300);
}

function toggleArchiveDetails(index) {
  const details = document.getElementById('archiveDetails_' + index);
  if (details) {
    details.style.display = details.style.display === 'none' ? 'block' : 'none';
  }
}

// Charger les archives au démarrage
loadArchivedCards();

// ===== SYSTÈME DE BACKUP AUTOMATIQUE =====
const MAX_BACKUPS = 7; // Garder 7 backups (1 semaine)
let backupsList = [];

// Charger la liste des backups depuis localStorage
function loadBackupsList() {
  try {
    const stored = localStorage.getItem('physipro_backups_list');
    if (stored) {
      backupsList = JSON.parse(stored);
      console.log(`💾 ${backupsList.length} backup(s) trouvé(s)`);
    }
  } catch (e) {
    console.error('Erreur chargement liste backups:', e);
    backupsList = [];
  }
}

// Sauvegarder la liste des backups
function saveBackupsList() {
  try {
    localStorage.setItem('physipro_backups_list', JSON.stringify(backupsList));
  } catch (e) {
    console.error('Erreur sauvegarde liste backups:', e);
  }
}

// Créer un backup complet
function createBackup(userName) {
  const backupId = 'backup_' + Date.now();
  const now = new Date();
  
  const backup = {
    id: backupId,
    createdAt: now.toISOString(),
    createdBy: userName || 'Inconnu',
    dateFormatted: now.toLocaleDateString('fr-CA') + ' ' + now.toLocaleTimeString('fr-CA'),
    data: {
      cardsData: JSON.parse(JSON.stringify(cardsData || {})),
      commandesData: JSON.parse(JSON.stringify(commandesData || {})),
      archivedCards: JSON.parse(JSON.stringify(archivedCards || [])),
      customRecettes: JSON.parse(JSON.stringify(window.customRecettes || {}))
    },
    stats: {
      totalMoulages: Object.keys(cardsData || {}).length,
      totalCommandes: Object.keys(commandesData || {}).length,
      totalArchives: (archivedCards || []).length
    }
  };
  
  // Ajouter au début de la liste
  backupsList.unshift({
    id: backupId,
    createdAt: backup.createdAt,
    createdBy: backup.createdBy,
    dateFormatted: backup.dateFormatted,
    stats: backup.stats
  });
  
  // Garder seulement les 7 derniers
  if (backupsList.length > MAX_BACKUPS) {
    const oldBackups = backupsList.splice(MAX_BACKUPS);
    // Supprimer les vieux backups du localStorage et Firebase
    oldBackups.forEach(old => {
      localStorage.removeItem('physipro_backup_' + old.id);
      if (firebaseDb) {
        firebaseDb.ref('backups/' + old.id).remove();
      }
    });
    console.log(`🗑️ ${oldBackups.length} ancien(s) backup(s) supprimé(s)`);
  }
  
  // Sauvegarder dans localStorage
  try {
    localStorage.setItem('physipro_backup_' + backupId, JSON.stringify(backup));
    saveBackupsList();
    console.log(`💾 Backup local créé: ${backupId}`);
  } catch (e) {
    console.error('Erreur backup localStorage:', e);
  }
  
  // Sauvegarder dans Firebase (cloud)
  if (firebaseDb) {
    firebaseDb.ref('backups/' + backupId).set(backup)
      .then(() => console.log(`☁️ Backup cloud créé: ${backupId}`))
      .catch(e => console.error('Erreur backup Firebase:', e));
  }
  
  return backup;
}

// Vérifier si un backup est nécessaire (pas de backup aujourd'hui)
function shouldCreateBackup() {
  if (backupsList.length === 0) return true;
  
  const lastBackup = new Date(backupsList[0].createdAt);
  const today = new Date();
  
  // Vérifier si le dernier backup est d'un jour différent
  return lastBackup.toDateString() !== today.toDateString();
}

// Effectuer un backup automatique pour Daniel
function performAutoBackup(userName) {
  if (shouldCreateBackup()) {
    // Attendre un peu que les données soient chargées
    setTimeout(() => {
      const backup = createBackup(userName);
      showBackupNotification(backup);
    }, 3000);
  } else {
    console.log('📅 Backup déjà effectué aujourd\'hui');
  }
}

// Afficher notification de backup
function showBackupNotification(backup) {
  const notification = document.createElement('div');
  notification.className = 'backup-notification';
  notification.innerHTML = `
    <div class="backup-notif-content">
      <span class="backup-notif-icon">✅</span>
      <div class="backup-notif-text">
        <strong>Backup automatique effectué!</strong>
        <span>${backup.stats.totalMoulages} moulages, ${backup.stats.totalCommandes} commandes</span>
      </div>
      <button onclick="this.parentElement.parentElement.remove()">✕</button>
    </div>
  `;
  document.body.appendChild(notification);
  
  // Disparaît après 5 secondes
  setTimeout(() => notification.remove(), 5000);
}

// Afficher la liste des backups pour restauration
function showBackupsPopup() {
  document.getElementById('backupsPopup')?.remove();
  
  const popup = document.createElement('div');
  popup.id = 'backupsPopup';
  popup.className = 'archives-popup-overlay';
  popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
  
  let backupsHtml = '';
  if (backupsList.length === 0) {
    backupsHtml = '<div class="archives-empty">Aucun backup disponible</div>';
  } else {
    backupsList.forEach((backup, index) => {
      backupsHtml += `
        <div class="backup-item">
          <div class="backup-info">
            <span class="backup-date">${backup.dateFormatted}</span>
            <span class="backup-by">Par: ${backup.createdBy}</span>
          </div>
          <div class="backup-stats">
            <span>🔧 ${backup.stats.totalMoulages} moulages</span>
            <span>📦 ${backup.stats.totalCommandes} commandes</span>
            <span>📁 ${backup.stats.totalArchives} archives</span>
          </div>
          <button class="backup-restore-btn" onclick="confirmRestore('${backup.id}')">
            Restaurer
          </button>
        </div>
      `;
    });
  }
  
  popup.innerHTML = `
    <div class="archives-popup">
      <div class="archives-header">
        <h2>💾 Backups disponibles</h2>
        <span class="archives-count">${backupsList.length} / ${MAX_BACKUPS}</span>
        <button class="archives-close" onclick="document.getElementById('backupsPopup').remove()">✕</button>
      </div>
      <div class="archives-list">
        ${backupsHtml}
      </div>
      <div class="backup-manual-section">
        <button class="backup-manual-btn" onclick="manualBackup()">
          ➕ Créer un backup maintenant
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
}

// Backup manuel
function manualBackup() {
  const userName = window._sessionUserName || 'Manuel';
  const backup = createBackup(userName);
  showBackupNotification(backup);
  document.getElementById('backupsPopup')?.remove();
  showBackupsPopup(); // Rafraîchir la liste
}

// Confirmer restauration
function confirmRestore(backupId) {
  if (confirm('⚠️ ATTENTION!\n\nRestaurer ce backup va remplacer TOUTES les données actuelles.\n\nÊtes-vous sûr de vouloir continuer?')) {
    restoreBackup(backupId);
  }
}

// Restaurer un backup
function restoreBackup(backupId) {
  try {
    const backupData = localStorage.getItem('physipro_backup_' + backupId);
    if (!backupData) {
      // Essayer depuis Firebase
      if (firebaseDb) {
        firebaseDb.ref('backups/' + backupId).once('value', (snapshot) => {
          const backup = snapshot.val();
          if (backup) {
            applyBackup(backup);
          } else {
            alert('Backup introuvable!');
          }
        });
      } else {
        alert('Backup introuvable!');
      }
      return;
    }
    
    const backup = JSON.parse(backupData);
    applyBackup(backup);
    
  } catch (e) {
    console.error('Erreur restauration:', e);
    alert('Erreur lors de la restauration: ' + e.message);
  }
}

// Appliquer les données d'un backup
function applyBackup(backup) {
  try {
    // Restaurer les données
    if (backup.data.cardsData) {
      cardsData = backup.data.cardsData;
      // Sauvegarder dans Firebase
      if (firebaseDb) {
        Object.entries(cardsData).forEach(([id, card]) => {
          firebaseDb.ref('cards/' + id).set(card);
        });
      }
    }
    
    if (backup.data.commandesData) {
      commandesData = backup.data.commandesData;
      if (firebaseDb) {
        Object.entries(commandesData).forEach(([id, cmd]) => {
          firebaseDb.ref('commandes/' + id).set(cmd);
        });
      }
    }
    
    if (backup.data.archivedCards) {
      archivedCards = backup.data.archivedCards;
      saveArchivedCards();
    }
    
    if (backup.data.customRecettes) {
      window.customRecettes = backup.data.customRecettes;
      localStorage.setItem('physipro_custom_recettes', JSON.stringify(backup.data.customRecettes));
    }
    
    alert(`✅ Backup restauré avec succès!\n\nDate du backup: ${backup.dateFormatted}\n\nLa page va se recharger.`);
    location.reload();
    
  } catch (e) {
    console.error('Erreur application backup:', e);
    alert('Erreur: ' + e.message);
  }
}

// Charger les backups au démarrage
loadBackupsList();

// ===== CALCUL DES JOURS OUVRABLES (EXCLUANT WEEKENDS ET JOURS FÉRIÉS QUÉBEC) =====
function getJoursFeriesQuebec(year) {
  const feries = [];
  // Jour de l'An
  feries.push(new Date(year, 0, 1));
  // Fête nationale du Québec
  feries.push(new Date(year, 5, 24));
  // Fête du Canada
  feries.push(new Date(year, 6, 1));
  // Noël
  feries.push(new Date(year, 11, 25));
  
  // Pâques et jours associés
  const paques = getPaquesDate(year);
  const vendrediSaint = new Date(paques);
  vendrediSaint.setDate(paques.getDate() - 2);
  feries.push(vendrediSaint);
  
  const lundiPaques = new Date(paques);
  lundiPaques.setDate(paques.getDate() + 1);
  feries.push(lundiPaques);
  
  // Fête du Travail (1er lundi de septembre)
  const feteTravail = new Date(year, 8, 1);
  while (feteTravail.getDay() !== 1) {
    feteTravail.setDate(feteTravail.getDate() + 1);
  }
  feries.push(feteTravail);
  
  // Action de grâce (2e lundi d'octobre)
  const actionGraces = new Date(year, 9, 1);
  let countMonday = 0;
  while (countMonday < 2) {
    if (actionGraces.getDay() === 1) countMonday++;
    if (countMonday < 2) actionGraces.setDate(actionGraces.getDate() + 1);
  }
  feries.push(actionGraces);
  
  return feries;
}

function getPaquesDate(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(year, month, day);
}

function estJourFerie(date, joursFeries) {
  const dateStr = date.toDateString();
  return joursFeries.some(ferie => ferie.toDateString() === dateStr);
}

function estWeekend(date) {
  const day = date.getDay();
  return day === 0 || day === 6;
}

function calculerJoursOuvrables(dateDebut, dateFin) {
  let joursOuvrables = 0;
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  debut.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  const anneeDebut = debut.getFullYear();
  const anneeFin = fin.getFullYear();
  let joursFeries = [];
  
  for (let annee = anneeDebut; annee <= anneeFin; annee++) {
    joursFeries = joursFeries.concat(getJoursFeriesQuebec(annee));
  }
  
  const currentDate = new Date(debut);
  while (currentDate < fin) {
    currentDate.setDate(currentDate.getDate() + 1);
    if (!estWeekend(currentDate) && !estJourFerie(currentDate, joursFeries)) {
      joursOuvrables++;
    }
  }
  return joursOuvrables;
}

// ===== SYSTÈME DE LOGIN NIVEAU 2 - EMAIL + MOT DE PASSE =====
const loginOverlay = document.getElementById('loginOverlay');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const userStatusEl = document.getElementById('userStatus');
const btnAuth = document.getElementById('btnAuth');

// Éléments changement de mot de passe
const changePasswordOverlay = document.getElementById('changePasswordOverlay');
const changePasswordUser = document.getElementById('changePasswordUser');
const newPassword1 = document.getElementById('newPassword1');
const newPassword2 = document.getElementById('newPassword2');
const changePasswordBtn = document.getElementById('changePasswordBtn');
const changePasswordError = document.getElementById('changePasswordError');
const reqLength = document.getElementById('reqLength');
const reqMatch = document.getElementById('reqMatch');

// Éléments mot de passe oublié
const forgotPasswordOverlay = document.getElementById('forgotPasswordOverlay');
const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
const forgotEmail = document.getElementById('forgotEmail');
const sendResetBtn = document.getElementById('sendResetBtn');
const backToLoginBtn = document.getElementById('backToLoginBtn');
const forgotPasswordError = document.getElementById('forgotPasswordError');
const forgotPasswordSuccess = document.getElementById('forgotPasswordSuccess');

// Variable pour stocker les infos pendant le changement de mot de passe
let pendingUserInfo = null;
let pendingUserEmail = null;

// Élément Remember Me
const rememberMeCheckbox = document.getElementById('rememberMe');

// Charger les credentials sauvegardés au démarrage
function loadSavedCredentials() {
  try {
    const saved = localStorage.getItem('physipro_remember');
    if (saved) {
      const data = JSON.parse(saved);
      if (data.email && data.password) {
        loginEmail.value = data.email;
        loginPassword.value = data.password;
        rememberMeCheckbox.checked = true;
        console.log("📝 Credentials chargés pour " + data.email);
      }
    }
  } catch(e) {
    console.error("Erreur chargement credentials:", e);
  }
}

// Sauvegarder les credentials si "Se souvenir de moi" est coché
function saveCredentials(email, password) {
  if (rememberMeCheckbox?.checked) {
    localStorage.setItem('physipro_remember', JSON.stringify({ email, password }));
    console.log("💾 Credentials sauvegardés");
  } else {
    localStorage.removeItem('physipro_remember');
  }
}

// Effacer les credentials sauvegardés
function clearSavedCredentials() {
  localStorage.removeItem('physipro_remember');
}

// Charger au démarrage
setTimeout(() => {
  loadSavedCredentials();
  if (!loginEmail.value) {
    loginEmail?.focus();
  }
}, 100);

// Event listeners login
loginBtn?.addEventListener('click', attemptLogin);
loginEmail?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') loginPassword?.focus();
});
loginPassword?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') attemptLogin();
});

// Event listeners mot de passe oublié
forgotPasswordBtn?.addEventListener('click', () => {
  loginOverlay.classList.add('hidden');
  forgotPasswordOverlay.classList.remove('hidden');
  forgotEmail.value = loginEmail.value || '';
  forgotEmail.focus();
  forgotPasswordError.textContent = '';
  forgotPasswordSuccess.classList.add('hidden');
});

backToLoginBtn?.addEventListener('click', () => {
  forgotPasswordOverlay.classList.add('hidden');
  loginOverlay.classList.remove('hidden');
  loginEmail.focus();
});

sendResetBtn?.addEventListener('click', sendPasswordReset);
forgotEmail?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendPasswordReset();
});

// Event listeners changement de mot de passe
newPassword1?.addEventListener('input', validateNewPassword);
newPassword2?.addEventListener('input', validateNewPassword);
changePasswordBtn?.addEventListener('click', changePassword);
newPassword2?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !changePasswordBtn.disabled) changePassword();
});

// Validation du nouveau mot de passe en temps réel
function validateNewPassword() {
  const pwd1 = newPassword1.value;
  const pwd2 = newPassword2.value;
  
  const lengthOk = pwd1.length >= 8;
  const matchOk = pwd1 === pwd2 && pwd2.length > 0;
  
  reqLength.textContent = lengthOk ? '✅ Au moins 8 caractères' : '❌ Au moins 8 caractères';
  reqLength.className = 'req ' + (lengthOk ? 'valid' : 'invalid');
  
  reqMatch.textContent = matchOk ? '✅ Les mots de passe correspondent' : '❌ Les mots de passe correspondent';
  reqMatch.className = 'req ' + (matchOk ? 'valid' : 'invalid');
  
  changePasswordBtn.disabled = !(lengthOk && matchOk);
}

// Envoyer email de réinitialisation
async function sendPasswordReset() {
  const email = forgotEmail.value.trim().toLowerCase();
  
  if (!email) {
    forgotPasswordError.textContent = "Veuillez entrer votre email";
    return;
  }
  
  sendResetBtn.textContent = "Envoi en cours...";
  sendResetBtn.disabled = true;
  forgotPasswordError.textContent = '';
  
  try {
    await firebaseAuth.sendPasswordResetEmail(email);
    forgotPasswordSuccess.textContent = "✅ Un email de réinitialisation a été envoyé à " + email + ". Vérifiez votre boîte de réception (et les spams).";
    forgotPasswordSuccess.classList.remove('hidden');
    forgotPasswordError.textContent = '';
  } catch(error) {
    console.error("Erreur reset password:", error);
    let errorMsg = "Erreur lors de l'envoi";
    if (error.code === 'auth/user-not-found') {
      errorMsg = "Aucun compte n'existe avec cet email";
    } else if (error.code === 'auth/invalid-email') {
      errorMsg = "Format d'email invalide";
    }
    forgotPasswordError.textContent = errorMsg;
  }
  
  sendResetBtn.textContent = "Envoyer le lien";
  sendResetBtn.disabled = false;
}

// Tentative de connexion avec email + mot de passe
async function attemptLogin() {
  const email = loginEmail.value.trim().toLowerCase();
  const password = loginPassword.value;
  
  if (!email) {
    loginError.textContent = "Veuillez entrer votre email";
    loginEmail.focus();
    return;
  }
  
  if (!password) {
    loginError.textContent = "Veuillez entrer votre mot de passe";
    loginPassword.focus();
    return;
  }
  
  // Vérifier si l'email est dans notre liste d'utilisateurs autorisés
  const userInfo = USERS[email];
  
  if (!userInfo) {
    loginError.textContent = "Cet email n'est pas autorisé";
    loginEmail.value = "";
    loginEmail.focus();
    return;
  }
  
  // Afficher indicateur de chargement
  loginBtn.textContent = "Connexion...";
  loginBtn.disabled = true;
  loginError.textContent = "";
  
  try {
    // Connexion via Firebase Authentication
    await firebaseAuth.signInWithEmailAndPassword(email, password);
    console.log("✅ Connexion réussie pour " + email);
    
    // Vérifier si c'est le mot de passe temporaire (premier login)
    // On compare le hash du mot de passe entré avec le hash stocké
    const passwordHash = await hashPassword(password);
    const isFirstLogin = passwordHash === userInfo.tempHash;
    
    if (isFirstLogin) {
      // Afficher le popup de changement de mot de passe
      pendingUserInfo = userInfo;
      pendingUserEmail = email;
      // Ne pas sauvegarder le mot de passe temporaire
      clearSavedCredentials();
      loginOverlay.classList.add('hidden');
      changePasswordOverlay.classList.remove('hidden');
      changePasswordUser.innerHTML = `<strong>${userInfo.name}</strong><br><small>${email}</small>`;
      newPassword1.value = '';
      newPassword2.value = '';
      changePasswordError.textContent = '';
      validateNewPassword();
      newPassword1.focus();
    } else {
      // Sauvegarder les credentials si demandé
      saveCredentials(email, password);
      // Connexion normale
      loginUserSuccess(userInfo, email);
    }
    
  } catch(error) {
    console.error("❌ Erreur connexion:", error);
    
    let errorMessage = "Erreur de connexion";
    switch(error.code) {
      case "auth/wrong-password":
      case "auth/invalid-credential":
        errorMessage = "Email ou mot de passe incorrect";
        break;
      case "auth/user-not-found":
        errorMessage = "Compte non trouvé. Contactez l'administrateur.";
        break;
      case "auth/too-many-requests":
        errorMessage = "Trop de tentatives. Réessayez dans quelques minutes.";
        break;
      case "auth/network-request-failed":
        errorMessage = "Erreur réseau. Vérifiez votre connexion.";
        break;
      case "auth/invalid-email":
        errorMessage = "Format d'email invalide";
        break;
    }
    
    loginError.textContent = errorMessage;
    loginPassword.value = "";
    loginPassword.focus();
  }
  
  // Restaurer le bouton
  loginBtn.textContent = "Se connecter";
  loginBtn.disabled = false;
}

// Changer le mot de passe (premier login)
async function changePassword() {
  const newPwd = newPassword1.value;
  
  if (newPwd.length < 8) {
    changePasswordError.textContent = "Le mot de passe doit faire au moins 8 caractères";
    return;
  }
  
  if (newPwd !== newPassword2.value) {
    changePasswordError.textContent = "Les mots de passe ne correspondent pas";
    return;
  }
  
  changePasswordBtn.textContent = "Mise à jour...";
  changePasswordBtn.disabled = true;
  changePasswordError.textContent = '';
  
  try {
    // Mettre à jour le mot de passe dans Firebase
    const user = firebaseAuth.currentUser;
    await user.updatePassword(newPwd);
    
    console.log("✅ Mot de passe mis à jour pour " + pendingUserEmail);
    
    // Sauvegarder les nouveaux credentials si checkbox coché
    if (rememberMeCheckbox?.checked) {
      saveCredentials(pendingUserEmail, newPwd);
    }
    
    // Masquer le popup et continuer la connexion
    changePasswordOverlay.classList.add('hidden');
    loginUserSuccess(pendingUserInfo, pendingUserEmail);
    
  } catch(error) {
    console.error("❌ Erreur changement mot de passe:", error);
    
    let errorMsg = "Erreur lors du changement de mot de passe";
    if (error.code === 'auth/weak-password') {
      errorMsg = "Mot de passe trop faible. Utilisez au moins 8 caractères.";
    } else if (error.code === 'auth/requires-recent-login') {
      errorMsg = "Session expirée. Veuillez vous reconnecter.";
      setTimeout(() => location.reload(), 2000);
    }
    
    changePasswordError.textContent = errorMsg;
  }
  
  changePasswordBtn.textContent = "Créer mon mot de passe";
  changePasswordBtn.disabled = false;
}

// Connexion réussie
function loginUserSuccess(userInfo, email) {
  currentUser = { ...userInfo, email: email };
  _sessionValid = true;
  
  // Stocker le nom de l'utilisateur pour les notes
  window._sessionUserName = userInfo.name;
  
  // Masquer tous les overlays de login
  loginOverlay.classList.add('hidden');
  changePasswordOverlay.classList.add('hidden');
  forgotPasswordOverlay.classList.add('hidden');
  
  // Mettre à jour le badge utilisateur avec le rôle
  const statusDot = userStatusEl?.querySelector('.status-dot');
  const userName = userStatusEl?.querySelector('.user-name');
  
  if (statusDot) statusDot.classList.remove('offline');
  if (userName) {
    const roleBadge = getRoleBadge(userInfo.role);
    userName.innerHTML = userInfo.name + roleBadge;
  }
  if (btnAuth) {
    btnAuth.textContent = 'Déconnexion';
    btnAuth.classList.remove('login');
  }
  
  console.log("🔐 Session établie pour " + userInfo.name + " (" + userInfo.role + ")");
  
  // Charger les cartes depuis Firebase
  loadCardsFromFirebase();
  
  // Charger les listes personnalisées
  loadCustomLists();
  
  // BACKUP AUTOMATIQUE pour les admins
  if (userInfo.role === 'admin') {
    performAutoBackup(userInfo.name);
  }
}

// Générer le badge de rôle HTML
function getRoleBadge(role) {
  const labels = {
    admin: 'Admin',
    editor: 'Éditeur',
    operator: 'Opérateur',
    viewer: 'Lecteur'
  };
  return `<span class="user-role-badge ${role}">${labels[role] || role}</span>`;
}

// Vérifier les permissions de l'utilisateur
function userCan(action) {
  if (!currentUser) return false;
  
  const permissions = {
    admin: ['view', 'edit', 'add', 'delete', 'move', 'manage_users', 'view_logs', 'export', 'import'],
    editor: ['view', 'edit', 'add', 'delete', 'move', 'export'],
    operator: ['view', 'edit', 'move'],
    viewer: ['view']
  };
  
  const userPermissions = permissions[currentUser.role] || [];
  return userPermissions.includes(action);
}

// Déconnexion
async function logout() {
  try {
    await firebaseAuth.signOut();
    console.log("🔓 Déconnexion réussie");
  } catch(e) {
    console.error("Erreur déconnexion:", e);
  }
  
  _sessionValid = false;
  currentUser = null;
  pendingUserInfo = null;
  pendingUserEmail = null;
  location.reload();
}

// ===== MODAL LOG =====
const logModal = document.getElementById('logModal');
const closeLogModal = document.getElementById('closeLogModal');

// Attendre que le DOM soit prêt pour les boutons
document.addEventListener('DOMContentLoaded', () => {
  // ===== DÉLÉGATION D'ÉVÉNEMENTS GLOBALE POUR BOUTONS FICHE =====
  // Cette approche capture les clics au niveau du document et les délègue
  // C'est plus fiable que les onclick ou addEventListener sur chaque bouton
  document.addEventListener('click', function(e) {
    // Vérifier si le clic est sur un bouton Fiche moulage
    const ficheBtn = e.target.closest('.mcard-toggle-btn[data-action="open-fiche"]');
    if (ficheBtn) {
      e.stopPropagation();
      e.preventDefault();
      const cardId = ficheBtn.dataset.cardId;
      if (cardId) {
        openMoulageFiche(cardId);
      }
      return;
    }
  }, true); // true = capture phase, se déclenche AVANT les autres handlers
  
  console.log('✅ Délégation globale pour boutons Fiche activée');

  // ===== MENU SETTINGS =====
  const btnSettings = document.getElementById('btnSettings');
  const settingsMenuOverlay = document.getElementById('settingsMenuOverlay');
  const settingsCloseBtn = document.getElementById('settingsCloseBtn');
  const settingsLogBtn = document.getElementById('settingsLogBtn');
  const settingsLogoutBtn = document.getElementById('settingsLogoutBtn');
  const settingsImportExportBtn = document.getElementById('settingsImportExportBtn');
  
  // Ouvrir le menu Settings
  if (btnSettings) {
    btnSettings.addEventListener('click', () => {
      settingsMenuOverlay?.classList.remove('hidden');
    });
    console.log('✅ Bouton Settings connecté');
  }
  
  // Fermer le menu Settings
  if (settingsCloseBtn) {
    settingsCloseBtn.addEventListener('click', () => {
      settingsMenuOverlay?.classList.add('hidden');
    });
  }
  
  // Clic sur l'overlay ferme le menu
  if (settingsMenuOverlay) {
    settingsMenuOverlay.addEventListener('click', (e) => {
      if (e.target === settingsMenuOverlay) {
        settingsMenuOverlay.classList.add('hidden');
      }
    });
  }
  
  // Bouton Import/Export dans Settings
  if (settingsImportExportBtn) {
    settingsImportExportBtn.addEventListener('click', () => {
      settingsMenuOverlay?.classList.add('hidden');
      openImportExportMenu();
    });
  }
  
  // Bouton Log dans Settings
  if (settingsLogBtn) {
    settingsLogBtn.addEventListener('click', () => {
      settingsMenuOverlay?.classList.add('hidden');
      showLogMenu();
    });
  }
  
  // Bouton Déconnexion dans Settings
  if (settingsLogoutBtn) {
    settingsLogoutBtn.addEventListener('click', () => {
      settingsMenuOverlay?.classList.add('hidden');
      if (currentUser) {
        logout();
      } else {
        loginOverlay.classList.remove('hidden');
        loginPassword?.focus();
      }
    });
  }
});

closeLogModal?.addEventListener('click', () => logModal?.classList.remove('active'));

function addLogEntry(action, details) {
  // Utiliser le nom de l'utilisateur connecté
  let userName = 'Anonyme';
  if (currentUser?.name) {
    userName = currentUser.name;
  } else if (currentUser?.email && USERS[currentUser.email]) {
    userName = USERS[currentUser.email].name;
  }
  
  const entry = {
    time: new Date().toLocaleString('fr-CA'),
    user: userName,
    action,
    details
  };
  logEntries.unshift(entry);
  if (logEntries.length > 100) logEntries.pop();
  
  // Note: Les logs restent locaux (pas de permission Firebase pour /logs)
}

function renderLogEntries() {
  const container = document.getElementById('logEntries');
  if (logEntries.length === 0) {
    container.innerHTML = '<div class="log-entry"><div class="log-time">Aucune entrée</div></div>';
    return;
  }
  
  container.innerHTML = logEntries.map(e => `
    <div class="log-entry">
      <div class="log-time">${e.time} - ${e.user}</div>
      <div><strong>${e.action}</strong>: ${e.details}</div>
    </div>
  `).join('');
}

// ===== MODAL AJOUTER MOULAGE =====
const addModal = document.getElementById('addModal');
const btnAddMoulage = document.getElementById('btnAddMoulage');
const closeAddModal = document.getElementById('closeAddModal');
const cancelAdd = document.getElementById('cancelAdd');
const confirmAdd = document.getElementById('confirmAdd');

btnAddMoulage.addEventListener('click', () => {
  if (!_sessionValid) {
    loginOverlay.classList.remove('hidden');
    loginEmail.focus();
    return;
  }
  
  // Vérifier les permissions
  if (!userCan('add')) {
    alert("⛔ Vous n'avez pas la permission d'ajouter des moulages.\nVotre rôle: " + (currentUser?.role || 'inconnu'));
    return;
  }
  
  // Initialiser les selects avec les listes personnalisées
  updateAllSelectsFromLists();
  
  // Reset les champs de date
  document.getElementById('addDateRecue').value = '';
  document.getElementById('addDateRobot').value = '';
  const dateRecueDisplay = document.getElementById('addDateRecueDisplay');
  const dateRobotDisplay = document.getElementById('addDateRobotDisplay');
  const dateRecueField = document.getElementById('addDateRecueField');
  const dateRobotField = document.getElementById('addDateRobotField');
  if (dateRecueDisplay) dateRecueDisplay.textContent = '-- Sélectionner --';
  if (dateRobotDisplay) dateRobotDisplay.textContent = '-- Sélectionner --';
  if (dateRecueField) dateRecueField.classList.remove('has-value');
  if (dateRobotField) dateRobotField.classList.remove('has-value');
  
  // Reset les autres champs
  document.getElementById('addClient').value = '';
  document.getElementById('addName').value = '';
  document.getElementById('addOrder').value = '';
  document.getElementById('addNumeroPO').value = '';
  document.getElementById('addIntervenant').value = '';
  document.getElementById('addRepresentant').value = '';
  
  addModal.classList.add('active');
  document.getElementById('addName').focus();
});

closeAddModal.addEventListener('click', () => addModal.classList.remove('active'));
cancelAdd.addEventListener('click', () => addModal.classList.remove('active'));

confirmAdd.addEventListener('click', () => {
  const client = document.getElementById('addClient').value || '';
  const name = document.getElementById('addName').value.trim() || 'Nom du moulage';
  const dateRecue = document.getElementById('addDateRecue').value || new Date().toISOString().split('T')[0];
  const dateRobot = document.getElementById('addDateRobot').value || '';
  const order = document.getElementById('addOrder').value.trim() || '000000';
  const numeroPO = document.getElementById('addNumeroPO').value.trim() || '';
  const region = document.getElementById('addRegion').value || 'Québec';
  const intervenant = document.getElementById('addIntervenant').value || '';
  const representant = document.getElementById('addRepresentant').value || '';
  
  // Créer la carte avec les données additionnelles
  const cardId = createCard(name, order, region, 0);
  
  // Mettre à jour les données supplémentaires
  if (cardsData[cardId]) {
    cardsData[cardId].client = client;
    cardsData[cardId].dateRecue = dateRecue;
    cardsData[cardId].dateRobot = dateRobot;
    cardsData[cardId].numeroPO = numeroPO;
    cardsData[cardId].intervenant = intervenant;
    cardsData[cardId].representant = representant;
    saveCardToFirebase(cardId);
  }
  
  addModal.classList.remove('active');
  
  // Reset les champs
  document.getElementById('addClient').value = '';
  document.getElementById('addName').value = '';
  document.getElementById('addDateRecue').value = '';
  document.getElementById('addDateRobot').value = '';
  document.getElementById('addOrder').value = '';
  document.getElementById('addNumeroPO').value = '';
  document.getElementById('addIntervenant').value = '';
  document.getElementById('addRepresentant').value = '';
  
  addLogEntry('Ajout', `Moulage "${name}" créé`);
  
  // Rafraîchir la table Robot si elle est active
  if (isRobotViewActive) {
    setTimeout(() => renderRobotTable(), 300);
  }
});

// ===== SYSTÈME DE GESTION DES LISTES PERSONNALISABLES =====
// Listes par défaut (seront écrasées par Firebase si disponible)
let customLists = {
  moulageClients: [
    'SAT IRDPQ Hamel',
    'SAT CRDPCA',
    'SAT Jonquiere Saguenay Lac Saint Jean',
    'SAT Gaspésie Saint Anne des Monts',
    'SAT Baie Comeau',
    'SAT Sept Iles',
    'SAT Trois Rivieres',
    'SAT Joliette',
    'SAT Mont Joli',
    'SAT CRE Sherbrooke',
    'Stan Cassidy Nouveau Brunswick',
    'Metro Health Nouveau Brunswick',
    'IWK Nouvelle Écosse',
    'MED +',
    'TLC Medical'
  ],
  commandeClients: ['Vermeiren', 'HME', 'C1SOUTH', 'Cubro', 'France'],
  regions: ['Québec', 'Ontario', 'Maritime'],
  intervenants: [
    'Joelle Bourdages',
    'Judith Lagimonière',
    'Camille Morel',
    'Anne Sophie Montminy',
    'Josianne Labrecque',
    'Eric Gagnon',
    'Nadyne Gobeil',
    'Marie Michelle Hamel',
    'Lisa Houde',
    'Stéphanie D\'Astou',
    'Annie Bourgeois',
    'Mireille Lefebvre',
    'Louis Matton',
    'Isabelle Neault',
    'Cindy Audet',
    'Josée Bédard',
    'Martine Comeau',
    'Ysabelle Fugere',
    'Julie Lefebvre',
    'Godefroy Neault',
    'Pam McKaskill',
    'Tabitha Knowles',
    'Marie Smith',
    'Anna Caulfield',
    'Maggie MCCann',
    'Jenny Jackson',
    'Mario Lebouthiller'
  ],
  representantes: ['Marie-Soleil', 'Marie-Pier', 'Multipass', 'Fabrys'],
  items: ['HP2', 'HP2 Ultra', 'EasyFit', 'Coussin Brio', 'Coquille 2Sizer', 'Siège', 'Dossier', 'Siège + Dossier'],
  locations: ['Étagère Val', 'Étagère Dan', 'Donné à Michelle', 'Tablette A1', 'Tablette A2', 'Rack C1', 'Magasin'],
  employeesRobot: ['Mario Jaques', 'Sina', 'Zakaria'],
  employeesDegauchage: ['Pierre', 'Serge', 'Nestor', 'Mathieu', 'Daniel'],
  employeesAtelier: ['Pierre', 'Serge', 'Nestor', 'Mathieu', 'Daniel', 'Valérie', 'Tommy', 'Saul', 'Checkna'],
  employeesCouture: ['Stéphanie', 'Cassie', 'Thérèse', 'Louisette', 'Suave', 'Martine'],
  employeesPeinture: ['Manuel', 'Cheickna', 'Saul', 'Pablo']
};

let currentListKey = null;
let currentListTitle = null;

// Charger les listes depuis Firebase
function loadCustomLists() {
  if (!database) return;
  const listsRef = database.ref('customLists');
  listsRef.once('value', snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      // Fusionner avec les listes par défaut
      Object.keys(data).forEach(key => {
        if (Array.isArray(data[key])) {
          customLists[key] = data[key];
        }
      });
      console.log('✅ Listes personnalisées chargées');
      
      // Synchroniser avec MENU_DATA pour compatibilité
      syncCustomListsToMenuData();
    }
    // Mettre à jour tous les selects
    updateAllSelectsFromLists();
  });
}

// Synchroniser customLists vers MENU_DATA
function syncCustomListsToMenuData() {
  if (customLists.moulageClients) MENU_DATA.clients = [...customLists.moulageClients];
  if (customLists.regions) MENU_DATA.regions = [...customLists.regions];
  if (customLists.intervenants) MENU_DATA.intervenants = [...customLists.intervenants];
  if (customLists.representantes) MENU_DATA.representantes = [...customLists.representantes];
  if (customLists.items) MENU_DATA.items = [...customLists.items];
  if (customLists.locations) MENU_DATA.locations = [...customLists.locations];
}

// Sauvegarder les listes dans Firebase
function saveCustomLists() {
  if (!database) return;
  database.ref('customLists').set(customLists)
    .then(() => console.log('✅ Listes sauvegardées'))
    .catch(err => console.error('❌ Erreur sauvegarde listes:', err));
}

// Mettre à jour tous les selects avec les listes
function updateAllSelectsFromLists() {
  // Moulages - Client
  const addClient = document.getElementById('addClient');
  if (addClient) {
    addClient.innerHTML = '<option value="">-- Sélectionner --</option>' +
      customLists.moulageClients.map(c => `<option value="${c}">${c}</option>`).join('');
  }
  
  // Moulages - Région
  const addRegion = document.getElementById('addRegion');
  if (addRegion) {
    addRegion.innerHTML = customLists.regions.map(r => `<option value="${r}">${r}</option>`).join('');
  }
  
  // Moulages - Intervenant
  const addIntervenant = document.getElementById('addIntervenant');
  if (addIntervenant) {
    addIntervenant.innerHTML = '<option value="">-- Sélectionner --</option>' +
      customLists.intervenants.map(i => `<option value="${i}">${i}</option>`).join('');
  }
  
  // Moulages - Représentante
  const addRepresentant = document.getElementById('addRepresentant');
  if (addRepresentant) {
    addRepresentant.innerHTML = '<option value="">-- Sélectionner --</option>' +
      customLists.representantes.map(r => `<option value="${r}">${r}</option>`).join('');
  }
}

// Ouvrir le gestionnaire de listes
function openListManager(listKey, title) {
  currentListKey = listKey;
  currentListTitle = title;
  
  const overlay = document.getElementById('listManagerOverlay');
  const titleEl = document.getElementById('listManagerTitle');
  const itemsEl = document.getElementById('listManagerItems');
  const inputEl = document.getElementById('listManagerNewItem');
  
  titleEl.textContent = `Gérer les ${title}s`;
  inputEl.value = '';
  
  renderListItems();
  
  overlay.classList.remove('hidden');
}

// Rendre les items de la liste
function renderListItems() {
  const itemsEl = document.getElementById('listManagerItems');
  const list = customLists[currentListKey] || [];
  
  // Si plus de 6 items, afficher sur 2 colonnes
  const useColumns = list.length > 6;
  
  if (useColumns) {
    itemsEl.style.display = 'grid';
    itemsEl.style.gridTemplateColumns = '1fr 1fr';
    itemsEl.style.gap = '6px';
  } else {
    itemsEl.style.display = 'block';
    itemsEl.style.gridTemplateColumns = '';
    itemsEl.style.gap = '';
  }
  
  itemsEl.innerHTML = list.map((item, index) => `
    <div class="list-manager-item">
      <span class="item-name">${item}</span>
      <button class="btn-remove-item" onclick="removeListItem(${index})" title="Supprimer">−</button>
    </div>
  `).join('');
}

// Ajouter un item à la liste
function addListItem() {
  const inputEl = document.getElementById('listManagerNewItem');
  const value = inputEl.value.trim();
  
  if (!value) return;
  
  if (!customLists[currentListKey]) {
    customLists[currentListKey] = [];
  }
  
  // Vérifier si déjà existant
  if (customLists[currentListKey].includes(value)) {
    alert('Cette valeur existe déjà');
    return;
  }
  
  customLists[currentListKey].push(value);
  inputEl.value = '';
  renderListItems();
}

// Supprimer un item de la liste
function removeListItem(index) {
  if (!customLists[currentListKey]) return;
  
  const item = customLists[currentListKey][index];
  if (confirm(`Supprimer "${item}" de la liste ?`)) {
    customLists[currentListKey].splice(index, 1);
    renderListItems();
  }
}

// Fermer le gestionnaire
function closeListManager() {
  document.getElementById('listManagerOverlay').classList.add('hidden');
}

// Sauvegarder et fermer
function saveListManager() {
  saveCustomLists();
  syncCustomListsToMenuData();
  updateAllSelectsFromLists();
  closeListManager();
  
  // Rafraîchir la fiche si ouverte
  if (currentExpandedCard) {
    const cardId = currentExpandedCard.dataset.cardId;
    closeFiche();
    const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (card) setTimeout(() => openFiche(card), 100);
  }
  
  // Rafraîchir la table robot si visible
  if (isRobotViewActive) {
    renderRobotTable();
  }
}

// ===== CALENDRIER POPUP POUR MODALES D'AJOUT =====
let addModalCalendarYear = new Date().getFullYear();
let addModalCalendarMonth = new Date().getMonth();
let addModalCalendarTarget = null; // ID du champ cible

function openAddModalCalendar(targetId) {
  addModalCalendarTarget = targetId;
  
  // Lire la date actuelle si existante
  const hiddenInput = document.getElementById(targetId);
  if (hiddenInput && hiddenInput.value) {
    const parts = hiddenInput.value.split('-');
    addModalCalendarYear = parseInt(parts[0]);
    addModalCalendarMonth = parseInt(parts[1]) - 1;
  } else {
    addModalCalendarYear = new Date().getFullYear();
    addModalCalendarMonth = new Date().getMonth();
  }
  
  renderAddModalCalendar();
  document.getElementById('addModalCalendarOverlay').classList.remove('hidden');
}

function closeAddModalCalendar() {
  document.getElementById('addModalCalendarOverlay').classList.add('hidden');
}

function addModalCalendarPrev() {
  addModalCalendarMonth--;
  if (addModalCalendarMonth < 0) {
    addModalCalendarMonth = 11;
    addModalCalendarYear--;
  }
  renderAddModalCalendar();
}

function addModalCalendarNext() {
  addModalCalendarMonth++;
  if (addModalCalendarMonth > 11) {
    addModalCalendarMonth = 0;
    addModalCalendarYear++;
  }
  renderAddModalCalendar();
}

function addModalCalendarToday() {
  const today = new Date();
  selectAddModalDate(today.toISOString().split('T')[0]);
}

function addModalCalendarClear() {
  if (addModalCalendarTarget) {
    document.getElementById(addModalCalendarTarget).value = '';
    const displayEl = document.getElementById(addModalCalendarTarget + 'Display');
    const fieldEl = document.getElementById(addModalCalendarTarget + 'Field');
    if (displayEl) displayEl.textContent = '-- Sélectionner --';
    if (fieldEl) fieldEl.classList.remove('has-value');
  }
  closeAddModalCalendar();
}

function selectAddModalDate(dateStr) {
  if (addModalCalendarTarget) {
    document.getElementById(addModalCalendarTarget).value = dateStr;
    const displayEl = document.getElementById(addModalCalendarTarget + 'Display');
    const fieldEl = document.getElementById(addModalCalendarTarget + 'Field');
    if (displayEl) {
      // Format français
      const d = new Date(dateStr + 'T12:00:00');
      displayEl.textContent = d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
    }
    if (fieldEl) fieldEl.classList.add('has-value');
  }
  closeAddModalCalendar();
}

function renderAddModalCalendar() {
  const titleEl = document.getElementById('addModalCalendarTitle');
  const daysEl = document.getElementById('addModalCalendarDays');
  
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  
  titleEl.textContent = `${monthNames[addModalCalendarMonth]} ${addModalCalendarYear}`;
  
  const firstDay = new Date(addModalCalendarYear, addModalCalendarMonth, 1);
  const lastDay = new Date(addModalCalendarYear, addModalCalendarMonth + 1, 0);
  const startDay = firstDay.getDay(); // 0 = Dimanche
  const daysInMonth = lastDay.getDate();
  
  const today = new Date().toISOString().split('T')[0];
  const selectedDate = addModalCalendarTarget ? document.getElementById(addModalCalendarTarget)?.value : '';
  
  let html = '';
  
  // Jours du mois précédent
  const prevMonthLastDay = new Date(addModalCalendarYear, addModalCalendarMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevMonthLastDay - i;
    html += `<div class="cal-day other-month">${day}</div>`;
  }
  
  // Jours du mois actuel
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${addModalCalendarYear}-${String(addModalCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let classes = 'cal-day';
    if (dateStr === today) classes += ' today';
    if (dateStr === selectedDate) classes += ' selected';
    html += `<div class="${classes}" onclick="selectAddModalDate('${dateStr}')">${day}</div>`;
  }
  
  // Jours du mois suivant
  const totalCells = startDay + daysInMonth;
  const remainingCells = (7 - (totalCells % 7)) % 7;
  for (let i = 1; i <= remainingCells; i++) {
    html += `<div class="cal-day other-month">${i}</div>`;
  }
  
  daysEl.innerHTML = html;
}

// Exposer les fonctions globalement
window.openListManager = openListManager;
window.closeListManager = closeListManager;
window.addListItem = addListItem;
window.removeListItem = removeListItem;
window.saveListManager = saveListManager;
window.openAddModalCalendar = openAddModalCalendar;
window.closeAddModalCalendar = closeAddModalCalendar;
window.addModalCalendarPrev = addModalCalendarPrev;
window.addModalCalendarNext = addModalCalendarNext;
window.addModalCalendarToday = addModalCalendarToday;
window.addModalCalendarClear = addModalCalendarClear;
window.selectAddModalDate = selectAddModalDate;

// ===== CRÉATION DE CARTE =====
function generateCardId() {
  return 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Raisons d'attente (modifiables)
let RAISONS_ATTENTE = [
  "En attente de pièces",
  "En attente d'approbation client",
  "En attente de réponse couture",
  "En attente de réponse atelier",
  "En attente de réponse robot",
  "En attente de posit",
  "En attente ROHO",
  "En attente de plaques d'aluminium",
  "En attente de fichiers de scans"
];

// Liste des employés par département (modifiables)
let EMPLOYES_ATELIER = ['Mario', 'Sina', 'Cassie'];
let EMPLOYES_COUTURE = ['Michelle', 'Francine', 'Stéphanie', 'Valérie'];

// Options d'expédition (modifiables)
let EXPEDITION_OPTIONS = [
  { value: 'attente', label: 'En attente', blink: false, color: '' },
  { value: 'pret', label: 'Prêt pour expédition', blink: true, color: 'green' },
  { value: 'partiel', label: 'Envoi partiel', blink: false, color: 'yellow' },
  { value: 'expedie', label: 'Expédié', blink: false, color: '' }
];

function createCard(name, order, region, columnIndex) {
  const cardId = generateCardId();
  const delay = MENU_DATA.delays[region] || 90;
  
  // Créer l'élément carte
  const card = document.createElement('div');
  card.className = 'mcard';
  card.dataset.cardId = cardId;
  
  // Classe région
  if (region === 'Québec') card.classList.add('region-qc');
  else if (region === 'Ontario') card.classList.add('region-on');
  else if (region === 'Maritime') card.classList.add('region-ma');
  
  // Marquer si colonne spéciale
  if (columnIndex === 7) card.classList.add('in-attente-column');
  if (columnIndex === 6) card.classList.add('in-expedition-column');
  
  const item = 'Siège';
  const isAttente = columnIndex === 7;
  const isExpedition = columnIndex === 6;
  
  // Déterminer le texte et la classe de couleur de la pastille délai
  let delayText = `${delay} jours ouvrables`;
  let delayClass = 'mcard-delay-pill delai-vert'; // Vert par défaut (pas encore de date robot)
  
  if (isAttente) {
    delayText = '? Raison';
    delayClass = 'mcard-delay-pill';
  } else if (isExpedition) {
    delayText = 'Expédier';
    delayClass = 'mcard-delay-pill';
  }
  
  card.innerHTML = `
    <div class="priority-badge hidden" data-priority="0"></div>
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <input type="text" class="mcard-title" value="${name}" data-field="name">
        </div>
        <div class="mcard-order-line">
          <button class="mcard-btn-priority-small" title="Définir priorité">⭐</button>
          <input type="text" class="mcard-order" value="${order}" data-field="order" maxlength="6">
          <button class="mcard-toggle-btn" data-action="open-fiche" data-card-id="${cardId}" title="Ouvrir la fiche">📋</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="${delayClass}" onclick="openDelaiMenu('${cardId}', event)"><span>${delayText}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move">Déplacer</button>
      <button class="mcard-btn mcard-btn-delete">Supprimer</button>
    </div>
  `;
  
  // Stocker les données avec tracking initial
  const today = new Date().toISOString().split('T')[0];
  const deptMap = {0:'robot', 1:'degauchage', 2:'essayage', 3:'atelier', 4:'couture', 5:'peinture', 6:'expedition'};
  const initialTracking = {};
  if (deptMap[columnIndex]) {
    initialTracking[deptMap[columnIndex]] = { entree: today };
  }
  
  cardsData[cardId] = {
    name, order, region,
    columnIndex,
    item,
    priority: 0, // 0=aucune, 1-4=priorité
    raisonAttente: '',
    dateRecue: today,
    dateRobot: columnIndex === 0 ? today : '',
    dateEssayage: '',
    client: '',
    intervenant: '',
    representant: '',
    notes: '',
    tracking: initialTracking
  };
  
  // Ajouter à la colonne
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[columnIndex];
  if (targetCol) {
    targetCol.appendChild(card);
  }
  
  // Attacher les événements
  attachCardEvents(card);
  updateColumnCounts();
  
  // Sauvegarder dans Firebase
  saveCardToFirebase(cardId);
  
  return cardId;
}

function attachCardEvents(card) {
  const cardId = card.dataset.cardId;
  
  // Le bouton Fiche est maintenant géré par la délégation globale (DOMContentLoaded)
  // Plus besoin d'attacher un événement ici
  
  // Input titre - sync avec fiche
  const titleInput = card.querySelector('.mcard-title');
  titleInput?.addEventListener('focus', () => {
    titleInput.select(); // Sélectionner tout au clic
  });
  titleInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      titleInput.blur(); // Confirmer avec Enter
    }
  });
  titleInput?.addEventListener('blur', () => {
    if (cardsData[cardId]) {
      cardsData[cardId].name = titleInput.value || 'Nom du moulage';
      saveCardToFirebase(cardId);
    }
  });
  titleInput?.addEventListener('click', (e) => e.stopPropagation());
  
  // Input numéro commande - sync avec fiche
  const orderInput = card.querySelector('.mcard-order');
  orderInput?.addEventListener('focus', () => {
    orderInput.select(); // Sélectionner tout au clic
  });
  orderInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      orderInput.blur(); // Confirmer avec Enter
    }
  });
  // Permettre seulement les chiffres et limiter à 6 caractères
  orderInput?.addEventListener('input', () => {
    orderInput.value = orderInput.value.replace(/[^0-9]/g, '').slice(0, 6);
  });
  orderInput?.addEventListener('blur', () => {
    // Compléter avec des zéros si moins de 6 chiffres
    let value = orderInput.value.replace(/[^0-9]/g, '');
    value = value.padStart(6, '0').slice(0, 6);
    orderInput.value = value;
    if (cardsData[cardId]) {
      cardsData[cardId].order = value;
      saveCardToFirebase(cardId);
    }
  });
  orderInput?.addEventListener('click', (e) => e.stopPropagation());
  
  // Pastille Item - switch au clic
  const itemPill = card.querySelector('.mcard-item-pill');
  const items = ['Siège', 'Dossier', 'Siège + Dossier'];
  itemPill?.addEventListener('click', (e) => {
    e.stopPropagation();
    const currentItem = itemPill.textContent;
    const currentIndex = items.indexOf(currentItem);
    const nextIndex = (currentIndex + 1) % items.length;
    const newItem = items[nextIndex];
    itemPill.textContent = newItem;
    
    if (cardsData[cardId]) {
      cardsData[cardId].item = newItem;
      saveCardToFirebase(cardId);
    }
  });
  
  // Pastille délai - gère En attente ET Expédition
  const delayPill = card.querySelector('.mcard-delay-pill');
  delayPill?.addEventListener('click', (e) => {
    e.stopPropagation();
    e.preventDefault();
    
    // Si déjà expédié, ne rien faire
    if (cardsData[cardId]?.expedie) return;
    
    if (card.classList.contains('in-attente-column')) {
      // En attente: afficher menu raisons (nouveau menu visuel)
      openRaisonAttenteMenu(cardId, e);
    } else if (card.classList.contains('in-expedition-column')) {
      // Expédition: marquer comme expédié avec la date
      const today = new Date().toISOString().split('T')[0];
      const delaySpan = delayPill.querySelector('span');
      if (delaySpan) {
        delaySpan.textContent = `Expédié ${today}`;
      }
      delayPill.classList.add('expedie');
      
      if (cardsData[cardId]) {
        cardsData[cardId].expedie = true;
        cardsData[cardId].dateExpedition = today;
        saveCardToFirebase(cardId);
      }
      
      addLogEntry('Expédition', `Moulage "${cardsData[cardId]?.name}" expédié le ${today}`);
    }
  });
  
  // Bouton supprimer - avec confirmation
  card.querySelector('.mcard-btn-delete')?.addEventListener('click', (e) => {
    e.stopPropagation();
    showDeleteConfirm(card, cardId);
  });
  
  // Bouton déplacer
  card.querySelector('.mcard-btn-move')?.addEventListener('click', (e) => {
    e.stopPropagation();
    showMoveMenu(card);
  });
  
  // Bouton priorité (petit bouton ⭐)
  card.querySelector('.mcard-btn-priority-small')?.addEventListener('click', (e) => {
    e.stopPropagation();
    showPriorityMenu(card, cardId, e);
  });
}

// ===== SYSTÈME DE PRIORITÉS =====
function showPriorityMenu(card, cardId, event) {
  // Vérifier les permissions
  if (!userCan('edit')) {
    alert("⛔ Vous n'avez pas la permission de modifier les priorités.");
    return;
  }
  
  // Fermer tout menu existant
  document.querySelector('.priority-menu')?.remove();
  
  const currentPriority = cardsData[cardId]?.priority || 0;
  
  const menu = document.createElement('div');
  menu.className = 'priority-menu';
  menu.innerHTML = `
    <div class="priority-menu-item" data-priority="1">
      <span class="priority-dot p1">1</span>
      <span>🔴 Priorité #1 - URGENT</span>
    </div>
    <div class="priority-menu-item" data-priority="2">
      <span class="priority-dot p2">2</span>
      <span>🟠 Priorité #2 - Important</span>
    </div>
    <div class="priority-menu-item" data-priority="3">
      <span class="priority-dot p3">3</span>
      <span>🟡 Priorité #3 - À surveiller</span>
    </div>
    <div class="priority-menu-item" data-priority="4">
      <span class="priority-dot p4">4</span>
      <span>🟢 Priorité #4 - Normal+</span>
    </div>
    <div class="priority-menu-item" data-priority="5">
      <span class="priority-dot p5">5</span>
      <span>🔵 Priorité #5 - Basse</span>
    </div>
    <div class="priority-menu-item" data-priority="0" style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 5px; padding-top: 10px;">
      <span class="priority-dot none">✕</span>
      <span>Aucune priorité</span>
    </div>
  `;
  
  // Positionner le menu
  const rect = event.target.getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - 250) + 'px';
  
  document.body.appendChild(menu);
  
  // Événements de sélection
  menu.querySelectorAll('.priority-menu-item').forEach(item => {
    item.addEventListener('click', () => {
      const priority = parseInt(item.dataset.priority);
      setPriority(cardId, priority);
      menu.remove();
    });
  });
  
  // Fermer au clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', function closePriorityMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closePriorityMenu);
      }
    });
  }, 10);
}

function setPriority(cardId, priority) {
  if (!cardsData[cardId]) return;
  
  cardsData[cardId].priority = priority;
  saveCardToFirebase(cardId);
  
  // Mettre à jour l'affichage de la carte
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    updateCardPriorityDisplay(card, priority);
  }
  
  // Synchroniser avec la vue horizontale si elle est visible
  const tableSelect = document.querySelector(`#robotTableBody select[data-card-id="${cardId}"][data-field="priority"]`);
  if (tableSelect) {
    tableSelect.value = priority;
  }
  
  // Log
  const priorityLabels = {
    0: 'Aucune',
    1: 'URGENT (#1)',
    2: 'Important (#2)',
    3: 'À surveiller (#3)',
    4: 'Normal+ (#4)',
    5: 'Basse (#5)'
  };
  addLogEntry('Priorité', `"${cardsData[cardId].name}" → ${priorityLabels[priority]}`);
}

function updateCardPriorityDisplay(card, priority) {
  const badge = card.querySelector('.priority-badge');
  
  if (priority > 0 && priority <= 5) {
    // Afficher le badge
    badge.textContent = priority;
    badge.className = `priority-badge p${priority}`;
    badge.classList.remove('hidden');
    
    // Ajouter l'effet clignotant à la carte (bordure seulement)
    card.classList.add('priority');
  } else {
    // Cacher le badge
    badge.classList.add('hidden');
    card.classList.remove('priority');
  }
}

// Mettre à jour les priorités au chargement des cartes
function refreshAllPriorities() {
  document.querySelectorAll('.mcard[data-card-id]').forEach(card => {
    const cardId = card.dataset.cardId;
    const priority = cardsData[cardId]?.priority || 0;
    updateCardPriorityDisplay(card, priority);
  });
}

// Gérer le changement de priorité depuis la fiche
function handlePriorityChange(selectEl, cardId) {
  const priority = parseInt(selectEl.value) || 0;
  setPriority(cardId, priority);
  
  // Synchroniser avec la vue horizontale si elle existe
  syncPriorityToTable(cardId, priority);
}
window.handlePriorityChange = handlePriorityChange;

// Gérer le changement de priorité depuis la vue horizontale Robot
function handlePriorityChangeFromTable(cardId, value) {
  const priority = parseInt(value) || 0;
  setPriority(cardId, priority);
  
  // Mettre à jour le select de priorité dans la fiche si elle est ouverte
  const ficheSelect = document.querySelector(`.mcard[data-card-id="${cardId}"] .fiche-priority-select`);
  if (ficheSelect) {
    ficheSelect.value = priority;
  }
}
window.handlePriorityChangeFromTable = handlePriorityChangeFromTable;

// Synchroniser la priorité vers la table horizontale
function syncPriorityToTable(cardId, priority) {
  const tableSelect = document.querySelector(`#robotTableBody select[data-card-id="${cardId}"][data-field="priority"]`);
  if (tableSelect) {
    tableSelect.value = priority;
  }
}

// Menu priorité dans la fiche (bouton dans le header)
function showFichePriorityMenu(cardId, event) {
  event.stopPropagation();
  
  // Fermer tout menu existant
  document.querySelector('.fiche-priority-menu')?.remove();
  
  const currentPriority = cardsData[cardId]?.priority || 0;
  
  const menu = document.createElement('div');
  menu.className = 'fiche-priority-menu';
  menu.innerHTML = `
    <div class="fiche-priority-menu-item ${currentPriority === 0 ? 'selected' : ''}" data-priority="0">
      <span class="fiche-priority-dot" style="background: #6b7280;">-</span>
      <span>Aucune priorité</span>
    </div>
    <div class="fiche-priority-menu-item ${currentPriority === 1 ? 'selected' : ''}" data-priority="1">
      <span class="fiche-priority-dot" style="background: #ef4444;">1</span>
      <span>🔴 #1 - URGENT</span>
    </div>
    <div class="fiche-priority-menu-item ${currentPriority === 2 ? 'selected' : ''}" data-priority="2">
      <span class="fiche-priority-dot" style="background: #f97316;">2</span>
      <span>🟠 #2 - Important</span>
    </div>
    <div class="fiche-priority-menu-item ${currentPriority === 3 ? 'selected' : ''}" data-priority="3">
      <span class="fiche-priority-dot" style="background: #eab308;">3</span>
      <span>🟡 #3 - À surveiller</span>
    </div>
    <div class="fiche-priority-menu-item ${currentPriority === 4 ? 'selected' : ''}" data-priority="4">
      <span class="fiche-priority-dot" style="background: #22c55e;">4</span>
      <span>🟢 #4 - Normal+</span>
    </div>
    <div class="fiche-priority-menu-item ${currentPriority === 5 ? 'selected' : ''}" data-priority="5">
      <span class="fiche-priority-dot" style="background: #3b82f6;">5</span>
      <span>🔵 #5 - Basse</span>
    </div>
  `;
  
  // Positionner le menu sous le bouton
  const rect = event.target.closest('.fiche-priority-btn').getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
  menu.style.top = (rect.bottom + 5) + 'px';
  
  document.body.appendChild(menu);
  
  // Événements de sélection
  menu.querySelectorAll('.fiche-priority-menu-item').forEach(item => {
    item.addEventListener('click', () => {
      const priority = parseInt(item.dataset.priority);
      setPriority(cardId, priority);
      
      // Mettre à jour le bouton dans la fiche
      const priorityLabels = {
        0: { text: '-- Aucune --', color: '#6b7280', emoji: '⚪' },
        1: { text: '#1 URGENT', color: '#ef4444', emoji: '🔴' },
        2: { text: '#2 Important', color: '#f97316', emoji: '🟠' },
        3: { text: '#3 À surveiller', color: '#eab308', emoji: '🟡' },
        4: { text: '#4 Normal+', color: '#22c55e', emoji: '🟢' },
        5: { text: '#5 Basse', color: '#3b82f6', emoji: '🔵' }
      };
      const info = priorityLabels[priority];
      const btn = event.target.closest('.fiche-priority-btn');
      if (btn) {
        btn.style.background = info.color;
        btn.querySelector('.fiche-priority-emoji').textContent = info.emoji;
      }
      
      menu.remove();
    });
  });
  
  // Fermer au clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', function closeFichePriorityMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeFichePriorityMenu);
      }
    });
  }, 10);
}
window.showFichePriorityMenu = showFichePriorityMenu;

// Menu des délais régionaux (original)
function showDelaiRegionsMenu(event, cardId) {
  // Fermer tout menu existant
  document.getElementById('delaiRegionsMenu')?.remove();
  
  const menu = document.createElement('div');
  menu.id = 'delaiRegionsMenu';
  menu.className = 'delai-regions-menu';
  
  const regions = MENU_DATA.regions;
  const delays = MENU_DATA.delays;
  
  const regionsHtml = regions.map(region => {
    const delai = delays[region] || 90;
    return `
      <div class="delai-region-row">
        <span class="delai-region-name">${region}</span>
        <div class="delai-region-controls">
          <button class="delai-btn minus" onclick="adjustDelaiRegion('${region}', -5)">−</button>
          <span class="delai-region-value" id="delaiValue_${region.replace(/\s/g, '_')}">${delai}</span>
          <button class="delai-btn plus" onclick="adjustDelaiRegion('${region}', 5)">+</button>
          <span class="delai-unit">jours</span>
        </div>
      </div>
    `;
  }).join('');
  
  menu.innerHTML = `
    <div class="delai-menu-header">⏱ Délais par région</div>
    <div class="delai-regions-list">
      ${regionsHtml}
    </div>
    <div class="delai-menu-footer">
      <button onclick="closeDelaiRegionsMenu()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Positionner près du clic
  const rect = event.target.getBoundingClientRect();
  menu.style.left = Math.min(rect.left, window.innerWidth - 250) + 'px';
  menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - 220) + 'px';
  
  // Fermer en cliquant ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeDelaiRegionsMenuOnClick);
  }, 100);
}

function closeDelaiRegionsMenuOnClick(e) {
  const menu = document.getElementById('delaiRegionsMenu');
  if (menu && !menu.contains(e.target)) {
    closeDelaiRegionsMenu();
  }
}

function closeDelaiRegionsMenu() {
  document.getElementById('delaiRegionsMenu')?.remove();
  document.removeEventListener('click', closeDelaiRegionsMenuOnClick);
}

function adjustDelaiRegion(region, delta) {
  const currentDelai = MENU_DATA.delays[region] || 90;
  const newDelai = Math.max(5, currentDelai + delta);
  MENU_DATA.delays[region] = newDelai;
  
  // Mettre à jour l'affichage
  const valueEl = document.getElementById('delaiValue_' + region.replace(/\s/g, '_'));
  if (valueEl) valueEl.textContent = newDelai;
  
  // Rafraîchir tous les délais des cartes
  refreshAllMoulageDelays();
}

// Menu raison d'attente avec popup visuel (pour la fiche moulage)
function openRaisonAttenteMenu(cardId, event) {
  event.stopPropagation();
  event.preventDefault();
  
  // Fermer TOUS les menus existants
  document.getElementById('raisonAttenteMenu')?.remove();
  document.getElementById('delaiMenu')?.remove();
  document.getElementById('rangRobotMenu')?.remove();
  document.getElementById('delaiRegionsMenu')?.remove();
  document.getElementById('moveMenu')?.remove();
  document.querySelectorAll('.raison-attente-menu, .cmd-select-menu, .client-select-menu, .delai-menu-popup, .move-menu').forEach(m => m.remove());
  
  const currentRaison = cardsData[cardId]?.raisonAttente || '';
  
  const menu = document.createElement('div');
  menu.id = 'raisonAttenteMenu';
  menu.className = 'raison-attente-menu';
  menu.onclick = function(e) { e.stopPropagation(); };
  
  const optionsHtml = RAISONS_ATTENTE.map(raison => {
    const isSelected = raison === currentRaison;
    return `<div class="raison-option ${isSelected ? 'selected' : ''}" onclick="selectRaisonAttente('${cardId}', '${raison.replace(/'/g, "\\'")}')">${raison}</div>`;
  }).join('');
  
  menu.innerHTML = `
    <div class="raison-menu-header">⏳ Raison d'attente</div>
    <div class="raison-options">
      ${optionsHtml}
    </div>
    <div class="raison-menu-actions">
      <div class="raison-action add" onclick="addRaisonAttente('${cardId}')">➕ Ajouter</div>
      <div class="raison-action remove" onclick="removeRaisonAttente()">➖ Supprimer</div>
      <div class="raison-action clear" onclick="clearRaisonAttente('${cardId}')">🗑 Effacer</div>
    </div>
    <div class="raison-menu-footer">
      <button onclick="document.getElementById('raisonAttenteMenu')?.remove()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Trouver la carte parent pour positionner à gauche de celle-ci
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  const cardRect = card ? card.getBoundingClientRect() : event.target.getBoundingClientRect();
  
  // Calculer la hauteur du menu pour centrer verticalement
  const menuHeight = menu.offsetHeight || 350;
  const cardCenterY = cardRect.top + (cardRect.height / 2);
  const menuTop = cardCenterY - (menuHeight / 2);
  
  // Positionner à gauche de la carte, centré verticalement
  menu.style.left = Math.max(10, cardRect.left - menu.offsetWidth - 10) + 'px';
  menu.style.top = Math.max(10, Math.min(menuTop, window.innerHeight - menuHeight - 10)) + 'px';
}

function selectRaisonAttente(cardId, raison) {
  if (cardsData[cardId]) {
    cardsData[cardId].raisonAttente = raison;
    cardsData[cardId].attenteActive = true;
    if (!cardsData[cardId].dateAttente) {
      cardsData[cardId].dateAttente = new Date().toLocaleDateString('fr-CA');
    }
    saveCardToFirebase(cardId);
    
    // Mettre à jour l'affichage
    const badge = document.querySelector(`#ficheAttenteSection_${cardId} .attente-badge-full`);
    if (badge) badge.innerHTML = `⏳ EN ATTENTE: ${raison}`;
  }
  document.getElementById('raisonAttenteMenu')?.remove();
}

function addRaisonAttente(cardId) {
  const newRaison = prompt('Nouvelle raison d\'attente:');
  if (newRaison && newRaison.trim()) {
    const raison = newRaison.trim();
    if (!RAISONS_ATTENTE.includes(raison)) {
      RAISONS_ATTENTE.push(raison);
    }
    selectRaisonAttente(cardId, raison);
  }
}

function removeRaisonAttente() {
  const listStr = RAISONS_ATTENTE.map((r, i) => `${i + 1}. ${r}`).join('\n');
  const choice = prompt(`Supprimer quelle raison?\n${listStr}\n\nNuméro:`);
  if (choice) {
    const index = parseInt(choice) - 1;
    if (index >= 0 && index < RAISONS_ATTENTE.length) {
      RAISONS_ATTENTE.splice(index, 1);
    }
  }
  document.getElementById('raisonAttenteMenu')?.remove();
}

function clearRaisonAttente(cardId) {
  if (cardsData[cardId]) {
    cardsData[cardId].raisonAttente = '';
    cardsData[cardId].attenteActive = false;
    cardsData[cardId].dateAttente = '';
    saveCardToFirebase(cardId);
    
    // Mettre à jour l'affichage
    const badge = document.querySelector(`#ficheAttenteSection_${cardId} .attente-badge-full`);
    if (badge) badge.innerHTML = `⏳ EN ATTENTE: Raison non spécifiée`;
  }
  document.getElementById('raisonAttenteMenu')?.remove();
}

// ===== DÉPLACEMENT =====
const COL_NAMES = ['🤖 Robot', '📐 Dégauchage', '👔 Essayage', '🔧 Atelier', '🧵 Couture', '🎨 Peinture', '🚚 Expédition', '⏳ En attente'];
const COL_NAMES_SHORT = ['Robot', 'Dégauch.', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expéd.', 'Attente'];
let cardToMove = null;

function showMoveMenu(card) {
  cardToMove = card;
  const currentCol = parseInt(card.closest('.col')?.dataset.col || 0);
  const moveColumns = document.getElementById('moveColumns');
  
  // Compter les cartes dans chaque colonne - SEULEMENT les colonnes du mainBoard
  const columns = document.querySelectorAll('#mainBoard .col');
  
  let html = '';
  columns.forEach((col, i) => {
    const cardsInCol = col.querySelectorAll('.mcard').length;
    const isCurrent = (i === currentCol);
    
    html += `
      <div class="move-column">
        <div class="move-column-header ${isCurrent ? 'current' : ''}">
          ${COL_NAMES_SHORT[i] || 'Col ' + (i+1)}
        </div>
        <div class="move-positions">
    `;
    
    // Calculer le nombre de positions disponibles
    // Si c'est la colonne actuelle, on ne peut pas déplacer vers elle-même
    // Pour les autres colonnes: cartes actuelles + 1 nouvelle position
    const maxPos = isCurrent ? 0 : cardsInCol + 1;
    
    if (isCurrent) {
      // Colonne actuelle - afficher message
      html += `<div class="move-position-btn" style="opacity:0.4;cursor:default;font-size:9px;">Colonne actuelle</div>`;
    } else if (cardsInCol === 0) {
      // Colonne vide - une seule position
      html += `<button class="move-position-btn" data-col="${i}" data-pos="1">1</button>`;
    } else {
      // Colonne avec des cartes - positions de 1 à (cartes + 1)
      for (let pos = 1; pos <= maxPos; pos++) {
        const isLast = (pos === maxPos);
        const posLabel = isLast ? `${pos} (dernier)` : pos;
        html += `<button class="move-position-btn" data-col="${i}" data-pos="${pos}">${posLabel}</button>`;
      }
    }
    
    html += `
        </div>
      </div>
    `;
  });
  
  moveColumns.innerHTML = html;
  
  // Ajouter les event listeners aux boutons de position
  moveColumns.querySelectorAll('.move-position-btn[data-col]').forEach(btn => {
    if (btn.tagName === 'BUTTON') {
      btn.addEventListener('click', () => {
        const targetCol = parseInt(btn.dataset.col);
        const targetPos = parseInt(btn.dataset.pos);
        moveCardToPosition(cardToMove, targetCol, targetPos);
        closeMoveMenu();
      });
    }
  });
  
  document.getElementById('moveOverlay').classList.remove('hidden');
}

function closeMoveMenu() {
  document.getElementById('moveOverlay').classList.add('hidden');
  cardToMove = null;
}

// Déplacer une carte vers une colonne à une position spécifique
function moveCardToPosition(card, targetColIndex, position) {
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[targetColIndex];
  const cardId = card.dataset.cardId;
  const currentColIndex = cardsData[cardId]?.columnIndex ?? -1;
  
  if (targetCol) {
    const cardsInTarget = targetCol.querySelectorAll('.mcard');
    
    // Position 1 = premier, position 2 = après la 1ère carte, etc.
    if (position <= 1 || cardsInTarget.length === 0) {
      // Insérer au début
      targetCol.insertBefore(card, cardsInTarget[0] || null);
    } else if (position > cardsInTarget.length) {
      // Insérer à la fin
      targetCol.appendChild(card);
    } else {
      // Insérer avant la carte à la position
      targetCol.insertBefore(card, cardsInTarget[position - 1]);
    }
    
    // ===== TRACKING AUTOMATIQUE =====
    const today = new Date().toISOString().split('T')[0];
    const deptMap = {0:'robot', 1:'degauchage', 2:'essayage', 3:'atelier', 4:'couture', 5:'peinture', 6:'expedition'};
    
    // Si on quitte une colonne de département (0-6), marquer la sortie
    if (currentColIndex >= 0 && currentColIndex <= 6 && currentColIndex !== targetColIndex) {
      const deptKey = deptMap[currentColIndex];
      if (deptKey && cardsData[cardId]) {
        if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
        if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
        if (cardsData[cardId].tracking[deptKey].entree && !cardsData[cardId].tracking[deptKey].sortie) {
          cardsData[cardId].tracking[deptKey].sortie = today;
        }
      }
    }
    
    // Si on entre dans une colonne de département (0-6), marquer l'entrée
    if (targetColIndex >= 0 && targetColIndex <= 6) {
      const deptKey = deptMap[targetColIndex];
      if (deptKey && cardsData[cardId]) {
        if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
        if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
        if (!cardsData[cardId].tracking[deptKey].entree) {
          cardsData[cardId].tracking[deptKey].entree = today;
        }
      }
    }
    
    // Mettre à jour l'affichage de la pastille délai
    updateCardDelayPill(card, cardId, targetColIndex);
    
    if (cardsData[cardId]) {
      cardsData[cardId].columnIndex = targetColIndex;
      saveCardToFirebase(cardId);
    }
    
    updateColumnCounts();
    addLogEntry('Déplacement', `Moulage déplacé vers ${COL_NAMES_SHORT[targetColIndex]} position ${position}`);
  }
}

// Mise à jour de la pastille délai selon la colonne
function updateCardDelayPill(card, cardId, targetColIndex) {
  const delayPill = card.querySelector('.mcard-delay-pill');
  const delaySpan = delayPill?.querySelector('span');
  
  // Retirer les classes de colonne spéciale et toutes les classes de couleur
  card.classList.remove('in-attente-column', 'in-expedition-column');
  delayPill?.classList.remove('attente-active', 'expedie', 'delay-warning', 'delay-danger', 'retard', 'delai-vert', 'delai-jaune', 'delai-rouge', 'delai-retard');
  
  const cardData = cardsData[cardId];
  
  // Si DÉJÀ expédié, garder le statut permanent
  if (cardData?.expedie && cardData?.dateExpedition) {
    if (delaySpan) delaySpan.textContent = `Expédié ${cardData.dateExpedition}`;
    delayPill?.classList.add('expedie');
  } else if (targetColIndex === 7) {
    // Vers En attente - enregistrer la date
    card.classList.add('in-attente-column');
    if (cardData && !cardData.dateAttente) {
      cardData.dateAttente = new Date().toLocaleDateString('fr-CA');
    }
    if (delaySpan) {
      const raison = cardData?.raisonAttente;
      delaySpan.textContent = raison || '? Raison';
      if (raison && cardData?.attenteActive) {
        delayPill?.classList.add('attente-active');
      }
    }
  } else if (targetColIndex === 6) {
    // Vers Expédition
    card.classList.add('in-expedition-column');
    if (delaySpan) {
      delaySpan.textContent = 'Expédier';
    }
  } else {
    // Autres colonnes - Afficher les jours RESTANTS avec couleurs
    if (delaySpan && cardData) {
      const hasValidDateRobot = cardData.dateRobot && cardData.dateRobot !== '' && cardData.dateRobot !== 'AAAA-MM-JJ';
      
      if (hasValidDateRobot) {
        const delaiInfo = calculateRemainingDelay(cardData);
        const joursRestants = delaiInfo.joursRestants;
        
        if (joursRestants < 0) {
          // En retard
          const joursRetard = Math.abs(joursRestants);
          delaySpan.textContent = `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`;
          delayPill?.classList.add('delai-retard');
        } else if (joursRestants === 0) {
          // Dernier jour
          delaySpan.textContent = "Aujourd'hui!";
          delayPill?.classList.add('delai-retard');
        } else {
          delaySpan.textContent = `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`;
          
          // Colorer selon les jours restants
          if (joursRestants <= 3) {
            delayPill?.classList.add('delai-rouge');
          } else if (joursRestants <= 10) {
            delayPill?.classList.add('delai-jaune');
          } else {
            delayPill?.classList.add('delai-vert');
          }
        }
      } else {
        // Pas de date robot - afficher le délai total de la région en vert
        const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
        delaySpan.textContent = `${delaiTotal} jours ouvrables`;
        delayPill?.classList.add('delai-vert');
      }
    }
  }
}

// Event listeners pour fermer le menu
document.getElementById('moveClose')?.addEventListener('click', closeMoveMenu);
document.getElementById('moveOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'moveOverlay') closeMoveMenu();
});

// ===== CONFIRMATION SUPPRESSION =====
let cardToDelete = null;
let cardIdToDelete = null;

function showDeleteConfirm(card, cardId) {
  cardToDelete = card;
  cardIdToDelete = cardId;
  const name = cardsData[cardId]?.name || 'ce moulage';
  document.getElementById('confirmMessage').textContent = `Voulez-vous vraiment supprimer "${name}"?`;
  document.getElementById('confirmOverlay').classList.remove('hidden');
}

function closeDeleteConfirm() {
  document.getElementById('confirmOverlay').classList.add('hidden');
  cardToDelete = null;
  cardIdToDelete = null;
}

function confirmDelete() {
  if (cardToDelete && cardIdToDelete) {
    const cardData = cardsData[cardIdToDelete];
    const name = cardData?.name || 'Inconnu';
    
    // ARCHIVER AVANT DE SUPPRIMER
    if (cardData) {
      archiveCard(cardIdToDelete, cardData, 'moulage');
    }
    
    cardToDelete.remove();
    delete cardsData[cardIdToDelete];
    updateColumnCounts();
    deleteCardFromFirebase(cardIdToDelete);
    addLogEntry('Suppression', `Moulage "${name}" supprimé et archivé`);
  }
  closeDeleteConfirm();
}

// Event listeners pour confirmation
document.getElementById('confirmYes')?.addEventListener('click', confirmDelete);
document.getElementById('confirmNo')?.addEventListener('click', closeDeleteConfirm);
document.getElementById('confirmOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'confirmOverlay') closeDeleteConfirm();
});

function moveCardToColumn(card, targetColIndex) {
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[targetColIndex];
  const cardId = card.dataset.cardId;
  
  if (targetCol) {
    // Enregistrer la date de sortie de l'ancienne colonne
    const oldColIndex = cardsData[cardId]?.columnIndex;
    if (oldColIndex !== undefined && oldColIndex !== targetColIndex) {
      updateDeptTracking(cardId, oldColIndex, 'sortie');
    }
    
    targetCol.appendChild(card);
    
    // Enregistrer la date d'entrée dans la nouvelle colonne
    updateDeptTracking(cardId, targetColIndex, 'entree');
    
    const delayPill = card.querySelector('.mcard-delay-pill');
    const delaySpan = delayPill?.querySelector('span');
    
    // Retirer les classes de colonne spéciale
    card.classList.remove('in-attente-column', 'in-expedition-column');
    delayPill?.classList.remove('attente-active');
    
    // Si DÉJÀ expédié, garder le statut permanent
    if (cardsData[cardId]?.expedie && cardsData[cardId]?.dateExpedition) {
      if (delaySpan) delaySpan.textContent = `Expédié ${cardsData[cardId].dateExpedition}`;
      delayPill?.classList.add('expedie');
    } else if (targetColIndex === 7) {
      // Vers En attente: afficher "? Raison" ou la raison existante
      card.classList.add('in-attente-column');
      if (delaySpan) {
        const raison = cardsData[cardId]?.raisonAttente;
        delaySpan.textContent = raison || '? Raison';
        if (raison && cardsData[cardId]?.attenteActive) {
          delayPill?.classList.add('attente-active');
        }
      }
    } else if (targetColIndex === 6) {
      // Vers Expédition: afficher "Expédier"
      card.classList.add('in-expedition-column');
      if (delaySpan) {
        delaySpan.textContent = 'Expédier';
      }
    } else {
      // Autres colonnes: afficher le délai
      if (delaySpan && cardsData[cardId]) {
        const delay = calculateRemainingDelay(cardsData[cardId]);
        delaySpan.textContent = `Délai ${delay} j`;
      }
    }
    
    if (cardsData[cardId]) {
      cardsData[cardId].columnIndex = targetColIndex;
      saveCardToFirebase(cardId);
    }
    
    updateColumnCounts();
    addLogEntry('Déplacement', `Moulage déplacé vers colonne ${targetColIndex}`);
  }
}

// Fonction pour mettre à jour le tracking des départements
function updateDeptTracking(cardId, colIndex, type) {
  if (!cardsData[cardId]) return;
  
  const deptMap = {
    0: 'robot',
    1: 'degauchage',
    2: 'essayage',
    3: 'atelier',
    4: 'couture',
    5: 'peinture',
    6: 'expedition'
    // 7 = En attente (pas de tracking)
  };
  
  const deptKey = deptMap[colIndex];
  if (!deptKey) return; // Pas de tracking pour "En attente"
  
  if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
  if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
  
  const today = new Date().toISOString().split('T')[0];
  
  if (type === 'entree' && !cardsData[cardId].tracking[deptKey].entree) {
    // Enregistrer l'entrée seulement si pas déjà enregistrée
    cardsData[cardId].tracking[deptKey].entree = today;
  } else if (type === 'sortie' && !cardsData[cardId].tracking[deptKey].sortie) {
    // Enregistrer la sortie seulement si pas déjà enregistrée
    cardsData[cardId].tracking[deptKey].sortie = today;
  }
}

// Générer le HTML du tracking pour un moulage
function renderMoulageTracking(data) {
  const departements = [
    { key: 'robot', name: 'Robot' },
    { key: 'degauchage', name: 'Dégau.' },
    { key: 'essayage', name: 'Essai' },
    { key: 'atelier', name: 'Atelier' },
    { key: 'couture', name: 'Couture' },
    { key: 'peinture', name: 'Peint.' },
    { key: 'expedition', name: 'Expéd.' }
  ];
  
  if (!data.tracking) data.tracking = {};
  
  let html = '';
  departements.forEach(dept => {
    const tracking = data.tracking[dept.key] || {};
    const entree = tracking.entree;
    const sortie = tracking.sortie;
    
    let jours = 0;
    let isActive = false;
    let isCompleted = false;
    let dateInfo = '';
    
    if (entree && sortie) {
      jours = calculerJoursOuvrables(new Date(entree), sortie);
      if (jours === null) jours = 0;
      isCompleted = true;
      dateInfo = `${entree.substring(5)} → ${sortie.substring(5)}`;
    } else if (entree && !sortie) {
      jours = calculerJoursOuvrables(new Date(entree), new Date());
      if (jours === null) jours = 0;
      isActive = true;
      dateInfo = `Depuis ${entree.substring(5)}`;
    }
    
    const activeClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
    
    html += `
      <div class="cmd-tracking-dept ${activeClass}">
        <div class="cmd-tracking-dept-name">${dept.name}</div>
        <div class="cmd-tracking-dept-time">${jours > 0 ? jours + 'j' : '-'}</div>
        ${dateInfo ? `<div class="cmd-tracking-dept-dates">${dateInfo}</div>` : ''}
      </div>
    `;
  });
  
  return html;
}

// Générer le total et les jours restants pour un moulage
function renderMoulageTrackingTotal(data) {
  const departements = ['robot', 'degauchage', 'essayage', 'atelier', 'couture', 'peinture', 'expedition'];
  
  if (!data.tracking) data.tracking = {};
  
  let totalJours = 0;
  departements.forEach(deptKey => {
    const tracking = data.tracking[deptKey] || {};
    if (tracking.entree) {
      const sortie = tracking.sortie || new Date().toISOString().split('T')[0];
      const jours = calculerJoursOuvrables(new Date(tracking.entree), sortie);
      if (jours !== null) totalJours += jours;
    }
  });
  
  // Calculer les jours restants pour la livraison
  let livraisonHtml = '';
  if (data.dateLivraison && data.dateLivraison !== 'AAAA-MM-JJ') {
    const joursRestants = calculerJoursOuvrables(new Date(), data.dateLivraison);
    if (joursRestants !== null) {
      let livraisonClass = 'ok';
      if (joursRestants < 0) livraisonClass = 'urgent';
      else if (joursRestants <= 3) livraisonClass = 'urgent';
      else if (joursRestants <= 7) livraisonClass = 'warning';
      
      const livraisonText = joursRestants < 0 
        ? `${Math.abs(joursRestants)}j retard` 
        : `${joursRestants}j restants`;
      
      livraisonHtml = `
        <div class="cmd-tracking-livraison">
          <span class="cmd-tracking-livraison-label">Livraison:</span>
          <span class="cmd-tracking-livraison-days ${livraisonClass}">${livraisonText}</span>
        </div>
      `;
    }
  }
  
  return `
    <div class="cmd-tracking-total">
      <span class="cmd-tracking-total-label">Temps total:</span>
      <span class="cmd-tracking-total-value">${totalJours}j</span>
    </div>
    ${livraisonHtml}
  `;
}

// ===== COMPTEURS COLONNES =====
function updateColumnCounts() {
  document.querySelectorAll('#mainBoard .col').forEach(col => {
    const count = col.querySelectorAll('.mcard').length;
    const countEl = col.querySelector('.col-count');
    if (countEl) countEl.textContent = count;
  });
}

// ===== RECHERCHE =====
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');

searchInput.addEventListener('input', () => {
  const term = searchInput.value.toLowerCase();
  
  // Recherche dans la page active
  if (currentPage === 'moulages') {
    document.querySelectorAll('#mainBoard .mcard').forEach(card => {
      const title = card.querySelector('.mcard-title')?.value?.toLowerCase() || '';
      const order = card.querySelector('.mcard-order')?.value?.toLowerCase() || '';
      const match = title.includes(term) || order.includes(term);
      card.style.display = match ? '' : 'none';
    });
  } else {
    document.querySelectorAll('#commandesBoard .mcard').forEach(card => {
      const title = card.querySelector('.mcard-title')?.value?.toLowerCase() || '';
      const order = card.querySelector('.mcard-order')?.value?.toLowerCase() || '';
      const match = title.includes(term) || order.includes(term);
      card.style.display = match ? '' : 'none';
    });
  }
});

searchClear.addEventListener('click', () => {
  searchInput.value = '';
  document.querySelectorAll('.mcard').forEach(card => card.style.display = '');
});

// ===== FIREBASE SYNC =====
function saveCardToFirebase(cardId) {
  if (!firebaseInitialized) return;
  
  // Vérifier les permissions
  if (!userCan('edit')) {
    console.warn("⚠️ Permission refusée: vous n'avez pas le droit de modifier");
    return;
  }
  
  const data = cardsData[cardId];
  if (data) {
    firebase.database().ref('cards/' + cardId).set(data);
  }
}

function deleteCardFromFirebase(cardId) {
  if (!firebaseInitialized) return;
  
  // Vérifier les permissions
  if (!userCan('delete')) {
    alert("⛔ Vous n'avez pas la permission de supprimer des cartes.");
    return false;
  }
  
  firebase.database().ref('cards/' + cardId).remove();
  return true;
}

function loadCardsFromFirebase() {
  if (!firebaseInitialized) return;
  
  // Écoute en temps réel des changements
  firebase.database().ref('cards').on('value', snapshot => {
    const data = snapshot.val();
    
    // Supprimer les cartes MOULAGES qui n'existent plus dans Firebase (pas les commandes)
    document.querySelectorAll('#mainBoard .mcard[data-card-id]').forEach(card => {
      const cardId = card.dataset.cardId;
      if (!data || !data[cardId]) {
        card.remove();
        delete cardsData[cardId];
      }
    });
    
    if (data) {
      Object.keys(data).forEach(cardId => {
        const cardData = data[cardId];
        cardsData[cardId] = cardData;
        
        // Vérifier si la carte existe déjà
        let card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        const isAttente = (cardData.columnIndex === 7);
        const isExpedition = (cardData.columnIndex === 6);
        
        if (card) {
          // Mettre à jour la carte existante
          const titleInput = card.querySelector('.mcard-title');
          const orderInput = card.querySelector('.mcard-order');
          if (titleInput) titleInput.value = cardData.name || 'Nom du moulage';
          if (orderInput) orderInput.value = cardData.order || '000000';
          
          // Mettre à jour la région et colonnes spéciales
          card.classList.remove('region-qc', 'region-on', 'region-ma', 'in-attente-column', 'in-expedition-column');
          if (cardData.region === 'Québec') card.classList.add('region-qc');
          else if (cardData.region === 'Ontario') card.classList.add('region-on');
          else if (cardData.region === 'Maritime') card.classList.add('region-ma');
          if (isAttente) card.classList.add('in-attente-column');
          if (isExpedition) card.classList.add('in-expedition-column');
          
          // Mettre à jour la pastille délai
          const delayPill = card.querySelector('.mcard-delay-pill');
          const delaySpan = delayPill?.querySelector('span');
          
          // Retirer les classes de pastille
          delayPill?.classList.remove('expedie', 'attente-active', 'delay-warning', 'delay-danger', 'retard', 'delai-vert', 'delai-jaune', 'delai-rouge', 'delai-retard');
          
          if (delaySpan) {
            if (cardData.expedie && cardData.dateExpedition) {
              // Expédié permanent
              delaySpan.textContent = `Expédié ${cardData.dateExpedition}`;
              delayPill.classList.add('expedie');
            } else if (isAttente) {
              delaySpan.textContent = cardData.raisonAttente || '? Raison';
              // Activer clignotement si raison sélectionnée
              if (cardData.raisonAttente && cardData.attenteActive) {
                delayPill.classList.add('attente-active');
              }
            } else if (isExpedition) {
              delaySpan.textContent = 'Expédier';
            } else {
              // Afficher les jours RESTANTS depuis dateRobot
              const hasValidDateRobot = cardData.dateRobot && cardData.dateRobot !== '' && cardData.dateRobot !== 'AAAA-MM-JJ';
              
              if (hasValidDateRobot) {
                const delaiInfo = calculateRemainingDelay(cardData);
                const joursRestants = delaiInfo.joursRestants;
                
                // Retirer toutes les classes de couleur
                delayPill.classList.remove('delai-vert', 'delai-jaune', 'delai-rouge', 'delai-retard');
                
                if (joursRestants < 0) {
                  // En retard
                  const joursRetard = Math.abs(joursRestants);
                  delaySpan.textContent = `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`;
                  delayPill.classList.add('delai-retard');
                } else if (joursRestants === 0) {
                  // Dernier jour
                  delaySpan.textContent = "Aujourd'hui!";
                  delayPill.classList.add('delai-retard');
                } else {
                  delaySpan.textContent = `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`;
                  
                  // Colorer selon les jours restants
                  if (joursRestants <= 3) {
                    delayPill.classList.add('delai-rouge');
                  } else if (joursRestants <= 10) {
                    delayPill.classList.add('delai-jaune');
                  } else {
                    delayPill.classList.add('delai-vert');
                  }
                }
              } else {
                // Pas de date robot - afficher le délai total de la région en vert
                const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
                delaySpan.textContent = `${delaiTotal} jours ouvrables`;
                delayPill.classList.remove('delai-vert', 'delai-jaune', 'delai-rouge', 'delai-retard');
                delayPill.classList.add('delai-vert');
              }
            }
          }
          
          // Déplacer si nécessaire
          const columns = document.querySelectorAll('#mainBoard .col');
          const currentCol = card.closest('.col');
          const targetCol = columns[cardData.columnIndex || 0];
          if (currentCol !== targetCol && targetCol) {
            targetCol.appendChild(card);
          }
        } else {
          // Créer nouvelle carte
          card = document.createElement('div');
          card.className = 'mcard';
          card.dataset.cardId = cardId;
          
          if (cardData.region === 'Québec') card.classList.add('region-qc');
          else if (cardData.region === 'Ontario') card.classList.add('region-on');
          else if (cardData.region === 'Maritime') card.classList.add('region-ma');
          if (isAttente) card.classList.add('in-attente-column');
          
          const isExpedition = (cardData.columnIndex === 6);
          if (isExpedition) card.classList.add('in-expedition-column');
          
          // Calculer le délai restant
          const delaiInfo = calculateRemainingDelay(cardData);
          const joursRestants = delaiInfo.joursRestants;
          const isRetard = joursRestants < 0;
          
          // Déterminer le texte et les classes de la pastille délai
          let delayText;
          let delayClasses = 'mcard-delay-pill';
          
          // Vérifier si dateRobot est défini et valide
          const hasValidDateRobot = cardData.dateRobot && cardData.dateRobot !== '' && cardData.dateRobot !== 'AAAA-MM-JJ';
          
          if (hasValidDateRobot) {
            if (isRetard) {
              // En retard
              const joursRetard = Math.abs(joursRestants);
              delayText = `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`;
              delayClasses += ' delai-retard';
            } else if (joursRestants === 0) {
              // Aujourd'hui - dernier jour
              delayText = "Aujourd'hui!";
              delayClasses += ' delai-retard';
            } else {
              // Jours restants
              delayText = `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`;
              // Colorer selon les jours restants
              if (joursRestants <= 3) {
                delayClasses += ' delai-rouge';
              } else if (joursRestants <= 10) {
                delayClasses += ' delai-jaune';
              } else {
                delayClasses += ' delai-vert';
              }
            }
          } else {
            // Pas de date robot - afficher le délai total de la région en vert
            const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
            delayText = `${delaiTotal} jours ouvrables`;
            delayClasses += ' delai-vert';
          }
          
          if (cardData.expedie && cardData.dateExpedition) {
            // Expédié permanent
            delayText = `Expédié ${cardData.dateExpedition}`;
            delayClasses = 'mcard-delay-pill expedie';
          } else if (isAttente) {
            delayText = cardData.raisonAttente || '? Raison';
            delayClasses = 'mcard-delay-pill';
            // Si raison sélectionnée, activer le clignotement
            if (cardData.raisonAttente && cardData.attenteActive) {
              delayClasses += ' attente-active';
            }
          } else if (isExpedition) {
            delayText = 'Expédier';
            delayClasses = 'mcard-delay-pill';
          }
          
          const regionText = cardData.region || '--';
          
          card.innerHTML = `
            <div class="priority-badge hidden" data-priority="0"></div>
            <div class="mcard-header">
              <div class="mcard-info">
                <div class="mcard-title-line">
                  <input type="text" class="mcard-title" value="${cardData.name || 'Nom du moulage'}" data-field="name">
                </div>
                <div class="mcard-order-line">
                  <button class="mcard-btn-priority-small" title="Définir priorité">⭐</button>
                  <input type="text" class="mcard-order" value="${cardData.order || '000000'}" data-field="order" maxlength="6">
                  <button class="mcard-toggle-btn" data-action="open-fiche" data-card-id="${cardId}" title="Ouvrir la fiche">📋</button>
                </div>
              </div>
            </div>
            <div class="mcard-separator"></div>
            <div class="${delayClasses}" onclick="openDelaiMenu('${cardId}', event)"><span>${delayText}</span></div>
            <div class="mcard-footer-buttons">
              <button class="mcard-btn mcard-btn-move">Déplacer</button>
              <button class="mcard-btn mcard-btn-delete">Supprimer</button>
            </div>
          `;
          
          const columns = document.querySelectorAll('#mainBoard .col');
          const targetCol = columns[cardData.columnIndex || 0];
          if (targetCol) targetCol.appendChild(card);
          
          attachCardEvents(card);
        }
      });
      
      updateColumnCounts();
      refreshAllPriorities();
      console.log(`✅ ${Object.keys(data).length} cartes synchronisées`);
    } else {
      updateColumnCounts();
    }
  });
}

// Calculer le délai restant basé sur dateRobot, en jours ouvrables
// SYSTÈME RÉÉCRIT POUR ÊTRE ROBUSTE
function calculateRemainingDelay(cardData) {
  // Si expédié, retourner 0
  if (cardData.expedie) {
    return { joursRestants: 0, joursEcoules: 0, delaiTotal: 0 };
  }
  
  // Délai selon la région (ou délai personnalisé)
  const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
  
  // Vérifier si dateRobot est valide
  const dateRobotStr = cardData.dateRobot;
  
  // Conditions pour une date valide
  if (!dateRobotStr || dateRobotStr === '' || dateRobotStr === 'AAAA-MM-JJ' || dateRobotStr === '-') {
    // Pas de date robot valide - retourner le délai total
    return { joursRestants: delaiTotal, joursEcoules: 0, delaiTotal };
  }
  
  // Parser la date Robot
  const dateRobot = new Date(dateRobotStr + 'T00:00:00');
  
  // Vérifier que la date est valide
  if (isNaN(dateRobot.getTime())) {
    console.warn('⚠️ Date Robot invalide:', dateRobotStr);
    return { joursRestants: delaiTotal, joursEcoules: 0, delaiTotal };
  }
  
  // Date d'aujourd'hui à minuit
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Calculer les jours ouvrables écoulés depuis la date robot
  let joursOuvrablesEcoules = compterJoursOuvrables(dateRobot, today);
  
  // Soustraire le temps passé en essayage (département essayage)
  if (cardData.tracking && cardData.tracking.essayage) {
    const essayage = cardData.tracking.essayage;
    if (essayage.entree && essayage.sortie) {
      const dateEntree = new Date(essayage.entree + 'T00:00:00');
      const dateSortie = new Date(essayage.sortie + 'T00:00:00');
      if (!isNaN(dateEntree.getTime()) && !isNaN(dateSortie.getTime())) {
        const joursEssayage = compterJoursOuvrables(dateEntree, dateSortie);
        joursOuvrablesEcoules -= joursEssayage;
        if (joursOuvrablesEcoules < 0) joursOuvrablesEcoules = 0;
      }
    }
  }
  
  const joursRestants = delaiTotal - joursOuvrablesEcoules;
  
  return { joursRestants, joursEcoules: joursOuvrablesEcoules, delaiTotal };
}

// NOUVELLE FONCTION: Compter les jours ouvrables entre deux dates
// Plus robuste que l'ancienne calculerJoursOuvrables
function compterJoursOuvrables(dateDebut, dateFin) {
  // Créer des copies pour ne pas modifier les originaux
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  
  // Normaliser à minuit
  debut.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  // Si la date de fin est avant ou égale à la date de début, retourner 0
  if (fin <= debut) {
    return 0;
  }
  
  // Obtenir les jours fériés pour toutes les années concernées
  const anneeDebut = debut.getFullYear();
  const anneeFin = fin.getFullYear();
  let joursFeries = [];
  
  for (let annee = anneeDebut; annee <= anneeFin; annee++) {
    const feries = getJoursFeriesQuebec(annee);
    joursFeries = joursFeries.concat(feries.map(d => d.toDateString()));
  }
  
  // Compter les jours ouvrables
  let joursOuvrables = 0;
  const current = new Date(debut);
  
  while (current < fin) {
    current.setDate(current.getDate() + 1);
    
    const jour = current.getDay();
    const estWeekend = (jour === 0 || jour === 6);
    const estFerie = joursFeries.includes(current.toDateString());
    
    if (!estWeekend && !estFerie) {
      joursOuvrables++;
    }
  }
  
  return joursOuvrables;
}

// Ouvrir le menu de délai quand on clique sur la pastille
function openDelaiMenu(cardId, event) {
  event.stopPropagation();
  event.preventDefault();
  
  // Fermer TOUS les menus existants d'abord
  document.getElementById('delaiMenu')?.remove();
  document.getElementById('raisonAttenteMenu')?.remove();
  document.getElementById('rangRobotMenu')?.remove();
  document.getElementById('delaiRegionsMenu')?.remove();
  document.querySelectorAll('.raison-attente-menu, .cmd-select-menu, .client-select-menu').forEach(m => m.remove());
  
  const cardData = cardsData[cardId];
  if (!cardData) return;
  
  // Si la carte est dans la colonne "En attente" (colonne 7), ouvrir le menu raison
  if (cardData.columnIndex === 7) {
    openRaisonAttenteMenu(cardId, event);
    return;
  }
  
  const delaiInfo = calculateRemainingDelay(cardData);
  const currentRegion = cardData.region || 'Québec';
  const delaiActuel = cardData.delaiPersonnalise || MENU_DATA.delays[currentRegion] || 90;
  
  const menu = document.createElement('div');
  menu.id = 'delaiMenu';
  menu.className = 'delai-menu-popup';
  
  // Obtenir les délais actuels pour chaque région
  const delaiQC = MENU_DATA.delays['Québec'] || 90;
  const delaiMA = MENU_DATA.delays['Maritime'] || 45;
  const delaiON = MENU_DATA.delays['Ontario'] || 30;
  
  menu.innerHTML = `
    <div class="delai-menu-header">⏱ Délais par région</div>
    <div class="delai-regions-simple">
      <div class="delai-region-row ${currentRegion === 'Québec' ? 'active' : ''}" onclick="selectRegionDelai('${cardId}', 'Québec')">
        <span class="region-name">Québec</span>
        <input type="number" class="region-delai-input" id="delaiQC" value="${delaiQC}" min="1" max="365" onclick="event.stopPropagation()">
        <span class="region-unit">jours</span>
      </div>
      <div class="delai-region-row ${currentRegion === 'Maritime' ? 'active' : ''}" onclick="selectRegionDelai('${cardId}', 'Maritime')">
        <span class="region-name">Maritime</span>
        <input type="number" class="region-delai-input" id="delaiMA" value="${delaiMA}" min="1" max="365" onclick="event.stopPropagation()">
        <span class="region-unit">jours</span>
      </div>
      <div class="delai-region-row ${currentRegion === 'Ontario' ? 'active' : ''}" onclick="selectRegionDelai('${cardId}', 'Ontario')">
        <span class="region-name">Ontario</span>
        <input type="number" class="region-delai-input" id="delaiON" value="${delaiON}" min="1" max="365" onclick="event.stopPropagation()">
        <span class="region-unit">jours</span>
      </div>
    </div>
    <div class="delai-menu-footer">
      <button class="delai-save-btn" onclick="saveDelaiAndClose('${cardId}')">Sauvegarder et fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Positionner près de l'élément cliqué
  const rect = event.target.getBoundingClientRect();
  menu.style.left = Math.min(rect.left, window.innerWidth - 250) + 'px';
  menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - 250) + 'px';
}

// Sélectionner une région et appliquer son délai
function selectRegionDelai(cardId, region) {
  // Marquer la ligne active visuellement
  document.querySelectorAll('.delai-region-row').forEach(row => row.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  // Mettre à jour la région de la carte
  if (cardsData[cardId]) {
    cardsData[cardId].region = region;
  }
}

// Sauvegarder les délais et fermer
function saveDelaiAndClose(cardId) {
  // Récupérer les valeurs des inputs
  const delaiQC = parseInt(document.getElementById('delaiQC')?.value) || 90;
  const delaiMA = parseInt(document.getElementById('delaiMA')?.value) || 45;
  const delaiON = parseInt(document.getElementById('delaiON')?.value) || 30;
  
  // Mettre à jour les délais globaux
  MENU_DATA.delays['Québec'] = delaiQC;
  MENU_DATA.delays['Maritime'] = delaiMA;
  MENU_DATA.delays['Ontario'] = delaiON;
  
  // Sauvegarder la région sélectionnée pour cette carte
  if (cardsData[cardId]) {
    const selectedRegion = document.querySelector('.delai-region-row.active .region-name')?.textContent || cardsData[cardId].region;
    cardsData[cardId].region = selectedRegion;
    cardsData[cardId].delaiPersonnalise = MENU_DATA.delays[selectedRegion];
    saveCardToFirebase(cardId);
    
    // Mettre à jour l'affichage
    const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (card) {
      const colIndex = parseInt(card.closest('.col')?.dataset.col || 0);
      updateCardDelayPill(card, cardId, colIndex);
    }
  }
  
  document.getElementById('delaiMenu')?.remove();
}

// Fonction pour rafraîchir tous les délais des cartes moulage
function refreshAllMoulageDelays() {
  document.querySelectorAll('#mainBoard .mcard').forEach(card => {
    const cardId = card.dataset.cardId;
    if (cardId && cardsData[cardId]) {
      const colIndex = parseInt(card.closest('.col')?.dataset.col || 0);
      updateCardDelayPill(card, cardId, colIndex);
    }
  });
}

// ===== FICHE MOULAGE =====
let currentExpandedCard = null;
let cardOverlay = null;

// Initialiser l'overlay
function initCardOverlay() {
  cardOverlay = document.getElementById('cardOverlay');
  if (cardOverlay) {
    cardOverlay.addEventListener('click', (e) => {
      // Ne fermer que si on clique directement sur l'overlay
      if (e.target === cardOverlay && currentExpandedCard) {
        closeFiche();
      }
    });
  }
}

// Appeler après le chargement du DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCardOverlay);
} else {
  initCardOverlay();
}

// ===== FONCTIONS SIDEBAR TRACKING =====
function generateTrackingSidebar(cardId, data) {
  const departements = [
    { key: 'robot', name: 'Robot', icon: '⚙️' },
    { key: 'degauchage', name: 'Dégau.', icon: '🪚' },
    { key: 'essayage', name: 'Essai', icon: '♿' },
    { key: 'atelier', name: 'Atelier', icon: '📐' },
    { key: 'couture', name: 'Couture', icon: '🧵' },
    { key: 'peinture', name: 'Peint.', icon: '🎨' },
    { key: 'expedition', name: 'Expéd.', icon: '🚚' }
  ];
  
  if (!data.tracking) data.tracking = {};
  
  let totalJours = 0;
  let deptItemsHTML = '';
  
  departements.forEach((dept) => {
    const tracking = data.tracking[dept.key] || {};
    const entree = tracking.entree || '';
    const sortie = tracking.sortie || '';
    
    let jours = 0;
    let isActive = false;
    let isCompleted = false;
    
    if (entree && sortie) {
      const dateEntree = new Date(entree);
      const dateSortie = new Date(sortie);
      jours = calculerJoursOuvrables(dateEntree, dateSortie);
      if (jours === null || jours === undefined || jours < 1) jours = 1;
      isCompleted = true;
    } else if (entree && !sortie) {
      const dateEntree = new Date(entree);
      jours = calculerJoursOuvrables(dateEntree, new Date());
      if (jours === null || jours === undefined || jours < 1) jours = 1;
      isActive = true;
    }
    
    totalJours += jours;
    
    const statusClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
    const joursDisplay = entree ? `${jours}j` : '-';
    
    deptItemsHTML += `
      <div class="tracking-dept-pill ${statusClass}" onclick="openTrackingDatesMenu('${cardId}', '${dept.key}', '${dept.icon} ${dept.name}', event)">
        <span class="tracking-pill-icon">${dept.icon}</span>
        <span class="tracking-pill-name">${dept.name}</span>
        <span class="tracking-pill-jours">${joursDisplay}</span>
      </div>
    `;
  });
  
  return `
    <div class="mcard-tracking-sidebar" data-card-id="${cardId}">
      <div class="tracking-sidebar-title">📊 Suivi</div>
      <div class="tracking-pills-container">
        ${deptItemsHTML}
      </div>
      <div class="tracking-total-box">
        <div class="tracking-total-label">Total</div>
        <div class="tracking-total-value">${totalJours}j</div>
      </div>
    </div>
  `;
}

// Menu pour modifier les dates d'un département
function openTrackingDatesMenu(cardId, deptKey, deptName, event) {
  event.stopPropagation();
  
  // Fermer tout menu existant
  document.getElementById('trackingDatesMenu')?.remove();
  
  const data = cardsData[cardId] || {};
  const tracking = data.tracking?.[deptKey] || {};
  const entree = tracking.entree || '';
  const sortie = tracking.sortie || '';
  
  const entreeDisplay = entree ? formatDateFull(entree) : 'Cliquer pour définir';
  const sortieDisplay = sortie ? formatDateFull(sortie) : 'Cliquer pour définir';
  
  const menu = document.createElement('div');
  menu.id = 'trackingDatesMenu';
  menu.className = 'tracking-dates-menu';
  
  menu.innerHTML = `
    <div class="tracking-menu-header">${deptName}</div>
    <div class="tracking-menu-row">
      <span class="tracking-menu-label">Entrée:</span>
      <span class="tracking-menu-date" onclick="openTrackingCalendar('${cardId}', '${deptKey}', 'entree', event)">${entreeDisplay}</span>
    </div>
    <div class="tracking-menu-row">
      <span class="tracking-menu-label">Sortie:</span>
      <span class="tracking-menu-date" onclick="openTrackingCalendar('${cardId}', '${deptKey}', 'sortie', event)">${sortieDisplay}</span>
    </div>
    <div class="tracking-menu-footer">
      <button onclick="document.getElementById('trackingDatesMenu')?.remove()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Positionner à droite de la pastille, centré verticalement
  const rect = event.target.getBoundingClientRect();
  const menuHeight = menu.offsetHeight || 120;
  const menuWidth = menu.offsetWidth || 180;
  
  // Horizontalement: à droite de la pastille avec 10px d'espace
  let leftPos = rect.right + 10;
  // Si ça dépasse à droite, mettre à gauche de la pastille
  if (leftPos + menuWidth > window.innerWidth - 10) {
    leftPos = rect.left - menuWidth - 10;
  }
  
  // Verticalement: centré par rapport à la pastille
  const pillCenterY = rect.top + (rect.height / 2);
  let topPos = pillCenterY - (menuHeight / 2);
  
  // S'assurer que le menu ne dépasse pas en haut ou en bas
  if (topPos < 10) topPos = 10;
  if (topPos + menuHeight > window.innerHeight - 10) {
    topPos = window.innerHeight - menuHeight - 10;
  }
  
  menu.style.left = leftPos + 'px';
  menu.style.top = topPos + 'px';
}

// Formater date complète
function formatDateFull(dateStr) {
  if (!dateStr) return 'Cliquer pour définir';
  const d = new Date(dateStr);
  const day = d.getDate().toString().padStart(2, '0');
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

// Formater date en format court
function formatDateShort(dateStr) {
  if (!dateStr) return '---';
  const d = new Date(dateStr);
  const day = d.getDate().toString().padStart(2, '0');
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  return `${day}/${month}`;
}

// Variables pour le calendrier tracking
let trackingCalCardId = null;
let trackingCalDeptKey = null;
let trackingCalDateType = null;
let trackingCalYear = new Date().getFullYear();
let trackingCalMonth = new Date().getMonth();

// Ouvrir calendrier pour tracking
function openTrackingCalendar(cardId, deptKey, dateType, event) {
  event.stopPropagation();
  
  trackingCalCardId = cardId;
  trackingCalDeptKey = deptKey;
  trackingCalDateType = dateType;
  
  // Récupérer la date actuelle si elle existe
  const data = cardsData[cardId] || {};
  const tracking = data.tracking?.[deptKey] || {};
  const currentDate = tracking[dateType];
  
  if (currentDate) {
    const d = new Date(currentDate);
    trackingCalYear = d.getFullYear();
    trackingCalMonth = d.getMonth();
  } else {
    trackingCalYear = new Date().getFullYear();
    trackingCalMonth = new Date().getMonth();
  }
  
  // Créer le popup calendrier
  document.getElementById('trackingCalPopup')?.remove();
  
  const popup = document.createElement('div');
  popup.id = 'trackingCalPopup';
  popup.className = 'tracking-cal-popup';
  popup.innerHTML = `
    <div class="tracking-cal-header">${dateType === 'entree' ? 'Date entrée' : 'Date sortie'}</div>
    <div class="tracking-cal-nav">
      <button onclick="trackingCalPrev()">◀</button>
      <span id="trackingCalMonthYear"></span>
      <button onclick="trackingCalNext()">▶</button>
    </div>
    <div class="tracking-cal-weekdays">
      <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
    </div>
    <div class="tracking-cal-days" id="trackingCalDays"></div>
    <div class="tracking-cal-btns">
      <button onclick="selectTrackingToday()">Aujourd'hui</button>
      <button onclick="clearTrackingDate()">Effacer</button>
      <button onclick="closeTrackingCalendar()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Positionner près du clic
  const rect = event.target.getBoundingClientRect();
  popup.style.left = Math.min(rect.left, window.innerWidth - 220) + 'px';
  popup.style.top = Math.min(rect.bottom + 5, window.innerHeight - 280) + 'px';
  
  renderTrackingCalendar();
}

function renderTrackingCalendar() {
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  document.getElementById('trackingCalMonthYear').textContent = `${monthNames[trackingCalMonth]} ${trackingCalYear}`;
  
  const daysContainer = document.getElementById('trackingCalDays');
  daysContainer.innerHTML = '';
  
  const firstDay = new Date(trackingCalYear, trackingCalMonth, 1).getDay();
  const daysInMonth = new Date(trackingCalYear, trackingCalMonth + 1, 0).getDate();
  const today = new Date();
  
  // Récupérer la date sélectionnée
  const data = cardsData[trackingCalCardId] || {};
  const tracking = data.tracking?.[trackingCalDeptKey] || {};
  const selectedDate = tracking[trackingCalDateType];
  
  // Jours vides avant le 1er
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('span');
    empty.className = 'tracking-cal-day empty';
    daysContainer.appendChild(empty);
  }
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement('span');
    dayEl.className = 'tracking-cal-day';
    dayEl.textContent = day;
    
    const dateStr = `${trackingCalYear}-${(trackingCalMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    
    if (dateStr === selectedDate) dayEl.classList.add('selected');
    if (today.getFullYear() === trackingCalYear && today.getMonth() === trackingCalMonth && today.getDate() === day) {
      dayEl.classList.add('today');
    }
    
    dayEl.onclick = () => selectTrackingDate(dateStr);
    daysContainer.appendChild(dayEl);
  }
}

function trackingCalPrev() {
  trackingCalMonth--;
  if (trackingCalMonth < 0) { trackingCalMonth = 11; trackingCalYear--; }
  renderTrackingCalendar();
}

function trackingCalNext() {
  trackingCalMonth++;
  if (trackingCalMonth > 11) { trackingCalMonth = 0; trackingCalYear++; }
  renderTrackingCalendar();
}

function selectTrackingDate(dateStr) {
  updateTrackingDate(trackingCalCardId, trackingCalDeptKey, trackingCalDateType, dateStr);
  closeTrackingCalendar();
}

function selectTrackingToday() {
  const today = new Date();
  const dateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
  selectTrackingDate(dateStr);
}

function clearTrackingDate() {
  updateTrackingDate(trackingCalCardId, trackingCalDeptKey, trackingCalDateType, '');
  closeTrackingCalendar();
}

function closeTrackingCalendar() {
  document.getElementById('trackingCalPopup')?.remove();
}

// Mise à jour directe des dates de tracking
function updateTrackingDate(cardId, deptKey, dateType, value) {
  if (!cardsData[cardId]) return;
  if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
  if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
  
  cardsData[cardId].tracking[deptKey][dateType] = value;
  saveCardToFirebase(cardId);
  
  // Rafraîchir la sidebar
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card && card.classList.contains('mcard-expanded')) {
    const sidebar = card.querySelector('.mcard-tracking-sidebar');
    if (sidebar) {
      const newHTML = generateTrackingSidebar(cardId, cardsData[cardId]);
      const temp = document.createElement('div');
      temp.innerHTML = newHTML;
      sidebar.outerHTML = temp.firstElementChild.outerHTML;
    }
  }
}

function openTrackingEdit(cardId, deptKey, deptName) {
  // Cette fonction n'est plus utilisée mais gardée pour compatibilité
  document.getElementById('trackingEditOverlay')?.remove();
  document.getElementById('trackingEditPopup')?.remove();
  
  const data = cardsData[cardId] || {};
  if (!data.tracking) data.tracking = {};
  if (!data.tracking[deptKey]) data.tracking[deptKey] = {};
  
  const entree = data.tracking[deptKey].entree || '';
  const sortie = data.tracking[deptKey].sortie || '';
  
  const overlay = document.createElement('div');
  overlay.id = 'trackingEditOverlay';
  overlay.className = 'tracking-edit-overlay active';
  overlay.onclick = closeTrackingEdit;
  document.body.appendChild(overlay);
  
  const popup = document.createElement('div');
  popup.id = 'trackingEditPopup';
  popup.className = 'tracking-edit-popup active';
  popup.innerHTML = `
    <div class="tracking-edit-header">${deptName}</div>
    <div class="tracking-edit-body">
      <div class="tracking-edit-field">
        <label>Date d'entrée</label>
        <input type="date" id="trackingEntree" value="${entree}">
      </div>
      <div class="tracking-edit-field">
        <label>Date de sortie</label>
        <input type="date" id="trackingSortie" value="${sortie}">
      </div>
      <div class="tracking-edit-btns">
        <button class="btn-save" onclick="saveTrackingEdit('${cardId}', '${deptKey}')">Sauvegarder</button>
        <button class="btn-clear" onclick="clearTrackingEdit('${cardId}', '${deptKey}')">Effacer</button>
        <button class="btn-close" onclick="closeTrackingEdit()">Fermer</button>
      </div>
    </div>
  `;
  popup.onclick = (e) => e.stopPropagation();
  document.body.appendChild(popup);
}

function saveTrackingEdit(cardId, deptKey) {
  const entree = document.getElementById('trackingEntree').value;
  const sortie = document.getElementById('trackingSortie').value;
  
  if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
  cardsData[cardId].tracking[deptKey] = { entree, sortie };
  
  saveCardToFirebase(cardId);
  closeTrackingEdit();
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card && card.classList.contains('mcard-expanded')) {
    const sidebar = card.querySelector('.mcard-tracking-sidebar');
    if (sidebar) {
      const newHTML = generateTrackingSidebar(cardId, cardsData[cardId]);
      const temp = document.createElement('div');
      temp.innerHTML = newHTML;
      sidebar.outerHTML = temp.firstElementChild.outerHTML;
    }
  }
}

function clearTrackingEdit(cardId, deptKey) {
  if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
  cardsData[cardId].tracking[deptKey] = { entree: '', sortie: '' };
  
  saveCardToFirebase(cardId);
  closeTrackingEdit();
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card && card.classList.contains('mcard-expanded')) {
    const sidebar = card.querySelector('.mcard-tracking-sidebar');
    if (sidebar) {
      const newHTML = generateTrackingSidebar(cardId, cardsData[cardId]);
      const temp = document.createElement('div');
      temp.innerHTML = newHTML;
      sidebar.outerHTML = temp.firstElementChild.outerHTML;
    }
  }
}

function closeTrackingEdit() {
  document.getElementById('trackingEditOverlay')?.remove();
  document.getElementById('trackingEditPopup')?.remove();
}

// ===== FONCTIONS POUR SELECTS DYNAMIQUES =====
function handleSelectChange(selectEl, listName, cardId) {
  const value = selectEl.value;
  
  if (value === '__ADD__') {
    // Remettre à la valeur précédente
    selectEl.value = '';
    addValueToList(listName, cardId);
  } else if (value === '__REMOVE__') {
    // Remettre à la valeur précédente
    selectEl.value = '';
    removeValueFromList(listName, cardId);
  }
  // Sinon laisser le comportement normal
}

// Gestion des selects dans la vue horizontale avec synchronisation
function handleTableSelectChange(selectEl, cardId, fieldName, listName) {
  const value = selectEl.value;
  
  if (value === '__ADD__') {
    selectEl.value = cardsData[cardId]?.[fieldName] || '';
    addValueToList(listName, null);
    renderRobotTable(); // Rafraîchir la table
  } else if (value === '__REMOVE__') {
    selectEl.value = cardsData[cardId]?.[fieldName] || '';
    removeValueFromList(listName, null);
    renderRobotTable(); // Rafraîchir la table
  } else {
    // Mettre à jour cardsData et sauvegarder
    if (cardsData[cardId]) {
      cardsData[cardId][fieldName] = value;
      saveCardToFirebase(cardId);
      
      // Mettre à jour aussi la carte Kanban visible
      updateCardDisplay(cardId);
    }
  }
}

// Mettre à jour l'affichage de la carte Kanban
function updateCardDisplay(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card || !cardsData[cardId]) return;
  
  const data = cardsData[cardId];
  
  // Mettre à jour le nom
  const titleInput = card.querySelector('.mcard-title');
  if (titleInput && data.name) titleInput.value = data.name;
  
  // Mettre à jour la région (couleur)
  card.classList.remove('region-quebec', 'region-ontario', 'region-maritime', 'region-qc', 'region-on', 'region-ma');
  if (data.region === 'Québec') card.classList.add('region-qc');
  else if (data.region === 'Ontario') card.classList.add('region-on');
  else if (data.region === 'Maritime') card.classList.add('region-ma');
  
  // Mettre à jour la pastille région
  const regionPill = card.querySelector('.mcard-region-pill');
  if (regionPill) regionPill.textContent = data.region || '--';
  
  // Mettre à jour la pastille délai
  const colIndex = parseInt(card.closest('.col')?.dataset.col || 0);
  updateCardDelayPill(card, cardId, colIndex);
}

function addValueToList(listName, currentCardId) {
  const newValue = prompt(`Ajouter une valeur à ${listName}:`);
  if (newValue && newValue.trim()) {
    const value = newValue.trim();
    
    // Mapper les noms de listes vers customLists
    const listMapping = {
      'clients': 'moulageClients',
      'regions': 'regions',
      'intervenants': 'intervenants',
      'representantes': 'representantes',
      'items': 'items',
      'locations': 'locations'
    };
    
    const customListKey = listMapping[listName];
    
    // Ajouter à MENU_DATA pour compatibilité
    if (listName === 'clients' && !MENU_DATA.clients.includes(value)) {
      MENU_DATA.clients.push(value);
    } else if (listName === 'regions' && !MENU_DATA.regions.includes(value)) {
      MENU_DATA.regions.push(value);
      MENU_DATA.delays[value] = 45; // délai par défaut
    } else if (listName === 'intervenants' && !MENU_DATA.intervenants.includes(value)) {
      MENU_DATA.intervenants.push(value);
    } else if (listName === 'representantes' && !MENU_DATA.representantes.includes(value)) {
      MENU_DATA.representantes.push(value);
    } else if (listName === 'items' && !MENU_DATA.items.includes(value)) {
      MENU_DATA.items.push(value);
    } else if (listName === 'locations' && !MENU_DATA.locations.includes(value)) {
      MENU_DATA.locations.push(value);
    }
    
    // Ajouter à customLists et sauvegarder dans Firebase
    if (customListKey && customLists[customListKey] && !customLists[customListKey].includes(value)) {
      customLists[customListKey].push(value);
      saveCustomLists();
    }
    
    // Rafraîchir tous les selects
    updateAllSelectsFromLists();
    
    // Rafraîchir la fiche si ouverte
    if (currentCardId && currentExpandedCard) {
      const cardId = currentExpandedCard.dataset.cardId;
      closeFiche();
      const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
      if (card) openFiche(card);
    }
  }
}

function removeValueFromList(listName, currentCardId) {
  // Mapper les noms de listes vers customLists
  const listMapping = {
    'clients': 'moulageClients',
    'regions': 'regions',
    'intervenants': 'intervenants',
    'representantes': 'representantes',
    'items': 'items',
    'locations': 'locations'
  };
  
  let list = [];
  if (listName === 'clients') list = MENU_DATA.clients;
  else if (listName === 'regions') list = MENU_DATA.regions;
  else if (listName === 'intervenants') list = MENU_DATA.intervenants;
  else if (listName === 'representantes') list = MENU_DATA.representantes;
  else if (listName === 'items') list = MENU_DATA.items;
  else if (listName === 'locations') list = MENU_DATA.locations;
  
  const listStr = list.map((v, i) => `${i + 1}. ${v}`).join('\n');
  const choice = prompt(`Supprimer de ${listName}:\n${listStr}\n\nNuméro:`);
  if (choice) {
    const index = parseInt(choice) - 1;
    if (index >= 0 && index < list.length) {
      const removedValue = list[index];
      list.splice(index, 1);
      
      // Supprimer aussi de customLists et sauvegarder
      const customListKey = listMapping[listName];
      if (customListKey && customLists[customListKey]) {
        const customIndex = customLists[customListKey].indexOf(removedValue);
        if (customIndex >= 0) {
          customLists[customListKey].splice(customIndex, 1);
          saveCustomLists();
        }
      }
      
      // Rafraîchir tous les selects
      updateAllSelectsFromLists();
      
      // Rafraîchir la fiche si ouverte
      if (currentCardId && currentExpandedCard) {
        const cardId = currentExpandedCard.dataset.cardId;
        closeFiche();
        const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        if (card) openFiche(card);
      }
    }
  }
}

// ===== RANG ROBOT =====
function openRangRobotMenu(cardId, event) {
  event.stopPropagation();
  
  // Fermer tout menu existant
  document.getElementById('rangRobotMenu')?.remove();
  
  // Compter les cartes dans Robot (colonne 0)
  const robotCol = document.querySelector('#mainBoard .col[data-col="0"]');
  const cardsInRobot = robotCol ? robotCol.querySelectorAll('.mcard').length : 0;
  
  const menu = document.createElement('div');
  menu.id = 'rangRobotMenu';
  menu.className = 'menu-popup';
  menu.style.cssText = `position:fixed;left:${event.clientX}px;top:${event.clientY}px;z-index:2000;background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);padding:8px;min-width:180px;`;
  
  let positionsHTML = '';
  for (let i = 1; i <= cardsInRobot + 1; i++) {
    positionsHTML += `<div class="menu-option" onclick="setRangRobot('${cardId}', ${i})" style="padding:6px 10px;cursor:pointer;border-bottom:1px solid #e5e7eb;font-size:11px;">Position ${i}</div>`;
  }
  
  menu.innerHTML = `
    <div style="font-size:11px;font-weight:700;color:#1e40af;padding:6px 10px;border-bottom:2px solid #3b82f6;">🤖 Rang Robot (${cardsInRobot} moulages)</div>
    ${positionsHTML}
    <div style="padding:6px 10px;margin-top:4px;">
      <button onclick="document.getElementById('rangRobotMenu')?.remove()" style="width:100%;padding:6px;font-size:10px;background:#6b7280;color:white;border:none;border-radius:4px;cursor:pointer;">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Fermer au clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', () => menu.remove(), { once: true });
  }, 10);
}

function setRangRobot(cardId, position) {
  document.getElementById('rangRobotMenu')?.remove();
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  // Déplacer vers Robot (colonne 0) à la position choisie
  moveCardToPosition(card, 0, position);
}

// Calculer le nombre de jours depuis la mise en attente
function calcJoursAttente(dateAttente) {
  if (!dateAttente) return 0;
  const dateDebut = new Date(dateAttente);
  const today = new Date();
  const diffTime = Math.abs(today - dateDebut);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

// ===== NOUVELLE FONCTION - OUVRIR FICHE PAR ID (comme openCommandeFiche) =====
// Cette fonction est appelée directement par onclick avec le cardId
// C'est LA SOLUTION au problème du premier clic qui ne fonctionnait pas
function openMoulageFiche(cardId) {
  console.log('🟢 openMoulageFiche appelée pour:', cardId);
  
  if (!cardId) {
    console.error('❌ openMoulageFiche: cardId manquant');
    return;
  }
  
  // Trouver la carte dans le DOM
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) {
    console.error('❌ openMoulageFiche: carte non trouvée dans le DOM');
    return;
  }
  
  // Si la carte est déjà ouverte, la fermer
  if (card.classList.contains('mcard-expanded')) {
    console.log('🔴 Fiche déjà ouverte, fermeture');
    closeFiche();
    return;
  }
  
  // Fermer toute fiche précédente
  if (currentExpandedCard && currentExpandedCard !== card) {
    const prevCardId = currentExpandedCard.dataset.cardId;
    if (prevCardId && cardsData[prevCardId]) {
      saveCardToFirebase(prevCardId);
    }
    currentExpandedCard.classList.remove('mcard-expanded');
    currentExpandedCard = null;
  }
  
  // S'assurer que l'overlay existe
  if (!cardOverlay) {
    cardOverlay = document.getElementById('cardOverlay');
  }
  
  // Générer la fiche si pas déjà fait
  if (!card.querySelector('.mcard-fiche')) {
    console.log('📝 Génération de la fiche HTML pour:', cardId);
    card.insertAdjacentHTML('beforeend', generateFicheHTML(card));
    attachFicheEvents(card);
  } else {
    // Mettre à jour la section En attente si nécessaire
    const attenteSection = card.querySelector('.fiche-attente-section');
    if (attenteSection) {
      const data = cardsData[cardId] || {};
      if (data.columnIndex === 7) {
        attenteSection.classList.add('visible');
        const badge = attenteSection.querySelector('.attente-badge-full');
        const days = attenteSection.querySelector('.attente-days-full');
        if (badge) badge.textContent = '⏳ EN ATTENTE: ' + (data.raisonAttente || 'Raison non spécifiée');
        if (days) days.textContent = 'En attente depuis ' + (data.dateAttente || '---') + ' (' + calcJoursAttente(data.dateAttente) + ' jours)';
      } else {
        attenteSection.classList.remove('visible');
      }
    }
  }
  
  // OUVRIR la fiche
  card.classList.add('mcard-expanded');
  if (cardOverlay) cardOverlay.classList.add('active');
  currentExpandedCard = card;
  
  console.log('✅ Fiche moulage ouverte:', cardId);
  
  // Marquer les notes comme lues
  markNoteAsRead(cardId);
}
window.openMoulageFiche = openMoulageFiche;

function openFiche(card) {
  if (!card) {
    console.log('❌ openFiche: card est null');
    return;
  }
  
  console.log('🔵 openFiche appelée pour:', card.dataset.cardId);
  
  // Si c'est la même carte, ne rien faire
  if (currentExpandedCard === card) {
    console.log('⚠️ Même carte déjà ouverte');
    return;
  }
  
  // Fermer la fiche précédente SANS animation/délai
  if (currentExpandedCard) {
    console.log('🔴 Fermeture de la fiche précédente');
    const prevCardId = currentExpandedCard.dataset.cardId;
    if (prevCardId && cardsData[prevCardId]) {
      saveCardToFirebase(prevCardId);
    }
    currentExpandedCard.classList.remove('mcard-expanded');
    currentExpandedCard = null;
  }
  
  // S'assurer que l'overlay existe
  if (!cardOverlay) {
    cardOverlay = document.getElementById('cardOverlay');
  }
  
  const cardId = card.dataset.cardId;
  
  // Générer la fiche si pas déjà fait
  if (!card.querySelector('.mcard-fiche')) {
    card.insertAdjacentHTML('beforeend', generateFicheHTML(card));
    attachFicheEvents(card);
  } else {
    // Mettre à jour la section En attente si elle existe déjà
    const attenteSection = card.querySelector('.fiche-attente-section');
    if (attenteSection) {
      const data = cardsData[cardId] || {};
      if (data.columnIndex === 7) {
        attenteSection.classList.add('visible');
        const badge = attenteSection.querySelector('.attente-badge-full');
        const days = attenteSection.querySelector('.attente-days-full');
        if (badge) badge.textContent = '⏳ EN ATTENTE: ' + (data.raisonAttente || 'Raison non spécifiée');
        if (days) days.textContent = 'En attente depuis ' + (data.dateAttente || '---') + ' (' + calcJoursAttente(data.dateAttente) + ' jours)';
      } else {
        attenteSection.classList.remove('visible');
      }
    }
  }
  
  // OUVRIR la nouvelle fiche
  card.classList.add('mcard-expanded');
  if (cardOverlay) cardOverlay.classList.add('active');
  currentExpandedCard = card;
  
  console.log('✅ Fiche ouverte:', cardId);
  
  // Marquer les notes comme lues
  if (cardId) {
    markNoteAsRead(cardId);
  }
}

// Fonction legacy pour compatibilité
function openFicheFromBtn(btn) {
  console.log('🟡 openFicheFromBtn (legacy) appelée');
  const card = btn.closest('.mcard');
  if (card) {
    const cardId = card.dataset.cardId;
    if (cardId) {
      openMoulageFiche(cardId);
    }
  }
}
window.openFicheFromBtn = openFicheFromBtn;

function closeFiche() {
  if (currentExpandedCard) {
    const cardId = currentExpandedCard.dataset.cardId;
    
    // SAUVEGARDER AVANT DE FERMER
    if (cardId && cardsData[cardId]) {
      saveCardToFirebase(cardId);
      console.log('💾 Fiche moulage sauvegardée:', cardId);
    }
    
    currentExpandedCard.classList.remove('mcard-expanded');
    // Fermer les popups
    currentExpandedCard.querySelector('.fiche-calendar-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.dept-dates-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.fiche-notes')?.classList.remove('expanded');
    
    // Rafraîchir la pastille délai de la carte
    if (cardId && cardsData[cardId]) {
      const colIndex = parseInt(currentExpandedCard.closest('.col')?.dataset.col || 0);
      updateCardDelayPill(currentExpandedCard, cardId, colIndex);
    }
  }
  if (cardOverlay) cardOverlay.classList.remove('active');
  currentExpandedCard = null;
}

window.closeFicheCard = closeFiche;

// Ouvrir fiche par ID (pour onclick)
function openFicheById(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    openFiche(card);
  }
}
window.openFicheById = openFicheById;

function generateFicheHTML(card) {
  const cardId = card.dataset.cardId;
  const data = cardsData[cardId] || {};
  
  // Pré-calculer les jours d'attente
  const joursAttente = calcJoursAttente(data.dateAttente);
  const isEnAttente = data.columnIndex === 7;
  
  // Options dynamiques
  const clientOptions = MENU_DATA.clients.map(c => 
    `<option value="${c}" ${data.client === c ? 'selected' : ''}>${c}</option>`
  ).join('') + '<option value="__ADD__">➕ Ajouter...</option><option value="__REMOVE__">➖ Supprimer...</option>';
  
  const intervenantOptions = MENU_DATA.intervenants.map(i => 
    `<option value="${i}" ${data.intervenant === i ? 'selected' : ''}>${i}</option>`
  ).join('') + '<option value="__ADD__">➕ Ajouter...</option><option value="__REMOVE__">➖ Supprimer...</option>';
  
  const regionOptions = MENU_DATA.regions.map(r => 
    `<option value="${r}" ${data.region === r ? 'selected' : ''}>${r}</option>`
  ).join('') + '<option value="__ADD__">➕ Ajouter...</option><option value="__REMOVE__">➖ Supprimer...</option>';
  
  const itemOptions = MENU_DATA.items.map(i => 
    `<option value="${i}" ${data.item === i ? 'selected' : ''}>${i}</option>`
  ).join('') + '<option value="__ADD__">➕ Ajouter...</option><option value="__REMOVE__">➖ Supprimer...</option>';
  
  const representanteOptions = MENU_DATA.representantes.map(r => 
    `<option value="${r}" ${data.representant === r ? 'selected' : ''}>${r}</option>`
  ).join('') + '<option value="__ADD__">➕ Ajouter...</option><option value="__REMOVE__">➖ Supprimer...</option>';
  
  // Générer la sidebar de tracking
  const trackingSidebarHTML = generateTrackingSidebar(cardId, data);
  
  // Générer le label de priorité pour le bouton
  const priorityLabels = {
    0: { text: '-- Aucune --', color: '#6b7280', emoji: '⚪' },
    1: { text: '#1 URGENT', color: '#ef4444', emoji: '🔴' },
    2: { text: '#2 Important', color: '#f97316', emoji: '🟠' },
    3: { text: '#3 À surveiller', color: '#eab308', emoji: '🟡' },
    4: { text: '#4 Normal+', color: '#22c55e', emoji: '🟢' },
    5: { text: '#5 Basse', color: '#3b82f6', emoji: '🔵' }
  };
  const currentPriority = data.priority || 0;
  const priorityInfo = priorityLabels[currentPriority] || priorityLabels[0];
  
  return `
    <!-- SIDEBAR TRACKING À GAUCHE -->
    ${trackingSidebarHTML}
    
    <div class="mcard-fiche" data-card-id="${cardId}">
      <div class="fiche-header">
        <div class="fiche-logo"><img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro1.png" alt="Physipro"/></div>
        <div class="fiche-title">
          <h3>Fiche Moulage</h3>
        </div>
        <div class="fiche-priority-btn" onclick="showFichePriorityMenu('${cardId}', event)" style="background: ${priorityInfo.color};">
          <span class="fiche-priority-emoji">${priorityInfo.emoji}</span>
          <span class="fiche-priority-text">Priorité</span>
        </div>
      </div>
      
      <div class="fiche-section">
        <div class="fiche-grid-2">
          <div class="fiche-field">
            <div class="fiche-label">Client <button class="list-manage-btn" onclick="event.stopPropagation(); openListManager('moulageClients', 'Client')">⚙</button></div>
            <select class="fiche-select" data-fiche-field="client" onchange="handleSelectChange(this, 'clients', '${cardId}')">
              <option value="">-- Sélectionner --</option>
              ${clientOptions}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Nom du moulage</div>
            <input type="text" class="fiche-input" data-fiche-field="name" value="${data.name || ''}" placeholder="Nom...">
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Date reçue</div>
            <div class="fiche-date-pill" data-fiche-field="dateRecue">${data.dateRecue || 'AAAA-MM-JJ'}</div>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date fabriquée au robot</div>
            <div class="fiche-date-pill" data-fiche-field="dateRobot">${data.dateRobot || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Numéro de commande</div>
            <input type="text" class="fiche-input" data-fiche-field="order" value="${data.order || ''}" placeholder="000000" maxlength="6" inputmode="numeric" onfocus="this.select();" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);">
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Numéro PO</div>
            <input type="text" class="fiche-input" data-fiche-field="numeroPO" value="${data.numeroPO || ''}" placeholder="000000" maxlength="6" inputmode="numeric" onfocus="this.select();" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);">
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Région <button class="list-manage-btn" onclick="event.stopPropagation(); openListManager('regions', 'Région')">⚙</button></div>
            <select class="fiche-select" data-fiche-field="region" onchange="handleSelectChange(this, 'regions', '${cardId}')">
              <option value="">-- Sélectionner --</option>
              ${regionOptions}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Intervenant <button class="list-manage-btn" onclick="event.stopPropagation(); openListManager('intervenants', 'Intervenant')">⚙</button></div>
            <select class="fiche-select" data-fiche-field="intervenant" onchange="handleSelectChange(this, 'intervenants', '${cardId}')">
              <option value="">-- Sélectionner --</option>
              ${intervenantOptions}
            </select>
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Représentante <button class="list-manage-btn" onclick="event.stopPropagation(); openListManager('representantes', 'Représentante')">⚙</button></div>
            <select class="fiche-select" data-fiche-field="representant" onchange="handleSelectChange(this, 'representantes', '${cardId}')">
              <option value="">-- Sélectionner --</option>
              ${representanteOptions}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date rendez-vous essayage</div>
            <div class="fiche-date-pill" data-fiche-field="dateEssayage">${data.dateEssayage || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
      </div>
      
      <!-- Section En attente - VISIBLE SEULEMENT SI EN ATTENTE -->
      <div class="fiche-attente-section ${isEnAttente ? 'visible' : ''}" id="ficheAttenteSection_${cardId}">
        <div class="attente-badge-full" onclick="openRaisonAttenteMenu('${cardId}', event)">⏳ EN ATTENTE: ${data.raisonAttente || 'Raison non spécifiée'}</div>
        <div class="attente-days-full">En attente depuis ${data.dateAttente || '---'} (${joursAttente} jours)</div>
      </div>
      
      
      <!-- Section Photos - EN BAS avec clignotement si lien existe -->
      <div class="fiche-photos-section fiche-photos-bottom">
        <div class="photos-row">
          <span class="photos-label" onclick="openPhotosMenu('${cardId}', event)">📷 Photos</span>
          <button class="photo-btn ${data.photoClient ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'client', event)">Client</button>
          <button class="photo-btn ${data.photoAtelier ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'atelier', event)">Atelier</button>
          <button class="photo-btn ${data.photoDevis ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'devis', event)">Devis / Modifs</button>
        </div>
      </div>
      
      <!-- Popup Photos menu (quand on clique sur le titre Photos) -->
      <div class="photos-menu-popup" id="photosMenuPopup" style="display:none;">
        <div class="photos-menu-header">📷 Gérer les liens photos</div>
        <div class="photos-menu-field">
          <label>Photo Client:</label>
          <input type="url" id="photoLinkClient" value="${data.photoClient || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Photo Atelier:</label>
          <input type="url" id="photoLinkAtelier" value="${data.photoAtelier || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Photo Devis / Modifs:</label>
          <input type="url" id="photoLinkDevis" value="${data.photoDevis || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-btns">
          <button onclick="saveAllPhotoLinks('${cardId}')">💾 Enregistrer</button>
          <button onclick="closePhotosMenu()">Fermer</button>
        </div>
      </div>
      
      <!-- Calendrier popup visuel -->
      <div class="fiche-calendar-popup">
        <div class="cal-header">
          <div class="cal-title">Sélectionner une date</div>
        </div>
        <div class="cal-nav">
          <button class="cal-prev">◀</button>
          <span class="cal-month-year">Décembre 2024</span>
          <button class="cal-next">▶</button>
        </div>
        <div class="cal-weekdays">
          <div class="cal-weekday">Dim</div>
          <div class="cal-weekday">Lun</div>
          <div class="cal-weekday">Mar</div>
          <div class="cal-weekday">Mer</div>
          <div class="cal-weekday">Jeu</div>
          <div class="cal-weekday">Ven</div>
          <div class="cal-weekday">Sam</div>
        </div>
        <div class="cal-days"></div>
        <div class="cal-buttons">
          <button class="btn-today">Aujourd'hui</button>
          <button class="btn-close-cal">Fermer</button>
        </div>
      </div>
    </div>
    
    <!-- Page Notes à droite -->
    <div class="mcard-notes-page" data-card-id="${cardId}">
      <div class="notes-page-header">
        <span onclick="togglePhotosLinks('${cardId}')" style="cursor:pointer;">📝 Notes</span>
        <button class="notes-close-btn" onclick="closeFicheCard()" title="Fermer">✕</button>
      </div>
      
      <!-- 6 boutons photos sur une ligne -->
      <div class="notes-photos-row">
        <button class="notes-photo-btn ${data.notePhoto1 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 1)">Photo 1</button>
        <button class="notes-photo-btn ${data.notePhoto2 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 2)">Photo 2</button>
        <button class="notes-photo-btn ${data.notePhoto3 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 3)">Photo 3</button>
        <button class="notes-photo-btn ${data.notePhoto4 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 4)">Photo 4</button>
        <button class="notes-photo-btn ${data.notePhoto5 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 5)">Photo 5</button>
        <button class="notes-photo-btn ${data.notePhoto6 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 6)">Photo 6</button>
      </div>
      
      <!-- Zone de liens photos (cachée par défaut) -->
      <div class="notes-photos-links" id="notesPhotosLinks_${cardId}" style="display:none;">
        <div class="photo-link-row">
          <label>Photo 1:</label>
          <input type="url" id="photoLink1_${cardId}" value="${data.notePhoto1 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 2:</label>
          <input type="url" id="photoLink2_${cardId}" value="${data.notePhoto2 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 3:</label>
          <input type="url" id="photoLink3_${cardId}" value="${data.notePhoto3 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 4:</label>
          <input type="url" id="photoLink4_${cardId}" value="${data.notePhoto4 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 5:</label>
          <input type="url" id="photoLink5_${cardId}" value="${data.notePhoto5 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 6:</label>
          <input type="url" id="photoLink6_${cardId}" value="${data.notePhoto6 || ''}" placeholder="https://...">
        </div>
        <button class="save-photos-btn" onclick="savePhotosLinks('${cardId}')">Enregistrer</button>
      </div>
      
      <!-- Zone de texte avec notes signées -->
      <textarea class="notes-page-textarea" id="notesTextarea_${cardId}" 
        placeholder="Cliquez ici pour écrire..."
        onfocus="prepareNoteWithSignature('${cardId}')"
        onblur="saveMoulageNotes('${cardId}')">${data.notes || ''}</textarea>
    </div>
  `;
}

// Afficher/masquer la zone de liens photos
function togglePhotosLinks(cardId) {
  const linksDiv = document.getElementById('notesPhotosLinks_' + cardId);
  if (linksDiv) {
    linksDiv.style.display = linksDiv.style.display === 'none' ? 'block' : 'none';
  }
}

// Sauvegarder les liens photos
function savePhotosLinks(cardId) {
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('photoLink' + i + '_' + cardId);
    if (input) {
      cardsData[cardId]['notePhoto' + i] = input.value.trim();
    }
  }
  saveCardToFirebase(cardId);
  
  // Mettre à jour les boutons
  for (let i = 1; i <= 6; i++) {
    const btn = document.querySelectorAll(`.mcard-notes-page[data-card-id="${cardId}"] .notes-photo-btn`)[i-1];
    if (btn) {
      if (cardsData[cardId]['notePhoto' + i]) {
        btn.classList.add('has-link');
      } else {
        btn.classList.remove('has-link');
      }
    }
  }
  
  // Masquer la zone de liens
  togglePhotosLinks(cardId);
}

// Ouvrir/gérer un lien photo dans les notes
function openNotePhoto(cardId, photoNum) {
  const fieldName = 'notePhoto' + photoNum;
  const currentUrl = cardsData[cardId]?.[fieldName] || '';
  
  if (currentUrl) {
    window.open(currentUrl, '_blank');
  } else {
    const newUrl = prompt('Entrer le lien pour Photo ' + photoNum + ':', '');
    if (newUrl && newUrl.trim()) {
      cardsData[cardId][fieldName] = newUrl.trim();
      saveCardToFirebase(cardId);
      
      // Mettre à jour le bouton
      const btns = document.querySelectorAll(`.mcard-notes-page[data-card-id="${cardId}"] .notes-photo-btn`);
      if (btns[photoNum - 1]) btns[photoNum - 1].classList.add('has-link');
    }
  }
}

// Préparer la note avec signature dans la zone de texte
function prepareNoteWithSignature(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
  
  const currentText = textarea.value;
  
  // Vérifier si le texte finit déjà par une signature avec EXACTEMENT la même heure
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('— ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    // Extraire l'heure de la dernière signature
    const match = lastSignatureLine.match(/— .+ \((\d{4}-\d{2}-\d{2}) à (\d{2}:\d{2})\) —/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      // Vérifier si c'est exactement la même date ET la même minute
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    // Ajouter la signature avec une ligne vide avant si besoin
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  // Placer le curseur à la fin (sur la nouvelle ligne)
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

// Sauvegarder les notes du moulage
function saveMoulageNotes(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (textarea && cardsData[cardId]) {
    cardsData[cardId].notes = textarea.value;
    saveCardToFirebase(cardId);
  }
}

// Fonctions notes commande avec signature
function prepareCmdNoteWithSignature(cmdId) {
  const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
  
  const currentText = textarea.value;
  
  // Vérifier si le texte finit déjà par une signature avec EXACTEMENT la même heure
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('— ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    const match = lastSignatureLine.match(/— .+ \((\d{4}-\d{2}-\d{2}) à (\d{2}:\d{2})\) —/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

// Fonction pour la zone de notes intégrée dans Magasin
function prepareCmdNoteSignature(cmdId) {
  prepareCmdNoteWithSignature(cmdId);
}

function saveCmdNotesInline(cmdId) {
  const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
  if (textarea && commandesData[cmdId]) {
    commandesData[cmdId].notes = textarea.value;
    saveCommandeToFirebase(cmdId);
  }
}

function toggleCmdNotesZone(cmdId) {
  const notesZone = document.getElementById('cmdNotesCollapsible_' + cmdId);
  const toggleBtn = document.getElementById('cmdNotesToggleBtn_' + cmdId);
  if (!notesZone) return;
  
  if (notesZone.style.display === 'none') {
    notesZone.style.display = 'flex';
    notesZone.style.flexDirection = 'column';
    toggleBtn.textContent = '📝 Fermer Notes';
    // Focus sur le textarea
    setTimeout(() => {
      const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
      if (textarea) {
        textarea.focus();
      }
    }, 100);
  } else {
    notesZone.style.display = 'none';
    toggleBtn.textContent = '📝 Notes';
  }
}

function saveCmdNotes(cmdId) {
  const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
  if (textarea && commandesData[cmdId]) {
    commandesData[cmdId].notes = textarea.value;
    saveCommandeToFirebase(cmdId);
    
    // Mettre à jour la preview
    const preview = document.querySelector('#cmdNotesCompact_' + cmdId + ' .cmd-notes-preview');
    if (preview) {
      preview.textContent = textarea.value ? textarea.value.substring(0, 50) + '...' : 'Cliquez pour ajouter une note...';
    }
  }
}

// Fonctions pour expand/collapse notes commande
function expandCmdNotes(cmdId) {
  const compact = document.getElementById('cmdNotesCompact_' + cmdId);
  const expanded = document.getElementById('cmdNotesExpanded_' + cmdId);
  if (compact) compact.style.display = 'none';
  if (expanded) {
    expanded.style.display = 'flex';
    const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
    if (textarea) {
      textarea.focus();
    }
  }
}

function collapseCmdNotes(cmdId) {
  const compact = document.getElementById('cmdNotesCompact_' + cmdId);
  const expanded = document.getElementById('cmdNotesExpanded_' + cmdId);
  if (compact) compact.style.display = 'flex';
  if (expanded) expanded.style.display = 'none';
  saveCmdNotes(cmdId);
}

let currentCalendarField = null;
let currentDeptName = null;
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();

const MOIS_FR = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

function renderCalendar(fiche, selectedDate) {
  const daysContainer = fiche.querySelector('.cal-days');
  const monthYearEl = fiche.querySelector('.cal-month-year');
  
  monthYearEl.textContent = `${MOIS_FR[calendarMonth]} ${calendarYear}`;
  
  // Premier jour du mois
  const firstDay = new Date(calendarYear, calendarMonth, 1);
  const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
  const startDay = firstDay.getDay(); // 0 = dimanche
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  let html = '';
  
  // Jours du mois précédent
  const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevMonthLastDay - i;
    html += `<button class="cal-day other-month" data-date="">${day}</button>`;
  }
  
  // Jours du mois courant
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let classes = 'cal-day';
    if (dateStr === todayStr) classes += ' today';
    if (dateStr === selectedDate) classes += ' selected';
    html += `<button class="${classes}" data-date="${dateStr}">${day}</button>`;
  }
  
  // Jours du mois suivant
  const totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
  const remainingCells = totalCells - (startDay + lastDay.getDate());
  for (let day = 1; day <= remainingCells; day++) {
    html += `<button class="cal-day other-month" data-date="">${day}</button>`;
  }
  
  daysContainer.innerHTML = html;
  
  // Événements sur les jours
  daysContainer.querySelectorAll('.cal-day:not(.other-month)').forEach(dayBtn => {
    dayBtn.addEventListener('click', () => {
      const date = dayBtn.dataset.date;
      if (date && currentCalendarField) {
        selectCalendarDate(fiche, date);
      }
    });
  });
}

function selectCalendarDate(fiche, date) {
  const cardId = fiche.dataset.cardId;
  
  if (currentCalendarField) {
    currentCalendarField.element.textContent = date;
    if (cardsData[cardId]) {
      cardsData[cardId][currentCalendarField.field] = date;
      
      // Si c'est dateRobot, mettre à jour aussi dans la section durées ET la pastille délai
      if (currentCalendarField.field === 'dateRobot') {
        const robotDateEl = fiche.querySelector('.dept-date-link[data-dept-field="dateRobot"]');
        if (robotDateEl) robotDateEl.textContent = date;
        
        // Rafraîchir la pastille délai de la carte
        const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        if (card) {
          const colIndex = parseInt(card.closest('.col')?.dataset.col || 0);
          updateCardDelayPill(card, cardId, colIndex);
        }
      }
      
      saveCardToFirebase(cardId);
    }
  }
  
  fiche.querySelector('.fiche-calendar-popup').classList.remove('active');
  currentCalendarField = null;
}

// Variables pour le popup département avec calendriers
let deptCalEntreeMonth, deptCalEntreeYear, deptCalSortieMonth, deptCalSortieYear;
let deptEntreeDate = '', deptSortieDate = '';

function renderDeptCalendar(container, month, year, selectedDate, type) {
  const MOIS = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay();
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  let html = `
    <div class="mini-cal-nav">
      <button class="mini-cal-btn" data-dir="prev" data-type="${type}">◀</button>
      <span class="mini-cal-title">${MOIS[month]} ${year}</span>
      <button class="mini-cal-btn" data-dir="next" data-type="${type}">▶</button>
    </div>
    <div class="mini-cal-weekdays">
      <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
    </div>
    <div class="mini-cal-days">
  `;
  
  // Jours du mois précédent
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    html += `<span class="mini-day other">${prevMonthLastDay - i}</span>`;
  }
  
  // Jours du mois courant
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let classes = 'mini-day';
    if (dateStr === todayStr) classes += ' today';
    if (dateStr === selectedDate) classes += ' selected';
    html += `<span class="${classes}" data-date="${dateStr}" data-type="${type}">${day}</span>`;
  }
  
  html += '</div>';
  container.innerHTML = html;
}

function attachFicheEvents(card) {
  const fiche = card.querySelector('.mcard-fiche');
  const cardId = card.dataset.cardId;
  
  // ===== CALENDRIER VISUEL POUR PASTILLES DATE =====
  fiche.querySelectorAll('.fiche-date-pill').forEach(pill => {
    pill.addEventListener('click', (e) => {
      e.stopPropagation();
      const field = pill.dataset.ficheField;
      if (!field) return;
      
      currentCalendarField = { element: pill, field };
      const popup = fiche.querySelector('.fiche-calendar-popup');
      const titleEl = fiche.querySelector('.cal-title');
      
      const titles = {
        dateRecue: 'Date reçue',
        dateRobot: 'Date fabriquée au robot',
        dateEssayage: 'Date rendez-vous essayage',
        dateExpedition: 'Date d\'expédition'
      };
      
      titleEl.textContent = titles[field] || 'Sélectionner une date';
      
      const currentValue = cardsData[cardId]?.[field];
      if (currentValue && currentValue !== '-' && currentValue !== 'AAAA-MM-JJ') {
        const parts = currentValue.split('-');
        calendarYear = parseInt(parts[0]);
        calendarMonth = parseInt(parts[1]) - 1;
      } else {
        calendarYear = new Date().getFullYear();
        calendarMonth = new Date().getMonth();
      }
      
      renderCalendar(fiche, currentValue || '');
      popup.classList.add('active');
    });
  });
  
  // ===== DATES DANS LA SECTION DURÉES (Robot et Expédition) =====
  fiche.querySelectorAll('.dept-date-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.stopPropagation();
      const field = link.dataset.deptField;
      if (!field) return;
      
      currentCalendarField = { element: link, field };
      const popup = fiche.querySelector('.fiche-calendar-popup');
      const titleEl = fiche.querySelector('.cal-title');
      
      titleEl.textContent = field === 'dateRobot' ? 'Date Robot' : 'Date Expédition';
      
      const currentValue = cardsData[cardId]?.[field];
      if (currentValue && currentValue !== '-') {
        const parts = currentValue.split('-');
        calendarYear = parseInt(parts[0]);
        calendarMonth = parseInt(parts[1]) - 1;
      } else {
        calendarYear = new Date().getFullYear();
        calendarMonth = new Date().getMonth();
      }
      
      renderCalendar(fiche, currentValue || '');
      popup.classList.add('active');
    });
  });
  
  // Navigation calendrier principal
  fiche.querySelector('.cal-prev')?.addEventListener('click', () => {
    calendarMonth--;
    if (calendarMonth < 0) {
      calendarMonth = 11;
      calendarYear--;
    }
    renderCalendar(fiche, cardsData[cardId]?.[currentCalendarField?.field] || '');
  });
  
  fiche.querySelector('.cal-next')?.addEventListener('click', () => {
    calendarMonth++;
    if (calendarMonth > 11) {
      calendarMonth = 0;
      calendarYear++;
    }
    renderCalendar(fiche, cardsData[cardId]?.[currentCalendarField?.field] || '');
  });
  
  fiche.querySelector('.btn-today')?.addEventListener('click', () => {
    const today = new Date().toISOString().split('T')[0];
    selectCalendarDate(fiche, today);
  });
  
  fiche.querySelector('.btn-close-cal')?.addEventListener('click', () => {
    fiche.querySelector('.fiche-calendar-popup').classList.remove('active');
    currentCalendarField = null;
  });
  
  // ===== DÉPARTEMENT (Dégauchage, Essayage, Atelier, Couture, Peinture) =====
  fiche.querySelectorAll('.dept-row').forEach(row => {
    row.addEventListener('click', (e) => {
      const dept = row.dataset.dept;
      // Robot et Expédition sont gérés par dept-date-link
      if (dept === 'Robot' || dept === 'Expédition') return;
      
      e.stopPropagation();
      currentDeptName = dept;
      
      const popup = fiche.querySelector('.dept-dates-popup');
      const title = popup.querySelector('.dept-popup-title');
      title.textContent = dept;
      
      // Charger les dates existantes
      const deptKey = dept.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      deptEntreeDate = cardsData[cardId]?.[`entree_${deptKey}`] || '';
      deptSortieDate = cardsData[cardId]?.[`sortie_${deptKey}`] || '';
      
      // Initialiser les calendriers
      const now = new Date();
      deptCalEntreeMonth = deptEntreeDate ? parseInt(deptEntreeDate.split('-')[1]) - 1 : now.getMonth();
      deptCalEntreeYear = deptEntreeDate ? parseInt(deptEntreeDate.split('-')[0]) : now.getFullYear();
      deptCalSortieMonth = deptSortieDate ? parseInt(deptSortieDate.split('-')[1]) - 1 : now.getMonth();
      deptCalSortieYear = deptSortieDate ? parseInt(deptSortieDate.split('-')[0]) : now.getFullYear();
      
      const entreeContainer = popup.querySelector('.dept-cal-container[data-type="entree"]');
      const sortieContainer = popup.querySelector('.dept-cal-container[data-type="sortie"]');
      
      renderDeptCalendar(entreeContainer, deptCalEntreeMonth, deptCalEntreeYear, deptEntreeDate, 'entree');
      renderDeptCalendar(sortieContainer, deptCalSortieMonth, deptCalSortieYear, deptSortieDate, 'sortie');
      
      // Ajouter events pour les mini calendriers
      attachDeptCalEvents(popup, cardId);
      
      popup.classList.add('active');
    });
  });
  
  function attachDeptCalEvents(popup, cardId) {
    // Navigation des mini calendriers
    popup.querySelectorAll('.mini-cal-btn').forEach(btn => {
      btn.onclick = () => {
        const dir = btn.dataset.dir;
        const type = btn.dataset.type;
        
        if (type === 'entree') {
          if (dir === 'prev') { deptCalEntreeMonth--; if (deptCalEntreeMonth < 0) { deptCalEntreeMonth = 11; deptCalEntreeYear--; } }
          else { deptCalEntreeMonth++; if (deptCalEntreeMonth > 11) { deptCalEntreeMonth = 0; deptCalEntreeYear++; } }
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="entree"]'), deptCalEntreeMonth, deptCalEntreeYear, deptEntreeDate, 'entree');
        } else {
          if (dir === 'prev') { deptCalSortieMonth--; if (deptCalSortieMonth < 0) { deptCalSortieMonth = 11; deptCalSortieYear--; } }
          else { deptCalSortieMonth++; if (deptCalSortieMonth > 11) { deptCalSortieMonth = 0; deptCalSortieYear++; } }
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="sortie"]'), deptCalSortieMonth, deptCalSortieYear, deptSortieDate, 'sortie');
        }
        attachDeptCalEvents(popup, cardId);
      };
    });
    
    // Sélection des jours
    popup.querySelectorAll('.mini-day:not(.other)').forEach(day => {
      day.onclick = () => {
        const date = day.dataset.date;
        const type = day.dataset.type;
        
        if (type === 'entree') {
          deptEntreeDate = date;
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="entree"]'), deptCalEntreeMonth, deptCalEntreeYear, deptEntreeDate, 'entree');
        } else {
          deptSortieDate = date;
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="sortie"]'), deptCalSortieMonth, deptCalSortieYear, deptSortieDate, 'sortie');
        }
        attachDeptCalEvents(popup, cardId);
      };
    });
  }
  
  // Sauvegarder département
  fiche.querySelector('.btn-save')?.addEventListener('click', () => {
    if (currentDeptName && cardsData[cardId]) {
      const deptKey = currentDeptName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      cardsData[cardId][`entree_${deptKey}`] = deptEntreeDate;
      cardsData[cardId][`sortie_${deptKey}`] = deptSortieDate;
      
      // Calculer les jours
      if (deptEntreeDate && deptSortieDate) {
        const days = Math.round((new Date(deptSortieDate) - new Date(deptEntreeDate)) / (1000 * 60 * 60 * 24));
        cardsData[cardId][`days${currentDeptName.replace('é', 'e')}`] = days >= 0 ? days : 0;
        
        // Mettre à jour l'affichage
        const daysEl = fiche.querySelector(`.dept-days[data-dept="${currentDeptName}"]`);
        if (daysEl) daysEl.textContent = days >= 0 ? days : '-';
        
        // Recalculer le total
        recalculateTotal(fiche, cardId);
      }
      
      saveCardToFirebase(cardId);
    }
    
    fiche.querySelector('.dept-dates-popup').classList.remove('active');
    currentDeptName = null;
  });
  
  fiche.querySelector('.btn-cancel')?.addEventListener('click', () => {
    fiche.querySelector('.dept-dates-popup').classList.remove('active');
    currentDeptName = null;
  });
  
  function recalculateTotal(fiche, cardId) {
    const data = cardsData[cardId];
    let total = 0;
    ['Degauchage', 'Atelier', 'Couture', 'Peinture'].forEach(dept => {
      const days = data[`days${dept}`];
      if (days && !isNaN(days)) total += parseInt(days);
    });
    data.totalDays = total;
    const totalEl = fiche.querySelector('.dept-total-days');
    if (totalEl) totalEl.textContent = total || '-';
  }
  
  // ===== INPUTS ET SELECTS =====
  fiche.querySelectorAll('.fiche-input, .fiche-select').forEach(el => {
    el.addEventListener('change', () => {
      const field = el.dataset.ficheField;
      const value = el.value;
      
      if (cardsData[cardId]) {
        cardsData[cardId][field] = value;
        saveCardToFirebase(cardId);
        
        // Sync avec la carte
        if (field === 'name') {
          const titleInput = card.querySelector('.mcard-title');
          if (titleInput) titleInput.value = value || 'Nom du moulage';
        } else if (field === 'order') {
          const orderInput = card.querySelector('.mcard-order');
          if (orderInput) orderInput.value = value || '000000';
        } else if (field === 'item') {
          const itemPill = card.querySelector('.mcard-item-pill');
          if (itemPill) itemPill.textContent = value || 'Siège';
        }
      }
    });
  });
  
  // ===== NOTES AVEC SIGNATURE DANS LE TEXTAREA =====
  const notesDiv = fiche.querySelector('.fiche-notes');
  const notesText = fiche.querySelector('.fiche-notes-text') || fiche.querySelector('.notes-page-textarea');
  const notesCloseBtn = fiche.querySelector('.fiche-notes-close-bottom');
  
  // Si pas de zone notes dans cette fiche, skip cette section
  if (!notesText) {
    console.log('⚠️ Pas de zone notes trouvée dans la fiche');
  }
  
  let signatureAdded = false;
  
  function addSignatureToNotes() {
    if (signatureAdded || !notesText) return;
    
    // Utiliser le nom de l'utilisateur connecté
    let userName = 'Anonyme';
    if (currentUser?.name) {
      userName = currentUser.name;
    } else if (currentUser?.email && USERS[currentUser.email]) {
      userName = USERS[currentUser.email].name;
    }
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    const signature = `\n\n— ${userName} (${dateStr} à ${timeStr}) —\n`;
    
    // Ajouter la signature à la fin du texte existant
    if (notesText) {
      const currentText = notesText.value;
      notesText.value = currentText + signature;
      
      // Placer le curseur après la signature
      notesText.selectionStart = notesText.value.length;
      notesText.selectionEnd = notesText.value.length;
    }
    
    signatureAdded = true;
  }
  
  function openNotes() {
    if (!notesDiv?.classList.contains('expanded')) {
      notesDiv?.classList.add('expanded');
      signatureAdded = false;
      notesText?.focus();
    }
  }
  
  function closeNotes() {
    notesDiv?.classList.remove('expanded');
    signatureAdded = false;
  }
  
  notesText?.addEventListener('click', (e) => {
    e.stopPropagation();
    openNotes();
  });
  
  notesText?.addEventListener('focus', () => {
    openNotes();
  });
  
  // Ajouter signature au premier caractère tapé
  notesText?.addEventListener('keydown', (e) => {
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
      addSignatureToNotes();
    }
  });
  
  notesCloseBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (cardsData[cardId]) {
      cardsData[cardId].notes = notesText?.value || '';
      saveCardToFirebase(cardId);
    }
    closeNotes();
  });
  
  notesText?.addEventListener('blur', () => {
    if (cardsData[cardId] && notesText && notesText.value !== cardsData[cardId].notes) {
      cardsData[cardId].notes = notesText.value;
      saveCardToFirebase(cardId);
    }
  });
}

// ===== ZONE NOTES EXPANDABLE =====
function expandNotesZone(cardId, element) {
  const card = cardsData[cardId];
  if (!card) return;
  
  const notesZone = element.closest('.fiche-notes-zone');
  if (!notesZone) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  // Remplacer par la zone expandée
  notesZone.innerHTML = `
    <div class="fiche-notes-expanded">
      <div class="notes-header">
        <span>Notes</span>
        <button onclick="collapseNotesZone('${cardId}', this)">Fermer</button>
      </div>
      <div class="notes-body">
        <div class="notes-signature">— ${userName} (${dateStr} à ${timeStr}) —</div>
        <textarea id="notesTextarea_${cardId}" placeholder="Écrire votre note ici..."></textarea>
        ${card.notes ? `<div class="notes-history">${card.notes}</div>` : ''}
      </div>
    </div>
  `;
  
  // Focus sur le textarea
  setTimeout(() => {
    document.getElementById('notesTextarea_' + cardId)?.focus();
  }, 100);
}

function collapseNotesZone(cardId, element) {
  const card = cardsData[cardId];
  if (!card) return;
  
  const notesZone = element.closest('.fiche-notes-zone');
  if (!notesZone) return;
  
  // Récupérer le texte du textarea
  const textarea = document.getElementById('notesTextarea_' + cardId);
  const newText = textarea?.value?.trim();
  
  // Si du texte a été écrit, l'ajouter aux notes existantes
  if (newText) {
    const userName = getCurrentUserName();
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    
    const newNote = `<div class="note-entry"><div class="note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div><div class="note-text">${newText}</div></div>`;
    
    const existingNotes = card.notes || '';
    card.notes = newNote + existingNotes;
    
    saveCardToFirebase(cardId);
  }
  
  // Remettre la zone simple
  const hasNotes = card.notes && card.notes.length > 0;
  notesZone.innerHTML = `
    <div class="fiche-notes-simple" onclick="expandNotesZone('${cardId}', this)">
      <span class="notes-text-center ${hasNotes ? 'has-notes' : ''}">Notes</span>
    </div>
  `;
}

// ===== FONCTIONS PHOTOS =====
let currentPhotoCardId = null;
let currentPhotoType = null;

function openPhotoPopup(cardId, photoType, event) {
  if (event) event.stopPropagation();
  
  currentPhotoCardId = cardId;
  currentPhotoType = photoType;
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  const popup = card.querySelector('#photoPopup');
  if (!popup) return;
  
  const typeNames = { client: 'Client', atelier: 'Atelier', devis: 'Devis + Modif' };
  popup.querySelector('#photoPopupType').textContent = typeNames[photoType] || photoType;
  
  const fieldName = 'photo' + photoType.charAt(0).toUpperCase() + photoType.slice(1);
  const currentUrl = cardsData[cardId]?.[fieldName] || '';
  popup.querySelector('#photoPopupUrl').value = currentUrl;
  
  // Fermer le menu photos
  closePhotosMenu();
  
  popup.style.display = 'block';
  popup.querySelector('#photoPopupUrl').focus();
}

function closePhotoPopup() {
  const popup = document.querySelector('#photoPopup');
  if (popup) popup.style.display = 'none';
  currentPhotoCardId = null;
  currentPhotoType = null;
}

function savePhotoLink() {
  if (!currentPhotoCardId || !currentPhotoType) return;
  
  const popup = document.querySelector('#photoPopup');
  const url = popup?.querySelector('#photoPopupUrl')?.value || '';
  
  const fieldName = 'photo' + currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1);
  
  if (cardsData[currentPhotoCardId]) {
    cardsData[currentPhotoCardId][fieldName] = url;
    saveCardToFirebase(currentPhotoCardId);
  }
  
  closePhotoPopup();
}

function openPhotoLink() {
  if (!currentPhotoCardId || !currentPhotoType) return;
  
  const fieldName = 'photo' + currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1);
  const url = cardsData[currentPhotoCardId]?.[fieldName];
  
  if (url) {
    window.open(url, '_blank');
  } else {
    alert('Aucun lien photo enregistré');
  }
}

// ===== MENU PHOTOS =====
function openPhotosMenu(cardId, event) {
  if (event) event.stopPropagation();
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  // Mettre à jour les valeurs des inputs
  const data = cardsData[cardId] || {};
  const popup = card.querySelector('#photosMenuPopup');
  if (popup) {
    const inputClient = popup.querySelector('#photoLinkClient');
    const inputAtelier = popup.querySelector('#photoLinkAtelier');
    const inputDevis = popup.querySelector('#photoLinkDevis');
    if (inputClient) inputClient.value = data.photoClient || '';
    if (inputAtelier) inputAtelier.value = data.photoAtelier || '';
    if (inputDevis) inputDevis.value = data.photoDevis || '';
    popup.style.display = 'block';
  }
}

function closePhotosMenu() {
  const popups = document.querySelectorAll('.photos-menu-popup');
  popups.forEach(p => p.style.display = 'none');
}

function saveAllPhotoLinks(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card || !cardsData[cardId]) return;
  
  const popup = card.querySelector('#photosMenuPopup');
  if (!popup) return;
  
  const photoClient = popup.querySelector('#photoLinkClient')?.value || '';
  const photoAtelier = popup.querySelector('#photoLinkAtelier')?.value || '';
  const photoDevis = popup.querySelector('#photoLinkDevis')?.value || '';
  
  cardsData[cardId].photoClient = photoClient;
  cardsData[cardId].photoAtelier = photoAtelier;
  cardsData[cardId].photoDevis = photoDevis;
  
  saveCardToFirebase(cardId);
  
  // Mettre à jour les pastilles
  const pillClient = card.querySelector('.photo-pill[onclick*="client"]');
  const pillAtelier = card.querySelector('.photo-pill[onclick*="atelier"]');
  const pillDevis = card.querySelector('.photo-pill[onclick*="devis"]');
  
  if (pillClient) pillClient.classList.toggle('has-link', !!photoClient);
  if (pillAtelier) pillAtelier.classList.toggle('has-link', !!photoAtelier);
  if (pillDevis) pillDevis.classList.toggle('has-link', !!photoDevis);
  
  closePhotosMenu();
}

// Ouvrir la photo dans un nouvel onglet quand on clique sur une pastille
function openPhotoFromPill(cardId, photoType, event) {
  if (event) event.stopPropagation();
  
  const fieldName = 'photo' + photoType.charAt(0).toUpperCase() + photoType.slice(1);
  const url = cardsData[cardId]?.[fieldName];
  
  if (url) {
    window.open(url, '_blank');
  } else {
    // Ouvrir le menu photos pour entrer le lien
    openPhotosMenu(cardId, event);
  }
}

// Ouvrir lien OneDrive/SharePoint depuis la carte compacte
function openLinkFromCard(cardId, event) {
  if (event) event.stopPropagation();
  
  const card = cardsData[cardId];
  const url = card?.oneDriveLink || card?.sharePointLink;
  
  if (url) {
    window.open(url, '_blank');
  } else {
    // Ouvrir la fiche pour ajouter un lien
    const cardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (cardEl) openFiche(cardEl);
  }
}

// Ouvrir photo depuis la carte compacte
function openPhotoFromCard(cardId, event) {
  if (event) event.stopPropagation();
  
  const card = cardsData[cardId];
  // Essayer d'ouvrir la première photo disponible
  const photoUrl = card?.photoClient || card?.photoAtelier || card?.photoDevis;
  
  if (photoUrl) {
    window.open(photoUrl, '_blank');
  } else {
    // Ouvrir la fiche pour ajouter des photos
    const cardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (cardEl) openFiche(cardEl);
  }
}

// ===== OVERLAY NOTES MOULAGE =====
function toggleMoulageNotesOverlay(cardId) {
  const mcardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!mcardEl) return;
  
  const fiche = mcardEl.querySelector('.mcard-fiche');
  if (!fiche) return;
  
  const overlay = fiche.querySelector('.moulage-notes-overlay');
  
  if (overlay && overlay.style.display === 'flex') {
    // Fermer l'overlay
    closeMoulageNotesOverlay(cardId);
  } else {
    // Ouvrir l'overlay
    openMoulageNotesOverlay(cardId);
  }
}

function openMoulageNotesOverlay(cardId) {
  const card = cardsData[cardId];
  if (!card) return;
  
  // Trouver la fiche moulage
  const mcardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!mcardEl) return;
  
  const fiche = mcardEl.querySelector('.mcard-fiche');
  if (!fiche) return;
  
  // Vérifier si l'overlay existe déjà
  let overlay = fiche.querySelector('.moulage-notes-overlay');
  if (!overlay) {
    // Créer l'overlay
    overlay = document.createElement('div');
    overlay.className = 'moulage-notes-overlay';
    fiche.appendChild(overlay);
  }
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  overlay.innerHTML = `
    <div class="moulage-notes-content">
      <div class="moulage-notes-signature">— ${userName} (${dateStr} à ${timeStr}) —</div>
      <textarea class="moulage-notes-textarea" id="notesTextarea_${cardId}" placeholder="Écrire votre note ici...">${card.notes || ''}</textarea>
    </div>
  `;
  
  overlay.style.display = 'flex';
  
  // Focus sur le textarea et placer curseur à la fin
  setTimeout(() => {
    const textarea = document.getElementById('notesTextarea_' + cardId);
    if (textarea) {
      textarea.focus();
      textarea.selectionStart = textarea.value.length;
      textarea.selectionEnd = textarea.value.length;
    }
  }, 100);
}

function closeMoulageNotesOverlay(cardId) {
  // Trouver la fiche moulage
  const mcardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!mcardEl) return;
  
  const fiche = mcardEl.querySelector('.mcard-fiche');
  if (!fiche) return;
  
  const overlay = fiche.querySelector('.moulage-notes-overlay');
  if (!overlay) return;
  
  // Récupérer le texte du textarea et sauvegarder
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (textarea && cardsData[cardId]) {
    cardsData[cardId].notes = textarea.value;
    saveCardToFirebase(cardId);
    
    // Mettre à jour le bouton notes
    const notesBtn = fiche.querySelector('.fiche-notes-btn');
    if (notesBtn) {
      if (textarea.value && textarea.value.length > 0) {
        notesBtn.classList.add('has-notes');
      } else {
        notesBtn.classList.remove('has-notes');
      }
    }
  }
  
  overlay.style.display = 'none';
}

function saveMoulageNote(cardId) {
  const newNoteText = document.getElementById('newNoteText')?.value?.trim();
  if (!newNoteText || !cardsData[cardId]) {
    closeMoulageNotesOverlay();
    return;
  }
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  const newNote = `<div class="note-entry"><div class="note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div><div class="note-text">${newNoteText}</div></div>`;
  
  // Ajouter la nouvelle note aux notes existantes
  const existingNotes = cardsData[cardId].notes || '';
  cardsData[cardId].notes = existingNotes + newNote;
  
  // Marquer comme non lu pour les autres
  markNoteAsUnread(cardId);
  
  saveCardToFirebase(cardId);
  closeMoulageNotesOverlay();
}

// ===== NOTES SIGNÉES =====
let currentUserName = 'Anonyme';

function getCurrentUserName() {
  // D'abord vérifier si on a un utilisateur connecté
  if (currentUser?.name) {
    return currentUser.name;
  }
  if (currentUser?.email && USERS[currentUser.email]) {
    return USERS[currentUser.email].name;
  }
  // Sinon utiliser le nom de session
  if (window._sessionUserName) {
    return window._sessionUserName;
  }
  return 'Anonyme';
}

function addSignedNote(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  const notesList = card.querySelector('#ficheNotesList');
  if (!notesList) return;
  
  currentUserName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  // Créer l'entrée de note
  const noteEntry = document.createElement('div');
  noteEntry.className = 'note-entry';
  noteEntry.innerHTML = `
    <div class="note-signature">— ${currentUserName} (${dateStr} à ${timeStr}) —</div>
    <div class="note-text" contenteditable="true" placeholder="Écrire la note ici..."></div>
  `;
  
  notesList.appendChild(noteEntry);
  
  const textDiv = noteEntry.querySelector('.note-text');
  textDiv.focus();
  
  // Sauvegarder quand on quitte le champ
  textDiv.addEventListener('blur', () => {
    saveNotesFromList(cardId);
    markNoteAsUnread(cardId);
  });
}

function saveNotesFromList(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  const notesList = card.querySelector('#ficheNotesList');
  if (!notesList || !cardsData[cardId]) return;
  
  cardsData[cardId].notes = notesList.innerHTML;
  saveCardToFirebase(cardId);
}

function markNoteAsUnread(cardId) {
  if (!cardsData[cardId]) return;
  
  // Marquer comme non lu pour tous sauf l'auteur
  const allUsers = Object.values(USERS).map(u => u.name);
  const currentUserName = getCurrentUserName();
  
  if (!cardsData[cardId].notesUnread) {
    cardsData[cardId].notesUnread = {};
  }
  
  allUsers.forEach(user => {
    if (user !== currentUserName) {
      cardsData[cardId].notesUnread[user] = true;
    }
  });
  
  saveCardToFirebase(cardId);
}

function markNoteAsRead(cardId) {
  if (!cardsData[cardId]) return;
  
  const currentUser = getCurrentUserName();
  
  if (cardsData[cardId].notesUnread) {
    cardsData[cardId].notesUnread[currentUser] = false;
    saveCardToFirebase(cardId);
  }
  
  // Enlever la classe clignotante
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  const notesTitle = card?.querySelector('.notes-title');
  if (notesTitle) {
    notesTitle.classList.remove('notes-unread');
  }
}

// ===== VUE HORIZONTALE ROBOT =====
let isRobotViewActive = false;

function toggleRobotView() {
  isRobotViewActive = !isRobotViewActive;
  
  const boardsContainer = document.getElementById('boardsContainer');
  const robotView = document.getElementById('robotHorizontalView');
  
  if (!boardsContainer || !robotView) {
    console.error("❌ Éléments non trouvés");
    return;
  }
  
  if (isRobotViewActive) {
    // Afficher la vue Robot
    boardsContainer.style.display = 'none';
    robotView.style.display = 'flex';
    renderRobotTable();
  } else {
    // Retour au Kanban - Les cartes sont déjà là, juste les réafficher
    boardsContainer.style.display = 'block';
    robotView.style.display = 'none';
    updateColumnCounts();
  }
}

// Ajouter un nouveau moulage depuis la vue horizontale
function addNewMoulageFromHorizontal() {
  // Ouvrir le même modal que le bouton Ajouter moulage
  const addModal = document.getElementById('addModal');
  if (addModal) {
    addModal.classList.add('active');
    document.getElementById('addName').focus();
  }
}

// Rendre le tableau Robot
function renderRobotTable() {
  const tbody = document.getElementById('robotTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  // Chercher les cartes de la colonne Robot
  let robotCards = Object.entries(cardsData).filter(([id, card]) => {
    const colIndex = card.columnIndex ?? card.column ?? -1;
    return colIndex === 0 || colIndex === '0' || colIndex === 'Robot';
  });
  
  // Si cardsData vide, chercher dans le DOM
  if (robotCards.length === 0) {
    const robotColumn = document.querySelector('.col[data-col="0"]');
    if (robotColumn) {
      const domCards = robotColumn.querySelectorAll('.mcard');
      domCards.forEach(card => {
        const cardId = card.dataset.cardId;
        if (cardId && cardsData[cardId]) {
          robotCards.push([cardId, cardsData[cardId]]);
        }
      });
    }
  }
  
  console.log(`📊 ${robotCards.length} cartes Robot trouvées`);
  
  if (robotCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;padding:20px;">Aucune carte dans Robot</td></tr>';
    return;
  }
  
  // Options pour les menus déroulants (utiliser customLists si disponible)
  const clientsList = customLists.moulageClients || MENU_DATA.clients || [];
  const intervenantsList = customLists.intervenants || MENU_DATA.intervenants || [];
  const representantesList = customLists.representantes || ['Marie-Soleil', 'Marie-Pier'];
  const itemsList = customLists.items || MENU_DATA.items || ['Siège', 'Dossier', 'Siège + Dossier'];
  const regionsList = customLists.regions || MENU_DATA.regions || ['Québec', 'Ontario', 'Maritime'];
  const rushList = ['Oui', 'Non'];
  
  robotCards.forEach(([cardId, card]) => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-card-id', cardId);
    
    // 15 COLONNES - MAPPING AVEC LA FICHE (incluant Priorité)
    // Calculer le rang actuel dans Robot
    const robotCol = document.querySelector('#mainBoard .col[data-col="0"]');
    const cardsInRobot = robotCol ? Array.from(robotCol.querySelectorAll('.mcard')) : [];
    const currentRang = cardsInRobot.findIndex(c => c.dataset.cardId === cardId) + 1;
    const rangText = currentRang > 0 ? `Position ${currentRang}` : 'Non au Robot';
    
    // Priorité (1-5 ou 0 pour aucune)
    const priorityValue = card.priority || 0;
    const priorityOptions = [
      { value: 0, label: '☆ Aucune', emoji: '☆' },
      { value: 1, label: '1️⃣ Priorité 1', emoji: '1️⃣' },
      { value: 2, label: '2️⃣ Priorité 2', emoji: '2️⃣' },
      { value: 3, label: '3️⃣ Priorité 3', emoji: '3️⃣' },
      { value: 4, label: '4️⃣ Priorité 4', emoji: '4️⃣' },
      { value: 5, label: '5️⃣ Priorité 5', emoji: '5️⃣' }
    ];
    
    tr.innerHTML = `
      <td class="editable" data-field="name" contenteditable="true">${card.name || ''}</td>
      <td class="table-select-cell" data-field="client">
        <select class="table-select" data-field="client" onchange="handleTableSelectChange(this, '${cardId}', 'client', 'clients')">
          <option value="">--</option>
          ${clientsList.map(c => `<option value="${c}" ${card.client === c ? 'selected' : ''}>${c}</option>`).join('')}
          <option value="__ADD__">➕ Ajouter</option>
          <option value="__REMOVE__">➖ Supprimer</option>
        </select>
      </td>
      <td class="editable" data-field="order" contenteditable="true">${card.order || ''}</td>
      <td class="table-select-cell priority-cell" data-field="priority">
        <select class="table-select priority-select" data-field="priority" data-card-id="${cardId}" onchange="handlePriorityChangeFromTable('${cardId}', this.value)">
          ${priorityOptions.map(p => `<option value="${p.value}" ${priorityValue == p.value ? 'selected' : ''}>${p.label}</option>`).join('')}
        </select>
      </td>
      <td class="rang-robot-cell">
        <button class="rang-robot-btn" onclick="openRangRobotMenu('${cardId}', event)">${rangText}</button>
      </td>
      <td class="table-select-cell" data-field="region">
        <select class="table-select" data-field="region" onchange="handleTableSelectChange(this, '${cardId}', 'region', 'regions')">
          <option value="">--</option>
          ${regionsList.map(r => `<option value="${r}" ${card.region === r ? 'selected' : ''}>${r}</option>`).join('')}
          <option value="__ADD__">➕ Ajouter</option>
          <option value="__REMOVE__">➖ Supprimer</option>
        </select>
      </td>
      <td class="table-select-cell" data-field="item">
        <select class="table-select" data-field="item" onchange="handleTableSelectChange(this, '${cardId}', 'item', 'items')">
          <option value="">--</option>
          ${itemsList.map(i => `<option value="${i}" ${card.item === i ? 'selected' : ''}>${i}</option>`).join('')}
          <option value="__ADD__">➕ Ajouter</option>
          <option value="__REMOVE__">➖ Supprimer</option>
        </select>
      </td>
      <td class="date-cell" data-field="dateRecue" data-card-id="${cardId}" onclick="showTableCalendar('${cardId}', 'dateRecue', this)">${card.dateRecue || 'AAAA-MM-JJ'}</td>
      <td class="date-cell" data-field="dateLivraison" data-card-id="${cardId}" onclick="showTableCalendar('${cardId}', 'dateLivraison', this)">${card.dateLivraison || 'AAAA-MM-JJ'}</td>
      <td class="date-cell" data-field="dateEssayage" data-card-id="${cardId}" onclick="showTableCalendar('${cardId}', 'dateEssayage', this)">${card.dateEssayage || 'AAAA-MM-JJ'}</td>
      <td class="table-select-cell" data-field="representant">
        <select class="table-select" data-field="representant" onchange="handleTableSelectChange(this, '${cardId}', 'representant', 'representantes')">
          <option value="">--</option>
          ${representantesList.map(r => `<option value="${r}" ${card.representant === r ? 'selected' : ''}>${r}</option>`).join('')}
          <option value="__ADD__">➕ Ajouter</option>
          <option value="__REMOVE__">➖ Supprimer</option>
        </select>
      </td>
      <td class="table-select-cell" data-field="file">
        <select class="table-select" data-field="file">
          <option value="">--</option>
          <option value="Oui" ${card.file === 'Oui' ? 'selected' : ''}>Oui</option>
          <option value="Non" ${card.file === 'Non' ? 'selected' : ''}>Non</option>
        </select>
      </td>
      <td class="editable" data-field="angle" contenteditable="true">${card.angle || ''}</td>
      <td class="table-select-cell" data-field="rush">
        <select class="table-select" data-field="rush">
          <option value="">--</option>
          ${rushList.map(r => `<option value="${r}" ${card.rush === r ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
      </td>
      <td class="notes-cell" data-field="notes" data-card-id="${cardId}">
        <button class="notes-btn ${card.notes ? 'has-notes' : ''}" onclick="showNotesPopup('${cardId}', event)">Notes</button>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  // Ajouter les event listeners
  setupTableListeners();
  setupColumnResize();
}

// Setup des listeners pour la table (édition et menus)
function setupTableListeners() {
  // Cellules éditables (texte)
  const editableCells = document.querySelectorAll('#robotTableBody td.editable');
  editableCells.forEach(cell => {
    const field = cell.getAttribute('data-field');
    
    // Pour les champs order et numeroPO, limiter à 6 chiffres
    if (field === 'order' || field === 'numeroPO') {
      cell.addEventListener('focus', function() {
        // Sélectionner tout au focus
        const range = document.createRange();
        range.selectNodeContents(this);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      });
      
      cell.addEventListener('input', function() {
        // Garder seulement les chiffres et max 6
        let value = this.textContent.replace(/[^0-9]/g, '').slice(0, 6);
        if (this.textContent !== value) {
          this.textContent = value;
          // Remettre le curseur à la fin
          const range = document.createRange();
          range.selectNodeContents(this);
          range.collapse(false);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });
      
      cell.addEventListener('keydown', function(e) {
        // Permettre seulement les chiffres, backspace, delete, arrows, tab, enter
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter', 'Home', 'End'];
        if (!allowedKeys.includes(e.key) && !/^[0-9]$/.test(e.key)) {
          e.preventDefault();
        }
        // Bloquer si déjà 6 chiffres (sauf si c'est une touche de contrôle)
        if (/^[0-9]$/.test(e.key) && this.textContent.replace(/[^0-9]/g, '').length >= 6) {
          e.preventDefault();
        }
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        }
      });
    } else {
      cell.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        }
      });
    }
    
    cell.addEventListener('blur', function() {
      const tr = this.closest('tr');
      const cardId = tr.getAttribute('data-card-id');
      const field = this.getAttribute('data-field');
      let newValue = this.textContent.trim();
      
      // Pour order/numeroPO, s'assurer que c'est 6 chiffres max
      if (field === 'order' || field === 'numeroPO') {
        newValue = newValue.replace(/[^0-9]/g, '').slice(0, 6);
        this.textContent = newValue;
      }
      
      if (cardId && field && cardsData[cardId]) {
        cardsData[cardId][field] = newValue;
        saveCardToFirebase(cardId);
        
        // Feedback visuel
        this.style.background = '#d1fae5';
        setTimeout(() => { this.style.background = ''; }, 500);
        
        // Mettre à jour la carte Kanban
        updateCardFromTable(cardId, field, newValue);
        
      }
    });
  });
  
  // Menus déroulants
  const selects = document.querySelectorAll('#robotTableBody select.table-select');
  selects.forEach(select => {
    select.addEventListener('change', function() {
      const tr = this.closest('tr');
      const cardId = tr.getAttribute('data-card-id');
      const field = this.getAttribute('data-field');
      const newValue = this.value;
      
      if (cardId && field && cardsData[cardId]) {
        cardsData[cardId][field] = newValue;
        saveCardToFirebase(cardId);
        
        // Feedback visuel
        this.style.background = '#d1fae5';
        setTimeout(() => { this.style.background = ''; }, 500);
        
        // Mettre à jour la carte Kanban
        updateCardFromTable(cardId, field, newValue);
        
        // Si région change, mettre à jour la couleur de la carte
        if (field === 'region') {
          updateCardRegionColor(cardId, newValue);
        }
        
      }
    });
  });
}

// Afficher popup de notes
function showNotesPopup(cardId, event) {
  const card = cardsData[cardId];
  if (!card) return;
  
  // Fermer l'ancien popup s'il existe
  closeNotesPopup();
  
  const popup = document.createElement('div');
  popup.className = 'notes-popup-overlay';
  popup.onclick = function(e) { if (e.target === this) closeNotesPopup(); };
  
  popup.innerHTML = `
    <div class="notes-popup" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90vw;width:400px;">
      <div class="notes-popup-header">
        <h4>📝 Notes - ${card.name || 'Sans nom'}</h4>
        <button class="notes-popup-close" onclick="closeNotesPopup()">Fermer</button>
      </div>
      <textarea class="notes-popup-text" id="notesPopupText" 
        onfocus="prepareTableNoteWithSignature('${cardId}')"
        style="width:100%;height:150px;box-sizing:border-box;line-height:1.3;">${card.notes || ''}</textarea>
      <div class="notes-popup-buttons">
        <button class="notes-popup-save" onclick="saveNotesPopup('${cardId}')">💾 Sauvegarder</button>
        <button class="notes-popup-cancel" onclick="closeNotesPopup()">Annuler</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Focus sur le textarea
  setTimeout(() => {
    document.getElementById('notesPopupText')?.focus();
  }, 100);
}

// Préparer la signature dans le popup notes vue horizontale
function prepareTableNoteWithSignature(cardId) {
  const textarea = document.getElementById('notesPopupText');
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
  
  const currentText = textarea.value;
  
  // Vérifier si le texte finit déjà par une signature avec EXACTEMENT la même heure
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('— ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    const match = lastSignatureLine.match(/— .+ \((\d{4}-\d{2}-\d{2}) à (\d{2}:\d{2})\) —/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

// Fermer popup notes
function closeNotesPopup() {
  const popup = document.querySelector('.notes-popup-overlay');
  if (popup) popup.remove();
}

// Sauvegarder notes depuis popup
function saveNotesPopup(cardId) {
  const textarea = document.getElementById('notesPopupText');
  if (!textarea || !cardsData[cardId]) return;
  
  const newNotes = textarea.value;
  cardsData[cardId].notes = newNotes;
  saveCardToFirebase(cardId);
  
  // Mettre à jour le bouton dans la table
  const notesBtn = document.querySelector(`td.notes-cell[data-card-id="${cardId}"] .notes-btn`);
  if (notesBtn) {
    notesBtn.classList.toggle('has-notes', !!newNotes);
  }
  
  // Mettre à jour aussi dans la fiche moulage si elle est ouverte
  const ficheCard = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (ficheCard) {
    const ficheNotesArea = ficheCard.querySelector('.fiche-notes-textarea');
    if (ficheNotesArea) {
      ficheNotesArea.value = newNotes;
    }
  }
  
  closeNotesPopup();
}

// ===== CALENDRIER POUR LA TABLE =====
let tableCalCurrentCardId = null;
let tableCalCurrentField = null;
let tableCalCurrentCell = null;
let tableCalMonth = new Date().getMonth();
let tableCalYear = new Date().getFullYear();

const MOIS_NOMS = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                   'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

function showTableCalendar(cardId, field, cell) {
  tableCalCurrentCardId = cardId;
  tableCalCurrentField = field;
  tableCalCurrentCell = cell;
  
  // Initialiser avec la date actuelle par défaut
  tableCalMonth = new Date().getMonth();
  tableCalYear = new Date().getFullYear();
  
  // Parser la date actuelle si elle existe et est valide
  const currentValue = cell.textContent;
  if (currentValue && currentValue !== 'AAAA-MM-JJ' && currentValue !== '📅') {
    const parts = currentValue.split('-');
    if (parts.length === 3) {
      const year = parseInt(parts[0]);
      const month = parseInt(parts[1]) - 1;
      // Vérifier que les valeurs sont valides
      if (!isNaN(year) && !isNaN(month) && year > 2000 && month >= 0 && month <= 11) {
        tableCalYear = year;
        tableCalMonth = month;
      }
    }
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'table-calendar-overlay';
  overlay.id = 'tableCalendarOverlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeTableCalendar(); };
  
  const fieldNames = {
    'dateRecue': 'Date Reçue',
    'dateLivraison': 'Date Livraison',
    'dateEssayage': 'Date Essayage'
  };
  
  overlay.innerHTML = `
    <div class="table-calendar-popup">
      <div class="table-calendar-header">${fieldNames[field] || field}</div>
      <div class="table-cal-nav">
        <button onclick="tableCalPrev()">◀</button>
        <span class="table-cal-month" id="tableCalMonthYear">${MOIS_NOMS[tableCalMonth]} ${tableCalYear}</span>
        <button onclick="tableCalNext()">▶</button>
      </div>
      <div class="table-cal-weekdays">
        <div class="table-cal-weekday">Dim</div>
        <div class="table-cal-weekday">Lun</div>
        <div class="table-cal-weekday">Mar</div>
        <div class="table-cal-weekday">Mer</div>
        <div class="table-cal-weekday">Jeu</div>
        <div class="table-cal-weekday">Ven</div>
        <div class="table-cal-weekday">Sam</div>
      </div>
      <div class="table-cal-days" id="tableCalDays"></div>
      <div class="table-cal-buttons">
        <button class="table-cal-today" onclick="tableCalSelectToday()">Aujourd'hui</button>
        <button class="table-cal-clear" onclick="tableCalClear()">Effacer</button>
        <button class="table-cal-close" onclick="closeTableCalendar()">Fermer</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  renderTableCalDays();
}

function renderTableCalDays() {
  const container = document.getElementById('tableCalDays');
  if (!container) return;
  
  container.innerHTML = '';
  
  const firstDay = new Date(tableCalYear, tableCalMonth, 1).getDay();
  const daysInMonth = new Date(tableCalYear, tableCalMonth + 1, 0).getDate();
  const today = new Date();
  
  // Mettre à jour le titre
  const monthYearEl = document.getElementById('tableCalMonthYear');
  if (monthYearEl) {
    monthYearEl.textContent = `${MOIS_NOMS[tableCalMonth]} ${tableCalYear}`;
  }
  
  // Cases vides avant le 1er jour
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'table-cal-day empty';
    container.appendChild(empty);
  }
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'table-cal-day';
    dayEl.textContent = day;
    
    // Marquer aujourd'hui
    if (day === today.getDate() && tableCalMonth === today.getMonth() && tableCalYear === today.getFullYear()) {
      dayEl.classList.add('today');
    }
    
    dayEl.onclick = () => tableCalSelectDay(day);
    container.appendChild(dayEl);
  }
}

function tableCalPrev() {
  tableCalMonth--;
  if (tableCalMonth < 0) {
    tableCalMonth = 11;
    tableCalYear--;
  }
  renderTableCalDays();
}

function tableCalNext() {
  tableCalMonth++;
  if (tableCalMonth > 11) {
    tableCalMonth = 0;
    tableCalYear++;
  }
  renderTableCalDays();
}

function tableCalSelectDay(day) {
  const dateStr = `${tableCalYear}-${String(tableCalMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  applyTableCalDate(dateStr);
}

function tableCalSelectToday() {
  const today = new Date();
  const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
  applyTableCalDate(dateStr);
}

function tableCalClear() {
  applyTableCalDate('');
}

function applyTableCalDate(dateStr) {
  if (!tableCalCurrentCardId || !tableCalCurrentField) return;
  
  // Mettre à jour cardsData
  cardsData[tableCalCurrentCardId][tableCalCurrentField] = dateStr;
  saveCardToFirebase(tableCalCurrentCardId);
  
  // Mettre à jour la cellule de la table
  if (tableCalCurrentCell) {
    tableCalCurrentCell.textContent = dateStr || '📅';
  }
  
  // Synchroniser avec la fiche si dateEssayage (= dateRendezVousEssayage)
  if (tableCalCurrentField === 'dateEssayage') {
    // La fiche utilise dateEssayage aussi, donc c'est synchronisé
    console.log(`✅ Date essayage synchronisée: ${dateStr}`);
  }
  
  // Synchroniser dateRecue avec la fiche
  if (tableCalCurrentField === 'dateRecue') {
    console.log(`✅ Date reçue synchronisée: ${dateStr}`);
  }
  
  closeTableCalendar();
  console.log(`✅ ${tableCalCurrentField} mis à jour: ${dateStr}`);
}

function closeTableCalendar() {
  const overlay = document.getElementById('tableCalendarOverlay');
  if (overlay) overlay.remove();
  tableCalCurrentCardId = null;
  tableCalCurrentField = null;
  tableCalCurrentCell = null;
}

// ===== CALCUL DU DÉLAI EN JOURS OUVRABLES =====
// Jours fériés du Québec (2024-2025)
const JOURS_FERIES = [
  // 2024
  '2024-01-01', // Jour de l'An
  '2024-03-29', // Vendredi Saint
  '2024-05-20', // Journée nationale des patriotes
  '2024-06-24', // Fête nationale du Québec
  '2024-07-01', // Fête du Canada
  '2024-09-02', // Fête du Travail
  '2024-10-14', // Action de grâce
  '2024-12-25', // Noël
  '2024-12-26', // Lendemain de Noël
  // 2025
  '2025-01-01', // Jour de l'An
  '2025-04-18', // Vendredi Saint
  '2025-05-19', // Journée nationale des patriotes
  '2025-06-24', // Fête nationale du Québec
  '2025-07-01', // Fête du Canada
  '2025-09-01', // Fête du Travail
  '2025-10-13', // Action de grâce
  '2025-12-25', // Noël
  '2025-12-26', // Lendemain de Noël
  // 2026
  '2026-01-01', // Jour de l'An
  '2026-04-03', // Vendredi Saint
  '2026-05-18', // Journée nationale des patriotes
  '2026-06-24', // Fête nationale du Québec
  '2026-07-01', // Fête du Canada
  '2026-09-07', // Fête du Travail
  '2026-10-12', // Action de grâce
  '2026-12-25', // Noël
  '2026-12-26', // Lendemain de Noël
];

function isJourFerie(date) {
  const dateStr = date.toISOString().split('T')[0];
  return JOURS_FERIES.includes(dateStr);
}

function isJourOuvrable(date) {
  const jour = date.getDay();
  // 0 = dimanche, 6 = samedi
  if (jour === 0 || jour === 6) return false;
  if (isJourFerie(date)) return false;
  return true;
}

function calculerJoursOuvrables(dateDebut, dateFin) {
  if (!dateDebut || !dateFin) return null;
  
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  
  // Si la date de fin est passée, retourner un nombre négatif
  const aujourdHui = new Date();
  aujourdHui.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  let jours = 0;
  const current = new Date(aujourdHui);
  
  if (fin < aujourdHui) {
    // Date passée - compter les jours négatifs
    while (current > fin) {
      current.setDate(current.getDate() - 1);
      if (isJourOuvrable(current)) {
        jours--;
      }
    }
  } else {
    // Date future - compter les jours positifs
    while (current < fin) {
      current.setDate(current.getDate() + 1);
      if (isJourOuvrable(current)) {
        jours++;
      }
    }
  }
  
  return jours;
}

function renderDelaiSection(cmd) {
  // Affichage simple du délai de livraison
  if (!cmd.dateLivraison || cmd.dateLivraison === 'AAAA-MM-JJ') {
    return `
      <div class="cmd-delai-header">
        <span class="cmd-delai-title">⏱ Délai</span>
      </div>
      <div style="text-align:center;color:#94a3b8;font-size:8px;padding:6px;">
        Entrez une date de livraison
      </div>
    `;
  }
  
  const joursRestants = calculerJoursOuvrables(new Date(), cmd.dateLivraison);
  
  if (joursRestants === null) return '';
  
  let badgeClass, badgeText;
  if (joursRestants < 0) {
    badgeClass = 'passed';
    badgeText = 'DÉPASSÉ';
  } else if (joursRestants <= 3) {
    badgeClass = 'urgent';
    badgeText = 'URGENT';
  } else if (joursRestants <= 7) {
    badgeClass = 'warning';
    badgeText = 'ATTENTION';
  } else {
    badgeClass = 'ok';
    badgeText = 'EN COURS';
  }
  
  const joursAbs = Math.abs(joursRestants);
  const joursLabel = joursRestants < 0 
    ? `${joursAbs}j de retard`
    : `${joursRestants}j restants`;
  
  return `
    <div class="cmd-delai-header">
      <span class="cmd-delai-title">⏱ Délai</span>
      <span class="cmd-delai-badge ${badgeClass}">${badgeText}</span>
    </div>
    <div style="text-align:center;font-size:10px;font-weight:700;color:#1e3a5f;">${joursLabel}</div>
    <div style="text-align:center;font-size:7px;color:#64748b;margin-top:2px;">Livraison: ${cmd.dateLivraison}</div>
  `;
}

// Version COMPACTE du délai - petit rectangle horizontal
function renderDelaiSectionCompact(cmd) {
  // Pas de date de livraison
  if (!cmd.dateLivraison || cmd.dateLivraison === 'AAAA-MM-JJ') {
    return `
      <div class="delai-compact delai-compact-vide">
        <span class="delai-compact-num">--</span>
        <span class="delai-compact-text">Pas de date</span>
      </div>
    `;
  }
  
  const joursRestants = calculerJoursOuvrables(new Date(), cmd.dateLivraison);
  if (joursRestants === null) return '';
  
  // Déterminer la classe de couleur et le texte
  let colorClass, statusText;
  if (joursRestants < 0) {
    colorClass = 'delai-compact-retard';
    statusText = '⚠️ RETARD';
  } else if (joursRestants <= 5) {
    colorClass = 'delai-compact-rouge';
    statusText = '🔴 URGENT';
  } else if (joursRestants <= 10) {
    colorClass = 'delai-compact-jaune';
    statusText = '🟡 ATTENTION';
  } else if (joursRestants <= 15) {
    colorClass = 'delai-compact-jaune';
    statusText = '🟡 SURVEILLER';
  } else {
    colorClass = 'delai-compact-vert';
    statusText = '✅ OK';
  }
  
  const joursAbs = Math.abs(joursRestants);
  const joursLabel = joursRestants < 0 ? 'j retard' : 'j restants';
  
  return `
    <div class="delai-compact ${colorClass}">
      <div class="delai-compact-status">${statusText}</div>
      <div class="delai-compact-main">
        <span class="delai-compact-num">${joursAbs}</span>
        <span class="delai-compact-text">${joursLabel}</span>
      </div>
      <div class="delai-compact-date">📅 ${cmd.dateLivraison}</div>
    </div>
  `;
}

// Version pastille pour le délai - même taille que les autres champs
function renderDelaiPill(cmd) {
  if (!cmd.dateLivraison || cmd.dateLivraison === 'AAAA-MM-JJ') {
    return `<div class="delai-pill-inner delai-pill-vide">-- jours</div>`;
  }
  
  const joursRestants = calculerJoursOuvrables(new Date(), cmd.dateLivraison);
  if (joursRestants === null) return `<div class="delai-pill-inner delai-pill-vide">-- jours</div>`;
  
  let colorClass, text;
  
  if (joursRestants < 0) {
    // En retard - clignotant
    const joursRetard = Math.abs(joursRestants);
    colorClass = 'delai-pill-retard';
    text = `${joursRetard} jour${joursRetard > 1 ? 's' : ''} en retard`;
  } else if (joursRestants === 0) {
    // Aujourd'hui - clignotant
    colorClass = 'delai-pill-retard';
    text = `Aujourd'hui!`;
  } else if (joursRestants <= 3) {
    // 1-3 jours - rouge 58%
    colorClass = 'delai-pill-rouge';
    text = `${joursRestants} jour${joursRestants > 1 ? 's' : ''} restant${joursRestants > 1 ? 's' : ''}`;
  } else if (joursRestants <= 8) {
    // 4-8 jours - jaune vrai
    colorClass = 'delai-pill-jaune';
    text = `${joursRestants} jours restants`;
  } else {
    // Plus de 8 jours - bleu pâle
    colorClass = 'delai-pill-vert';
    text = `${joursRestants} jours restants`;
  }
  
  return `<div class="delai-pill-inner ${colorClass}">${text}</div>`;
}

// Version agrandie du délai pour l'onglet Information
function renderDelaiSectionBig(cmd) {
  // Pas de date de livraison - rectangle vide
  if (!cmd.dateLivraison || cmd.dateLivraison === 'AAAA-MM-JJ') {
    return `
      <div class="delai-rectangle delai-vide">
        <div class="delai-titre">⏱ Délai</div>
        <div class="delai-chiffre" style="font-size: 18px; color: #94a3b8;">--</div>
        <div class="delai-label" style="color: #64748b;">Entrez une date</div>
      </div>
    `;
  }
  
  const joursRestants = calculerJoursOuvrables(new Date(), cmd.dateLivraison);
  
  if (joursRestants === null) return '';
  
  // Déterminer la classe de couleur et le texte
  let colorClass, badgeText;
  if (joursRestants < 0) {
    colorClass = 'delai-retard';
    badgeText = '⚠️ RETARD';
  } else if (joursRestants <= 5) {
    colorClass = 'delai-rouge';
    badgeText = '🔴 URGENT';
  } else if (joursRestants <= 10) {
    colorClass = 'delai-jaune';
    badgeText = '🟡 ATTENTION';
  } else if (joursRestants <= 15) {
    colorClass = 'delai-jaune';
    badgeText = '🟡 À SURVEILLER';
  } else {
    colorClass = 'delai-vert';
    badgeText = '✅ OK';
  }
  
  const joursAbs = Math.abs(joursRestants);
  const joursLabel = joursRestants < 0 
    ? joursAbs + 'j retard'
    : joursRestants + 'j restants';
  
  return `
    <div class="delai-rectangle ${colorClass}">
      <div class="delai-badge">${badgeText}</div>
      <div class="delai-chiffre">${joursAbs}</div>
      <div class="delai-label">${joursLabel}</div>
      <div class="delai-date">📅 ${cmd.dateLivraison}</div>
    </div>
  `;
}

// Nouveau système de suivi des départements
function renderTrackingSection(cmd) {
  const departements = [
    { key: 'robot', name: 'Robot' },
    { key: 'degauchage', name: 'Dégauchage' },
    { key: 'essayage', name: 'Essayage' },
    { key: 'atelier', name: 'Atelier' },
    { key: 'couture', name: 'Couture' },
    { key: 'peinture', name: 'Peinture' },
    { key: 'expedition', name: 'Expédition' }
  ];
  
  // Initialiser les données de tracking si nécessaire
  if (!cmd.tracking) cmd.tracking = {};
  
  let totalJours = 0;
  let deptHtml = '';
  
  departements.forEach(dept => {
    const tracking = cmd.tracking[dept.key] || {};
    const entree = tracking.entree;
    const sortie = tracking.sortie;
    
    let jours = 0;
    let isActive = false;
    let isCompleted = false;
    let dateInfo = '';
    
    if (entree && sortie) {
      // Département terminé
      jours = calculerJoursOuvrables(new Date(entree), sortie);
      if (jours === null) jours = 0;
      isCompleted = true;
      dateInfo = `${entree.substring(5)} → ${sortie.substring(5)}`;
    } else if (entree && !sortie) {
      // Département actif
      jours = calculerJoursOuvrables(new Date(entree), new Date());
      if (jours === null) jours = 0;
      isActive = true;
      dateInfo = `Depuis ${entree.substring(5)}`;
    }
    
    totalJours += jours;
    
    const activeClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
    
    deptHtml += `
      <div class="cmd-tracking-dept ${activeClass}">
        <div class="cmd-tracking-dept-name">${dept.name}</div>
        <div class="cmd-tracking-dept-time">${jours > 0 ? jours + 'j' : '-'}</div>
        ${dateInfo ? `<div class="cmd-tracking-dept-dates">${dateInfo}</div>` : ''}
      </div>
    `;
  });
  
  // Calculer les jours restants pour la livraison
  let livraisonHtml = '';
  if (cmd.dateLivraison && cmd.dateLivraison !== 'AAAA-MM-JJ') {
    const joursRestants = calculerJoursOuvrables(new Date(), cmd.dateLivraison);
    if (joursRestants !== null) {
      let livraisonClass = 'ok';
      if (joursRestants < 0) livraisonClass = 'urgent';
      else if (joursRestants <= 3) livraisonClass = 'urgent';
      else if (joursRestants <= 7) livraisonClass = 'warning';
      
      const livraisonText = joursRestants < 0 
        ? `${Math.abs(joursRestants)}j retard` 
        : `${joursRestants}j restants`;
      
      livraisonHtml = `
        <div class="cmd-tracking-livraison">
          <span class="cmd-tracking-livraison-label">Livraison:</span>
          <span class="cmd-tracking-livraison-days ${livraisonClass}">${livraisonText}</span>
        </div>
      `;
    }
  }
  
  return `
    <div class="cmd-tracking-section">
      <div class="cmd-tracking-title">📊 Suivi Production</div>
      <div class="cmd-tracking-grid">
        ${deptHtml}
      </div>
      <div class="cmd-tracking-total">
        <span class="cmd-tracking-total-label">Temps total en production:</span>
        <span class="cmd-tracking-total-value">${totalJours} jours</span>
      </div>
      ${livraisonHtml}
    </div>
  `;
}

// ===== CALENDRIER FICHE COMMANDE =====
let cmdCalCurrentField = null;

function openCmdDatePicker(field) {
  cmdCalCurrentField = field;
  
  // Parser la date actuelle si elle existe
  const elementId = field === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const currentEl = document.getElementById(elementId);
  const currentValue = currentEl?.textContent;
  
  if (currentValue && currentValue !== 'AAAA-MM-JJ') {
    const parts = currentValue.split('-');
    if (parts.length === 3) {
      tableCalYear = parseInt(parts[0]);
      tableCalMonth = parseInt(parts[1]) - 1;
    }
  } else {
    tableCalMonth = new Date().getMonth();
    tableCalYear = new Date().getFullYear();
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'table-calendar-overlay';
  overlay.id = 'cmdCalendarOverlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeCmdCalendar(); };
  
  const fieldNames = {
    'dateRecue': 'Date Reçue',
    'dateLivraison': 'Date Livraison'
  };
  
  overlay.innerHTML = `
    <div class="table-calendar-popup">
      <div class="table-calendar-header">${fieldNames[field] || field}</div>
      <div class="table-cal-nav">
        <button onclick="cmdCalPrev()">◀</button>
        <span class="table-cal-month" id="cmdCalMonthYear">${MOIS_NOMS[tableCalMonth]} ${tableCalYear}</span>
        <button onclick="cmdCalNext()">▶</button>
      </div>
      <div class="table-cal-weekdays">
        <div class="table-cal-weekday">Dim</div>
        <div class="table-cal-weekday">Lun</div>
        <div class="table-cal-weekday">Mar</div>
        <div class="table-cal-weekday">Mer</div>
        <div class="table-cal-weekday">Jeu</div>
        <div class="table-cal-weekday">Ven</div>
        <div class="table-cal-weekday">Sam</div>
      </div>
      <div class="table-cal-days" id="cmdCalDays"></div>
      <div class="table-cal-buttons">
        <button class="table-cal-today" onclick="cmdCalSelectToday()">Aujourd'hui</button>
        <button class="table-cal-clear" onclick="cmdCalClear()">Effacer</button>
        <button class="table-cal-close" onclick="closeCmdCalendar()">Fermer</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  renderCmdCalDays();
}

function renderCmdCalDays() {
  const container = document.getElementById('cmdCalDays');
  if (!container) return;
  
  container.innerHTML = '';
  
  const firstDay = new Date(tableCalYear, tableCalMonth, 1).getDay();
  const daysInMonth = new Date(tableCalYear, tableCalMonth + 1, 0).getDate();
  const today = new Date();
  
  // Mettre à jour le titre
  const monthYearEl = document.getElementById('cmdCalMonthYear');
  if (monthYearEl) {
    monthYearEl.textContent = `${MOIS_NOMS[tableCalMonth]} ${tableCalYear}`;
  }
  
  // Cases vides avant le 1er jour
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'table-cal-day empty';
    container.appendChild(empty);
  }
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'table-cal-day';
    dayEl.textContent = day;
    
    // Marquer aujourd'hui
    if (day === today.getDate() && tableCalMonth === today.getMonth() && tableCalYear === today.getFullYear()) {
      dayEl.classList.add('today');
    }
    
    dayEl.onclick = () => cmdCalSelectDay(day);
    container.appendChild(dayEl);
  }
}

function cmdCalPrev() {
  tableCalMonth--;
  if (tableCalMonth < 0) {
    tableCalMonth = 11;
    tableCalYear--;
  }
  renderCmdCalDays();
}

function cmdCalNext() {
  tableCalMonth++;
  if (tableCalMonth > 11) {
    tableCalMonth = 0;
    tableCalYear++;
  }
  renderCmdCalDays();
}

function cmdCalSelectDay(day) {
  const month = String(tableCalMonth + 1).padStart(2, '0');
  const dayStr = String(day).padStart(2, '0');
  const dateStr = `${tableCalYear}-${month}-${dayStr}`;
  
  const elementId = cmdCalCurrentField === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const el = document.getElementById(elementId);
  if (el) el.textContent = dateStr;
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalCurrentField === 'dateLivraison' && currentCmdId) {
    updateDelaiDisplay(currentCmdId, dateStr);
  }
  
  closeCmdCalendar();
}

function cmdCalSelectToday() {
  const today = new Date();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const dateStr = `${today.getFullYear()}-${month}-${day}`;
  
  const elementId = cmdCalCurrentField === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const el = document.getElementById(elementId);
  if (el) el.textContent = dateStr;
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalCurrentField === 'dateLivraison' && currentCmdId) {
    updateDelaiDisplay(currentCmdId, dateStr);
  }
  
  closeCmdCalendar();
}

function cmdCalClear() {
  const elementId = cmdCalCurrentField === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const el = document.getElementById(elementId);
  if (el) el.textContent = 'AAAA-MM-JJ';
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalCurrentField === 'dateLivraison' && currentCmdId) {
    updateDelaiDisplay(currentCmdId, null);
  }
  
  closeCmdCalendar();
}

function updateDelaiDisplay(cmdId, dateLivraison) {
  const section = document.getElementById('cmdDelaiSection_' + cmdId);
  if (section) {
    const cmd = { dateLivraison: dateLivraison };
    section.innerHTML = renderDelaiPill(cmd);
  }
}

function closeCmdCalendar() {
  const overlay = document.getElementById('cmdCalendarOverlay');
  if (overlay) overlay.remove();
  cmdCalCurrentField = null;
}

// Mettre à jour la couleur de région d'une carte
function updateCardRegionColor(cardId, region) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  card.classList.remove('region-qc', 'region-on', 'region-ma');
  if (region === 'Québec') card.classList.add('region-qc');
  else if (region === 'Ontario') card.classList.add('region-on');
  else if (region === 'Maritime') card.classList.add('region-ma');
}

// Mettre à jour la carte dans le DOM Kanban depuis le tableau
function updateCardFromTable(cardId, field, value) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  switch(field) {
    case 'name':
      const titleInput = card.querySelector('.mcard-title');
      if (titleInput) titleInput.value = value;
      break;
    case 'order':
      const orderInput = card.querySelector('.mcard-order');
      if (orderInput) orderInput.value = value;
      break;
    case 'client':
      const clientSpan = card.querySelector('.mcard-client');
      if (clientSpan) clientSpan.textContent = value || 'Client';
      break;
    case 'intervenant':
      const intervenantSpan = card.querySelector('.mcard-intervenant');
      if (intervenantSpan) intervenantSpan.textContent = value || 'Intervenant';
      break;
  }
}


// Setup du redimensionnement des colonnes
function setupColumnResize() {
  const handles = document.querySelectorAll('.resize-handle');
  handles.forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      const th = this.parentElement;
      const startX = e.pageX;
      const startWidth = th.offsetWidth;
      
      function onMouseMove(e) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 50) {
          th.style.width = newWidth + 'px';
          th.style.minWidth = newWidth + 'px';
        }
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  });
}

// ===== GESTION DES PAGES (MOULAGES / COMMANDES) =====
let currentPage = 'moulages';
let commandesData = {};

// Variable pour suivre l'état du flip
let isFlipping = false;
let currentLogoState = 'moulages'; // 'moulages' = front, 'commandes' = back

// Fonction pour faire le flip du logo et changer de page
function flipLogoAndSwitch() {
  if (isFlipping) return; // Éviter les clics multiples pendant l'animation
  
  const container = document.getElementById('logoFlipContainer');
  const inner = document.getElementById('logoFlipInner');
  
  isFlipping = true;
  
  // Déterminer la nouvelle page et l'animation
  const newPage = currentLogoState === 'moulages' ? 'commandes' : 'moulages';
  const flipClass = currentLogoState === 'moulages' ? 'flipping-to-back' : 'flipping-to-front';
  
  // Retirer les anciennes classes d'animation
  container.classList.remove('flipping-to-back', 'flipping-to-front');
  
  // Forcer un reflow pour redémarrer l'animation
  void container.offsetWidth;
  
  // Ajouter la classe de flip
  container.classList.add(flipClass);
  
  // Changer la page à mi-chemin de l'animation (350ms sur 700ms)
  setTimeout(() => {
    switchPage(newPage);
  }, 350);
  
  // Fin de l'animation
  setTimeout(() => {
    container.classList.remove('flipping-to-back', 'flipping-to-front');
    
    if (newPage === 'commandes') {
      // Garder le flip (montrer le dos)
      inner.style.transform = 'rotateY(180deg)';
    } else {
      // Revenir à la normale (montrer le front)
      inner.style.transform = 'rotateY(0deg)';
    }
    
    currentLogoState = newPage;
    isFlipping = false;
    
    // Mettre à jour les classes actives
    container.classList.remove('active-moulages', 'active-commandes');
    container.classList.add('active-' + newPage);
  }, 700);
}

function switchPage(page) {
  currentPage = page;
  
  const boardsContainer = document.getElementById('boardsContainer');
  const commandesPage = document.getElementById('commandesPage');
  const robotView = document.getElementById('robotHorizontalView');
  const btnAddMoulage = document.getElementById('btnAddMoulage');
  const btnAddCommande = document.getElementById('btnAddCommande');
  const pageTitle = document.getElementById('pageTitle');
  const searchInput = document.getElementById('searchInput');
  
  if (page === 'moulages') {
    // Afficher la page moulages
    boardsContainer.style.display = 'block';
    boardsContainer.classList.remove('hidden');
    commandesPage.classList.add('hidden');
    commandesPage.style.display = 'none';
    robotView.style.display = 'none';
    isRobotViewActive = false;
    
    btnAddMoulage.classList.remove('hidden');
    btnAddCommande.classList.add('hidden');
    pageTitle.textContent = 'Outil de gestion des moulages';
    searchInput.placeholder = 'Rechercher un moulage...';
    
    // Forcer le rendu des cartes existantes
    updateColumnCounts();
    console.log('📦 Page Moulages activée');
  } else {
    // Afficher la page commandes
    boardsContainer.style.display = 'none';
    boardsContainer.classList.add('hidden');
    commandesPage.classList.remove('hidden');
    commandesPage.style.display = 'block';
    robotView.style.display = 'none';
    isRobotViewActive = false;
    
    btnAddMoulage.classList.add('hidden');
    btnAddCommande.classList.remove('hidden');
    pageTitle.textContent = 'Outil de gestion des commandes';
    searchInput.placeholder = 'Rechercher une commande...';
    
    // Rafraîchir le board commandes
    renderCommandesBoard();
    console.log('📋 Page Commandes activée');
  }
}

// ===== GESTION DES COMMANDES =====
function renderCommandesBoard() {
  const columns = document.querySelectorAll('#commandesBoard .col');
  columns.forEach(col => {
    // Garder le header, vider le reste
    const header = col.querySelector('.colheader');
    col.innerHTML = '';
    col.appendChild(header);
  });
  
  // Trier les commandes par colonne puis par position
  const sortedCommandes = Object.entries(commandesData)
    .sort((a, b) => {
      // D'abord par colonne
      const colA = a[1].columnIndex ?? 0;
      const colB = b[1].columnIndex ?? 0;
      if (colA !== colB) return colA - colB;
      // Ensuite par position (rang 1, 2, 3...)
      const posA = a[1].position ?? 999;
      const posB = b[1].position ?? 999;
      return posA - posB;
    });
  
  // Rendre les cartes commandes - placer selon le client
  sortedCommandes.forEach(([cmdId, cmd]) => {
    // Déterminer la colonne selon le client
    const colIndex = getColumnIndexForClient(cmd.client);
    // Mettre à jour columnIndex si différent
    if (cmd.columnIndex !== colIndex) {
      cmd.columnIndex = colIndex;
    }
    const col = document.querySelector(`#commandesBoard .col[data-col-cmd="${colIndex}"]`);
    if (col) {
      const cardEl = createCommandeCard(cmdId, cmd);
      col.appendChild(cardEl);
    }
  });
  
  updateCommandesCounts();
}

function createCommandeCard(cmdId, data) {
  const region = data.region || 'Québec';
  let regionClass = 'region-qc';
  if (region === 'Ontario') regionClass = 'region-on';
  else if (region === 'Maritime') regionClass = 'region-ma';
  
  // Classe client
  let clientClass = '';
  if (data.client === 'Vermeiren') clientClass = 'client-vermeiren';
  else if (data.client === 'HME') clientClass = 'client-hme';
  else if (data.client === 'France') clientClass = 'client-france';
  else if (data.client === 'Cubro') clientClass = 'client-cubro';
  else if (data.client === 'C1SOUTH') clientClass = 'client-c1south';
  
  const card = document.createElement('div');
  card.className = `mcard ${regionClass} ${clientClass}`.trim();
  card.setAttribute('data-cmd-id', cmdId);
  
  // Calculer délai pour commandes (jours OUVRABLES restants jusqu'à dateLivraison)
  let delayText = '-- jours ouvrables';
  let delayClass = '';
  
  // Vérifier si dateLivraison est définie et valide
  const hasValidDateLivraison = data.dateLivraison && data.dateLivraison !== '' && data.dateLivraison !== 'AAAA-MM-JJ';
  
  if (hasValidDateLivraison) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const livraison = new Date(data.dateLivraison);
    livraison.setHours(0, 0, 0, 0);
    
    if (livraison < today) {
      // En retard - calculer les jours ouvrables de retard
      const joursRetard = calculerJoursOuvrables(livraison, today);
      delayText = `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`;
      delayClass = 'delai-retard';
    } else if (livraison.getTime() === today.getTime()) {
      delayText = "Aujourd'hui!";
      delayClass = 'delai-retard';
    } else {
      // Calculer les jours ouvrables restants
      const joursRestants = calculerJoursOuvrables(today, livraison);
      delayText = `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`;
      
      // Déterminer la couleur selon les jours restants
      if (joursRestants <= 3) {
        delayClass = 'delai-rouge';
      } else if (joursRestants <= 10) {
        delayClass = 'delai-jaune';
      } else {
        delayClass = 'delai-vert';
      }
    }
  }
  
  card.innerHTML = `
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <div class="mcard-client-select" data-cmd-id="${cmdId}" onclick="showClientMenu('${cmdId}', event)">${data.client || 'Client'}</div>
        </div>
        <div class="mcard-order-line">
          <input type="text" class="mcard-order" value="${data.order || '000000'}" data-field="order" maxlength="6">
          <button class="mcard-toggle-btn" onclick="openCommandeFiche('${cmdId}')">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="mcard-delay-pill ${delayClass}"><span>${delayText}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move" onclick="showCommandeMoveMenu('${cmdId}')">Déplacer</button>
      <button class="mcard-btn mcard-btn-delete" onclick="confirmDeleteCommande('${cmdId}')">Supprimer</button>
    </div>
  `;
  
  // Event listeners pour édition inline
  const orderInput = card.querySelector('.mcard-order');
  
  orderInput.addEventListener('blur', () => {
    commandesData[cmdId].order = orderInput.value;
    saveCommandeToFirebase(cmdId);
  });
  
  return card;
}

function updateCommandesCounts() {
  const columns = document.querySelectorAll('#commandesBoard .col');
  columns.forEach(col => {
    const count = col.querySelectorAll('.mcard').length;
    const countEl = col.querySelector('.col-count-cmd');
    if (countEl) countEl.textContent = count;
  });
}

function addNewCommande() {
  // Créer ou afficher le modal
  let modal = document.getElementById('addCommandeModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'addCommandeModal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
          <h3>➕ Ajouter une commande</h3>
          <button class="modal-close" onclick="document.getElementById('addCommandeModal').classList.remove('active')">×</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="add-modal-field">
            <label>Client <button class="list-manage-btn" onclick="openListManager('commandeClients', 'Client')">⚙</button></label>
            <select id="addCmdClient"></select>
          </div>
          <div class="add-modal-field">
            <label>N° Commande</label>
            <input type="text" id="addCmdOrder" placeholder="000000" maxlength="6">
          </div>
          <div class="add-modal-field">
            <label>Date reçue</label>
            <div class="date-picker-field" id="addCmdDateRecueField" onclick="openAddModalCalendar('addCmdDateRecue')">
              <span class="date-picker-value" id="addCmdDateRecueDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addCmdDateRecue">
          </div>
          <div class="add-modal-field">
            <label>Date livraison</label>
            <div class="date-picker-field" id="addCmdDateLivraisonField" onclick="openAddModalCalendar('addCmdDateLivraison')">
              <span class="date-picker-value" id="addCmdDateLivraisonDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addCmdDateLivraison">
          </div>
          <div class="add-modal-field" style="grid-column: 1 / -1;">
            <label>N° PO</label>
            <input type="text" id="addCmdPO" placeholder="000000" maxlength="6">
          </div>
        </div>
        <div class="add-modal-buttons">
          <button class="btn-cancel-modal" onclick="document.getElementById('addCommandeModal').classList.remove('active')">Annuler</button>
          <button class="btn-add" onclick="confirmAddCommande()">Ajouter</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Remplir le select avec les clients de la liste personnalisée
  const clientSelect = document.getElementById('addCmdClient');
  if (clientSelect) {
    clientSelect.innerHTML = customLists.commandeClients.map(c => `<option value="${c}">${c}</option>`).join('');
  }
  
  // Reset les champs
  if (clientSelect && customLists.commandeClients.length > 0) {
    clientSelect.value = customLists.commandeClients[0];
  }
  document.getElementById('addCmdOrder').value = '';
  document.getElementById('addCmdPO').value = '';
  document.getElementById('addCmdDateRecue').value = '';
  document.getElementById('addCmdDateLivraison').value = '';
  
  // Reset les affichages de date
  const dateRecueDisplay = document.getElementById('addCmdDateRecueDisplay');
  const dateLivraisonDisplay = document.getElementById('addCmdDateLivraisonDisplay');
  const dateRecueField = document.getElementById('addCmdDateRecueField');
  const dateLivraisonField = document.getElementById('addCmdDateLivraisonField');
  
  if (dateRecueDisplay) dateRecueDisplay.textContent = '-- Sélectionner --';
  if (dateLivraisonDisplay) dateLivraisonDisplay.textContent = '-- Sélectionner --';
  if (dateRecueField) dateRecueField.classList.remove('has-value');
  if (dateLivraisonField) dateLivraisonField.classList.remove('has-value');
  
  modal.classList.add('active');
}

function confirmAddCommande() {
  const client = document.getElementById('addCmdClient').value;
  const order = document.getElementById('addCmdOrder').value.trim() || '000000';
  const numeroPO = document.getElementById('addCmdPO').value.trim() || '';
  const dateRecue = document.getElementById('addCmdDateRecue').value || '';
  const dateLivraison = document.getElementById('addCmdDateLivraison').value || '';
  
  // Déterminer la colonne selon le client (basé sur la liste dynamique)
  const columnIndex = customLists.commandeClients.indexOf(client);
  const finalColumnIndex = columnIndex >= 0 ? columnIndex : 0;
  
  const cmdId = 'cmd_' + Date.now();
  const newCmd = {
    client: client,
    order: order,
    numeroPO: numeroPO,
    dateRecue: dateRecue,
    dateLivraison: dateLivraison,
    item: 'Article',
    region: 'Québec',
    columnIndex: finalColumnIndex,
    dateCreated: new Date().toISOString(),
    notes: '',
    items: []
  };
  
  commandesData[cmdId] = newCmd;
  saveCommandeToFirebase(cmdId);
  renderCommandesBoard();
  
  document.getElementById('addCommandeModal').classList.remove('active');
  console.log(`✅ Nouvelle commande ajoutée: ${cmdId}`);
}
window.confirmAddCommande = confirmAddCommande;

function showCommandeMoveMenu(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const currentCol = cmd.columnIndex ?? 0;
  const columnNames = ['Vermeiren', 'HME', 'C1SOUTH', 'Cubro', 'France'];
  const clientName = columnNames[currentCol] || 'Client';
  
  // Récupérer toutes les cartes de cette colonne, triées par position
  const cardsInCol = Object.entries(commandesData)
    .filter(([id, c]) => (c.columnIndex ?? 0) === currentCol)
    .sort((a, b) => (a[1].position ?? 999) - (b[1].position ?? 999));
  
  const totalCards = cardsInCol.length;
  
  // Trouver la position actuelle de cette carte
  const currentPos = cardsInCol.findIndex(([id, c]) => id === cmdId);
  
  const overlay = document.createElement('div');
  overlay.className = 'move-overlay';
  overlay.id = 'cmdMoveOverlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  
  // Générer les boutons de rang
  let rangsHtml = '';
  
  if (totalCards === 0) {
    // Colonne vide - seulement position 1
    rangsHtml = `<button class="move-rang-btn" onclick="moveCommandeToRang('${cmdId}', 0)">Rang 1</button>`;
  } else if (totalCards === 1 && currentPos === 0) {
    // Seule carte dans la colonne - juste afficher position actuelle
    rangsHtml = `<button class="move-rang-btn current" disabled>Rang 1 (actuel)</button>`;
  } else {
    // Plusieurs cartes - afficher les rangs existants + "Placer en dernier"
    for (let rang = 0; rang < totalCards; rang++) {
      const isCurrentRang = rang === currentPos;
      const displayRang = rang + 1;
      rangsHtml += `<button class="move-rang-btn ${isCurrentRang ? 'current' : ''}" 
        onclick="moveCommandeToRang('${cmdId}', ${rang})" 
        ${isCurrentRang ? 'disabled' : ''}>
        Rang ${displayRang}${isCurrentRang ? ' (actuel)' : ''}
      </button>`;
    }
    
    // Ajouter "Placer en dernier" seulement si la carte n'est pas déjà en dernière position
    if (currentPos !== totalCards - 1) {
      rangsHtml += `<button class="move-rang-btn move-rang-last" 
        onclick="moveCommandeToRang('${cmdId}', ${totalCards - 1})" 
        style="background: #facc15; color: #000; font-weight: 700;">
        Placer en dernier
      </button>`;
    }
  }
  
  overlay.innerHTML = `
    <div class="move-panel-simple">
      <div class="move-title">📦 Déplacer dans ${clientName}</div>
      <div class="move-subtitle">${totalCards} carte${totalCards > 1 ? 's' : ''} dans cette colonne</div>
      <div class="move-rangs-list">
        ${rangsHtml}
      </div>
      <div class="move-actions">
        <button class="move-cancel-btn" onclick="document.getElementById('cmdMoveOverlay').remove()">Fermer</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
}

function moveCommandeToRang(cmdId, newRang) {
  if (!commandesData[cmdId]) return;
  
  const currentCol = commandesData[cmdId].columnIndex ?? 0;
  
  // Récupérer toutes les cartes de cette colonne, triées par position
  const cardsInCol = Object.entries(commandesData)
    .filter(([id, c]) => (c.columnIndex ?? 0) === currentCol)
    .sort((a, b) => (a[1].position ?? 999) - (b[1].position ?? 999));
  
  // Trouver la position actuelle
  const currentRang = cardsInCol.findIndex(([id, c]) => id === cmdId);
  if (currentRang === newRang) return; // Pas de changement
  
  // Retirer la carte de sa position actuelle
  const [movedCard] = cardsInCol.splice(currentRang, 1);
  
  // Insérer à la nouvelle position
  cardsInCol.splice(newRang, 0, movedCard);
  
  // Mettre à jour les positions de toutes les cartes
  cardsInCol.forEach(([id, c], idx) => {
    commandesData[id].position = idx;
    saveCommandeToFirebase(id);
  });
  
  document.getElementById('cmdMoveOverlay')?.remove();
  renderCommandesBoard();
  console.log(`✅ Commande ${cmdId} déplacée au rang ${newRang + 1}`);
}

// Ancienne fonction conservée pour compatibilité
function moveCommandeToPos(cmdId, colIndex, position) {
  if (!commandesData[cmdId]) return;
  
  commandesData[cmdId].columnIndex = colIndex;
  commandesData[cmdId].position = position;
  saveCommandeToFirebase(cmdId);
  
  document.getElementById('cmdMoveOverlay')?.remove();
  renderCommandesBoard();
  console.log(`✅ Commande ${cmdId} déplacée vers colonne ${colIndex}, position ${position}`);
}

function confirmDeleteCommande(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  document.getElementById('cmdMoveOverlay')?.remove();
  
  const overlay = document.createElement('div');
  overlay.className = 'move-overlay';
  overlay.id = 'cmdDeleteOverlay';
  
  overlay.innerHTML = `
    <div class="move-menu">
      <div class="move-menu-title">⚠️ Supprimer cette commande?</div>
      <div style="text-align:center;padding:10px;font-size:14px;color:#fbbf24;">${cmd.client || 'Sans nom'}</div>
      <div class="move-menu-actions">
        <button class="move-delete-btn" onclick="deleteCommande('${cmdId}')">🗑️ Oui, supprimer</button>
        <button class="move-cancel-btn" onclick="document.getElementById('cmdDeleteOverlay').remove()">Non, annuler</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
}

function deleteCommande(cmdId) {
  if (!commandesData[cmdId]) return;
  
  // ARCHIVER AVANT DE SUPPRIMER
  archiveCard(cmdId, commandesData[cmdId], 'commande');
  
  delete commandesData[cmdId];
  
  // Supprimer de Firebase
  if (firebaseDb) {
    firebaseDb.ref('commandes/' + cmdId).remove();
  }
  
  document.getElementById('cmdDeleteOverlay')?.remove();
  renderCommandesBoard();
  console.log(`🗑️ Commande ${cmdId} supprimée et archivée`);
}

// Menu client sur carte commande
const CMD_CLIENTS = ['Vermeiren', 'HME', 'France', 'Cubro', 'C1SOUTH'];

function showClientMenu(cmdId, event) {
  event.stopPropagation();
  
  // Fermer menu existant
  closeClientMenu();
  
  const menu = document.createElement('div');
  menu.className = 'client-menu-popup';
  menu.id = 'clientMenuPopup';
  menu.style.left = event.clientX + 'px';
  menu.style.top = event.clientY + 'px';
  
  let menuHTML = CMD_CLIENTS.map(client => 
    `<div class="client-menu-item" onclick="selectClient('${cmdId}', '${client}')">${client}</div>`
  ).join('');
  
  // Ajouter les boutons Ajouter/Supprimer
  menuHTML += `
    <div style="border-top:1px solid rgba(255,255,255,0.2);margin-top:6px;padding-top:6px;">
      <div class="client-menu-item" style="background:rgba(34,197,94,0.3);" onclick="addNewClient('${cmdId}')">➕ Ajouter</div>
      <div class="client-menu-item" style="background:rgba(239,68,68,0.3);" onclick="removeClientOption()">➖ Supprimer</div>
    </div>
  `;
  
  menu.innerHTML = menuHTML;
  
  document.body.appendChild(menu);
  
  // Fermer au clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeClientMenu, { once: true });
  }, 10);
}

function addNewClient(cmdId) {
  closeClientMenu();
  const newClient = prompt('Nom du nouveau client:');
  if (newClient && newClient.trim()) {
    const clientName = newClient.trim();
    if (!CMD_CLIENTS.includes(clientName)) {
      CMD_CLIENTS.push(clientName);
    }
    selectClient(cmdId, clientName);
  }
}

function removeClientOption() {
  closeClientMenu();
  const clientList = CMD_CLIENTS.map((c, i) => `${i + 1}. ${c}`).join('\n');
  const choice = prompt(`Supprimer quel client?\n${clientList}\n\nNuméro:`);
  if (choice) {
    const index = parseInt(choice) - 1;
    if (index >= 0 && index < CMD_CLIENTS.length) {
      CMD_CLIENTS.splice(index, 1);
    }
  }
}

function closeClientMenu() {
  const menu = document.getElementById('clientMenuPopup');
  if (menu) menu.remove();
}

function selectClient(cmdId, client) {
  commandesData[cmdId].client = client;
  saveCommandeToFirebase(cmdId);
  renderCommandesBoard();
  closeClientMenu();
}

function updateCmdClientFromFiche(cmdId, client) {
  commandesData[cmdId].client = client;
  saveCommandeToFirebase(cmdId);
  
  // Mettre à jour la carte si visible - couleur et texte
  const cardEl = document.querySelector(`.mcard[data-cmd-id="${cmdId}"]`);
  if (cardEl) {
    // Enlever toutes les classes client
    cardEl.classList.remove('client-vermeiren', 'client-hme', 'client-france', 'client-cubro', 'client-c1south');
    
    // Ajouter la nouvelle classe
    if (client === 'Vermeiren') cardEl.classList.add('client-vermeiren');
    else if (client === 'HME') cardEl.classList.add('client-hme');
    else if (client === 'France') cardEl.classList.add('client-france');
    else if (client === 'Cubro') cardEl.classList.add('client-cubro');
    else if (client === 'C1SOUTH') cardEl.classList.add('client-c1south');
    
    // Mettre à jour le texte
    const clientSelect = cardEl.querySelector('.mcard-client-select');
    if (clientSelect) clientSelect.textContent = client || 'Client';
    
    // Déplacer la carte dans la bonne colonne client
    const colIndex = getColumnIndexForClient(client);
    const targetCol = document.querySelector(`#commandesBoard .col[data-col-cmd="${colIndex}"]`);
    if (targetCol && cardEl.parentElement !== targetCol) {
      targetCol.appendChild(cardEl);
      commandesData[cmdId].columnIndex = colIndex;
      updateCmdColumnCounts();
    }
  }
}

// Obtenir l'index de colonne selon le client
function getColumnIndexForClient(client) {
  switch(client) {
    case 'Vermeiren': return 0;
    case 'HME': return 1;
    case 'C1SOUTH': return 2;
    case 'Cubro': return 3;
    case 'France': return 4;
    default: return 0; // Par défaut Vermeiren
  }
}

// Variable globale pour la fiche commande courante
let currentCmdId = null;

function openCommandeFiche(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  // Initialiser items si pas présent
  if (!cmd.items) cmd.items = [];
  
  const overlay = document.getElementById('cmdFicheOverlay');
  const content = document.getElementById('cmdFicheContent');
  
  content.innerHTML = `
    <div class="cmd-fiche-main-container">
      <!-- HEADER avec logo, titre et onglets -->
      <div class="cmd-fiche-main-header">
        <div class="logo-section">
          <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro2.png" alt="PhysiPro Série Plus"/>
        </div>
        <div class="cmd-main-tabs">
          <button class="cmd-main-tab tab-info-magasin active" id="tabBtnInfoMag_${cmdId}" onclick="switchCmdMainTab('${cmdId}', 'info-magasin')">📋 Info / Magasin</button>
          <button class="cmd-main-tab tab-tableau" id="tabBtnTableau_${cmdId}" onclick="switchCmdMainTab('${cmdId}', 'tableau')">📊 Tableau</button>
        </div>
        <div class="cmd-header-actions">
          <button class="cmd-import-json-btn" onclick="document.getElementById('importAtelierFileCmd_${cmdId}').click()">
            📥 Importer JSON
          </button>
          <input type="file" id="importAtelierFileCmd_${cmdId}" accept=".json" style="display:none" onchange="handleImportAtelierFileCmd(event, '${cmdId}')">
        </div>
        <button class="cmd-close-x" onclick="closeCmdFiche()">✕</button>
      </div>
      
      <!-- BODY - Contenu des vues -->
      <div class="cmd-fiche-main-body">
        
        <!-- VUE INFO/MAGASIN - 2 colonnes côte à côte -->
        <div class="cmd-view-info-magasin active" id="viewInfoMag_${cmdId}">
          <!-- PANNEAU INFORMATION (gauche) -->
          <div class="cmd-panel-info">
            <div class="cmd-panel-header">
              <h4>📋 Information</h4>
            </div>
            <div class="cmd-panel-body" style="display: flex; flex-direction: column; height: 100%;">
              <!-- Ligne 1: Client + N° Commande -->
              <div class="cmd-info-row" style="margin-bottom: 8px;">
                <div class="cmd-info-field half">
                  <label style="font-size: 10px;">Client <button class="list-manage-btn" onclick="event.stopPropagation(); openListManager('commandeClients', 'Client')">⚙</button></label>
                  <select id="cmdClient" onchange="updateCmdClientFromFiche('${cmdId}', this.value)" class="cmd-pill-input">
                    <option value="">-- Sélectionner --</option>
                    ${customLists.commandeClients.map(c => `<option value="${c}" ${cmd.client === c ? 'selected' : ''}>${c}</option>`).join('')}
                  </select>
                </div>
                <div class="cmd-info-field half">
                  <label style="font-size: 10px;">N° Commande</label>
                  <input type="text" id="cmdNumero" value="${cmd.order || ''}" placeholder="000000" 
                    maxlength="6" 
                    pattern="[0-9]{6}" 
                    inputmode="numeric"
                    onfocus="if(this.value.length > 0) this.select();"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);"
                    onchange="updateCmdField('${cmdId}', 'order', this.value)" 
                    class="cmd-pill-input">
                </div>
              </div>
              
              <!-- Ligne 2: PO + Date reçue -->
              <div class="cmd-info-row" style="margin-bottom: 8px;">
                <div class="cmd-info-field half">
                  <label style="font-size: 10px;">N° PO</label>
                  <input type="text" id="cmdNumeroPO" value="${cmd.numeroPO || ''}" placeholder="000000" 
                    maxlength="6" 
                    pattern="[0-9]{6}" 
                    inputmode="numeric"
                    onfocus="if(this.value.length > 0) this.select();"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);"
                    onchange="updateCmdField('${cmdId}', 'numeroPO', this.value)" 
                    class="cmd-pill-input">
                </div>
                <div class="cmd-info-field half">
                  <label style="font-size: 10px;">Date reçue</label>
                  <div class="cmd-fiche-date-pill cmd-pill-input" id="cmdDateRecue" onclick="openCmdDatePicker('dateRecue')">${cmd.dateRecue || 'AAAA-MM-JJ'}</div>
                </div>
              </div>
              
              <!-- Ligne 3: Date livraison + Délai -->
              <div class="cmd-info-row" style="margin-bottom: 8px;">
                <div class="cmd-info-field half">
                  <label style="font-size: 10px;">Date livraison</label>
                  <div class="cmd-fiche-date-pill cmd-pill-input" id="cmdDateLivraison" onclick="openCmdDatePicker('dateLivraison')">${cmd.dateLivraison || 'AAAA-MM-JJ'}</div>
                </div>
                <div class="cmd-info-field half">
                  <label style="font-size: 10px;">Délai restant</label>
                  <div class="cmd-delai-pill" id="cmdDelaiSection_${cmdId}">
                    ${renderDelaiPill(cmd)}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- PANNEAU MAGASIN (droite) -->
          <div class="cmd-panel-magasin" style="display: flex; flex-direction: column;">
            <div class="cmd-panel-header">
              <h4>📦 Magasin</h4>
              <div style="display: flex; gap: 4px; margin-left: auto;">
                <button class="cmd-recettes-btn" onclick="openRecettesPopup()" style="font-size: 8px; padding: 3px 8px; background: linear-gradient(to bottom, #3f6eb8, #1d3560); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">⚙ Recettes</button>
                <button onclick="printMateriaux('${cmdId}')" style="font-size: 8px; padding: 3px 8px; background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">🖨 Imprimer</button>
              </div>
            </div>
            <!-- Total Matériaux - EN HAUT juste après le header -->
            <div class="cmd-materiaux-total-section-top" id="cmdMateriauxTotalTop">
              <!-- Généré par updateMateriauxSection -->
            </div>
            <!-- Zone scrollable pour les recettes - prend tout l'espace -->
            <div class="cmd-panel-body" style="flex: 1; overflow-y: auto; padding: 8px;">
              <div class="cmd-materiaux-container" id="cmdMateriauxContainer">
                <!-- Les colonnes seront générées dynamiquement par item -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- VUE TABLEAU - pleine largeur -->
        <div class="cmd-view-tableau" id="viewTableau_${cmdId}">
          <div class="cmd-tableau-body">
            <div class="cmd-items-list" id="atelierItemsList">
              ${renderDeptItems(cmd.items, cmdId, 'atelier')}
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- FOOTER -->
      <div class="cmd-fiche-main-footer">
        <button onclick="saveCmdFicheAndClose('${cmdId}')">Fermer</button>
      </div>
    </div>
  `;
  
  overlay.classList.add('active');
  currentCmdId = cmdId;
  
  // Mettre à jour les matériaux automatiquement
  setTimeout(() => updateMateriauxSection(cmdId), 100);
}

// Fonction pour basculer entre les onglets
function switchCmdTab(cmdId, tab) {
  // Ancienne fonction - conservée pour compatibilité
}

// Nouvelle fonction pour les onglets principaux
function switchCmdMainTab(cmdId, tab) {
  // Désactiver tous les onglets et vues
  const btnInfoMag = document.getElementById('tabBtnInfoMag_' + cmdId);
  const btnTableau = document.getElementById('tabBtnTableau_' + cmdId);
  const viewInfoMag = document.getElementById('viewInfoMag_' + cmdId);
  const viewTableau = document.getElementById('viewTableau_' + cmdId);
  
  if (!btnInfoMag || !btnTableau || !viewInfoMag || !viewTableau) return;
  
  btnInfoMag.classList.remove('active');
  btnTableau.classList.remove('active');
  viewInfoMag.classList.remove('active');
  viewTableau.classList.remove('active');
  
  // Activer l'onglet sélectionné
  if (tab === 'info-magasin') {
    btnInfoMag.classList.add('active');
    viewInfoMag.classList.add('active');
    // Rafraîchir les matériaux quand on revient sur Info/Magasin
    setTimeout(() => updateMateriauxSection(cmdId), 50);
  } else if (tab === 'tableau') {
    btnTableau.classList.add('active');
    viewTableau.classList.add('active');
  }
}

function renderDeptItems(items, cmdId, dept) {
  // Tableau avec espacement uniforme via CSS border-spacing
  // ATELIER: 6 cols (+, Item, Qté, Total, Status, Notes)
  // COUTURE: 6 cols (Item, Qté, Total, Status, Emp, Notes)
  // INSPECTION: 7 cols (Item, Qté, Total, Status, Expéd, Notes, X)
  let html = `
    <table class="cmd-items-table">
      <colgroup>
        <!-- ATELIER -->
        <col style="width: 12px;">
        <col style="width: 52px;">
        <col style="width: 24px;">
        <col style="width: 32px;">
        <col style="width: 42px;">
        <col style="width: 30px;">
        <!-- COUTURE -->
        <col style="width: 52px;">
        <col style="width: 24px;">
        <col style="width: 32px;">
        <col style="width: 42px;">
        <col style="width: 58px;">
        <col style="width: 30px;">
        <!-- INSPECTION -->
        <col style="width: 52px;">
        <col style="width: 24px;">
        <col style="width: 32px;">
        <col style="width: 42px;">
        <col style="width: 88px;">
        <col style="width: 30px;">
        <col style="width: 14px;">
      </colgroup>
      <thead>
        <tr>
          <th class="section-header atelier" colspan="6">Atelier</th>
          <th class="section-header couture" colspan="6">Couture</th>
          <th class="section-header" colspan="7">Inspection</th>
        </tr>
        <tr>
          <!-- ATELIER -->
          <th class="col-header col-plus"></th>
          <th class="col-header col-item"><button class="cmd-table-add-item-green" onclick="addCmdItemDept('${cmdId}')">+ Item</button></th>
          <th class="col-header col-qty">Qté</th>
          <th class="col-header col-total">Total</th>
          <th class="col-header col-status">Status</th>
          <th class="col-header col-notes border-right-solid">Notes</th>
          <!-- COUTURE -->
          <th class="col-header col-item">Item</th>
          <th class="col-header col-qty">Qté</th>
          <th class="col-header col-total">Total</th>
          <th class="col-header col-status">Status</th>
          <th class="col-header col-emp">Emp.</th>
          <th class="col-header col-notes border-right-solid">Notes</th>
          <!-- INSPECTION -->
          <th class="col-header col-item">Item</th>
          <th class="col-header col-qty">Qté</th>
          <th class="col-header col-total">Total</th>
          <th class="col-header col-status">Status</th>
          <th class="col-header col-exped">Expédition</th>
          <th class="col-header col-notes">Notes</th>
          <th class="col-header col-x"></th>
        </tr>
      </thead>
      <tbody>
  `;
  
  if (!items || items.length === 0) {
    html += `<tr><td colspan="19" style="text-align:center;color:#9ca3af;padding:10px;font-size:8px;">Aucun item - Cliquez sur "+ Item" pour ajouter</td></tr>`;
  } else {
    items.forEach((item, itemIdx) => {
      const grandeurs = item.grandeurs || [];
      
      // Calculer quantité totale
      let totalQty = 0;
      grandeurs.forEach(g => {
        totalQty += parseInt(g.qty) || 0;
      });
      
      // Ligne de l'item
      html += `
        <tr class="item-row">
          <!-- ATELIER -->
          <td class="col-plus"><button class="cmd-table-add-grandeur" onclick="addCmdGrandeurDept('${cmdId}', ${itemIdx})">+</button></td>
          <td class="col-item"><button class="cmd-table-item-pill" onclick="openCmdItemMenu('${cmdId}', ${itemIdx}, event)">${item.name || 'Item'}</button></td>
          <td class="col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="col-total"></td>
          <td class="col-status"></td>
          <td class="col-notes border-right-solid"></td>
          <!-- COUTURE -->
          <td class="col-item"><span class="cmd-table-item-name">${item.name || 'Item'}</span></td>
          <td class="col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="col-total"></td>
          <td class="col-status"></td>
          <td class="col-emp"></td>
          <td class="col-notes border-right-solid"></td>
          <!-- INSPECTION -->
          <td class="col-item"><span class="cmd-table-item-name">${item.name || 'Item'}</span></td>
          <td class="col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="col-total"></td>
          <td class="col-status"></td>
          <td class="col-exped"></td>
          <td class="col-notes"></td>
          <td class="col-x"><span class="cmd-table-delete-text" onclick="deleteCmdItemDept('${cmdId}', ${itemIdx})">−</span></td>
        </tr>
      `;
      
      // Lignes des grandeurs
      grandeurs.forEach((g, gIdx) => {
        const qtyTotal = g.qty || 0;
        
        // Données Atelier - Status: À faire, Partiel, Complet
        const atelierData = g.atelier || { status: 'todo', note: '', qtyFait: 0 };
        const atelierStatusClass = atelierData.status === 'done' ? 'done' : (atelierData.status === 'partial' ? 'partial' : 'todo');
        const atelierStatusText = atelierData.status === 'done' ? 'Complet' : (atelierData.status === 'partial' ? 'Partiel' : 'À faire');
        const atelierQtyFait = atelierData.qtyFait || 0;
        const atelierHasNote = atelierData.note && atelierData.note.trim() !== '';
        const atelierNoteClass = atelierHasNote ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        
        // Données Couture - Status: À faire, Partiel, Complet
        const coutureData = g.couture || { status: 'todo', note: '', qtyFait: 0, employe: '' };
        const coutureStatusClass = coutureData.status === 'done' ? 'done' : (coutureData.status === 'partial' ? 'partial' : 'todo');
        const coutureStatusText = coutureData.status === 'done' ? 'Complet' : (coutureData.status === 'partial' ? 'Partiel' : 'À faire');
        const coutureQtyFait = coutureData.qtyFait || 0;
        const coutureHasNote = coutureData.note && coutureData.note.trim() !== '';
        const coutureNoteClass = coutureHasNote ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        const coutureEmpText = coutureData.employe || 'Employé';
        
        // Données Inspection - Status: À faire, Partiel, Emboîté + Pastille Expédition
        const inspData = g.inspection || { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
        const inspStatusClass = inspData.status === 'done' ? 'done' : (inspData.status === 'partial' ? 'partial' : 'todo');
        const inspStatusText = inspData.status === 'done' ? 'Emboîté' : (inspData.status === 'partial' ? 'Partiel' : 'À faire');
        const inspQtyFait = inspData.qtyFait || 0;
        const inspHasNote = inspData.note && inspData.note.trim() !== '';
        const inspNoteClass = inspHasNote ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        const inspExped = inspData.exped || 'attente';
        
        // Trouver l'option correspondante pour le clignotement et la couleur
        const expedOption = EXPEDITION_OPTIONS.find(o => o.value === inspExped) || { label: inspExped, blink: false, color: '' };
        let inspExpedClass = 'attente';
        if (expedOption.blink) {
          inspExpedClass = 'pret blink-green';
        } else if (expedOption.color === 'yellow') {
          inspExpedClass = 'partiel yellow-bg';
        } else if (inspExped === 'expedie') {
          inspExpedClass = 'expedie';
        }
        const inspExpedText = expedOption.label;
        
        html += `
          <tr class="grandeur-row">
            <!-- ATELIER -->
            <td class="col-plus"></td>
            <td class="col-item"><button class="cmd-table-grandeur-pill" onclick="openCmdGrandeurMenu('${cmdId}', ${itemIdx}, ${gIdx}, event)">${g.name || 'Grandeur'}</button></td>
            <td class="col-qty"><input type="text" class="cmd-table-qty-input" value="${qtyTotal}" maxlength="3" onfocus="this.select()" oninput="this.value=this.value.replace(/[^0-9]/g,'')" onchange="updateCmdGrandeurQty('${cmdId}', ${itemIdx}, ${gIdx}, this.value)"></td>
            <td class="col-total"><div class="cmd-table-fait-container"><input type="text" class="cmd-table-fait-input-top" value="${atelierQtyFait}" maxlength="${String(qtyTotal).length}" onfocus="this.select()" oninput="limitQtyInputText(this, ${qtyTotal})" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'atelier', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="col-status"><button class="cmd-table-status ${atelierStatusClass}">${atelierStatusText}</button></td>
            <td class="col-notes border-right-solid"><button class="${atelierNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'atelier', event)">Notes</button></td>
            <!-- COUTURE -->
            <td class="col-item"><span class="cmd-table-grandeur-readonly">${g.name || 'Grandeur'}</span></td>
            <td class="col-qty"><span class="cmd-table-qty-readonly">${qtyTotal}</span></td>
            <td class="col-total"><div class="cmd-table-fait-container"><input type="text" class="cmd-table-fait-input-top" value="${coutureQtyFait}" maxlength="${String(qtyTotal).length}" onfocus="this.select()" oninput="limitQtyInputText(this, ${qtyTotal})" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="col-status"><button class="cmd-table-status ${coutureStatusClass}">${coutureStatusText}</button></td>
            <td class="col-emp">
              <select class="cmd-table-emp-select" onchange="handleCmdEmployeSelect(this, '${cmdId}', ${itemIdx}, ${gIdx}, 'couture')">
                <option value="">Employé</option>
                ${EMPLOYES_COUTURE.map(emp => `<option value="${emp}" ${coutureData.employe === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                <option value="__ADD__">➕ Ajouter</option>
                <option value="__REMOVE__">➖ Supprimer</option>
              </select>
            </td>
            <td class="col-notes border-right-solid"><button class="${coutureNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', event)">Notes</button></td>
            <!-- INSPECTION -->
            <td class="col-item"><span class="cmd-table-grandeur-readonly">${g.name || 'Grandeur'}</span></td>
            <td class="col-qty"><span class="cmd-table-qty-readonly">${qtyTotal}</span></td>
            <td class="col-total"><div class="cmd-table-fait-container"><input type="text" class="cmd-table-fait-input-top" value="${inspQtyFait}" maxlength="${String(qtyTotal).length}" onfocus="this.select()" oninput="limitQtyInputText(this, ${qtyTotal})" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'inspection', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="col-status"><button class="cmd-table-status ${inspStatusClass}">${inspStatusText}</button></td>
            <td class="col-exped">
              <select class="cmd-table-exped-select ${inspExpedClass}" onchange="handleCmdExpedSelect(this, '${cmdId}', ${itemIdx}, ${gIdx})">
                ${EXPEDITION_OPTIONS.map(opt => `<option value="${opt.value}" ${inspExped === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                <option value="__ADD__">➕ Ajouter</option>
                <option value="__REMOVE__">➖ Supprimer</option>
              </select>
            </td>
            <td class="col-notes"><button class="${inspNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'inspection', event)">Notes</button></td>
            <td class="col-x"><span class="cmd-table-delete-text" onclick="deleteCmdGrandeurDept('${cmdId}', ${itemIdx}, ${gIdx})">−</span></td>
          </tr>
        `;
      });
    });
  }
  
  html += `
      </tbody>
    </table>
  `;
  
  return html;
}

// Listes des valeurs pour Item et Grandeur
const CMD_ITEM_VALUES = ["Premium", "Ultra", "PZ Siliko", "Physiair", "Easy-fit", "HP2", "Cinch", "Resolve", "Brio", "Appuis Thoraciques"];
const CMD_GRANDEUR_VALUES = ["10 x 10", "12 x 12", "12 x 14", "14 x 14", "14 x 16", "16 x 16", "16 x 18", "18 x 16", "18 x 18", "18 x 20", "20 x 20", "20 x 18", "20 x 16", "20 x 22", "22 x 18", "22 x 20"];

// Menu État pour Inspection (grosse pastille)
function openInspectionEtatMenu(cmdId, itemIdx, gIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 2) + 'px';
  
  menu.innerHTML = `
    <div class="cmd-select-title">État</div>
    <button class="cmd-select-option" onclick="setInspectionEtat('${cmdId}', ${itemIdx}, ${gIdx}, 'Inspecté')">✓ Inspecté</button>
    <button class="cmd-select-option" onclick="setInspectionEtat('${cmdId}', ${itemIdx}, ${gIdx}, 'Expédié')">📦 Expédié</button>
    <button class="cmd-select-option" onclick="setInspectionEtat('${cmdId}', ${itemIdx}, ${gIdx}, '')">— Aucun</button>
  `;
  
  document.body.appendChild(menu);
  setTimeout(() => {
    document.addEventListener('click', closeCmdSelectMenu, { once: true });
  }, 10);
}

// Définir l'état pour Inspection
function setInspectionEtat(cmdId, itemIdx, gIdx, etat) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g.inspection) g.inspection = { status: 'todo', etat: '', note: '', qtyFait: 0 };
  g.inspection.etat = etat;
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

// Fermer le menu de sélection
function closeCmdSelectMenu() {
  const existing = document.querySelector('.cmd-select-menu');
  if (existing) existing.remove();
}

// Ouvrir le menu Item
function openCmdItemMenu(cmdId, itemIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 2) + 'px';
  
  menu.innerHTML = `
    <div class="cmd-select-title">Item commande</div>
    ${CMD_ITEM_VALUES.map(val => `
      <button class="cmd-select-option" onclick="selectCmdItem('${cmdId}', ${itemIdx}, '${val}')">${val}</button>
    `).join('')}
  `;
  
  document.body.appendChild(menu);
  
  // Fermer si clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeCmdSelectMenu, { once: true });
  }, 10);
}

// Sélectionner un Item
function selectCmdItem(cmdId, itemIdx, value) {
  commandesData[cmdId].items[itemIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

// Ouvrir le menu Grandeur
// Fonction utilitaire pour positionner les menus au centre et éviter les bords
function positionMenuSmart(menu, rect) {
  const menuWidth = 150; // Largeur estimée du menu
  const menuHeight = 200; // Hauteur estimée du menu
  const padding = 10;
  
  // Position horizontale: centrer par rapport à l'écran
  let left = (window.innerWidth - menuWidth) / 2;
  
  // Position verticale: centrer par rapport à l'écran
  let top = (window.innerHeight - menuHeight) / 2;
  
  // S'assurer qu'on ne dépasse pas les bords
  if (left < padding) left = padding;
  if (left + menuWidth > window.innerWidth - padding) left = window.innerWidth - menuWidth - padding;
  if (top < padding) top = padding;
  if (top + menuHeight > window.innerHeight - padding) top = window.innerHeight - menuHeight - padding;
  
  menu.style.left = left + 'px';
  menu.style.top = top + 'px';
}

function openCmdGrandeurMenu(cmdId, itemIdx, gIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  
  menu.innerHTML = `
    <div class="cmd-select-title">Grandeur</div>
    ${CMD_GRANDEUR_VALUES.map(val => `
      <button class="cmd-select-option" onclick="selectCmdGrandeur('${cmdId}', ${itemIdx}, ${gIdx}, '${val}')">${val}</button>
    `).join('')}
  `;
  
  document.body.appendChild(menu);
  
  // Positionner au centre de l'écran
  positionMenuSmart(menu, rect);
  
  // Fermer si clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeCmdSelectMenu, { once: true });
  }, 10);
}

// Sélectionner une Grandeur
function selectCmdGrandeur(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

function deleteCmdGrandeurDept(cmdId, itemIdx, gIdx) {
  commandesData[cmdId].items[itemIdx].grandeurs.splice(gIdx, 1);
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

// Limiter l'input de quantité selon le maximum (pour type="text")
function limitQtyInputText(input, maxQty) {
  // Enlever tout sauf les chiffres
  input.value = input.value.replace(/[^0-9]/g, '');
  
  // Convertir en nombre
  let val = parseInt(input.value) || 0;
  
  // Ne pas dépasser le max
  if (val > maxQty) {
    input.value = maxQty;
  }
}
window.limitQtyInputText = limitQtyInputText;

// Ancienne fonction conservée pour compatibilité
function limitQtyInput(input, maxQty) {
  let val = parseInt(input.value) || 0;
  if (val > maxQty) {
    input.value = maxQty;
  }
  if (val < 0) {
    input.value = 0;
  }
}
window.limitQtyInput = limitQtyInput;

// Mettre à jour Qté fait (format X/Y, on garde seulement X)
function updateCmdQtyFait(cmdId, itemIdx, gIdx, dept, value) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0 };
  
  // On prend juste le chiffre entré
  const qtyFait = parseInt(value) || 0;
  const qtyTotal = parseInt(g.qty) || 0;
  
  // Ne pas dépasser le total
  g[dept].qtyFait = Math.min(qtyFait, qtyTotal);
  
  // Mettre à jour le status automatiquement
  if (g[dept].qtyFait === 0) {
    g[dept].status = 'todo';
  } else if (g[dept].qtyFait >= qtyTotal) {
    g[dept].status = 'done';
  } else {
    g[dept].status = 'partial';
  }
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

// Ouvrir un prompt pour entrer la quantité faite
function openFaitInput(cmdId, itemIdx, gIdx, dept, qtyTotal) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  const currentQty = g[dept] ? (g[dept].qtyFait || 0) : 0;
  
  const input = prompt(`Quantité faite (sur ${qtyTotal}):`, currentQty);
  if (input !== null) {
    updateCmdQtyFait(cmdId, itemIdx, gIdx, dept, input);
  }
}

// Toggle expédition Inspection: En attente <-> Prêt pour expédition
function toggleInspExped(cmdId, itemIdx, gIdx) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente', expedBlink: false };
  
  const popup = document.createElement('div');
  popup.className = 'cmd-popup-menu';
  popup.id = 'cmdMiniNotePopup';
  
  const optionsHtml = EXPEDITION_OPTIONS.map(opt => {
    const isSelected = g.inspection.exped === opt.value;
    const blinkIcon = opt.blink ? '✨' : '';
    return `<div class="cmd-popup-option ${isSelected ? 'selected' : ''}" onclick="selectCmdExped('${cmdId}', ${itemIdx}, ${gIdx}, '${opt.value}', ${opt.blink})">${blinkIcon} ${opt.label}</div>`;
  }).join('');
  
  popup.innerHTML = `
    <div class="cmd-popup-header">🚚 Expédition</div>
    <div class="cmd-popup-options">
      ${optionsHtml}
    </div>
    <div class="cmd-popup-actions">
      <div class="cmd-popup-action add" onclick="addNewExpedOption()">➕ Ajouter</div>
      <div class="cmd-popup-action remove" onclick="removeExpedOption()">➖ Supprimer</div>
      <div class="cmd-popup-action config" onclick="toggleExpedBlink()">⚙ Clignotement</div>
    </div>
    <div class="cmd-popup-footer">
      <button onclick="closeCmdGrandeurNote()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(popup);
}

function selectCmdExped(cmdId, itemIdx, gIdx, value, blink) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente', expedBlink: false };
  
  g.inspection.exped = value;
  g.inspection.expedBlink = blink;
  
  closeCmdGrandeurNote();
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function addNewExpedOption() {
  closeCmdGrandeurNote();
  const newLabel = prompt('Nom de la nouvelle option:');
  if (newLabel && newLabel.trim()) {
    const value = newLabel.trim().toLowerCase().replace(/\s+/g, '_');
    const blink = confirm('Cette option doit-elle clignoter en vert?');
    EXPEDITION_OPTIONS.push({ value, label: newLabel.trim(), blink });
  }
}

function removeExpedOption() {
  closeCmdGrandeurNote();
  const optList = EXPEDITION_OPTIONS.map((o, i) => `${i + 1}. ${o.label}${o.blink ? ' ✨' : ''}`).join('\n');
  const choice = prompt(`Supprimer quelle option?\n${optList}\n\nNuméro:`);
  if (choice) {
    const index = parseInt(choice) - 1;
    if (index >= 0 && index < EXPEDITION_OPTIONS.length) {
      EXPEDITION_OPTIONS.splice(index, 1);
    }
  }
}

function toggleExpedBlink() {
  closeCmdGrandeurNote();
  const optList = EXPEDITION_OPTIONS.map((o, i) => `${i + 1}. ${o.label} - ${o.blink ? 'Clignote' : 'Ne clignote pas'}`).join('\n');
  const choice = prompt(`Changer le clignotement de quelle option?\n${optList}\n\nNuméro:`);
  if (choice) {
    const index = parseInt(choice) - 1;
    if (index >= 0 && index < EXPEDITION_OPTIONS.length) {
      EXPEDITION_OPTIONS[index].blink = !EXPEDITION_OPTIONS[index].blink;
      alert(`${EXPEDITION_OPTIONS[index].label}: ${EXPEDITION_OPTIONS[index].blink ? 'Clignote maintenant' : 'Ne clignote plus'}`);
    }
  }
}

// Popup pour la nouvelle pastille (à définir plus tard)
function addCmdItemDept(cmdId) {
  if (!commandesData[cmdId].items) commandesData[cmdId].items = [];
  commandesData[cmdId].items.push({ 
    name: '', 
    grandeurs: [] 
  });
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function deleteCmdItemDept(cmdId, itemIdx) {
  commandesData[cmdId].items.splice(itemIdx, 1);
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdItemNameDept(cmdId, itemIdx, value) {
  commandesData[cmdId].items[itemIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function addCmdGrandeurDept(cmdId, itemIdx) {
  if (!commandesData[cmdId].items[itemIdx].grandeurs) {
    commandesData[cmdId].items[itemIdx].grandeurs = [];
  }
  commandesData[cmdId].items[itemIdx].grandeurs.push({ 
    name: '', 
    qty: 0,
    atelier: { status: 'todo', location: '', note: '' },
    couture: { status: 'todo', location: '', note: '' }
  });
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdGrandeurNameDept(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdGrandeurQty(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].qty = parseInt(value) || 0;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function toggleCmdGrandeurStatus(cmdId, itemIdx, gIdx, dept) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  
  // Toggle: todo <-> done (À faire <-> Complété)
  g[dept].status = g[dept].status === 'done' ? 'todo' : 'done';
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function openCmdLocationPopup(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  
  const popup = document.createElement('div');
  popup.className = 'cmd-mini-note-popup';
  popup.id = 'cmdMiniNotePopup';
  popup.style.left = (event.clientX - 100) + 'px';
  popup.style.top = (event.clientY + 10) + 'px';
  
  // Créer les options du menu
  const locations = MENU_DATA.locations || [];
  const optionsHtml = locations.map((loc, idx) => 
    `<div class="menu-option location-option" data-loc-idx="${idx}" onclick="selectCmdLocation('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}', '${loc.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:9px;cursor:pointer;border-bottom:1px solid #e5e7eb;">${loc}</div>`
  ).join('');
  
  popup.innerHTML = `
    <div style="font-size:10px;font-weight:600;margin-bottom:4px;">Localisation</div>
    <div id="locationOptionsList" style="max-height:150px;overflow-y:auto;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
      ${optionsHtml}
    </div>
    <input type="text" id="cmdLocationInput" value="${g[dept].location || ''}" placeholder="Ou saisir..." style="width:100%;padding:4px;font-size:9px;border:1px solid #d1d5db;border-radius:4px;box-sizing:border-box;margin-top:4px;">
    <div class="menu-popup-actions">
      <button class="menu-popup-add-btn" onclick="addNewLocation()">+ Ajouter</button>
      <button class="menu-popup-delete-btn" onclick="toggleDeleteLocationMode()">Supprimer</button>
    </div>
    <div class="mini-note-btns">
      <button class="save-btn" onclick="saveCmdLocation('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}')">OK</button>
      <button class="close-btn" onclick="closeCmdGrandeurNote()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(popup);
}

let deleteLocationMode = false;

function toggleDeleteLocationMode() {
  deleteLocationMode = !deleteLocationMode;
  const options = document.querySelectorAll('.location-option');
  const deleteBtn = document.querySelector('.menu-popup-delete-btn');
  
  if (deleteLocationMode) {
    deleteBtn.textContent = '❌ Cliquez sur une location';
    deleteBtn.style.background = '#ef4444';
    options.forEach(opt => {
      opt.style.background = '#fee2e2';
      opt.onclick = function() {
        const idx = parseInt(this.dataset.locIdx);
        if (confirm('Supprimer "' + MENU_DATA.locations[idx] + '" ?')) {
          MENU_DATA.locations.splice(idx, 1);
          closeCmdGrandeurNote();
        }
      };
    });
  } else {
    deleteBtn.textContent = 'Supprimer';
    deleteBtn.style.background = '';
    closeCmdGrandeurNote();
  }
}

function selectCmdLocation(cmdId, itemIdx, gIdx, dept, location) {
  // Sauvegarder directement et fermer le menu
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  g[dept].location = location;
  saveCommandeToFirebase(cmdId);
  refreshCmdDeptTables(cmdId);
  closeCmdGrandeurNote();
}

function addNewLocation() {
  const input = document.getElementById('cmdLocationInput');
  if (input && input.value.trim()) {
    const newLoc = input.value.trim();
    if (!MENU_DATA.locations.includes(newLoc)) {
      MENU_DATA.locations.push(newLoc);
    }
  }
}

function saveCmdLocation(cmdId, itemIdx, gIdx, dept) {
  const input = document.getElementById('cmdLocationInput');
  if (input) {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
    g[dept].location = input.value;
    saveCommandeToFirebase(cmdId);
  }
  closeCmdGrandeurNote();
}

// Les listes EMPLOYES_ATELIER et EMPLOYES_COUTURE sont définies plus haut dans le fichier

function openCmdEmployePopup(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '', employe: '' };
  
  const employesList = dept === 'atelier' ? EMPLOYES_ATELIER : EMPLOYES_COUTURE;
  const currentEmp = g[dept].employe || '';
  
  const popup = document.createElement('div');
  popup.className = 'cmd-popup-menu';
  popup.id = 'cmdMiniNotePopup';
  
  const optionsHtml = employesList.map(emp => 
    `<div class="cmd-popup-option ${emp === currentEmp ? 'selected' : ''}" onclick="selectCmdEmploye('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}', '${emp}')">${emp}</div>`
  ).join('');
  
  popup.innerHTML = `
    <div class="cmd-popup-header">👤 Employé</div>
    <div class="cmd-popup-options">
      ${optionsHtml}
    </div>
    <div class="cmd-popup-actions">
      <div class="cmd-popup-action add" onclick="addNewEmploye('${dept}', '${cmdId}', ${itemIdx}, ${gIdx})">➕ Ajouter</div>
      <div class="cmd-popup-action remove" onclick="removeEmployeOption('${dept}')">➖ Supprimer</div>
    </div>
    <div class="cmd-popup-footer">
      <button onclick="closeCmdGrandeurNote()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(popup);
}

function addNewEmploye(dept, cmdId, itemIdx, gIdx) {
  closeCmdGrandeurNote();
  const newEmp = prompt('Nom du nouvel employé:');
  if (newEmp && newEmp.trim()) {
    const empName = newEmp.trim();
    const list = dept === 'atelier' ? EMPLOYES_ATELIER : EMPLOYES_COUTURE;
    if (!list.includes(empName)) {
      list.push(empName);
    }
    // Sélectionner ce nouvel employé
    selectCmdEmploye(cmdId, itemIdx, gIdx, dept, empName);
  }
}

function removeEmployeOption(dept) {
  closeCmdGrandeurNote();
  const list = dept === 'atelier' ? EMPLOYES_ATELIER : EMPLOYES_COUTURE;
  const empList = list.map((e, i) => `${i + 1}. ${e}`).join('\n');
  const choice = prompt(`Supprimer quel employé?\n${empList}\n\nNuméro:`);
  if (choice) {
    const index = parseInt(choice) - 1;
    if (index >= 0 && index < list.length) {
      list.splice(index, 1);
    }
  }
}

function selectCmdEmploye(cmdId, itemIdx, gIdx, dept, employe) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '', employe: '' };
  g[dept].employe = employe;
  saveCommandeToFirebase(cmdId);
  closeCmdGrandeurNote();
  refreshCmdDeptTables(cmdId);
}

// Gestion du select Employé avec +/-
function handleCmdEmployeSelect(selectEl, cmdId, itemIdx, gIdx, dept) {
  const value = selectEl.value;
  
  if (value === '__ADD__') {
    const newEmp = prompt('Nom du nouvel employé:');
    if (newEmp && newEmp.trim()) {
      const empName = newEmp.trim();
      if (dept === 'atelier' && !EMPLOYES_ATELIER.includes(empName)) {
        EMPLOYES_ATELIER.push(empName);
      } else if (dept === 'couture' && !EMPLOYES_COUTURE.includes(empName)) {
        EMPLOYES_COUTURE.push(empName);
      }
      // Sélectionner le nouvel employé
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '', employe: '' };
      g[dept].employe = empName;
      saveCommandeToFirebase(cmdId);
      refreshCmdDeptTables(cmdId);
    } else {
      // Remettre à la valeur précédente
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      selectEl.value = g[dept]?.employe || '';
    }
  } else if (value === '__REMOVE__') {
    const list = dept === 'atelier' ? EMPLOYES_ATELIER : EMPLOYES_COUTURE;
    const empList = list.map((e, i) => `${i + 1}. ${e}`).join('\n');
    const choice = prompt(`Supprimer quel employé?\n${empList}\n\nNuméro:`);
    if (choice) {
      const index = parseInt(choice) - 1;
      if (index >= 0 && index < list.length) {
        list.splice(index, 1);
        refreshCmdDeptTables(cmdId);
      }
    }
    // Remettre à la valeur précédente
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    selectEl.value = g[dept]?.employe || '';
  } else {
    // Valeur normale - mettre à jour
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '', employe: '' };
    g[dept].employe = value;
    saveCommandeToFirebase(cmdId);
  }
}

// Gestion du select Expédition avec +/-
function handleCmdExpedSelect(selectEl, cmdId, itemIdx, gIdx) {
  const value = selectEl.value;
  
  if (value === '__ADD__') {
    const newLabel = prompt('Nom de la nouvelle option:');
    if (newLabel && newLabel.trim()) {
      const optValue = newLabel.trim().toLowerCase().replace(/\s+/g, '_');
      const blink = confirm('Cette option doit-elle clignoter en vert?');
      let color = '';
      if (!blink) {
        const isYellow = confirm('Cette option doit-elle être jaune?');
        if (isYellow) color = 'yellow';
      }
      EXPEDITION_OPTIONS.push({ value: optValue, label: newLabel.trim(), blink, color });
      // Sélectionner la nouvelle option
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
      g.inspection.exped = optValue;
      saveCommandeToFirebase(cmdId);
      refreshCmdDeptTables(cmdId);
    } else {
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      selectEl.value = g.inspection?.exped || 'attente';
    }
  } else if (value === '__REMOVE__') {
    const optList = EXPEDITION_OPTIONS.map((o, i) => `${i + 1}. ${o.label}`).join('\n');
    const choice = prompt(`Supprimer quelle option?\n${optList}\n\nNuméro:`);
    if (choice) {
      const index = parseInt(choice) - 1;
      if (index >= 0 && index < EXPEDITION_OPTIONS.length) {
        EXPEDITION_OPTIONS.splice(index, 1);
        refreshCmdDeptTables(cmdId);
      }
    }
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    selectEl.value = g.inspection?.exped || 'attente';
  } else {
    // Valeur normale - mettre à jour
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
    g.inspection.exped = value;
    saveCommandeToFirebase(cmdId);
    
    // Mettre à jour la classe CSS du select pour la couleur
    const expedOption = EXPEDITION_OPTIONS.find(o => o.value === value) || {};
    selectEl.className = 'cmd-table-exped-select';
    if (expedOption.blink) {
      selectEl.classList.add('blink-green');
    } else if (expedOption.color === 'yellow') {
      selectEl.classList.add('yellow-bg');
    } else if (value === 'expedie') {
      selectEl.classList.add('expedie');
    }
  }
}

function openCmdGrandeurNoteDept(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  
  const popup = document.createElement('div');
  popup.className = 'cmd-mini-note-popup';
  popup.id = 'cmdMiniNotePopup';
  
  popup.innerHTML = `
    <textarea id="cmdMiniNoteText">${g[dept].note || ''}</textarea>
    <div class="mini-note-btns">
      <button class="save-btn" onclick="saveCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}')">OK</button>
      <button class="close-btn" onclick="closeCmdGrandeurNote()">✕</button>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Centrer à l'écran
  popup.style.left = ((window.innerWidth - 200) / 2) + 'px';
  popup.style.top = ((window.innerHeight - 100) / 2) + 'px';
}

function saveCmdGrandeurNoteDept(cmdId, itemIdx, gIdx, dept) {
  const textarea = document.getElementById('cmdMiniNoteText');
  if (textarea) {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
    g[dept].note = textarea.value;
    saveCommandeToFirebase(cmdId);
  }
  closeCmdGrandeurNote();
}

function refreshCmdDeptTables(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const atelierList = document.getElementById('atelierItemsList');
  const coutureList = document.getElementById('coutureItemsList');
  const inspectionList = document.getElementById('inspectionItemsList');
  
  if (atelierList) atelierList.innerHTML = renderDeptItems(cmd.items, cmdId, 'atelier');
  if (coutureList) coutureList.innerHTML = renderDeptItems(cmd.items, cmdId, 'couture');
  if (inspectionList) inspectionList.innerHTML = renderDeptItems(cmd.items, cmdId, 'inspection');
  
  // Mettre à jour la section matériaux
  updateMateriauxSection(cmdId);
}

function closeCmdGrandeurNote() {
  const popup = document.getElementById('cmdMiniNotePopup');
  if (popup) popup.remove();
}

function toggleCmdNotes() {
  const content = document.getElementById('cmdNotesContent');
  const toggle = document.getElementById('cmdNotesToggle');
  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    toggle.textContent = '▼';
  } else {
    content.classList.add('expanded');
    toggle.textContent = '▲';
  }
}

function saveCmdFicheAndClose(cmdId) {
  // Sauvegarder toutes les données puis fermer
  saveAllCmdFicheData(cmdId);
  
  // Fermer la fiche
  const overlay = document.getElementById('cmdFicheOverlay');
  overlay.classList.remove('active');
  closeCmdGrandeurNote();
  currentCmdId = null;
  
  console.log(`✅ Fiche commande ${cmdId} sauvegardée et fermée`);
}

function saveCmdFiche(cmdId) {
  saveCmdFicheAndClose(cmdId);
}

// Fonction centralisée pour sauvegarder TOUTES les données de la fiche commande
// (les deux onglets: Info/Magasin ET Tableau)
function saveAllCmdFicheData(cmdId) {
  if (!cmdId || !commandesData[cmdId]) return;
  
  // ===== ONGLET INFO/MAGASIN =====
  // Dates
  const dateRecueEl = document.getElementById('cmdDateRecue');
  if (dateRecueEl && dateRecueEl.textContent !== 'AAAA-MM-JJ') {
    commandesData[cmdId].dateRecue = dateRecueEl.textContent;
  }
  
  const dateLivraisonEl = document.getElementById('cmdDateLivraison');
  if (dateLivraisonEl && dateLivraisonEl.textContent !== 'AAAA-MM-JJ') {
    commandesData[cmdId].dateLivraison = dateLivraisonEl.textContent;
  }
  
  // Numéros
  const numeroEl = document.getElementById('cmdNumero');
  if (numeroEl) commandesData[cmdId].order = numeroEl.value || '';
  
  const numeroPOEl = document.getElementById('cmdNumeroPO');
  if (numeroPOEl) commandesData[cmdId].numeroPO = numeroPOEl.value || '';
  
  // Client
  const clientEl = document.getElementById('cmdClient');
  if (clientEl) commandesData[cmdId].client = clientEl.value || '';
  
  // ===== ONGLET TABLEAU (items par département) =====
  // Les items sont déjà sauvegardés en temps réel via les fonctions updateCmdItemField, etc.
  // Mais on s'assure que tout est bien synchronisé
  
  // Sauvegarder dans Firebase
  saveCommandeToFirebase(cmdId);
  
  // Mettre à jour l'affichage
  renderCommandesBoard();
}

function closeCmdFiche() {
  // SAUVEGARDER TOUTES LES DONNÉES AVANT DE FERMER (les deux onglets)
  if (currentCmdId && commandesData[currentCmdId]) {
    saveAllCmdFicheData(currentCmdId);
    console.log('💾 Fiche commande sauvegardée (tous les onglets):', currentCmdId);
  }
  
  const overlay = document.getElementById('cmdFicheOverlay');
  overlay.classList.remove('active');
  closeCmdGrandeurNote();
  currentCmdId = null;
}

// Mise à jour d'un champ commande
function updateCmdField(cmdId, field, value) {
  if (commandesData[cmdId]) {
    commandesData[cmdId][field] = value;
    saveCommandeToFirebase(cmdId);
    renderCommandesBoard();
  }
}

function loadCommandesFromFirebase() {
  console.log('🔄 Chargement des commandes...');
  
  if (!firebaseDb) {
    console.log('⚠️ Firebase non disponible, création locale');
    if (Object.keys(commandesData).length === 0) {
      createDefaultCommandes();
    }
    renderCommandesBoard();
    return;
  }
  
  // Chargement initial avec once()
  firebaseDb.ref('commandes').once('value')
    .then((snapshot) => {
      const data = snapshot.val();
      console.log('📥 Données Firebase reçues:', data ? Object.keys(data).length : 0, 'commandes');
      
      if (data && Object.keys(data).length > 0) {
        commandesData = data;
      } else {
        console.log('📝 Aucune commande, création des cartes par défaut');
        createDefaultCommandes();
      }
      
      // Toujours rendre après chargement
      renderCommandesBoard();
      
      // Écouter les changements en temps réel
      setupCommandesRealtimeSync();
    })
    .catch((error) => {
      console.error('❌ Erreur chargement commandes:', error);
      // En cas d'erreur, créer localement
      if (Object.keys(commandesData).length === 0) {
        createDefaultCommandes();
      }
      renderCommandesBoard();
    });
}

function setupCommandesRealtimeSync() {
  if (!firebaseDb) return;
  
  firebaseDb.ref('commandes').on('value', (snap) => {
    const newData = snap.val();
    if (newData) {
      commandesData = newData;
      if (currentPage === 'commandes') {
        renderCommandesBoard();
      }
      console.log('🔄 Sync temps réel:', Object.keys(commandesData).length, 'commandes');
    }
  }, (error) => {
    console.error('❌ Erreur sync temps réel:', error);
  });
}

function createDefaultCommandes() {
  // DÉSACTIVÉ - Ne plus créer de cartes par défaut automatiquement
  // Les cartes sont créées manuellement avec le bouton "+ Ajouter commande"
  console.log('ℹ️ createDefaultCommandes désactivé - utilisez le bouton + Ajouter commande');
  return;
  
  /* Code original commenté:
  console.log('📝 Création de 5 cartes par défaut...');
  const timestamp = Date.now();
  
  // Créer une carte dans les 5 premières colonnes (pas BO)
  for (let idx = 0; idx < 5; idx++) {
    const cmdId = 'cmd_' + timestamp + '_' + idx;
    commandesData[cmdId] = {
      client: '',
      order: '000000',
      numeroPO: '',
      region: 'Québec',
      columnIndex: idx,
      dateCreated: new Date().toISOString(),
      items: [],
      notes: ''
    };
    
    // Sauvegarder immédiatement dans Firebase
    if (firebaseDb) {
      firebaseDb.ref('commandes/' + cmdId).set(commandesData[cmdId])
        .then(() => console.log(`✅ Carte ${idx} sauvegardée`))
        .catch(err => console.error(`❌ Erreur sauvegarde carte ${idx}:`, err));
    }
  }
  console.log('✅ 5 cartes par défaut créées');
  */
}

// Sauvegarde avec retry et backup local
function saveCommandeToFirebase(cmdId, retryCount = 0) {
  if (!commandesData[cmdId]) return;
  
  // Vérifier si l'utilisateur est connecté
  if (!currentUser) {
    console.log('⚠️ Utilisateur non connecté, sauvegarde locale seulement');
    // Backup local dans localStorage
    try {
      const backupKey = 'physipro_cmd_backup_' + cmdId;
      localStorage.setItem(backupKey, JSON.stringify(commandesData[cmdId]));
    } catch (e) {
      console.warn('⚠️ Backup local impossible:', e);
    }
    return;
  }
  
  // Backup local dans localStorage
  try {
    const backupKey = 'physipro_cmd_backup_' + cmdId;
    localStorage.setItem(backupKey, JSON.stringify(commandesData[cmdId]));
  } catch (e) {
    console.warn('⚠️ Backup local impossible:', e);
  }
  
  if (!firebaseDb) {
    console.log('⚠️ Firebase non disponible, sauvegarde locale seulement');
    return;
  }
  
  firebaseDb.ref('commandes/' + cmdId).set(commandesData[cmdId])
    .then(() => {
      console.log(`✅ Commande ${cmdId} sauvegardée`);
      // Nettoyer le backup après succès
      try {
        localStorage.removeItem('physipro_cmd_backup_' + cmdId);
      } catch (e) {}
    })
    .catch((error) => {
      console.error(`❌ Erreur sauvegarde ${cmdId}:`, error);
      
      // Retry jusqu'à 3 fois seulement si pas permission_denied
      if (error.message && error.message.includes('PERMISSION_DENIED')) {
        console.log('⚠️ Permission refusée - vérifiez les règles Firebase');
        return;
      }
      
      if (retryCount < 3) {
        console.log(`🔄 Retry ${retryCount + 1}/3 dans 2 secondes...`);
        setTimeout(() => {
          saveCommandeToFirebase(cmdId, retryCount + 1);
        }, 2000);
      } else {
        console.error(`❌ Échec après 3 tentatives pour ${cmdId}`);
        // Garder le backup local pour récupération ultérieure
      }
    });
}

// Récupérer les backups locaux au démarrage
function recoverLocalBackups() {
  try {
    const keys = Object.keys(localStorage).filter(k => k.startsWith('physipro_cmd_backup_'));
    if (keys.length > 0) {
      console.log(`🔄 Récupération de ${keys.length} backups locaux...`);
      keys.forEach(key => {
        const cmdId = key.replace('physipro_cmd_backup_', '');
        const data = JSON.parse(localStorage.getItem(key));
        if (data && !commandesData[cmdId]) {
          commandesData[cmdId] = data;
          saveCommandeToFirebase(cmdId);
        }
      });
    }
  } catch (e) {
    console.warn('⚠️ Récupération backups impossible:', e);
  }
}

// ===== INITIALISATION =====
document.addEventListener('DOMContentLoaded', () => {
  console.log('🚀 PhysiPro Moulage v11.0 - Production');
  
  // Récupérer les backups locaux
  recoverLocalBackups();
  
  // Event listener pour bouton Ajouter commande
  const btnAddCommande = document.getElementById('btnAddCommande');
  if (btnAddCommande) {
    btnAddCommande.addEventListener('click', addNewCommande);
  }
  
  // Charger les commandes depuis Firebase après connexion
  if (firebaseAuth) {
    firebaseAuth.onAuthStateChanged((user) => {
      if (user) {
        loadCommandesFromFirebase();
      } else {
        // Même sans utilisateur, créer cartes par défaut localement
        if (Object.keys(commandesData).length === 0) {
          createDefaultCommandes();
        }
        renderCommandesBoard();
      }
    });
  } else {
    // Si pas de Firebase auth, créer cartes par défaut
    if (Object.keys(commandesData).length === 0) {
      createDefaultCommandes();
    }
    renderCommandesBoard();
  }
  
  // Fermer modals avec Escape (sauf login si pas connecté)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      logModal.classList.remove('active');
      addModal.classList.remove('active');
      if (currentExpandedCard) closeFiche();
      // Retour au Kanban si vue Robot active
      if (isRobotViewActive) toggleRobotView();
      // Fermer calendrier table
      closeTableCalendar();
      // Fermer popup notes
      closeNotesPopup();
      // Fermer popup recettes
      closeRecettesPopup();
    }
  });
});

// ========================================
// SYSTÈME DE RECETTES ET MATÉRIAUX
// ========================================

// Recettes personnalisées (sauvegardées dans Firebase)
let customRecettes = {};

// Charger les recettes personnalisées depuis Firebase
function loadCustomRecettes() {
  if (!firebaseInitialized) return;
  firebaseDb.ref('recettes').on('value', (snap) => {
    customRecettes = snap.val() || {};
    console.log('Recettes chargées:', customRecettes);
  });
}

// Sauvegarder une recette personnalisée
function saveCustomRecette(itemName, materiaux) {
  if (!firebaseInitialized) return;
  firebaseDb.ref('recettes/' + itemName.replace(/[.#$/[\]]/g, '_')).set(materiaux);
}

// Supprimer une recette personnalisée
function deleteCustomRecette(itemName) {
  if (!firebaseInitialized) return;
  firebaseDb.ref('recettes/' + itemName.replace(/[.#$/[\]]/g, '_')).remove();
}

// Obtenir la recette pour un item
function getRecetteForItem(itemName) {
  if (!itemName) return [];
  
  // D'abord vérifier les recettes personnalisées (exact match)
  const customKey = itemName.replace(/[.#$/[\]]/g, '_');
  if (customRecettes[customKey]) {
    return customRecettes[customKey];
  }
  
  // Vérifier les recettes par défaut (exact match)
  if (MENU_DATA.recettes[itemName]) {
    return MENU_DATA.recettes[itemName];
  }
  
  // Recherche partielle dans les recettes par défaut
  const itemNameLower = itemName.toLowerCase();
  for (const [key, value] of Object.entries(MENU_DATA.recettes)) {
    if (key.toLowerCase().includes(itemNameLower) || itemNameLower.includes(key.toLowerCase())) {
      return value;
    }
  }
  
  // Recherche partielle dans les recettes personnalisées
  for (const [key, value] of Object.entries(customRecettes)) {
    const keyClean = key.replace(/_/g, ' ').toLowerCase();
    if (keyClean.includes(itemNameLower) || itemNameLower.includes(keyClean)) {
      return value;
    }
  }
  
  return [];
}

// Mettre à jour la section Matériaux nécessaires
function updateMateriauxSection(cmdId) {
  const container = document.getElementById('cmdMateriauxContainer');
  const totalContainer = document.getElementById('cmdMateriauxTotal');
  if (!container) return;
  
  const cmd = commandesData[cmdId];
  if (!cmd || !cmd.items || cmd.items.length === 0) {
    container.innerHTML = '<div style="color:#9ca3af;font-size:8px;text-align:center;padding:10px;grid-column:1/-1;">Aucun item ajouté dans Atelier</div>';
    if (totalContainer) totalContainer.innerHTML = '';
    return;
  }
  
  // Collecter tous les matériaux pour le total
  const totalMateriaux = {};
  
  // Préparer les colonnes par paires (gauche/droite)
  const columns = [];
  
  // Pour chaque item dans la commande
  cmd.items.forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    
    // Calculer la quantité totale (somme de toutes les grandeurs)
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    // Créer les lignes pour cet item
    const lines = [];
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const matQty = parseFloat(mat.qty) || 1;
        const qtyNeeded = matQty * (totalQty || 1);
        const qtyDisplay = qtyNeeded % 1 === 0 ? qtyNeeded : qtyNeeded.toFixed(1);
        const epaisseur = mat.epaisseur || '';
        const code = mat.code || '';
        const matName = mat.materiau || 'Matériau';
        const fullName = epaisseur ? `${matName} ${epaisseur}` : matName;
        
        lines.push({ code, fullName, qtyDisplay });
        
        // Ajouter au total
        const key = code || fullName;
        if (!totalMateriaux[key]) {
          totalMateriaux[key] = { code, name: fullName, qty: 0 };
        }
        totalMateriaux[key].qty += qtyNeeded;
      });
    }
    
    columns.push({
      name: itemName,
      qty: totalQty,
      lines: lines,
      hasRecette: recette && recette.length > 0
    });
  });
  
  // Générer le HTML des colonnes (recettes seulement)
  let html = '';
  
  for (let i = 0; i < columns.length; i += 2) {
    const left = columns[i];
    const right = columns[i + 1];
    
    // Créer une rangée avec 2 colonnes
    html += '<div style="display:contents;">';
    
    // Colonne gauche
    html += `<div class="cmd-materiaux-column">
      <div class="cmd-materiaux-header">${left.name} (×${left.qty || 0})</div>
      <div class="cmd-materiaux-list">`;
    
    if (left.hasRecette) {
      left.lines.forEach(line => {
        html += `<div class="cmd-materiaux-item">
          <span class="cmd-materiaux-code">${line.code}</span>
          <span class="cmd-materiaux-name">${line.fullName}</span>
          <span class="cmd-materiaux-qty">${line.qtyDisplay}</span>
        </div>`;
      });
    } else {
      html += '<div style="color:#f59e0b;font-size:8px;font-style:italic;text-align:center;padding:4px;">⚠ Pas de recette</div>';
    }
    
    html += '</div></div>';
    
    // Colonne droite (si existe)
    if (right) {
      html += `<div class="cmd-materiaux-column">
        <div class="cmd-materiaux-header">${right.name} (×${right.qty || 0})</div>
        <div class="cmd-materiaux-list">`;
      
      if (right.hasRecette) {
        right.lines.forEach(line => {
          html += `<div class="cmd-materiaux-item">
            <span class="cmd-materiaux-code">${line.code}</span>
            <span class="cmd-materiaux-name">${line.fullName}</span>
            <span class="cmd-materiaux-qty">${line.qtyDisplay}</span>
          </div>`;
        });
      } else {
        html += '<div style="color:#f59e0b;font-size:8px;font-style:italic;text-align:center;padding:4px;">⚠ Pas de recette</div>';
      }
      
      html += '</div></div>';
    }
    
    html += '</div>';
  }
  
  container.innerHTML = html;
  
  // Générer le HTML du Total Matériaux
  const totalKeys = Object.keys(totalMateriaux);
  let totalHtml = '';
  
  if (totalKeys.length > 0) {
    totalHtml = `
      <div class="cmd-materiaux-total">
        <div class="cmd-materiaux-total-header">📦 TOTAL MATÉRIAUX</div>
        <div class="cmd-materiaux-total-list">
    `;
    
    totalKeys.forEach(key => {
      const mat = totalMateriaux[key];
      const qtyDisplay = mat.qty % 1 === 0 ? mat.qty : mat.qty.toFixed(1);
      totalHtml += `
        <div class="cmd-materiaux-total-item">
          <span class="code">${mat.code || ''}</span>
          <span class="name">${mat.name}</span>
          <span class="qty">${qtyDisplay}</span>
        </div>
      `;
    });
    
    totalHtml += '</div></div>';
  }
  
  // Mettre à jour la section Total Matériaux EN HAUT de Magasin
  const totalContainerTop = document.getElementById('cmdMateriauxTotalTop');
  if (totalContainerTop) {
    totalContainerTop.innerHTML = totalHtml;
  }
  
  // Aussi mettre à jour dans Information (si existe encore)
  const totalContainerLeft = document.getElementById('cmdMateriauxTotalLeft');
  if (totalContainerLeft) {
    totalContainerLeft.innerHTML = '';
  }
}

// Ouvrir le popup de gestion des recettes
function openRecettesPopup() {
  // Créer le popup s'il n'existe pas
  let popup = document.getElementById('recettesPopup');
  if (!popup) {
    popup = document.createElement('div');
    popup.className = 'recettes-popup';
    popup.id = 'recettesPopup';
    document.body.appendChild(popup);
  }
  
  // Construire le contenu
  let recettesHtml = '';
  
  // Recettes par défaut + personnalisées
  const allRecettes = { ...MENU_DATA.recettes, ...customRecettes };
  
  Object.entries(allRecettes).forEach(([itemName, materiaux]) => {
    const isCustom = customRecettes[itemName] !== undefined;
    recettesHtml += buildRecetteCardEditable(itemName, materiaux, isCustom);
  });
  
  popup.innerHTML = `
    <div class="recettes-popup-header">
      <h3>⚙ Gestion des Recettes</h3>
    </div>
    <div class="recettes-popup-body">
      ${recettesHtml}
      
      <div class="add-recette-form">
        <h4>+ Ajouter une nouvelle recette</h4>
        <input type="text" id="newRecetteItem" placeholder="Nom de l'item (ex: Coussin Spécial)">
        <div style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:8px;">
          <span style="font-size:10px;font-weight:600;">Code</span>
          <span style="font-size:10px;font-weight:600;">Matériaux</span>
          <span style="font-size:10px;font-weight:600;">Épaisseur</span>
          <span style="font-size:10px;font-weight:600;">Qté</span>
          <span></span>
        </div>
        <div id="newRecetteMateriaux">
          <div class="new-materiau-row" style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:4px;">
            <input type="text" placeholder="VIS-22" style="padding:4px;font-size:10px;">
            <input type="text" placeholder="Feuille Viscose 22x24" style="padding:4px;font-size:10px;">
            <input type="text" placeholder="1 pouce" style="padding:4px;font-size:10px;">
            <input type="number" placeholder="1" value="1" min="0" step="0.5" style="padding:4px;font-size:10px;">
            <button onclick="this.parentElement.remove()" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;">✕</button>
          </div>
        </div>
        <button onclick="addNewMateriauRow()" style="font-size:10px;padding:4px 8px;margin-bottom:8px;background:#3b82f6;color:white;border:none;border-radius:3px;cursor:pointer;">+ Ajouter matériau</button>
        <br>
        <button onclick="saveNewRecette()" style="padding:6px 12px;font-size:11px;background:#22c55e;color:white;border:none;border-radius:4px;cursor:pointer;">Sauvegarder la recette</button>
      </div>
    </div>
    <div class="recettes-popup-footer">
      <button class="recettes-btn-save" onclick="closeRecettesPopup()">Enregistrer</button>
      <button class="recettes-btn-close" onclick="closeRecettesPopup()">Fermer</button>
    </div>
  `;
  
  popup.classList.add('show');
}

function buildRecetteCardEditable(itemName, materiaux, isCustom) {
  let materiauxRows = '';
  
  materiaux.forEach((mat, idx) => {
    materiauxRows += `
      <div class="recette-materiau-row" style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:2px;align-items:center;">
        <input type="text" value="${mat.code || ''}" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'code', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <input type="text" value="${mat.materiau}" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'materiau', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <input type="text" value="${mat.epaisseur || ''}" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'epaisseur', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <input type="number" value="${mat.qty}" min="0" step="0.5" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'qty', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <button onclick="removeRecetteMateriau('${itemName}', ${idx})" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">✕</button>
      </div>
    `;
  });
  
  return `
    <div class="recette-card">
      <div class="recette-card-header">
        <div class="recette-card-title">
          <input type="text" value="${itemName}" 
                 onchange="renameRecette('${itemName}', this.value)" 
                 style="font-size:12px;font-weight:700;border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;width:150px;background:#f8fafc;"
                 title="Cliquer pour modifier le nom">
          ${isCustom ? '<span style="color:#8b5cf6;font-size:10px;margin-left:5px;">(personnalisée)</span>' : ''}
        </div>
        <div class="recette-card-actions">
          <button class="recette-edit-btn" onclick="addMateriauToRecette('${itemName}')" style="background:#22c55e;">+ Mat.</button>
          ${isCustom ? `<button class="recette-delete-btn" onclick="deleteRecette('${itemName}')">Suppr.</button>` : ''}
        </div>
      </div>
      <div style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:4px;padding:4px 0;border-bottom:1px solid #e5e7eb;">
        <span style="font-size:9px;font-weight:600;">Code</span>
        <span style="font-size:9px;font-weight:600;">Matériaux</span>
        <span style="font-size:9px;font-weight:600;">Épaisseur</span>
        <span style="font-size:9px;font-weight:600;">Qté</span>
        <span></span>
      </div>
      <div class="recette-materiaux-list">
        ${materiauxRows}
      </div>
    </div>
  `;
}

function addNewMateriauRow() {
  const container = document.getElementById('newRecetteMateriaux');
  const row = document.createElement('div');
  row.className = 'new-materiau-row';
  row.style.cssText = 'display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:4px;';
  row.innerHTML = `
    <input type="text" placeholder="Code" style="padding:4px;font-size:10px;">
    <input type="text" placeholder="Matériau" style="padding:4px;font-size:10px;">
    <input type="text" placeholder="Épaisseur" style="padding:4px;font-size:10px;">
    <input type="number" placeholder="1" value="1" min="0" step="0.5" style="padding:4px;font-size:10px;">
    <button onclick="this.parentElement.remove()" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;">✕</button>
  `;
  container.appendChild(row);
}

function saveNewRecette() {
  const itemName = document.getElementById('newRecetteItem').value.trim();
  if (!itemName) {
    alert('Veuillez entrer un nom d\'item');
    return;
  }
  
  const rows = document.querySelectorAll('#newRecetteMateriaux .new-materiau-row');
  const materiaux = [];
  
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs[1].value.trim()) {
      materiaux.push({
        code: inputs[0].value.trim(),
        materiau: inputs[1].value.trim(),
        epaisseur: inputs[2].value.trim(),
        qty: parseFloat(inputs[3].value) || 1
      });
    }
  });
  
  if (materiaux.length === 0) {
    alert('Veuillez ajouter au moins un matériau');
    return;
  }
  
  saveCustomRecette(itemName, materiaux);
  setTimeout(() => openRecettesPopup(), 500);
}

function updateRecetteMateriau(itemName, idx, field, value) {
  // Récupérer la recette actuelle
  let recette = customRecettes[itemName] || MENU_DATA.recettes[itemName];
  if (!recette) return;
  
  // Copier pour modifier
  recette = JSON.parse(JSON.stringify(recette));
  
  if (field === 'qty') {
    recette[idx].qty = parseFloat(value) || 0;
  } else {
    recette[idx][field] = value;
  }
  
  // Sauvegarder comme recette personnalisée
  saveCustomRecette(itemName, recette);
}

function removeRecetteMateriau(itemName, idx) {
  let recette = customRecettes[itemName] || MENU_DATA.recettes[itemName];
  if (!recette) return;
  
  recette = JSON.parse(JSON.stringify(recette));
  recette.splice(idx, 1);
  
  if (recette.length === 0) {
    deleteCustomRecette(itemName);
  } else {
    saveCustomRecette(itemName, recette);
  }
  
  setTimeout(() => openRecettesPopup(), 300);
}

function addMateriauToRecette(itemName) {
  let recette = customRecettes[itemName] || MENU_DATA.recettes[itemName];
  if (!recette) recette = [];
  
  recette = JSON.parse(JSON.stringify(recette));
  recette.push({ code: '', materiau: 'Nouveau matériau', epaisseur: '', qty: 1 });
  
  saveCustomRecette(itemName, recette);
  setTimeout(() => openRecettesPopup(), 300);
}

// Renommer une recette
function renameRecette(oldName, newName) {
  newName = newName.trim();
  if (!newName || newName === oldName) return;
  
  // Vérifier si le nouveau nom existe déjà
  if (MENU_DATA.recettes[newName] || customRecettes[newName]) {
    alert('Une recette avec ce nom existe déjà!');
    setTimeout(() => openRecettesPopup(), 100);
    return;
  }
  
  // Récupérer la recette actuelle
  let recette = customRecettes[oldName] || MENU_DATA.recettes[oldName];
  if (!recette) return;
  
  recette = JSON.parse(JSON.stringify(recette));
  
  // Supprimer l'ancienne
  if (customRecettes[oldName]) {
    delete customRecettes[oldName];
  }
  
  // Sauvegarder avec le nouveau nom
  customRecettes[newName] = recette;
  saveRecettesToFirebase();
  
  // Mettre à jour aussi MENU_DATA si c'était une recette par défaut
  if (MENU_DATA.recettes[oldName] && !customRecettes[oldName]) {
    // On ne peut pas supprimer de MENU_DATA, mais on peut l'override
    customRecettes[newName] = recette;
  }
  
  setTimeout(() => openRecettesPopup(), 300);
}

function closeRecettesPopup() {
  const popup = document.getElementById('recettesPopup');
  if (popup) popup.classList.remove('show');
  
  // Mettre à jour les matériaux si une fiche est ouverte
  if (currentCmdId) {
    updateMateriauxSection(currentCmdId);
  }
}

// Fonction d'impression des matériaux
function printMateriaux(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  // D'abord calculer le TOTAL de tous les matériaux
  const totalMateriaux = {};
  (cmd.items || []).forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const matQty = parseFloat(mat.qty) || 1;
        const qtyNeeded = matQty * (totalQty || 1);
        const key = mat.code || mat.materiau || 'inconnu';
        if (!totalMateriaux[key]) {
          totalMateriaux[key] = { code: mat.code || '', name: mat.materiau || '', epaisseur: mat.epaisseur || '', qty: 0 };
        }
        totalMateriaux[key].qty += qtyNeeded;
      });
    }
  });
  
  // Construire le HTML d'impression
  let printHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Matériaux - ${cmd.order || 'Commande'}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 15px; font-size: 11px; }
        .header { border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 12px; }
        .header h1 { font-size: 16px; margin: 0 0 5px 0; }
        .info-row { display: flex; gap: 20px; font-size: 10px; margin-bottom: 3px; }
        .info-item { display: flex; gap: 5px; }
        .info-label { font-weight: bold; }
        
        /* TOTAL MATÉRIAUX - EN HAUT */
        .total-section { background: #1e3a5f; color: white; padding: 12px; border-radius: 6px; margin-bottom: 20px; }
        .total-section h2 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 6px; }
        .total-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .total-item { display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 3px; font-size: 10px; }
        .total-item .code { font-weight: bold; color: #93c5fd; }
        .total-item .name { flex: 1; margin: 0 8px; }
        .total-item .qty { font-weight: bold; font-size: 12px; color: #4ade80; }
        
        /* Détail par coussin */
        .detail-section { margin-top: 15px; }
        .detail-section h2 { font-size: 13px; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .materiaux-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .item-card { border: 1px solid #333; border-radius: 4px; padding: 8px; }
        .item-header { background: #333; color: white; padding: 5px 8px; margin: -8px -8px 8px -8px; border-radius: 3px 3px 0 0; font-weight: bold; font-size: 12px; }
        .mat-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .mat-table th { text-align: left; border-bottom: 1px solid #333; padding: 3px 5px; font-size: 9px; }
        .mat-table td { padding: 3px 5px; border-bottom: 1px dotted #ccc; }
        .mat-table .qty { text-align: right; font-weight: bold; font-size: 12px; }
        @media print { body { padding: 10px; } .total-section { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>PHYSIPRO - Liste Matériaux</h1>
        <div class="info-row">
          <div class="info-item"><span class="info-label">Client:</span> ${cmd.client || '-'}</div>
          <div class="info-item"><span class="info-label">N° Commande:</span> ${cmd.order || '-'}</div>
          <div class="info-item"><span class="info-label">N° PO:</span> ${cmd.numeroPO || '-'}</div>
        </div>
        <div class="info-row">
          <div class="info-item"><span class="info-label">Date reçue:</span> ${cmd.dateRecue || '-'}</div>
          <div class="info-item"><span class="info-label">Date livraison:</span> ${cmd.dateLivraison || '-'}</div>
        </div>
      </div>
      
      <!-- TOTAL MATÉRIAUX EN HAUT -->
      <div class="total-section">
        <h2>📦 TOTAL MATÉRIAUX REQUIS</h2>
        <div class="total-grid">
  `;
  
  // Ajouter le total
  const totalKeys = Object.keys(totalMateriaux);
  if (totalKeys.length > 0) {
    totalKeys.forEach(key => {
      const mat = totalMateriaux[key];
      const qtyDisplay = mat.qty % 1 === 0 ? mat.qty : mat.qty.toFixed(1);
      printHtml += `
        <div class="total-item">
          <span class="code">${mat.code || '-'}</span>
          <span class="name">${mat.name}${mat.epaisseur ? ' ' + mat.epaisseur : ''}</span>
          <span class="qty">${qtyDisplay}</span>
        </div>
      `;
    });
  } else {
    printHtml += `<div style="grid-column: 1/-1; text-align: center; opacity: 0.7;">Aucun matériau calculé</div>`;
  }
  
  printHtml += `
        </div>
      </div>
      
      <!-- DÉTAIL PAR COUSSIN -->
      <div class="detail-section">
        <h2>📋 Détail par item</h2>
        <div class="materiaux-grid">
  `;
  
  // Pour chaque item (détail)
  (cmd.items || []).forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    printHtml += `
      <div class="item-card">
        <div class="item-header">${itemName} (×${totalQty || 0})</div>
        <table class="mat-table">
          <tr><th>Code</th><th>Matériaux</th><th>Épaisseur</th><th style="text-align:right;">Qté</th></tr>
    `;
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const matQty = parseFloat(mat.qty) || 1;
        const qtyNeeded = matQty * (totalQty || 1);
        const qtyDisplay = qtyNeeded % 1 === 0 ? qtyNeeded : qtyNeeded.toFixed(1);
        printHtml += `
          <tr>
            <td>${mat.code || '-'}</td>
            <td>${mat.materiau || '-'}</td>
            <td>${mat.epaisseur || '-'}</td>
            <td class="qty">${qtyDisplay}</td>
          </tr>
        `;
      });
    } else {
      printHtml += `<tr><td colspan="4" style="text-align:center;color:#999;">Pas de recette définie</td></tr>`;
    }
    
    printHtml += `</table></div>`;
  });
  
  printHtml += `
        </div>
      </div>
      <div style="margin-top: 20px; font-size: 9px; color: #666; border-top: 1px solid #ccc; padding-top: 8px;">
        Imprimé le ${new Date().toLocaleDateString('fr-CA')} à ${new Date().toLocaleTimeString('fr-CA')}
      </div>
    </body>
    </html>
  `;
  
  // Ouvrir fenêtre d'impression
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printHtml);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 250);
}

function deleteRecette(itemName) {
  if (confirm(`Supprimer la recette pour "${itemName}" ?`)) {
    deleteCustomRecette(itemName);
    setTimeout(() => openRecettesPopup(), 500);
  }
}

// Popup Notes pour la fiche commande
let currentNotesCommandeId = null;

function openCmdNotesPopup(cmdId) {
  currentNotesCommandeId = cmdId;
  const cmd = commandesData[cmdId];
  
  // Fermer l'ancien popup
  closeCmdNotesPopup();
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  let popup = document.getElementById('cmdNotesPopup');
  if (!popup) {
    popup = document.createElement('div');
    popup.className = 'cmd-notes-popup-overlay';
    popup.id = 'cmdNotesPopup';
    popup.onclick = function(e) { if (e.target === this) closeCmdNotesPopup(); };
    document.body.appendChild(popup);
  }
  
  popup.innerHTML = `
    <div class="cmd-notes-popup-content">
      <div class="cmd-notes-popup-header">
        <h3>📝 Notes - ${cmd.client || 'Commande'}</h3>
        <button onclick="closeCmdNotesPopup()">Fermer</button>
      </div>
      <div class="cmd-notes-popup-body">
        <div class="cmd-existing-notes">${cmd.notes || '<span style="color:#9ca3af;font-style:italic;">Aucune note</span>'}</div>
        <div class="cmd-new-note-section">
          <div class="cmd-note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div>
          <textarea id="cmdNotesPopupText" placeholder="Ajouter une nouvelle note..."></textarea>
        </div>
      </div>
      <div class="cmd-notes-popup-footer">
        <button class="btn-save" onclick="saveCmdNotesPopup()">💾 Sauvegarder</button>
        <button class="btn-close" onclick="closeCmdNotesPopup()">Fermer</button>
      </div>
    </div>
  `;
  
  popup.style.display = 'flex';
  
  // Focus sur le textarea
  setTimeout(() => {
    document.getElementById('cmdNotesPopupText')?.focus();
  }, 100);
}

function closeCmdNotesPopup() {
  const popup = document.getElementById('cmdNotesPopup');
  if (popup) popup.style.display = 'none';
  currentNotesCommandeId = null;
}

function saveCmdNotesPopup() {
  if (!currentNotesCommandeId) return;
  
  const textarea = document.getElementById('cmdNotesPopupText');
  const newNoteText = textarea?.value?.trim();
  
  if (newNoteText) {
    const userName = getCurrentUserName();
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    
    const newNote = `<div class="note-entry"><div class="note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div><div class="note-text">${newNoteText}</div></div>`;
    
    const existingNotes = commandesData[currentNotesCommandeId].notes || '';
    commandesData[currentNotesCommandeId].notes = existingNotes + newNote;
    saveCommandeToFirebase(currentNotesCommandeId);
    
    // Mettre à jour l'aperçu
    const preview = document.getElementById('cmdNotesPreview');
    if (preview) {
      const notes = textarea.value;
      preview.textContent = notes ? notes.substring(0, 50) + (notes.length > 50 ? '...' : '') : 'Cliquez pour ajouter des notes...';
    }
  }
  
  closeCmdNotesPopup();
}

// Charger les recettes au démarrage
setTimeout(loadCustomRecettes, 2000);

// ===== FONCTIONS IMPORT/EXPORT =====

function openImportExportMenu() {
  document.getElementById('importExportOverlay')?.classList.remove('hidden');
}

function closeImportExportMenu() {
  document.getElementById('importExportOverlay')?.classList.add('hidden');
}

// Fermer avec clic sur overlay
document.getElementById('importExportOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'importExportOverlay') {
    closeImportExportMenu();
  }
});

// Exporter TOUTES les données
function exportAllData() {
  const exportData = {
    version: 'PhysiPro_v291.4',
    exportDate: new Date().toISOString(),
    exportedBy: currentUser?.email || 'Anonyme',
    
    // Données des moulages
    moulages: cardsData,
    
    // Données des commandes
    commandes: commandesData,
    
    // Paramètres et listes
    settings: {
      MENU_DATA: MENU_DATA,
      USERS: USERS,
      RAISONS_ATTENTE: RAISONS_ATTENTE,
      EMPLOYES_ATELIER: EMPLOYES_ATELIER,
      EMPLOYES_COUTURE: EMPLOYES_COUTURE,
      EXPEDITION_OPTIONS: EXPEDITION_OPTIONS
    },
    
    // Logs et archives (si disponibles)
    logs: typeof logEntries !== 'undefined' ? logEntries : [],
    archives: typeof archivedCards !== 'undefined' ? archivedCards : []
  };
  
  downloadJSON(exportData, `physipro_backup_${formatDateForFilename()}.json`);
  console.log('✅ Export complet effectué');
  alert('✅ Export complet effectué!\n\nFichier téléchargé avec toutes les données.');
}

// Exporter seulement les moulages
function exportMoulagesOnly() {
  const exportData = {
    version: 'PhysiPro_v291.4',
    exportDate: new Date().toISOString(),
    exportType: 'moulages_only',
    moulages: cardsData
  };
  
  downloadJSON(exportData, `physipro_moulages_${formatDateForFilename()}.json`);
  console.log('✅ Export moulages effectué');
  alert('✅ Export des moulages effectué!');
}

// Exporter seulement les commandes
function exportCommandesOnly() {
  const exportData = {
    version: 'PhysiPro_v291.4',
    exportDate: new Date().toISOString(),
    exportType: 'commandes_only',
    commandes: commandesData
  };
  
  downloadJSON(exportData, `physipro_commandes_${formatDateForFilename()}.json`);
  console.log('✅ Export commandes effectué');
  alert('✅ Export des commandes effectué!');
}

// Fonction utilitaire pour télécharger un JSON
function downloadJSON(data, filename) {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Formater la date pour le nom de fichier
function formatDateForFilename() {
  const now = new Date();
  return now.toISOString().slice(0,10).replace(/-/g, '') + '_' + 
         now.toTimeString().slice(0,5).replace(':', '');
}

// Gérer l'importation d'un fichier
function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      // Vérifier que c'est un fichier PhysiPro valide
      if (!importedData.version || !importedData.version.startsWith('PhysiPro')) {
        alert('❌ Fichier invalide!\n\nCe fichier ne semble pas être un export PhysiPro valide.');
        return;
      }
      
      // Confirmer l'importation
      const confirmMsg = `⚠️ ATTENTION!\n\nVous êtes sur le point d'importer des données du ${new Date(importedData.exportDate).toLocaleString('fr-CA')}.\n\nType: ${importedData.exportType || 'Backup complet'}\n\nCette action remplacera vos données actuelles.\n\nÊtes-vous sûr de vouloir continuer?`;
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      // Importer les données selon le type
      let importCount = { moulages: 0, commandes: 0, settings: false };
      
      // Importer les moulages
      if (importedData.moulages) {
        Object.keys(importedData.moulages).forEach(cardId => {
          cardsData[cardId] = importedData.moulages[cardId];
          saveCardToFirebase(cardId);
          importCount.moulages++;
        });
      }
      
      // Importer les commandes
      if (importedData.commandes) {
        Object.keys(importedData.commandes).forEach(cmdId => {
          commandesData[cmdId] = importedData.commandes[cmdId];
          saveCommandeToFirebase(cmdId);
          importCount.commandes++;
        });
      }
      
      // Importer les paramètres
      if (importedData.settings) {
        if (importedData.settings.MENU_DATA) {
          Object.assign(MENU_DATA, importedData.settings.MENU_DATA);
        }
        if (importedData.settings.RAISONS_ATTENTE) {
          RAISONS_ATTENTE = importedData.settings.RAISONS_ATTENTE;
        }
        if (importedData.settings.EMPLOYES_ATELIER) {
          EMPLOYES_ATELIER = importedData.settings.EMPLOYES_ATELIER;
        }
        if (importedData.settings.EMPLOYES_COUTURE) {
          EMPLOYES_COUTURE = importedData.settings.EMPLOYES_COUTURE;
        }
        importCount.settings = true;
      }
      
      // Rafraîchir l'affichage
      loadCardsFromFirebase();
      renderCommandesBoard();
      
      // Message de succès
      alert(`✅ Importation réussie!\n\n• ${importCount.moulages} moulages importés\n• ${importCount.commandes} commandes importées\n• Paramètres: ${importCount.settings ? 'Oui' : 'Non'}\n\nL'affichage a été rafraîchi.`);
      
      closeImportExportMenu();
      console.log('✅ Import effectué:', importCount);
      
    } catch (error) {
      console.error('Erreur d\'importation:', error);
      alert('❌ Erreur lors de l\'importation!\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  
  // Réinitialiser l'input file pour permettre de réimporter le même fichier
  event.target.value = '';
}

// ===== IMPORT JSON ATELIER (Items/Grandeurs/Quantités) =====
function handleImportAtelierFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Vérifier les permissions
  if (!userCan('edit')) {
    alert("⛔ Vous n'avez pas la permission d'importer des données.");
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      // Vérifier que c'est un tableau
      if (!Array.isArray(importedData)) {
        alert('❌ Format invalide!\n\nLe fichier doit contenir un tableau JSON.\n\nExemple:\n[\n  { "commande": "123456", "item": "HP2", "grandeur": "M", "qty": 2 }\n]');
        return;
      }
      
      // Compter les mises à jour
      let updated = 0;
      let notFound = [];
      let errors = [];
      
      importedData.forEach((entry, index) => {
        // Valider les champs requis
        if (!entry.commande) {
          errors.push(`Ligne ${index + 1}: "commande" manquant`);
          return;
        }
        
        // Chercher la carte par numéro de commande
        const commande = String(entry.commande).padStart(6, '0');
        let cardFound = false;
        
        for (const [cardId, cardData] of Object.entries(cardsData)) {
          if (cardData.order === commande) {
            // Mettre à jour les champs
            if (entry.item !== undefined) {
              cardsData[cardId].item = entry.item;
            }
            if (entry.grandeur !== undefined) {
              cardsData[cardId].grandeur = entry.grandeur;
            }
            if (entry.qty !== undefined) {
              cardsData[cardId].quantite = entry.qty;
            }
            
            // Sauvegarder
            saveCardToFirebase(cardId);
            updated++;
            cardFound = true;
            break;
          }
        }
        
        if (!cardFound) {
          notFound.push(commande);
        }
      });
      
      // Message de résultat
      let message = `✅ Import Atelier terminé!\n\n`;
      message += `• ${updated} moulage(s) mis à jour\n`;
      
      if (notFound.length > 0) {
        message += `\n⚠️ ${notFound.length} commande(s) non trouvée(s):\n`;
        message += notFound.slice(0, 10).join(', ');
        if (notFound.length > 10) message += `... et ${notFound.length - 10} autres`;
      }
      
      if (errors.length > 0) {
        message += `\n\n❌ ${errors.length} erreur(s):\n`;
        message += errors.slice(0, 5).join('\n');
      }
      
      alert(message);
      
      // Rafraîchir l'affichage
      loadCardsFromFirebase();
      closeImportExportMenu();
      
      console.log('✅ Import Atelier effectué:', { updated, notFound, errors });
      
    } catch (error) {
      console.error('Erreur d\'importation Atelier:', error);
      alert('❌ Erreur lors de l\'importation!\n\nVérifiez que le fichier est un JSON valide.\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}

// Import JSON directement dans le tableau de la commande ouverte
function handleImportAtelierFileCmd(event, cmdId) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Vérifier les permissions
  if (!userCan('edit')) {
    alert("⛔ Vous n'avez pas la permission d'importer des données.");
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      // Vérifier que c'est un tableau
      if (!Array.isArray(importedData)) {
        alert('❌ Format invalide!\n\nLe fichier doit contenir un tableau JSON.\n\nExemple:\n[\n  { "item": "HP2", "grandeur": "M", "qty": 2 }\n]');
        return;
      }
      
      // S'assurer que la commande existe
      if (!commandesData[cmdId]) {
        alert('❌ Commande non trouvée!');
        return;
      }
      
      // Initialiser items si nécessaire
      if (!commandesData[cmdId].items) {
        commandesData[cmdId].items = [];
      }
      
      let itemsAdded = 0;
      let grandeursAdded = 0;
      
      importedData.forEach((entry) => {
        const itemName = entry.item || 'Item';
        const grandeurName = entry.grandeur || entry.size || 'Grandeur';
        const qty = parseInt(entry.qty) || parseInt(entry.quantity) || 1;
        
        // Chercher si l'item existe déjà
        let itemFound = commandesData[cmdId].items.find(i => i.name === itemName);
        
        if (!itemFound) {
          // Créer un nouvel item
          itemFound = { name: itemName, grandeurs: [] };
          commandesData[cmdId].items.push(itemFound);
          itemsAdded++;
        }
        
        // Ajouter la grandeur
        itemFound.grandeurs.push({
          name: grandeurName,
          qty: qty,
          atelier: { status: 'todo', note: '', qtyFait: 0 },
          couture: { status: 'todo', note: '', qtyFait: 0, employe: '' },
          inspection: { status: 'todo', note: '', qtyFait: 0, exped: '' }
        });
        grandeursAdded++;
      });
      
      // Sauvegarder et rafraîchir
      saveCommandeToFirebase(cmdId);
      refreshCmdDeptTables(cmdId);
      
      alert(`✅ Import terminé!\n\n• ${itemsAdded} item(s) créé(s)\n• ${grandeursAdded} grandeur(s) ajoutée(s)`);
      
    } catch (error) {
      console.error('Erreur d\'importation:', error);
      alert('❌ Erreur lors de l\'importation!\n\nVérifiez que le fichier est un JSON valide.\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}
window.handleImportAtelierFileCmd = handleImportAtelierFileCmd;
</script>
</body>
</html>
